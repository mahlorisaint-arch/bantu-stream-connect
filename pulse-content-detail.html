<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulse Detail - Bantu Connect Pulse</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Color Theme - Same as pulse-feed.html */
        :root {
            --deep-black: #0A0E12;
            --deep-navy: #0F172A;
            --soft-white: #F8FAFC;
            --slate-grey: #94A3B8;
            --bantu-blue: #1D4ED8;
            --warm-gold: #F59E0B;
            --error-color: #EF4444;
            --success-color: #10B981;
            --glow-cycle-1: #00A3FF;
            --glow-cycle-2: #0066FF;
            --glow-cycle-3: #8B5CF6;
            --glow-cycle-4: #EC4899;
            --card-bg: rgba(15, 23, 42, 0.6);
            --card-border: rgba(148, 163, 184, 0.2);
            --hover-overlay: rgba(255, 255, 255, 0.05);
            --active-overlay: rgba(245, 158, 11, 0.1);
            --indigo: #4F46E5;
            --gold-glow: rgba(245, 158, 11, 0.3);
            --blue-glow: rgba(29, 78, 216, 0.3);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--deep-black);
            color: var(--soft-white);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--deep-black);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--bantu-blue);
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Animated Background - Same as pulse-feed.html */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            overflow: hidden;
        }
        
        .glow-cycle {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.1;
            animation: float 8s infinite ease-in-out;
        }
        
        .glow-1 {
            width: 400px;
            height: 400px;
            background: var(--glow-cycle-1);
            top: 10%;
            left: 5%;
            animation-delay: 0s;
        }
        
        .glow-2 {
            width: 300px;
            height: 300px;
            background: var(--glow-cycle-2);
            top: 60%;
            right: 10%;
            animation-delay: 2s;
        }
        
        .glow-3 {
            width: 350px;
            height: 350px;
            background: var(--glow-cycle-3);
            bottom: 10%;
            left: 20%;
            animation-delay: 4s;
        }
        
        .glow-4 {
            width: 250px;
            height: 250px;
            background: var(--glow-cycle-4);
            top: 20%;
            right: 20%;
            animation-delay: 6s;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-20px) scale(1.05); }
        }
        
        /* Main Container */
        .container {
            max-width: 720px;
            margin: 0 auto;
            padding: 24px;
            position: relative;
            z-index: 2;
            padding-bottom: 120px; /* Space for bottom nav */
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            margin-bottom: 24px;
            position: sticky;
            top: 0;
            background-color: rgba(10, 14, 18, 0.9);
            backdrop-filter: blur(20px);
            z-index: 100;
            border-bottom: 1px solid var(--card-border);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 32px rgba(29, 78, 216, 0.3);
            overflow: hidden;
            background: transparent;
        }
        
        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .logo-text {
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 16px;
            background: linear-gradient(to right, var(--soft-white), var(--bantu-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: 0.5px;
        }
        
        .user-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--soft-white);
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            display: none;
        }
        
        /* Pulse Post Container - Glassmorphism with Gold Glow */
        .pulse-post-container {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            padding: 0;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .pulse-post-container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--warm-gold), var(--bantu-blue), var(--warm-gold));
            border-radius: 26px;
            z-index: -1;
            opacity: 0.3;
            animation: pulse-glow 2s infinite alternate;
        }
        
        @keyframes pulse-glow {
            0% { opacity: 0.2; }
            100% { opacity: 0.4; }
        }
        
        /* Pulse Header */
        .pulse-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            padding-bottom: 0;
        }
        
        .creator-info {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }
        
        .creator-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 600;
            color: var(--soft-white);
            font-size: 16px;
            position: relative;
            overflow: hidden;
        }
        
        .creator-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        .creator-meta h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--soft-white);
            margin-bottom: 2px;
            cursor: pointer;
        }
        
        .creator-meta p {
            font-size: 14px;
            color: var(--slate-grey);
        }
        
        .more-options {
            position: relative;
        }
        
        .more-btn {
            background: none;
            border: none;
            color: var(--slate-grey);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .more-btn:hover {
            color: var(--soft-white);
            background: var(--hover-overlay);
        }
        
        /* FIX: Scrollable more menu */
        .more-menu {
            position: absolute;
            top: 40px;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            width: 200px;
            max-height: 300px; /* FIX: Added max-height */
            overflow-y: auto; /* FIX: Added scrollbar */
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
        }
        
        .more-menu.active {
            display: block;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            color: var(--soft-white);
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .menu-item:hover {
            background: var(--hover-overlay);
        }
        
        .menu-item.delete {
            color: var(--error-color);
            border-top: 1px solid var(--card-border);
        }
        
        /* Media Container - Updated Video Player */
        .media-container {
            width: 100%;
            aspect-ratio: 9/16;
            background: black;
            border-radius: 0;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
            display: none;
        }
        
        .media-container.has-media {
            display: block;
        }
        
        .pulse-media {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        /* Custom Video Controls - Glassmorphism */
        .video-controls-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .media-container:hover .video-controls-overlay {
            opacity: 1;
        }
        
        .video-progress {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            margin-bottom: 15px;
            position: relative;
            cursor: pointer;
        }
        
        .video-progress-filled {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: var(--warm-gold);
            border-radius: 2px;
            width: 0%;
        }
        
        .video-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .video-left-controls,
        .video-right-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .video-control-btn {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--warm-gold);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        .video-control-btn:hover {
            background: rgba(245, 158, 11, 0.2);
            transform: scale(1.1);
        }
        
        .video-time {
            color: var(--warm-gold);
            font-size: 14px;
            font-weight: 500;
            min-width: 100px;
            text-align: center;
        }
        
        .video-volume {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .volume-slider {
            width: 80px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }
        
        .volume-slider-filled {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: var(--warm-gold);
            border-radius: 2px;
            width: 50%;
        }
        
        /* Narrative Block */
        .narrative-block {
            padding: 0 20px 20px;
        }
        
        .series-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--warm-gold);
            margin-bottom: 12px;
            cursor: pointer;
            display: inline-block;
            padding: 4px 12px;
            background: rgba(245, 158, 11, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .series-label:hover {
            background: rgba(245, 158, 11, 0.2);
        }
        
        .caption-text {
            font-size: 16px;
            line-height: 1.6;
            color: var(--soft-white);
            white-space: pre-line;
        }
        
        /* Action Bar */
        .action-bar {
            display: flex;
            align-items: center;
            gap: 24px;
            padding: 16px 20px;
            border-top: 1px solid var(--card-border);
        }
        
        .action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            color: var(--slate-grey);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .action-btn:hover {
            color: var(--soft-white);
            background: var(--hover-overlay);
        }
        
        .action-btn.liked {
            color: var(--warm-gold);
        }
        
        .action-btn i {
            font-size: 18px;
        }
        
        .action-count {
            font-size: 13px;
            color: var(--slate-grey);
            margin-left: 4px;
        }
        
        /* Comments Section Container */
        .comments-section-container {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            padding: 24px;
            margin-top: 32px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .comments-section {
            margin-top: 0;
        }
        
        .comments-header {
            margin-bottom: 24px;
        }
        
        .comments-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--soft-white);
            margin-bottom: 4px;
        }
        
        .comments-subtitle {
            font-size: 14px;
            color: var(--slate-grey);
        }
        
        /* Comment Composer */
        .comment-composer {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 32px;
            padding: 16px;
            background: rgba(10, 14, 18, 0.6);
            border: 1px solid var(--card-border);
            border-radius: 16px;
        }
        
        .composer-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--soft-white);
            font-size: 12px;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }
        
        .composer-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            display: none;
        }
        
        .composer-input {
            flex: 1;
            padding: 12px 16px;
            background: rgba(10, 14, 18, 0.6);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            color: var(--soft-white);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            resize: none;
            min-height: 44px;
            transition: border-color 0.3s ease;
        }
        
        .composer-input:focus {
            outline: none;
            border-color: var(--warm-gold);
        }
        
        .composer-input::placeholder {
            color: var(--slate-grey);
        }
        
        .post-comment-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
            border: none;
            border-radius: 12px;
            color: var(--soft-white);
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .post-comment-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(29, 78, 216, 0.3);
        }
        
        .post-comment-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Comments Thread */
        .comments-thread {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .comment-item {
            padding: 16px;
            background: rgba(10, 14, 18, 0.4);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            position: relative;
        }
        
        .comment-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--soft-white);
            font-size: 10px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .comment-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            display: none;
        }
        
        .comment-meta {
            flex: 1;
        }
        
        .comment-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--soft-white);
            margin-bottom: 2px;
            cursor: pointer;
        }
        
        .comment-handle {
            font-size: 12px;
            color: var(--slate-grey);
        }
        
        .comment-time {
            font-size: 11px;
            color: var(--slate-grey);
        }
        
        .comment-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--soft-white);
            margin-bottom: 12px;
            white-space: pre-line;
        }
        
        .comment-actions {
            display: flex;
            gap: 16px;
        }
        
        .comment-action {
            display: flex;
            align-items: center;
            gap: 4px;
            background: none;
            border: none;
            color: var(--slate-grey);
            font-size: 12px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .comment-action:hover {
            color: var(--soft-white);
            background: var(--hover-overlay);
        }
        
        .comment-action.liked {
            color: var(--warm-gold);
        }
        
        /* Comment Edit/Delete Options */
        .comment-options {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        
        .comment-options-btn {
            background: none;
            border: none;
            color: var(--slate-grey);
            font-size: 14px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .comment-options-btn:hover {
            color: var(--soft-white);
            background: var(--hover-overlay);
        }
        
        .comment-options-menu {
            position: absolute;
            top: 25px;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            width: 120px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 100;
            overflow: hidden;
        }
        
        .comment-options-menu.active {
            display: block;
        }
        
        .comment-option-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            color: var(--soft-white);
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .comment-option-item:hover {
            background: var(--hover-overlay);
        }
        
        .comment-option-item.delete {
            color: var(--error-color);
            border-top: 1px solid var(--card-border);
        }
        
        /* Reply Thread */
        .reply-thread {
            margin-left: 16px;
            padding-left: 16px;
            border-left: 1px solid rgba(148, 163, 184, 0.1);
            margin-top: 12px;
        }
        
        .reply-composer {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding: 8px;
            background: rgba(10, 14, 18, 0.3);
            border-radius: 12px;
            display: none;
        }
        
        .reply-composer.active {
            display: flex;
        }
        
        .reply-input {
            flex: 1;
            padding: 8px 12px;
            background: transparent;
            border: 1px solid var(--card-border);
            border-radius: 8px;
            color: var(--soft-white);
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            resize: none;
            min-height: 36px;
        }
        
        .reply-input:focus {
            outline: none;
            border-color: var(--warm-gold);
        }
        
        .reply-input::placeholder {
            color: var(--slate-grey);
            font-size: 13px;
        }
        
        .post-reply-btn {
            padding: 6px 12px;
            background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
            border: none;
            border-radius: 8px;
            color: var(--soft-white);
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--slate-grey);
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--soft-white);
            margin-bottom: 8px;
        }
        
        .empty-description {
            font-size: 14px;
            max-width: 300px;
            margin: 0 auto;
            line-height: 1.4;
        }
        
        /* Share Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        
        .share-modal {
            background: var(--deep-navy);
            border-radius: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--card-border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--card-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--soft-white);
        }
        
        .close-modal {
            background: none;
            border: none;
            color: var(--slate-grey);
            font-size: 24px;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .close-modal:hover {
            color: var(--soft-white);
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .share-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .share-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .share-option:hover {
            border-color: var(--bantu-blue);
            background: rgba(29, 78, 216, 0.05);
        }
        
        .share-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }
        
        .share-text {
            flex: 1;
            color: var(--soft-white);
            font-weight: 500;
        }
        
        .share-description {
            font-size: 12px;
            color: var(--slate-grey);
            margin-top: 2px;
        }
        
        .copy-link-section {
            background: rgba(10, 14, 18, 0.6);
            border-radius: 12px;
            padding: 16px;
            margin-top: 24px;
        }
        
        .copy-link-label {
            font-size: 14px;
            color: var(--slate-grey);
            margin-bottom: 8px;
        }
        
        .link-container {
            display: flex;
            gap: 8px;
        }
        
        .link-input {
            flex: 1;
            padding: 12px;
            background: var(--deep-black);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            color: var(--soft-white);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .copy-link-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
            border: none;
            border-radius: 8px;
            color: var(--soft-white);
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Edit Comment Modal */
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .modal-btn-cancel {
            background: var(--card-bg);
            color: var(--slate-grey);
            border: 1px solid var(--card-border);
        }
        
        .modal-btn-cancel:hover {
            background: var(--hover-overlay);
            color: var(--soft-white);
        }
        
        .modal-btn-post {
            background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
            color: var(--soft-white);
            margin-left: 10px;
        }
        
        .modal-btn-post:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(29, 78, 216, 0.3);
        }
        
        .modal-footer {
            padding: 20px 0 0;
            border-top: 1px solid var(--card-border);
            display: flex;
            justify-content: flex-end;
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
        }
        
        .toast {
            background: var(--error-color);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideUp 0.3s ease;
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
            max-width: 90vw;
        }
        
        .toast.success {
            background: var(--success-color);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }
        
        @keyframes slideUp {
            from {
                transform: translate(-50%, 100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--deep-black);
            border-top: 1px solid var(--card-border);
            display: flex;
            padding: 12px 0;
            z-index: 100;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            background: none;
            border: none;
            color: var(--slate-grey);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .nav-item:hover {
            color: var(--soft-white);
        }
        
        .nav-item.active {
            color: var(--bantu-blue);
        }
        
        .nav-icon {
            font-size: 20px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
                max-width: 100%;
                padding-bottom: 100px;
            }
            
            .media-container.has-media {
                border-radius: 0;
                margin-left: -16px;
                margin-right: -16px;
                width: calc(100% + 32px);
            }
            
            .comment-composer {
                flex-direction: column;
            }
            
            .post-comment-btn {
                align-self: flex-end;
            }
            
            .share-modal {
                width: 95%;
            }
            
            .pulse-post-container {
                border-radius: 16px;
            }
            
            .more-menu {
                width: 180px;
                max-height: 250px;
            }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--deep-navy);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--bantu-blue);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--warm-gold);
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading" class="loading-screen">
        <div class="spinner"></div>
        <div id="loading-text">Loading Pulse...</div>
    </div>

    <!-- Animated Background -->
    <div class="animated-bg">
        <div class="glow-cycle glow-1"></div>
        <div class="glow-cycle glow-2"></div>
        <div class="glow-cycle glow-3"></div>
        <div class="glow-cycle glow-4"></div>
    </div>

    <!-- Main Container -->
    <div class="container" id="content" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="logo-container" onclick="window.location.href='pulse-feed.html'">
                <div class="logo-icon">
                    <svg width="32" height="32" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="40" height="40" rx="8" fill="#0F172A"/>
                        <path d="M8 20 L12 16 L16 22 L20 18 L24 24 L28 20 L32 26" stroke="url(#pulse-gradient)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="32" cy="26" r="3" fill="#F59E0B"/>
                        <defs>
                            <linearGradient id="pulse-gradient" x1="8" y1="20" x2="32" y2="26" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#1D4ED8"/>
                                <stop offset="1" stop-color="#F59E0B"/>
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <div class="logo-text">BANTU CONNECT PULSE</div>
            </div>
            
            <div class="user-section">
                <div class="user-avatar" id="user-avatar" onclick="window.location.href='profile.html'">
                    <img id="user-avatar-img">
                    <span id="avatar-initials">AB</span>
                </div>
            </div>
        </header>
        
        <!-- Pulse Post Container -->
        <div class="pulse-post-container">
            <!-- Pulse Header -->
            <div class="pulse-header">
                <div class="creator-info" onclick="viewCreatorProfile()">
                    <div class="creator-avatar" id="creator-avatar">
                        <img id="creator-avatar-img">
                        <span id="creator-initials">AB</span>
                    </div>
                    <div class="creator-meta">
                        <h3 id="creator-name">Alex Bantu</h3>
                        <p id="creator-handle">@alexbantu · <span id="pulse-time">2 hours ago</span></p>
                    </div>
                </div>
                
                <div class="more-options">
                    <button class="more-btn" id="moreBtn">
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                    <div class="more-menu" id="moreMenu">
                        <button class="menu-item" id="savePulseBtn">
                            <i class="far fa-bookmark"></i>
                            Save Pulse
                        </button>
                        <button class="menu-item" id="reportPulseBtn">
                            <i class="far fa-flag"></i>
                            Report
                        </button>
                        <button class="menu-item" id="muteCreatorBtn">
                            <i class="fas fa-volume-mute"></i>
                            Mute Creator
                        </button>
                        <button class="menu-item delete" id="deletePulseBtn" style="display: none;">
                            <i class="fas fa-trash"></i>
                            Delete Pulse
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Media Container -->
            <div class="media-container">
                <div id="media-content">
                    <!-- Media will be loaded here -->
                </div>
                
                <!-- Custom Video Controls -->
                <div class="video-controls-overlay">
                    <div class="video-progress" id="videoProgress">
                        <div class="video-progress-filled" id="videoProgressFilled"></div>
                    </div>
                    <div class="video-controls">
                        <div class="video-left-controls">
                            <button class="video-control-btn" id="playPauseBtn">
                                <i class="fas fa-play"></i>
                            </button>
                            <div class="video-time" id="currentTime">0:00</div>
                        </div>
                        <div class="video-right-controls">
                            <div class="video-volume">
                                <button class="video-control-btn" id="muteBtn">
                                    <i class="fas fa-volume-mute"></i>
                                </button>
                                <div class="volume-slider" id="volumeSlider">
                                    <div class="volume-slider-filled" id="volumeSliderFilled"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Narrative Block -->
            <div class="narrative-block">
                <div class="series-label" id="seriesLabel" style="display: none;">
                    PULSE SERIES · Part <span id="series-part">2</span> of <span id="series-total">5</span>
                </div>
                <div class="caption-text" id="caption-text">
                    The rhythm of African storytelling isn't just in the words—it's in the spaces between them. The moments of silence, the glances, the pauses that speak volumes. That's where the real magic happens.
                </div>
            </div>
            
            <!-- Action Bar -->
            <div class="action-bar">
                <button class="action-btn" id="commentBtn">
                    <i class="fas fa-comment"></i> <span id="comment-count">24</span>
                </button>
                <button class="action-btn" id="likeBtn">
                    <i class="fas fa-heart"></i> <span id="like-count">142</span>
                </button>
                <button class="action-btn" id="shareBtn">
                    <i class="fas fa-share"></i> <span id="share-count">8</span>
                </button>
            </div>
        </div>
        
        <!-- Comments Section Container -->
        <div class="comments-section-container">
            <!-- Comments Section -->
            <div class="comments-section">
                <div class="comments-header">
                    <h3 class="comments-title">Conversation</h3>
                    <p class="comments-subtitle">Thoughts on this Pulse?</p>
                </div>
                
                <!-- Comment Composer -->
                <div class="comment-composer">
                    <div class="composer-avatar" id="composer-avatar">
                        <img id="composer-avatar-img">
                        <span>AB</span>
                    </div>
                    <textarea 
                        class="composer-input" 
                        id="commentInput" 
                        placeholder="Add your voice…"
                        maxlength="500"
                        rows="2"
                    ></textarea>
                    <button class="post-comment-btn" id="postCommentBtn" disabled>Post</button>
                </div>
                
                <!-- Comments Thread -->
                <div class="comments-thread" id="commentsThread">
                    <!-- Comments will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-item" onclick="window.location.href='pulse-feed.html'">
            <i class="fas fa-home nav-icon"></i>
            <span>Home</span>
        </button>
        <button class="nav-item" onclick="window.location.href='search.html'">
            <i class="fas fa-search nav-icon"></i>
            <span>Search</span>
        </button>
        <button class="nav-item" onclick="window.location.href='saved.html'">
            <i class="fas fa-bookmark nav-icon"></i>
            <span>Saved</span>
        </button>
        <button class="nav-item" onclick="window.location.href='profile.html'">
            <i class="fas fa-user nav-icon"></i>
            <span>Profile</span>
        </button>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Share Modal -->
    <div id="shareModal" class="modal-overlay">
        <div class="share-modal">
            <div class="modal-header">
                <h3 class="modal-title">Share Pulse</h3>
                <button class="close-modal" id="closeShareModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="share-options">
                    <div class="share-option" id="copyLinkOption">
                        <div class="share-icon">
                            <i class="fas fa-link"></i>
                        </div>
                        <div class="share-text">
                            Copy link
                            <div class="share-description">Share via any platform</div>
                        </div>
                    </div>
                    
                    <div class="share-option" id="shareWhatsApp">
                        <div class="share-icon" style="background: linear-gradient(135deg, #25D366, #128C7E);">
                            <i class="fab fa-whatsapp"></i>
                        </div>
                        <div class="share-text">
                            Share on WhatsApp
                            <div class="share-description">Send to contacts or groups</div>
                        </div>
                    </div>
                    
                    <div class="share-option" id="shareTwitter">
                        <div class="share-icon" style="background: linear-gradient(135deg, #1DA1F2, #0d8bd9);">
                            <i class="fab fa-twitter"></i>
                        </div>
                        <div class="share-text">
                            Share on X
                            <div class="share-description">Post to your followers</div>
                        </div>
                    </div>
                    
                    <div class="share-option" id="shareInstagram">
                        <div class="share-icon" style="background: linear-gradient(135deg, #E1306C, #C13584);">
                            <i class="fab fa-instagram"></i>
                        </div>
                        <div class="share-text">
                            Share on Instagram
                            <div class="share-description">Add to your story or post</div>
                        </div>
                    </div>
                    
                    <div class="share-option" id="shareInternal">
                        <div class="share-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="share-text">
                            Share inside Bantu
                            <div class="share-description">Send to Connectors</div>
                        </div>
                    </div>
                    
                    <div class="share-option" id="addToSeries" style="display: none;">
                        <div class="share-icon">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <div class="share-text">
                            Add to Series
                            <div class="share-description">Include in an existing series</div>
                        </div>
                    </div>
                </div>
                
                <div class="copy-link-section">
                    <div class="copy-link-label">Direct link to this Pulse</div>
                    <div class="link-container">
                        <input type="text" class="link-input" id="shareLink" readonly value="https://bantuconnect.pulse/id/12345">
                        <button class="copy-link-btn" id="copyLinkBtn">Copy</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Comment Modal -->
    <div id="editCommentModal" class="modal-overlay">
        <div class="share-modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Edit Comment</h3>
                <button class="close-modal" id="closeEditCommentModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <textarea 
                    class="composer-input" 
                    id="editCommentInput" 
                    placeholder="Edit your comment..."
                    maxlength="500"
                    rows="4"
                ></textarea>
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-cancel" id="cancelEditComment">Cancel</button>
                    <button class="modal-btn modal-btn-post" id="saveEditComment">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase client
        const SUPABASE_URL = 'https://ydnxqnbjoshvxteevemc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkbnhxbmJqb3Nodnh0ZWV2ZW1jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MzI0OTMsImV4cCI6MjA3MzIwODQ5M30.NlaCCnLPSz1mM7AFeSlfZQ78kYEKUMh_Fi-7P_ccs_U';

        let supabaseClient = null;
        let currentUserId = null;
        let pulseId = null;
        let currentPulse = null;
        let pulseCreator = null;
        let isLiked = false;
        let isSaved = false;
        let videoElement = null;
        let isPlaying = false;
        let isMuted = false;
        let volume = 1;
        let editingCommentId = null;
        let editingReplyId = null;

        async function initialize() {
            console.log('Starting Pulse Detail initialization...');
            
            try {
                // Create Supabase client
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    auth: {
                        autoRefreshToken: true,
                        persistSession: true,
                        detectSessionInUrl: true
                    }
                });
                
                // Check session
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                
                if (error) {
                    throw error;
                }
                
                if (!session) {
                    // No session, redirect to login
                    window.location.href = 'login.html';
                    return;
                }
                
                console.log('User authenticated:', session.user.email);
                currentUserId = session.user.id;
                
                // Set user initials
                const user = session.user;
                const initials = getUserInitials(user);
                document.getElementById('avatar-initials').textContent = initials;
                const composerAvatar = document.getElementById('composer-avatar');
                composerAvatar.querySelector('span').textContent = initials;
                
                // Set user avatar if available
                try {
                    const { data: profile } = await supabaseClient
                        .from('user_profiles')
                        .select('avatar_url, full_name')
                        .eq('id', user.id)
                        .single();
                    
                    if (profile?.avatar_url) {
                        const avatarImg = document.getElementById('user-avatar-img');
                        avatarImg.src = profile.avatar_url;
                        avatarImg.style.display = 'block';
                        document.getElementById('avatar-initials').style.display = 'none';
                        
                        // Also set composer avatar
                        const composerImg = document.getElementById('composer-avatar-img');
                        composerImg.src = profile.avatar_url;
                        composerImg.style.display = 'block';
                        composerAvatar.querySelector('span').style.display = 'none';
                    }
                } catch (error) {
                    console.log('No profile picture found, using initials');
                }
                
                // Get pulse ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                pulseId = urlParams.get('id');
                
                if (!pulseId) {
                    showToast('No pulse ID specified', 'error');
                    // Redirect to feed after delay
                    setTimeout(() => {
                        window.location.href = 'pulse-feed.html';
                    }, 2000);
                    return;
                }
                
                // Load pulse data
                await loadPulse();
                
                // Hide loading, show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
                // Initialize event listeners
                initializeEventListeners();
                
                // Load comments
                loadComments();
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading-text').textContent = 'Error loading pulse. Please refresh.';
                
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('content').style.display = 'block';
                    initializeEventListeners();
                }, 2000);
            }
        }
        
        function getUserInitials(user) {
            const email = user.email || '';
            const name = user.user_metadata?.full_name || email.split('@')[0] || 'U';
            return name.substring(0, 2).toUpperCase();
        }
        
        async function loadPulse() {
            try {
                console.log('Loading pulse:', pulseId);
                
                // Fetch pulse with user details
                const { data: pulse, error } = await supabaseClient
                    .from('pulses_with_user_details')
                    .select('*')
                    .eq('id', pulseId)
                    .single();
                
                if (error) {
                    console.error('Error fetching pulse:', error);
                    // Try alternative table
                    const { data: pulseAlt, error: errorAlt } = await supabaseClient
                        .from('pulses')
                        .select(`
                            *,
                            user_profiles (
                                id,
                                full_name,
                                username,
                                avatar_url,
                                role,
                                email
                            )
                        `)
                        .eq('id', pulseId)
                        .single();
                    
                    if (errorAlt) throw errorAlt;
                    
                    currentPulse = pulseAlt;
                    
                    // Extract creator info from user_profiles
                    pulseCreator = {
                        full_name: pulseAlt.user_profiles?.full_name || 'User',
                        username: pulseAlt.user_profiles?.username || 'user',
                        avatar_url: pulseAlt.user_profiles?.avatar_url,
                        role: pulseAlt.user_profiles?.role,
                        email: pulseAlt.user_profiles?.email,
                        id: pulseAlt.user_id
                    };
                } else {
                    currentPulse = pulse;
                    
                    // Get creator info
                    pulseCreator = {
                        full_name: pulse.full_name,
                        username: pulse.username,
                        avatar_url: pulse.avatar_url,
                        role: pulse.role,
                        email: pulse.email,
                        id: pulse.user_id
                    };
                }
                
                // Update UI
                document.getElementById('creator-name').textContent = pulseCreator.full_name || 'User';
                document.getElementById('creator-handle').innerHTML = `@${pulseCreator.username || 'user'} · <span id="pulse-time">${getTimeAgo(new Date(currentPulse.created_at))}</span>`;
                
                const creatorInitials = getInitials(pulseCreator.full_name || pulseCreator.email || 'User');
                document.getElementById('creator-initials').textContent = creatorInitials;
                
                // Set creator avatar
                const creatorAvatarImg = document.getElementById('creator-avatar-img');
                const creatorInitialsElement = document.getElementById('creator-initials');
                
                if (pulseCreator.avatar_url) {
                    creatorAvatarImg.src = pulseCreator.avatar_url;
                    creatorAvatarImg.style.display = 'block';
                    creatorInitialsElement.style.display = 'none';
                } else {
                    creatorAvatarImg.style.display = 'none';
                    creatorInitialsElement.style.display = 'flex';
                }
                
                // Show series label if part of a series
                if (currentPulse.series_id && currentPulse.series_order) {
                    document.getElementById('seriesLabel').style.display = 'inline-block';
                    document.getElementById('series-part').textContent = currentPulse.series_order;
                    
                    // Try to get total parts in series
                    try {
                        const { data: series } = await supabaseClient
                            .from('pulse_series')
                            .select('total_parts')
                            .eq('id', currentPulse.series_id)
                            .single();
                        
                        if (series?.total_parts) {
                            document.getElementById('series-total').textContent = series.total_parts;
                        } else {
                            document.getElementById('series-total').textContent = '?';
                        }
                    } catch (error) {
                        console.log('Could not fetch series details');
                        document.getElementById('series-total').textContent = '?';
                    }
                }
                
                // Set caption
                document.getElementById('caption-text').textContent = currentPulse.caption || '';
                
                // Set counts
                document.getElementById('comment-count').textContent = currentPulse.comments_count || 0;
                document.getElementById('like-count').textContent = currentPulse.likes_count || 0;
                document.getElementById('share-count').textContent = currentPulse.shares_count || 0;
                
                // Load media
                const mediaContainer = document.querySelector('.media-container');
                const mediaContent = document.getElementById('media-content');
                mediaContent.innerHTML = '';
                
                if (currentPulse.media_url && currentPulse.media_url.trim() !== '') {
                    mediaContainer.classList.add('has-media');
                    
                    if (currentPulse.media_type === 'video') {
                        videoElement = document.createElement('video');
                        videoElement.src = currentPulse.media_url;
                        videoElement.className = 'pulse-media';
                        videoElement.muted = false; // Start with sound on
                        videoElement.playsInline = true;
                        videoElement.preload = 'auto';
                        videoElement.autoplay = true; // Auto-play enabled
                        
                        // Video event listeners
                        videoElement.addEventListener('loadedmetadata', function() {
                            updateVideoTime();
                            document.getElementById('volumeSliderFilled').style.width = (volume * 100) + '%';
                        });
                        
                        videoElement.addEventListener('timeupdate', updateVideoTime);
                        videoElement.addEventListener('play', () => {
                            isPlaying = true;
                            document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-pause"></i>';
                        });
                        videoElement.addEventListener('pause', () => {
                            isPlaying = false;
                            document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-play"></i>';
                        });
                        videoElement.addEventListener('ended', () => {
                            isPlaying = false;
                            document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-play"></i>';
                        });
                        
                        mediaContent.appendChild(videoElement);
                        
                        // Start playing
                        videoElement.play().catch(e => {
                            console.log('Autoplay prevented:', e);
                            // Show play button if autoplay is blocked
                        });
                    } else {
                        const img = document.createElement('img');
                        img.src = currentPulse.media_url;
                        img.className = 'pulse-media';
                        img.alt = 'Pulse image';
                        mediaContent.appendChild(img);
                        document.querySelector('.video-controls-overlay').style.display = 'none';
                    }
                } else {
                    mediaContainer.classList.remove('has-media');
                }
                
                // Check if user liked this pulse
                await checkLikeStatus();
                
                // Check if user saved this pulse
                await checkSaveStatus();
                
                // Show delete button if user owns the pulse
                if (currentPulse.user_id === currentUserId) {
                    document.getElementById('deletePulseBtn').style.display = 'flex';
                    document.getElementById('addToSeries').style.display = 'flex';
                }
                
            } catch (error) {
                console.error('Error loading pulse:', error);
                showToast('Failed to load pulse', 'error');
            }
        }
        
        function updateVideoTime() {
            if (!videoElement) return;
            
            const current = videoElement.currentTime;
            const duration = videoElement.duration;
            
            // Update progress bar
            const progressPercent = (current / duration) * 100;
            document.getElementById('videoProgressFilled').style.width = progressPercent + '%';
            
            // Update time display
            const currentFormatted = formatTime(current);
            const durationFormatted = formatTime(duration);
            document.getElementById('currentTime').textContent = `${currentFormatted} / ${durationFormatted}`;
        }
        
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function getInitials(name) {
            if (!name) return 'U';
            return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        }
        
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + ' years ago';
            
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + ' months ago';
            
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + ' days ago';
            
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + ' hours ago';
            
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + ' minutes ago';
            
            return Math.floor(seconds) + ' seconds ago';
        }
        
        async function checkLikeStatus() {
            try {
                const { data, error } = await supabaseClient
                    .from('pulse_likes')
                    .select('id')
                    .eq('pulse_id', pulseId)
                    .eq('user_id', currentUserId)
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    throw error;
                }
                
                isLiked = !!data;
                updateLikeUI();
                
            } catch (error) {
                console.error('Error checking like status:', error);
            }
        }
        
        async function checkSaveStatus() {
            try {
                const { data, error } = await supabaseClient
                    .from('saved_pulses')
                    .select('id')
                    .eq('pulse_id', pulseId)
                    .eq('user_id', currentUserId)
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    throw error;
                }
                
                isSaved = !!data;
                updateSaveUI();
                
            } catch (error) {
                console.error('Error checking save status:', error);
            }
        }
        
        function updateLikeUI() {
            const likeBtn = document.getElementById('likeBtn');
            if (isLiked) {
                likeBtn.classList.add('liked');
            } else {
                likeBtn.classList.remove('liked');
            }
        }
        
        function updateSaveUI() {
            const saveBtn = document.getElementById('savePulseBtn');
            if (isSaved) {
                saveBtn.innerHTML = '<i class="fas fa-bookmark"></i> Unsave Pulse';
            } else {
                saveBtn.innerHTML = '<i class="far fa-bookmark"></i> Save Pulse';
            }
        }
        
        function initializeEventListeners() {
            // More options menu
            const moreBtn = document.getElementById('moreBtn');
            const moreMenu = document.getElementById('moreMenu');
            
            moreBtn.addEventListener('click', () => {
                moreMenu.classList.toggle('active');
            });
            
            // Close menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!moreBtn.contains(e.target) && !moreMenu.contains(e.target)) {
                    moreMenu.classList.remove('active');
                }
            });
            
            // Video controls
            const playPauseBtn = document.getElementById('playPauseBtn');
            const muteBtn = document.getElementById('muteBtn');
            const videoProgress = document.getElementById('videoProgress');
            const volumeSlider = document.getElementById('volumeSlider');
            
            if (playPauseBtn) {
                playPauseBtn.addEventListener('click', () => {
                    if (videoElement) {
                        if (isPlaying) {
                            videoElement.pause();
                        } else {
                            videoElement.play();
                        }
                    }
                });
            }
            
            if (muteBtn) {
                muteBtn.addEventListener('click', () => {
                    if (videoElement) {
                        videoElement.muted = !videoElement.muted;
                        isMuted = videoElement.muted;
                        muteBtn.innerHTML = isMuted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
                    }
                });
            }
            
            if (videoProgress && videoElement) {
                videoProgress.addEventListener('click', (e) => {
                    const rect = videoProgress.getBoundingClientRect();
                    const pos = (e.clientX - rect.left) / rect.width;
                    videoElement.currentTime = pos * videoElement.duration;
                });
            }
            
            if (volumeSlider && videoElement) {
                volumeSlider.addEventListener('click', (e) => {
                    const rect = volumeSlider.getBoundingClientRect();
                    const pos = (e.clientX - rect.left) / rect.width;
                    volume = Math.max(0, Math.min(1, pos));
                    videoElement.volume = volume;
                    document.getElementById('volumeSliderFilled').style.width = (volume * 100) + '%';
                });
            }
            
            // Media click to play/pause
            const mediaContainer = document.querySelector('.media-container');
            if (mediaContainer && videoElement) {
                mediaContainer.addEventListener('click', (e) => {
                    if (e.target === mediaContainer || e.target.classList.contains('video-controls-overlay')) {
                        if (isPlaying) {
                            videoElement.pause();
                        } else {
                            videoElement.play();
                        }
                    }
                });
            }
            
            // Like button
            const likeBtn = document.getElementById('likeBtn');
            likeBtn.addEventListener('click', handleLike);
            
            // Comment button (scroll to comment input)
            const commentBtn = document.getElementById('commentBtn');
            commentBtn.addEventListener('click', () => {
                document.getElementById('commentInput').focus();
            });
            
            // Share button
            const shareBtn = document.getElementById('shareBtn');
            shareBtn.addEventListener('click', openShareModal);
            
            // Save pulse button
            const savePulseBtn = document.getElementById('savePulseBtn');
            savePulseBtn.addEventListener('click', handleSave);
            
            // Report pulse button
            const reportPulseBtn = document.getElementById('reportPulseBtn');
            reportPulseBtn.addEventListener('click', handleReport);
            
            // Mute creator button
            const muteCreatorBtn = document.getElementById('muteCreatorBtn');
            muteCreatorBtn.addEventListener('click', handleMuteCreator);
            
            // Delete pulse button
            const deletePulseBtn = document.getElementById('deletePulseBtn');
            if (deletePulseBtn) {
                deletePulseBtn.addEventListener('click', handleDelete);
            }
            
            // Comment input
            const commentInput = document.getElementById('commentInput');
            const postCommentBtn = document.getElementById('postCommentBtn');
            
            commentInput.addEventListener('input', () => {
                postCommentBtn.disabled = commentInput.value.trim().length === 0;
            });
            
            commentInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!postCommentBtn.disabled) {
                        postComment();
                    }
                }
            });
            
            // Post comment button
            postCommentBtn.addEventListener('click', postComment);
            
            // Share modal
            const closeShareModal = document.getElementById('closeShareModal');
            closeShareModal.addEventListener('click', closeShareModalFunc);
            
            // Share options
            document.getElementById('copyLinkOption').addEventListener('click', copyLink);
            document.getElementById('shareWhatsApp').addEventListener('click', shareToWhatsApp);
            document.getElementById('shareTwitter').addEventListener('click', shareToTwitter);
            document.getElementById('shareInstagram').addEventListener('click', shareToInstagram);
            document.getElementById('shareInternal').addEventListener('click', shareInternal);
            document.getElementById('addToSeries').addEventListener('click', addToSeries);
            
            // Copy link button
            document.getElementById('copyLinkBtn').addEventListener('click', copyLink);
            
            // Close modal when clicking outside
            const shareModal = document.getElementById('shareModal');
            shareModal.addEventListener('click', (e) => {
                if (e.target === shareModal) {
                    closeShareModalFunc();
                }
            });
            
            // Edit comment modal
            const closeEditCommentModal = document.getElementById('closeEditCommentModal');
            const cancelEditComment = document.getElementById('cancelEditComment');
            const saveEditComment = document.getElementById('saveEditComment');
            
            closeEditCommentModal.addEventListener('click', closeEditCommentModalFunc);
            cancelEditComment.addEventListener('click', closeEditCommentModalFunc);
            saveEditComment.addEventListener('click', saveEditedComment);
            
            const editCommentModal = document.getElementById('editCommentModal');
            editCommentModal.addEventListener('click', (e) => {
                if (e.target === editCommentModal) {
                    closeEditCommentModalFunc();
                }
            });
            
            // Listen for auth changes
            supabaseClient.auth.onAuthStateChange((event, session) => {
                console.log('🔐 Auth state changed:', event);
                
                if (event === 'SIGNED_OUT') {
                    window.location.href = 'login.html';
                }
            });
        }
        
        async function handleLike() {
            try {
                if (isLiked) {
                    // Unlike
                    const { error } = await supabaseClient
                        .from('pulse_likes')
                        .delete()
                        .eq('pulse_id', pulseId)
                        .eq('user_id', currentUserId);
                    
                    if (error) throw error;
                    
                    isLiked = false;
                    
                    // Update pulse likes count
                    const currentCount = parseInt(document.getElementById('like-count').textContent) || 0;
                    document.getElementById('like-count').textContent = Math.max(0, currentCount - 1);
                    
                    showToast('Like removed', 'success');
                } else {
                    // Like
                    const { error } = await supabaseClient
                        .from('pulse_likes')
                        .insert({
                            pulse_id: pulseId,
                            user_id: currentUserId
                        });
                    
                    if (error) throw error;
                    
                    isLiked = true;
                    
                    // Update pulse likes count
                    const currentCount = parseInt(document.getElementById('like-count').textContent) || 0;
                    document.getElementById('like-count').textContent = currentCount + 1;
                    
                    showToast('Pulse liked!', 'success');
                }
                
                updateLikeUI();
                
            } catch (error) {
                console.error('Error handling like:', error);
                showToast('Failed to like pulse', 'error');
            }
        }
        
        async function handleSave() {
            try {
                if (isSaved) {
                    // Unsave
                    const { error } = await supabaseClient
                        .from('saved_pulses')
                        .delete()
                        .eq('pulse_id', pulseId)
                        .eq('user_id', currentUserId);
                    
                    if (error) throw error;
                    
                    isSaved = false;
                    showToast('Pulse removed from saved', 'success');
                } else {
                    // Save
                    const { error } = await supabaseClient
                        .from('saved_pulses')
                        .insert({
                            pulse_id: pulseId,
                            user_id: currentUserId
                        });
                    
                    if (error) throw error;
                    
                    isSaved = true;
                    showToast('Pulse saved!', 'success');
                }
                
                updateSaveUI();
                document.getElementById('moreMenu').classList.remove('active');
                
            } catch (error) {
                console.error('Error handling save:', error);
                showToast('Failed to save pulse', 'error');
            }
        }
        
        function handleReport() {
            showToast('Report submitted. Our team will review this pulse.', 'success');
            document.getElementById('moreMenu').classList.remove('active');
        }
        
        async function handleMuteCreator() {
            if (!pulseCreator) return;
            
            try {
                // Create muted_creators table if it doesn't exist
                // For now, we'll use localStorage as a fallback
                const mutedCreators = JSON.parse(localStorage.getItem('muted_creators') || '[]');
                if (!mutedCreators.includes(pulseCreator.id)) {
                    mutedCreators.push(pulseCreator.id);
                    localStorage.setItem('muted_creators', JSON.stringify(mutedCreators));
                }
                
                showToast(`You won't see pulses from @${pulseCreator.username} anymore`, 'success');
                document.getElementById('moreMenu').classList.remove('active');
                
            } catch (error) {
                console.error('Error muting creator:', error);
                showToast('Failed to mute creator', 'error');
            }
        }
        
        async function handleDelete() {
            if (!confirm('Are you sure you want to delete this pulse? This action cannot be undone.')) {
                return;
            }
            
            try {
                // Check if pulse is part of a series
                if (currentPulse.series_id) {
                    const { error: seriesError } = await supabaseClient
                        .from('pulses')
                        .update({ 
                            deleted_at: new Date().toISOString(),
                            series_id: null,
                            series_order: null
                        })
                        .eq('id', pulseId);
                    
                    if (seriesError) throw seriesError;
                } else {
                    const { error } = await supabaseClient
                        .from('pulses')
                        .update({ deleted_at: new Date().toISOString() })
                        .eq('id', pulseId);
                    
                    if (error) throw error;
                }
                
                showToast('Pulse deleted successfully', 'success');
                
                // Redirect to feed after delay
                setTimeout(() => {
                    window.location.href = 'pulse-feed.html';
                }, 1500);
                
            } catch (error) {
                console.error('Error deleting pulse:', error);
                showToast('Failed to delete pulse', 'error');
            }
        }
        
        async function loadComments() {
            try {
                console.log('Loading comments for pulse:', pulseId);
                
                // Get all comments for this pulse
                const { data: comments, error: commentsError } = await supabaseClient
                    .from('pulse_comments')
                    .select('*')
                    .eq('pulse_id', pulseId)
                    .eq('is_removed', false)
                    .order('created_at', { ascending: true });
                
                if (commentsError) {
                    console.error('Error loading comments:', commentsError);
                    throw commentsError;
                }
                
                const commentsThread = document.getElementById('commentsThread');
                
                if (!comments || comments.length === 0) {
                    commentsThread.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-comment-slash"></i>
                            </div>
                            <div class="empty-title">No replies yet</div>
                            <div class="empty-description">Be the first to respond</div>
                        </div>
                    `;
                    return;
                }
                
                // Get user profiles for all comment authors
                const userIds = [...new Set(comments.map(comment => comment.user_id))];
                
                let userProfiles = [];
                try {
                    const { data: profiles, error: profilesError } = await supabaseClient
                        .from('user_profiles')
                        .select('*')
                        .in('id', userIds);
                    
                    if (profilesError) {
                        console.error('Error loading user profiles:', profilesError);
                    } else {
                        userProfiles = profiles || [];
                    }
                } catch (profileError) {
                    console.error('Error loading user data:', profileError);
                }
                
                // Create a map of user_id to profile
                const userMap = {};
                userProfiles.forEach(profile => {
                    userMap[profile.id] = profile;
                });
                
                // Get comment likes for current user - USING pulse_comments_likes table
                const commentIds = comments.map(c => c.id);
                let userCommentLikes = [];
                
                try {
                    const { data: likes } = await supabaseClient
                        .from('pulse_comments_likes')  // Fixed: Changed to pulse_comments_likes
                        .select('comment_id')
                        .eq('user_id', currentUserId)
                        .in('comment_id', commentIds);
                    
                    userCommentLikes = likes || [];
                } catch (likeError) {
                    console.error('Error loading comment likes:', likeError);
                }
                
                const likedCommentIds = new Set(userCommentLikes.map(like => like.comment_id));
                
                // Display comments
                commentsThread.innerHTML = '';
                
                // Group comments by parent (for replies)
                const topLevelComments = comments.filter(c => !c.parent_comment_id);
                const replies = comments.filter(c => c.parent_comment_id);
                
                console.log('Top level comments:', topLevelComments.length, 'Replies:', replies.length);
                
                // Display top-level comments
                topLevelComments.forEach(comment => {
                    const commentReplies = replies.filter(r => r.parent_comment_id === comment.id);
                    displayComment(comment, commentReplies, userMap, likedCommentIds);
                });
                
            } catch (error) {
                console.error('Error loading comments:', error);
                const commentsThread = document.getElementById('commentsThread');
                commentsThread.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-title">Failed to load comments</div>
                        <div class="empty-description">Please try again later</div>
                    </div>
                `;
            }
        }
        
        function displayComment(comment, replies = [], userMap = {}, likedCommentIds = new Set()) {
            const commentsThread = document.getElementById('commentsThread');
            
            const commentItem = document.createElement('div');
            commentItem.className = 'comment-item';
            commentItem.dataset.commentId = comment.id;
            
            // Get user data
            const userProfile = userMap[comment.user_id] || {};
            const initials = getInitials(userProfile.full_name || userProfile.email || comment.user_id.substring(0, 2) || 'U');
            const avatarUrl = userProfile.avatar_url;
            const username = userProfile.username || 'user';
            const fullName = userProfile.full_name || 'User';
            const isCommentOwner = comment.user_id === currentUserId;
            const isLiked = likedCommentIds.has(comment.id);
            
            commentItem.innerHTML = `
                <div class="comment-header">
                    <div class="comment-avatar" onclick="viewUserProfile('${comment.user_id}')" style="${avatarUrl ? `background-image: url('${avatarUrl}'); background-size: cover; background-position: center;` : ''}">
                        ${avatarUrl ? '' : initials}
                    </div>
                    <div class="comment-meta">
                        <div class="comment-name" onclick="viewUserProfile('${comment.user_id}')">${fullName}</div>
                        <div class="comment-handle">@${username}</div>
                    </div>
                    <div class="comment-time">${getTimeAgo(new Date(comment.created_at))}${comment.is_edited ? ' (edited)' : ''}</div>
                </div>
                <div class="comment-text">${comment.comment_text || ''}</div>
                <div class="comment-actions">
                    <button class="comment-action like-comment-btn ${isLiked ? 'liked' : ''}" data-comment-id="${comment.id}">
                        <i class="fas fa-heart"></i> <span class="comment-like-count">${comment.likes_count || 0}</span>
                    </button>
                    <button class="comment-action reply-comment-btn" data-comment-id="${comment.id}">
                        <i class="fas fa-reply"></i> Reply
                    </button>
                </div>
            `;
            
            // Add edit/delete options for comment owner
            if (isCommentOwner) {
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'comment-options';
                optionsDiv.innerHTML = `
                    <button class="comment-options-btn" data-comment-id="${comment.id}">
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                    <div class="comment-options-menu" id="comment-options-${comment.id}">
                        <button class="comment-option-item edit-comment-btn" data-comment-id="${comment.id}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="comment-option-item delete delete-comment-btn" data-comment-id="${comment.id}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                commentItem.appendChild(optionsDiv);
            }
            
            // Add reply composer (hidden by default)
            const replyComposer = document.createElement('div');
            replyComposer.className = 'reply-composer';
            replyComposer.id = `reply-composer-${comment.id}`;
            replyComposer.innerHTML = `
                <textarea class="reply-input" placeholder="Reply to @${username}…" maxlength="300"></textarea>
                <button class="post-reply-btn" data-parent-id="${comment.id}">Reply</button>
            `;
            
            // Add replies if any
            if (replies.length > 0) {
                const replyThread = document.createElement('div');
                replyThread.className = 'reply-thread';
                
                replies.forEach(reply => {
                    const replyUserProfile = userMap[reply.user_id] || {};
                    const replyInitials = getInitials(replyUserProfile.full_name || replyUserProfile.email || reply.user_id.substring(0, 2) || 'U');
                    const replyAvatarUrl = replyUserProfile.avatar_url;
                    const replyUsername = replyUserProfile.username || 'user';
                    const replyFullName = replyUserProfile.full_name || 'User';
                    const isReplyOwner = reply.user_id === currentUserId;
                    const isReplyLiked = likedCommentIds.has(reply.id);
                    
                    const replyItem = document.createElement('div');
                    replyItem.className = 'comment-item';
                    replyItem.style.marginBottom = '8px';
                    replyItem.dataset.commentId = reply.id;
                    
                    replyItem.innerHTML = `
                        <div class="comment-header">
                            <div class="comment-avatar" onclick="viewUserProfile('${reply.user_id}')" style="${replyAvatarUrl ? `background-image: url('${replyAvatarUrl}'); background-size: cover; background-position: center;` : ''}">
                                ${replyAvatarUrl ? '' : replyInitials}
                            </div>
                            <div class="comment-meta">
                                <div class="comment-name" onclick="viewUserProfile('${reply.user_id}')">${replyFullName}</div>
                                <div class="comment-handle">@${replyUsername}</div>
                            </div>
                            <div class="comment-time">${getTimeAgo(new Date(reply.created_at))}${reply.is_edited ? ' (edited)' : ''}</div>
                        </div>
                        <div class="comment-text">${reply.comment_text || ''}</div>
                        <div class="comment-actions">
                            <button class="comment-action like-comment-btn ${isReplyLiked ? 'liked' : ''}" data-comment-id="${reply.id}">
                                <i class="fas fa-heart"></i> <span class="comment-like-count">${reply.likes_count || 0}</span>
                            </button>
                        </div>
                    `;
                    
                    // Add edit/delete options for reply owner
                    if (isReplyOwner) {
                        const replyOptionsDiv = document.createElement('div');
                        replyOptionsDiv.className = 'comment-options';
                        replyOptionsDiv.innerHTML = `
                            <button class="comment-options-btn" data-comment-id="${reply.id}">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <div class="comment-options-menu" id="comment-options-${reply.id}">
                                <button class="comment-option-item edit-comment-btn" data-comment-id="${reply.id}" data-is-reply="true">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="comment-option-item delete delete-comment-btn" data-comment-id="${reply.id}" data-is-reply="true">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        `;
                        replyItem.appendChild(replyOptionsDiv);
                    }
                    
                    replyThread.appendChild(replyItem);
                });
                
                commentItem.appendChild(replyThread);
            }
            
            commentItem.appendChild(replyComposer);
            commentsThread.appendChild(commentItem);
            
            // Add event listeners for this comment
            const likeBtn = commentItem.querySelector('.like-comment-btn');
            const replyBtn = commentItem.querySelector('.reply-comment-btn');
            const postReplyBtn = commentItem.querySelector('.post-reply-btn');
            const replyInput = commentItem.querySelector('.reply-input');
            
            likeBtn.addEventListener('click', () => likeComment(comment.id));
            replyBtn.addEventListener('click', () => {
                replyComposer.classList.toggle('active');
                if (replyComposer.classList.contains('active')) {
                    replyInput.focus();
                }
            });
            
            if (postReplyBtn) {
                postReplyBtn.addEventListener('click', () => postReply(comment.id, replyInput));
            }
            
            if (replyInput) {
                replyInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        postReply(comment.id, replyInput);
                    }
                });
            }
            
            // Add event listeners for edit/delete buttons
            if (isCommentOwner) {
                const optionsBtn = commentItem.querySelector('.comment-options-btn');
                const optionsMenu = commentItem.querySelector(`#comment-options-${comment.id}`);
                const editBtn = commentItem.querySelector('.edit-comment-btn');
                const deleteBtn = commentItem.querySelector('.delete-comment-btn');
                
                optionsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    optionsMenu.classList.toggle('active');
                });
                
                editBtn.addEventListener('click', () => editComment(comment.id, comment.comment_text, false));
                deleteBtn.addEventListener('click', () => deleteComment(comment.id, false));
                
                // Close menu when clicking outside
                document.addEventListener('click', (e) => {
                    if (!optionsBtn.contains(e.target) && !optionsMenu.contains(e.target)) {
                        optionsMenu.classList.remove('active');
                    }
                });
            }
            
            // Add event listeners for reply edit/delete buttons
            const replyEditButtons = commentItem.querySelectorAll('.edit-comment-btn[data-is-reply="true"]');
            const replyDeleteButtons = commentItem.querySelectorAll('.delete-comment-btn[data-is-reply="true"]');
            
            replyEditButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const replyId = e.target.closest('[data-comment-id]').dataset.commentId;
                    const replyText = e.target.closest('.comment-item').querySelector('.comment-text').textContent;
                    editComment(replyId, replyText, true);
                });
            });
            
            replyDeleteButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const replyId = e.target.closest('[data-comment-id]').dataset.commentId;
                    deleteComment(replyId, true);
                });
            });
            
            // Add event listeners for reply like buttons
            const replyLikeButtons = commentItem.querySelectorAll('.like-comment-btn[data-comment-id]');
            replyLikeButtons.forEach(btn => {
                if (!btn.hasAttribute('data-listener-added')) {
                    const replyId = btn.dataset.commentId;
                    btn.addEventListener('click', () => likeComment(replyId));
                    btn.setAttribute('data-listener-added', 'true');
                }
            });
        }
        
        async function postComment() {
            const commentInput = document.getElementById('commentInput');
            const commentText = commentInput.value.trim();
            
            if (!commentText) return;
            
            try {
                const { error } = await supabaseClient
                    .from('pulse_comments')
                    .insert({
                        pulse_id: pulseId,
                        user_id: currentUserId,
                        comment_text: commentText,
                        likes_count: 0,
                        is_removed: false
                    });
                
                if (error) throw error;
                
                // Clear input
                commentInput.value = '';
                document.getElementById('postCommentBtn').disabled = true;
                
                // Update comment count
                const currentCount = parseInt(document.getElementById('comment-count').textContent) || 0;
                document.getElementById('comment-count').textContent = currentCount + 1;
                
                // Reload comments
                loadComments();
                
                showToast('Comment posted!', 'success');
                
            } catch (error) {
                console.error('Error posting comment:', error);
                showToast('Failed to post comment', 'error');
            }
        }
        
        async function postReply(parentId, replyInput) {
            const replyText = replyInput.value.trim();
            
            if (!replyText) return;
            
            try {
                const { error } = await supabaseClient
                    .from('pulse_comments')
                    .insert({
                        pulse_id: pulseId,
                        user_id: currentUserId,
                        comment_text: replyText,
                        parent_comment_id: parentId,
                        likes_count: 0,
                        is_removed: false
                    });
                
                if (error) throw error;
                
                // Clear input and hide composer
                replyInput.value = '';
                document.getElementById(`reply-composer-${parentId}`).classList.remove('active');
                
                // Reload comments
                loadComments();
                
                showToast('Reply posted!', 'success');
                
            } catch (error) {
                console.error('Error posting reply:', error);
                showToast('Failed to post reply', 'error');
            }
        }
        
        async function likeComment(commentId) {
            try {
                console.log('Attempting to like comment:', commentId);
                
                // First, check if the user already liked this comment
                const { data: existingLike, error: checkError } = await supabaseClient
                    .from('pulse_comments_likes')  // Fixed: Changed to pulse_comments_likes
                    .select('id')
                    .eq('comment_id', commentId)
                    .eq('user_id', currentUserId)
                    .maybeSingle();
                
                if (checkError && checkError.code !== 'PGRST116') {
                    console.error('Error checking existing like:', checkError);
                    throw checkError;
                }
                
                const alreadyLiked = !!existingLike;
                console.log('Already liked:', alreadyLiked, 'Like data:', existingLike);
                
                if (alreadyLiked) {
                    // UNLIKE: Delete the like record
                    const { error: deleteError } = await supabaseClient
                        .from('pulse_comments_likes')  // Fixed: Changed to pulse_comments_likes
                        .delete()
                        .eq('id', existingLike.id);
                    
                    if (deleteError) {
                        console.error('Error deleting like:', deleteError);
                        throw deleteError;
                    }
                    
                    // Get current likes count safely
                    const { data: commentData } = await supabaseClient
                        .from('pulse_comments')
                        .select('likes_count')
                        .eq('id', commentId)
                        .single()
                        .catch(() => ({ data: { likes_count: 0 } }));
                    
                    const currentLikes = commentData?.likes_count || 0;
                    const newLikesCount = Math.max(0, currentLikes - 1);
                    
                    // Update comment likes count directly (not using RPC)
                    const { error: updateError } = await supabaseClient
                        .from('pulse_comments')
                        .update({ 
                            likes_count: newLikesCount,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', commentId);
                    
                    if (updateError) {
                        console.error('Error updating comment likes:', updateError);
                        // Don't throw, just update UI with our calculation
                    }
                    
                    // Update UI immediately
                    updateCommentLikeUI(commentId, newLikesCount, false);
                    showToast('Like removed', 'success');
                    
                } else {
                    // LIKE: Insert new like record
                    const { data: newLike, error: insertError } = await supabaseClient
                        .from('pulse_comments_likes')  // Fixed: Changed to pulse_comments_likes
                        .insert({
                            comment_id: commentId,
                            user_id: currentUserId,
                            created_at: new Date().toISOString()
                        })
                        .select()
                        .single();
                    
                    if (insertError) {
                        // Handle unique constraint violation (409 error)
                        if (insertError.code === '23505') {
                            console.log('Like already exists, fetching existing like...');
                            // Try to fetch the existing like
                            const { data: existing } = await supabaseClient
                                .from('pulse_comments_likes')  // Fixed: Changed to pulse_comments_likes
                                .select('id')
                                .eq('comment_id', commentId)
                                .eq('user_id', currentUserId)
                                .single();
                            
                            if (existing) {
                                // Update UI as liked
                                await updateCommentLikeCount(commentId, 1);
                                updateCommentLikeUI(commentId, null, true); // null will trigger fetch
                                showToast('Comment liked!', 'success');
                                return;
                            }
                        }
                        console.error('Error inserting like:', insertError);
                        throw insertError;
                    }
                    
                    // Update comment likes count
                    await updateCommentLikeCount(commentId, 1);
                    
                    // Update UI
                    updateCommentLikeUI(commentId, null, true); // null will trigger fetch
                    showToast('Comment liked!', 'success');
                }
                
            } catch (error) {
                console.error('Error in likeComment:', error);
                
                // Fallback: Update UI based on current state
                const likeBtn = document.querySelector(`[data-comment-id="${commentId}"] .like-comment-btn`);
                if (likeBtn) {
                    const wasLiked = likeBtn.classList.contains('liked');
                    const likeCountElement = likeBtn.querySelector('.comment-like-count');
                    const currentCount = parseInt(likeCountElement.textContent) || 0;
                    
                    if (wasLiked) {
                        // Was liked, now unliking
                        likeCountElement.textContent = Math.max(0, currentCount - 1);
                        likeBtn.classList.remove('liked');
                    } else {
                        // Was not liked, now liking
                        likeCountElement.textContent = currentCount + 1;
                        likeBtn.classList.add('liked');
                    }
                }
                
                showToast('Failed to update like. Please refresh.', 'error');
            }
        }
        
        async function updateCommentLikeCount(commentId, change) {
            try {
                // Get current count
                const { data: comment } = await supabaseClient
                    .from('pulse_comments')
                    .select('likes_count')
                    .eq('id', commentId)
                    .single();
                
                const currentLikes = comment?.likes_count || 0;
                const newLikesCount = Math.max(0, currentLikes + change);
                
                // Update directly
                const { error } = await supabaseClient
                    .from('pulse_comments')
                    .update({ 
                        likes_count: newLikesCount,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', commentId);
                
                if (error) throw error;
                
                return newLikesCount;
                
            } catch (error) {
                console.error('Error updating comment like count:', error);
                throw error;
            }
        }
        
        async function updateCommentLikeUI(commentId, likesCount = null, isLiked = null) {
            const likeBtn = document.querySelector(`[data-comment-id="${commentId}"] .like-comment-btn`);
            if (!likeBtn) return;
            
            // If likesCount is not provided, fetch it
            if (likesCount === null) {
                try {
                    const { data: comment } = await supabaseClient
                        .from('pulse_comments')
                        .select('likes_count')
                        .eq('id', commentId)
                        .single();
                    
                    likesCount = comment?.likes_count || 0;
                } catch (error) {
                    console.error('Error fetching comment likes count:', error);
                    const likeCountElement = likeBtn.querySelector('.comment-like-count');
                    likesCount = parseInt(likeCountElement.textContent) || 0;
                }
            }
            
            // If isLiked is not provided, check current state
            if (isLiked === null) {
                isLiked = likeBtn.classList.contains('liked');
            }
            
            // Update UI
            const likeCountElement = likeBtn.querySelector('.comment-like-count');
            if (likeCountElement) {
                likeCountElement.textContent = likesCount;
            }
            
            if (isLiked) {
                likeBtn.classList.add('liked');
            } else {
                likeBtn.classList.remove('liked');
            }
        }
        
        function editComment(commentId, currentText, isReply = false) {
            editingCommentId = commentId;
            editingReplyId = isReply ? commentId : null;
            document.getElementById('editCommentInput').value = currentText;
            document.getElementById('editCommentModal').style.display = 'flex';
        }
        
        async function saveEditedComment() {
            if (!editingCommentId) return;
            
            const newText = document.getElementById('editCommentInput').value.trim();
            
            if (!newText) {
                showToast('Comment cannot be empty', 'error');
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('pulse_comments')
                    .update({
                        comment_text: newText,
                        is_edited: true,
                        edited_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', editingCommentId);
                
                if (error) throw error;
                
                closeEditCommentModalFunc();
                loadComments(); // Reload to show updated text and "edited" badge
                showToast(editingReplyId ? 'Reply updated' : 'Comment updated', 'success');
                
            } catch (error) {
                console.error('Error updating comment:', error);
                showToast('Failed to update comment', 'error');
            }
        }
        
        async function deleteComment(commentId, isReply = false) {
            if (!confirm(`Are you sure you want to delete this ${isReply ? 'reply' : 'comment'}?`)) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('pulse_comments')
                    .update({
                        is_removed: true,
                        removed_reason: 'User deleted',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', commentId);
                
                if (error) throw error;
                
                loadComments();
                showToast(`${isReply ? 'Reply' : 'Comment'} deleted`, 'success');
                
            } catch (error) {
                console.error('Error deleting comment:', error);
                showToast(`Failed to delete ${isReply ? 'reply' : 'comment'}`, 'error');
            }
        }
        
        function closeEditCommentModalFunc() {
            editingCommentId = null;
            editingReplyId = null;
            document.getElementById('editCommentModal').style.display = 'none';
            document.getElementById('editCommentInput').value = '';
        }
        
        function openShareModal() {
            // Set the share link
            const shareLink = document.getElementById('shareLink');
            shareLink.value = `${window.location.origin}/pulse-content-detail.html?id=${pulseId}`;
            
            document.getElementById('shareModal').style.display = 'flex';
        }
        
        function closeShareModalFunc() {
            document.getElementById('shareModal').style.display = 'none';
        }
        
        function copyLink() {
            const shareLink = document.getElementById('shareLink');
            shareLink.select();
            document.execCommand('copy');
            
            showToast('Pulse link copied', 'success');
            closeShareModalFunc();
        }
        
        function shareToWhatsApp() {
            const text = `Check out this pulse on Bantu Connect Pulse!`;
            const url = `${window.location.origin}/pulse-content-detail.html?id=${pulseId}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`, '_blank');
            closeShareModalFunc();
        }
        
        function shareToTwitter() {
            const text = `Check out this pulse on Bantu Connect Pulse!`;
            const url = `${window.location.origin}/pulse-content-detail.html?id=${pulseId}`;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
            closeShareModalFunc();
        }
        
        function shareToInstagram() {
            showToast('Share to Instagram coming soon!', 'success');
            closeShareModalFunc();
        }
        
        async function shareInternal() {
            try {
                const { error } = await supabaseClient
                    .from('pulse_shares')
                    .insert({
                        pulse_id: pulseId,
                        user_id: currentUserId,
                        share_type: 'internal',
                        share_platform: 'internal'
                    });
                
                if (error) throw error;
                
                // Update share count
                const currentCount = parseInt(document.getElementById('share-count').textContent) || 0;
                document.getElementById('share-count').textContent = currentCount + 1;
                
                showToast('Pulse shared internally!', 'success');
                closeShareModalFunc();
                
            } catch (error) {
                console.error('Error sharing internally:', error);
                showToast('Failed to share pulse', 'error');
            }
        }
        
        function addToSeries() {
            showToast('Add to Series feature coming soon!', 'success');
            closeShareModalFunc();
        }
        
        function viewCreatorProfile() {
            if (pulseCreator) {
                window.location.href = `profile.html?user_id=${pulseCreator.id}`;
            }
        }
        
        function viewUserProfile(userId) {
            window.location.href = `profile.html?user_id=${userId}`;
        }
        
        function showToast(message, type = 'error') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            const container = document.getElementById('toast-container');
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // Start initialization
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
