<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulse Detail - BANTU CONNECT Pulse</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Color Theme - Same as pulse-feed.html */
        :root {
            --deep-black: #0A0E12;
            --deep-navy: #0F172A;
            --soft-white: #F8FAFC;
            --slate-grey: #94A3B8;
            --bantu-blue: #1D4ED8;
            --warm-gold: #F59E0B;
            --error-color: #EF4444;
            --success-color: #10B981;
            --glow-cycle-1: #00A3FF;
            --glow-cycle-2: #0066FF;
            --glow-cycle-3: #8B5CF6;
            --glow-cycle-4: #EC4899;
            --card-bg: rgba(15, 23, 42, 0.6);
            --card-border: rgba(148, 163, 184, 0.2);
            --hover-overlay: rgba(255, 255, 255, 0.05);
            --active-overlay: rgba(245, 158, 11, 0.1);
            --indigo: #4F46E5;
            --gold-glow: rgba(245, 158, 11, 0.3);
            --blue-glow: rgba(29, 78, 216, 0.3);
            --glass-bg: rgba(15, 23, 42, 0.8);
            --glass-border: rgba(148, 163, 184, 0.1);
            --tap-color: #10B981;
            --comment-color: #3B82F6;
            --repulse-color: #F59E0B;
            --save-color: #EC4899;
            --glowing-blue: #00A3FF;
            --glowing-gold: #FFB300;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--deep-black);
            color: var(--soft-white);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--deep-black);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--bantu-blue);
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Animated Background */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            overflow: hidden;
        }
        
        .glow-cycle {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.1;
            animation: float 8s infinite ease-in-out;
        }
        
        .glow-1 {
            width: 400px;
            height: 400px;
            background: var(--glow-cycle-1);
            top: 10%;
            left: 5%;
            animation-delay: 0s;
        }
        
        .glow-2 {
            width: 300px;
            height: 300px;
            background: var(--glow-cycle-2);
            top: 60%;
            right: 10%;
            animation-delay: 2s;
        }
        
        .glow-3 {
            width: 350px;
            height: 350px;
            background: var(--glow-cycle-3);
            bottom: 10%;
            left: 20%;
            animation-delay: 4s;
        }
        
        .glow-4 {
            width: 250px;
            height: 250px;
            background: var(--glow-cycle-4);
            top: 20%;
            right: 20%;
            animation-delay: 6s;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-20px) scale(1.05); }
        }
        
        /* Main Container */
        .container {
            max-width: 720px;
            margin: 0 auto;
            padding: 24px;
            position: relative;
            z-index: 2;
            padding-bottom: 120px;
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            margin-bottom: 24px;
            position: sticky;
            top: 0;
            background-color: rgba(10, 14, 18, 0.9);
            backdrop-filter: blur(20px);
            z-index: 100;
            border-bottom: 1px solid var(--card-border);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 32px rgba(29, 78, 216, 0.3);
            overflow: hidden;
            background: transparent;
        }
        
        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .logo-text {
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 16px;
            background: linear-gradient(to right, var(--soft-white), var(--bantu-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: 0.5px;
        }
        
        .user-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        /* NEW: Notification Button with Dot */
        .notification-btn {
            background: none;
            border: none;
            color: var(--slate-grey);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .notification-btn:hover {
            color: var(--soft-white);
            background: var(--hover-overlay);
        }
        
        .notification-btn.has-unread::after {
            content: '';
            position: absolute;
            top: 6px;
            right: 6px;
            width: 8px;
            height: 8px;
            background: var(--warm-gold);
            border-radius: 50%;
            display: block;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);
            animation: pulse-gold 2s infinite;
        }
        
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--soft-white);
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            display: none;
        }
        
        /* NEW: Pulse Post Container - Glassmorphism with Gold Glow */
        .pulse-post-container {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 0;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .pulse-post-container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--warm-gold), var(--bantu-blue), var(--warm-gold));
            border-radius: 26px;
            z-index: -1;
            opacity: 0.3;
            animation: pulse-glow 2s infinite alternate;
        }
        
        @keyframes pulse-glow {
            0% { opacity: 0.2; }
            100% { opacity: 0.4; }
        }
        
        /* NEW: Pulse Header with Connect Button */
        .pulse-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 20px 0 20px;
        }
        
        .creator-info {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            flex: 1;
        }
        
        .creator-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 600;
            color: var(--soft-white);
            font-size: 16px;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .creator-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        .creator-meta h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--soft-white);
            margin-bottom: 2px;
            cursor: pointer;
        }
        
        .creator-meta p {
            font-size: 14px;
            color: var(--slate-grey);
        }
        
        /* NEW: Connect Button */
        .pulse-connect-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--warm-gold);
            color: var(--warm-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 8px;
            font-size: 14px;
            position: relative;
            z-index: 10;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.2);
            outline: none;
            flex-shrink: 0;
        }
        
        .pulse-connect-btn:hover,
        .pulse-connect-btn:focus {
            background: rgba(245, 158, 11, 0.1);
            transform: scale(1.1);
            box-shadow: 0 0 25px rgba(245, 158, 11, 0.4);
        }
        
        .pulse-connect-btn.connected {
            border-color: var(--success-color);
            color: var(--success-color);
            background: rgba(16, 185, 129, 0.1);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.2);
        }
        
        .pulse-connect-btn.connecting {
            animation: connectPulse 0.6s ease;
            border-color: var(--bantu-blue);
            color: var(--bantu-blue);
        }
        
        @keyframes connectPulse {
            0% {
                transform: scale(1);
                border-color: var(--warm-gold);
                color: var(--warm-gold);
            }
            33% {
                transform: scale(1.2);
                border-color: var(--bantu-blue);
                color: var(--bantu-blue);
            }
            66% {
                transform: scale(1.1);
                border-color: var(--bantu-blue);
                color: var(--bantu-blue);
            }
            100% {
                transform: scale(1);
                border-color: var(--success-color);
                color: var(--success-color);
            }
        }
        
        .more-options {
            position: relative;
            flex-shrink: 0;
        }
        
        .more-btn {
            background: none;
            border: none;
            color: var(--slate-grey);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .more-btn:hover {
            color: var(--soft-white);
            background: var(--hover-overlay);
        }
        
        .more-menu {
            position: absolute;
            top: 40px;
            right: 0;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            width: 200px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
            backdrop-filter: blur(20px);
        }
        
        .more-menu.active {
            display: block;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            color: var(--soft-white);
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .menu-item:hover {
            background: var(--hover-overlay);
        }
        
        .menu-item.delete {
            color: var(--error-color);
            border-top: 1px solid var(--glass-border);
        }
        
        /* NEW: Series Label */
        .series-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--warm-gold);
            margin: 16px 20px 0;
            cursor: pointer;
            display: inline-block;
            padding: 4px 12px;
            background: rgba(245, 158, 11, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .series-label:hover {
            background: rgba(245, 158, 11, 0.2);
        }
        
        /* Media Container - Updated Video Player */
        .media-container {
            width: 100%;
            aspect-ratio: 9/16;
            background: black;
            border-radius: 0;
            overflow: hidden;
            margin: 16px 0;
            position: relative;
            display: none;
        }
        
        .media-container.has-media {
            display: block;
        }
        
        .pulse-media {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        /* Custom Video Controls - Glassmorphism */
        .video-controls-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .media-container:hover .video-controls-overlay {
            opacity: 1;
        }
        
        .video-progress {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            margin-bottom: 15px;
            position: relative;
            cursor: pointer;
        }
        
        .video-progress-filled {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: var(--warm-gold);
            border-radius: 2px;
            width: 0%;
        }
        
        .video-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .video-left-controls,
        .video-right-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .video-control-btn {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--warm-gold);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        .video-control-btn:hover {
            background: rgba(245, 158, 11, 0.2);
            transform: scale(1.1);
        }
        
        .video-time {
            color: var(--warm-gold);
            font-size: 14px;
            font-weight: 500;
            min-width: 100px;
            text-align: center;
        }
        
        .video-volume {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .volume-slider {
            width: 80px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }
        
        .volume-slider-filled {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: var(--warm-gold);
            border-radius: 2px;
            width: 50%;
        }
        
        /* NEW: Re-Pulse Context Section */
        .repulse-context {
            background: rgba(245, 158, 11, 0.1);
            border-left: 3px solid var(--warm-gold);
            padding: 12px 16px;
            margin: 0 20px 16px;
            border-radius: 0 8px 8px 0;
            font-style: italic;
            color: var(--warm-gold);
            font-size: 14px;
        }
        
        .repulse-context-user {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--soft-white);
        }
        
        .repulse-hidden-contexts {
            display: none;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .repulse-hidden-contexts.expanded {
            display: block;
        }
        
        .repulse-expand-toggle {
            background: none;
            border: none;
            color: var(--warm-gold);
            font-size: 12px;
            cursor: pointer;
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .repulse-expand-toggle:hover {
            background: rgba(245, 158, 11, 0.1);
        }
        
        /* NEW: Mention styling */
        .mention {
            color: var(--bantu-blue);
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .mention:hover {
            color: var(--warm-gold);
            text-decoration: underline;
        }
        
        /* NEW: Narrative Block */
        .narrative-block {
            padding: 0 20px 16px;
        }
        
        .caption-text {
            font-size: 16px;
            line-height: 1.6;
            color: var(--soft-white);
            white-space: pre-line;
        }
        
        /* NEW: Updated Action Bar for BANTU CONNECT */
        .pulse-actions {
            display: flex;
            padding: 12px 20px;
            border-top: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
            gap: 8px;
        }
        
        .action-button {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: var(--slate-grey);
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            outline: none;
            min-height: 44px;
            position: relative;
        }
        
        .action-button:hover,
        .action-button:focus {
            color: var(--soft-white);
            background-color: var(--hover-overlay);
            border-color: var(--bantu-blue);
        }
        
        .action-button:focus-visible {
            box-shadow: 0 0 0 3px rgba(29, 78, 216, 0.3);
        }
        
        /* Tap Button */
        .tap-btn {
            position: relative;
        }
        
        .tap-btn.tapped {
            color: var(--tap-color);
            border-color: rgba(16, 185, 129, 0.3);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .tap-btn.tapped .tap-icon {
            animation: tapPulse 0.5s ease;
        }
        
        @keyframes tapPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        /* Save Button */
        .save-btn.saved {
            color: var(--save-color);
            border-color: rgba(236, 72, 153, 0.3);
            background: rgba(236, 72, 153, 0.1);
        }
        
        /* Re-Pulse Button */
        .repulse-btn.repulsed {
            color: var(--repulse-color);
            border-color: rgba(245, 158, 11, 0.3);
            background: rgba(245, 158, 11, 0.1);
        }
        
        /* NEW: Pulse Stats */
        .pulse-stats {
            display: flex;
            padding: 0 20px 16px;
            gap: 16px;
            font-size: 12px;
            color: var(--slate-grey);
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* NEW: Reaction Menu for Long Press */
        .reaction-menu {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 12px;
            display: none;
            gap: 12px;
            z-index: 1001;
            min-width: 150px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            animation: slideUp 0.3s ease;
        }
        
        .reaction-menu.active {
            display: flex;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        .reaction-option {
            padding: 12px 16px;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.05);
            color: var(--soft-white);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 60px;
            font-size: 14px;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        .reaction-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .reaction-option.awe {
            border-color: var(--glowing-blue);
            background: rgba(0, 149, 255, 0.1);
        }
        
        .reaction-option.awe:hover {
            background: rgba(0, 149, 255, 0.2);
        }
        
        .reaction-option.banger {
            border-color: var(--glowing-gold);
            background: rgba(255, 179, 0, 0.1);
        }
        
        .reaction-option.banger:hover {
            background: rgba(255, 179, 0, 0.2);
        }
        
        /* Lightning Animation for Awe */
        @keyframes lightningGlow {
            0% {
                text-shadow: 0 0 5px var(--glowing-blue),
                             0 0 10px var(--glowing-blue),
                             0 0 15px var(--glowing-blue);
                transform: scale(1);
            }
            50% {
                text-shadow: 0 0 20px var(--glowing-blue),
                             0 0 30px var(--glowing-blue),
                             0 0 40px var(--glowing-blue);
                transform: scale(1.2);
            }
            100% {
                text-shadow: 0 0 5px var(--glowing-blue),
                             0 0 10px var(--glowing-blue),
                             0 0 15px var(--glowing-blue);
                transform: scale(1);
            }
        }
        
        /* Flame Animation for Banger */
        @keyframes flameGlow {
            0% {
                text-shadow: 0 0 5px var(--glowing-gold),
                             0 0 10px var(--glowing-gold),
                             0 0 15px var(--glowing-gold);
                transform: scale(1);
            }
            50% {
                text-shadow: 0 0 20px var(--glowing-gold),
                             0 0 30px var(--glowing-gold),
                             0 0 40px var(--glowing-gold);
                transform: scale(1.2);
            }
            100% {
                text-shadow: 0 0 5px var(--glowing-gold),
                             0 0 10px var(--glowing-gold),
                             0 0 15px var(--glowing-gold);
                transform: scale(1);
            }
        }
        
        .reaction-option.awe.active i {
            animation: lightningGlow 0.6s ease;
        }
        
        .reaction-option.banger.active i {
            animation: flameGlow 0.6s ease;
        }
        
        .reaction-icon {
            font-size: 16px;
        }
        
        /* Comments Section Container */
        .comments-section-container {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 24px;
            margin-top: 32px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .comments-section {
            margin-top: 0;
        }
        
        .comments-header {
            margin-bottom: 24px;
        }
        
        .comments-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--soft-white);
            margin-bottom: 4px;
        }
        
        .comments-subtitle {
            font-size: 14px;
            color: var(--slate-grey);
        }
        
        /* NEW: Comment Composer with Mention Support */
        .comment-composer {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 32px;
            padding: 16px;
            background: rgba(10, 14, 18, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
        }
        
        .composer-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--soft-white);
            font-size: 12px;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }
        
        .composer-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            display: none;
        }
        
        .composer-input-container {
            flex: 1;
            position: relative;
        }
        
        .composer-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(10, 14, 18, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--soft-white);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            resize: none;
            min-height: 44px;
            transition: border-color 0.3s ease;
        }
        
        .composer-input:focus {
            outline: none;
            border-color: var(--warm-gold);
        }
        
        .composer-input::placeholder {
            color: var(--slate-grey);
        }
        
        /* NEW: Mention counter */
        .mention-counter {
            font-size: 12px;
            color: var(--slate-grey);
            margin-top: 4px;
            text-align: right;
        }
        
        .mention-counter.warning {
            color: var(--warm-gold);
        }
        
        .mention-counter.error {
            color: var(--error-color);
        }
        
        /* NEW: Autocomplete dropdown for mentions */
        .mention-autocomplete {
            position: absolute;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 2000;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            display: none;
            width: 100%;
        }
        
        .mention-suggestion {
            padding: 10px 15px;
            border-bottom: 1px solid var(--glass-border);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .mention-suggestion:hover,
        .mention-suggestion.selected {
            background: var(--hover-overlay);
        }
        
        .mention-suggestion-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--soft-white);
            flex-shrink: 0;
        }
        
        .mention-suggestion-username {
            font-weight: 600;
            color: var(--soft-white);
        }
        
        .mention-suggestion-name {
            color: var(--slate-grey);
            font-size: 12px;
        }
        
        .post-comment-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
            border: none;
            border-radius: 12px;
            color: var(--soft-white);
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .post-comment-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(29, 78, 216, 0.3);
        }
        
        .post-comment-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Comments Thread */
        .comments-thread {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .comment-item {
            padding: 16px;
            background: rgba(10, 14, 18, 0.4);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            position: relative;
        }
        
        .comment-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--soft-white);
            font-size: 10px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .comment-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .comment-meta {
            flex: 1;
        }
        
        .comment-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--soft-white);
            margin-bottom: 2px;
            cursor: pointer;
        }
        
        .comment-handle {
            font-size: 12px;
            color: var(--slate-grey);
        }
        
        .comment-time {
            font-size: 11px;
            color: var(--slate-grey);
        }
        
        .comment-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--soft-white);
            margin-bottom: 12px;
            white-space: pre-line;
        }
        
        .comment-actions {
            display: flex;
            gap: 16px;
        }
        
        .comment-action {
            display: flex;
            align-items: center;
            gap: 4px;
            background: none;
            border: none;
            color: var(--slate-grey);
            font-size: 12px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .comment-action:hover {
            color: var(--soft-white);
            background: var(--hover-overlay);
        }
        
        .comment-action.liked {
            color: var(--warm-gold);
        }
        
        /* Comment Edit/Delete Options */
        .comment-options {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        
        .comment-options-btn {
            background: none;
            border: none;
            color: var(--slate-grey);
            font-size: 14px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .comment-options-btn:hover {
            color: var(--soft-white);
            background: var(--hover-overlay);
        }
        
        .comment-options-menu {
            position: absolute;
            top: 25px;
            right: 0;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            width: 120px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 100;
            overflow: hidden;
        }
        
        .comment-options-menu.active {
            display: block;
        }
        
        .comment-option-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            color: var(--soft-white);
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .comment-option-item:hover {
            background: var(--hover-overlay);
        }
        
        .comment-option-item.delete {
            color: var(--error-color);
            border-top: 1px solid var(--glass-border);
        }
        
        /* Reply Thread */
        .reply-thread {
            margin-left: 16px;
            padding-left: 16px;
            border-left: 1px solid rgba(148, 163, 184, 0.1);
            margin-top: 12px;
        }
        
        .reply-composer {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding: 8px;
            background: rgba(10, 14, 18, 0.3);
            border-radius: 12px;
            display: none;
        }
        
        .reply-composer.active {
            display: flex;
        }
        
        .reply-input {
            flex: 1;
            padding: 8px 12px;
            background: transparent;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--soft-white);
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            resize: none;
            min-height: 36px;
        }
        
        .reply-input:focus {
            outline: none;
            border-color: var(--warm-gold);
        }
        
        .reply-input::placeholder {
            color: var(--slate-grey);
            font-size: 13px;
        }
        
        .post-reply-btn {
            padding: 6px 12px;
            background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
            border: none;
            border-radius: 8px;
            color: var(--soft-white);
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--slate-grey);
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--soft-white);
            margin-bottom: 8px;
        }
        
        .empty-description {
            font-size: 14px;
            max-width: 300px;
            margin: 0 auto;
            line-height: 1.4;
        }
        
        /* NEW: Re-Pulse Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        
        .share-modal {
            background: var(--deep-navy);
            border-radius: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--card-border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .repulse-modal {
            background: var(--glass-bg);
            border-radius: 16px;
            padding: 24px;
            min-width: 300px;
            max-width: 400px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
        }
        
        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .repulse-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--soft-white);
        }
        
        .repulse-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--soft-white);
        }
        
        .close-modal {
            background: none;
            border: none;
            color: var(--slate-grey);
            font-size: 24px;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .repulse-modal-close {
            background: none;
            border: none;
            color: var(--slate-grey);
            font-size: 18px;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .repulse-context-input {
            width: 100%;
            padding: 12px;
            background: rgba(10, 14, 18, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--soft-white);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 16px;
        }
        
        .repulse-context-input:focus {
            outline: none;
            border-color: var(--repulse-color);
        }
        
        .repulse-modal-actions {
            display: flex;
            gap: 12px;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .modal-btn-cancel {
            background: var(--glass-bg);
            color: var(--slate-grey);
            border: 1px solid var(--glass-border);
        }
        
        .modal-btn-cancel:hover {
            background: var(--hover-overlay);
            color: var(--soft-white);
        }
        
        .modal-btn-post {
            background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
            color: var(--soft-white);
            margin-left: 10px;
        }
        
        .modal-btn-post:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(29, 78, 216, 0.3);
        }
        
        .modal-repulse-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--repulse-color);
            background: rgba(245, 158, 11, 0.1);
            color: var(--repulse-color);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .modal-repulse-btn:hover {
            background: var(--repulse-color);
            color: white;
        }
        
        .modal-repulse-btn.soft {
            border-color: var(--slate-grey);
            background: rgba(255, 255, 255, 0.05);
            color: var(--slate-grey);
        }
        
        .modal-repulse-btn.soft:hover {
            border-color: var(--repulse-color);
            background: rgba(245, 158, 11, 0.2);
            color: var(--repulse-color);
        }
        
        .modal-footer {
            padding: 20px 0 0;
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: flex-end;
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
        }
        
        .toast {
            background: var(--error-color);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideUp 0.3s ease;
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
            max-width: 90vw;
        }
        
        .toast.success {
            background: var(--success-color);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }
        
        @keyframes slideUp {
            from {
                transform: translate(-50%, 100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--deep-black);
            border-top: 1px solid var(--glass-border);
            display: flex;
            padding: 12px 0;
            z-index: 100;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            background: none;
            border: none;
            color: var(--slate-grey);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .nav-item:hover {
            color: var(--soft-white);
        }
        
        .nav-item.active {
            color: var(--bantu-blue);
        }
        
        .nav-icon {
            font-size: 20px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
                max-width: 100%;
                padding-bottom: 100px;
            }
            
            .media-container.has-media {
                border-radius: 0;
                margin-left: -16px;
                margin-right: -16px;
                width: calc(100% + 32px);
            }
            
            .comment-composer {
                flex-direction: column;
            }
            
            .post-comment-btn {
                align-self: flex-end;
            }
            
            .share-modal {
                width: 95%;
            }
            
            .pulse-post-container {
                border-radius: 16px;
            }
            
            .more-menu {
                width: 180px;
                max-height: 250px;
            }
            
            .pulse-actions {
                gap: 4px;
            }
            
            .action-button {
                font-size: 12px;
                padding: 8px 4px;
            }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--deep-navy);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--bantu-blue);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--warm-gold);
        }
        
        /* Avatar images */
        .comment-avatar img,
        .creator-avatar img,
        .user-avatar img,
        .composer-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading" class="loading-screen">
        <div class="spinner"></div>
        <div id="loading-text">Loading Pulse...</div>
    </div>

    <!-- Animated Background -->
    <div class="animated-bg">
        <div class="glow-cycle glow-1"></div>
        <div class="glow-cycle glow-2"></div>
        <div class="glow-cycle glow-3"></div>
        <div class="glow-cycle glow-4"></div>
    </div>

    <!-- Main Container -->
    <div class="container" id="content" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="logo-container" onclick="window.location.href='pulse-feed.html'">
                <div class="logo-icon">
                    <svg width="32" height="32" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="40" height="40" rx="8" fill="#0F172A"/>
                        <path d="M8 20 L12 16 L16 22 L20 18 L24 24 L28 20 L32 26" stroke="url(#pulse-gradient)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="32" cy="26" r="3" fill="#F59E0B"/>
                        <defs>
                            <linearGradient id="pulse-gradient" x1="8" y1="20" x2="32" y2="26" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#1D4ED8"/>
                                <stop offset="1" stop-color="#F59E0B"/>
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <div class="logo-text">BANTU CONNECT PULSE</div>
            </div>
            
            <div class="user-section">
                <!-- NEW: Notification Button -->
                <button class="notification-btn" id="notificationBtn" onclick="window.location.href='notifications.html'" aria-label="Notifications">
                    <i class="far fa-bell"></i>
                </button>
                <div class="user-avatar" id="user-avatar" onclick="window.location.href='profile.html'">
                    <img id="user-avatar-img">
                    <span id="avatar-initials">AB</span>
                </div>
            </div>
        </header>
        
        <!-- Pulse Post Container -->
        <div class="pulse-post-container">
            <!-- Pulse Header -->
            <div class="pulse-header">
                <div class="creator-info" onclick="viewCreatorProfile()">
                    <div class="creator-avatar" id="creator-avatar">
                        <img id="creator-avatar-img">
                        <span id="creator-initials">AB</span>
                    </div>
                    <div class="creator-meta">
                        <h3 id="creator-name">Alex Bantu</h3>
                        <p id="creator-handle">@alexbantu  <span id="pulse-time">2 hours ago</span></p>
                    </div>
                </div>
                
                <!-- NEW: Connect Button -->
                <button class="pulse-connect-btn" id="connectBtn" aria-label="Connect with creator">
                    <i class="fas fa-user-plus" aria-hidden="true"></i>
                </button>
                
                <div class="more-options">
                    <button class="more-btn" id="moreBtn">
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                    <div class="more-menu" id="moreMenu">
                        <button class="menu-item" id="savePulseBtn">
                            <i class="far fa-bookmark"></i>
                            Save Pulse
                        </button>
                        <!-- UPDATED: Continue Series Button - Now properly implemented -->
                        <button class="menu-item" id="continueSeriesBtn" style="display: none;">
                            <i class="fas fa-layer-group"></i>
                            Continue Series
                        </button>
                        <!-- UPDATED: Edit Button - Now properly implemented -->
                        <button class="menu-item" id="editPulseBtn" style="display: none;">
                            <i class="fas fa-edit"></i>
                            Edit Pulse
                        </button>
                        <button class="menu-item" id="reportPulseBtn">
                            <i class="far fa-flag"></i>
                            Report
                        </button>
                        <button class="menu-item" id="muteCreatorBtn">
                            <i class="fas fa-volume-mute"></i>
                            Mute Creator
                        </button>
                        <button class="menu-item delete" id="deletePulseBtn" style="display: none;">
                            <i class="fas fa-trash"></i>
                            Delete Pulse
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- NEW: Series Label -->
            <div class="series-label" id="seriesLabel" style="display: none;">
                PULSE SERIES  Part <span id="series-part">2</span> of <span id="series-total">5</span>
            </div>
            
            <!-- Media Container -->
            <div class="media-container">
                <div id="media-content">
                    <!-- Media will be loaded here -->
                </div>
                
                <!-- Custom Video Controls -->
                <div class="video-controls-overlay">
                    <div class="video-progress" id="videoProgress">
                        <div class="video-progress-filled" id="videoProgressFilled"></div>
                    </div>
                    <div class="video-controls">
                        <div class="video-left-controls">
                            <button class="video-control-btn" id="playPauseBtn">
                                <i class="fas fa-play"></i>
                            </button>
                            <div class="video-time" id="currentTime">0:00</div>
                        </div>
                        <div class="video-right-controls">
                            <div class="video-volume">
                                <button class="video-control-btn" id="muteBtn">
                                    <i class="fas fa-volume-mute"></i>
                                </button>
                                <div class="volume-slider" id="volumeSlider">
                                    <div class="volume-slider-filled" id="volumeSliderFilled"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Narrative Block -->
            <div class="narrative-block">
                <!-- NEW: Re-Pulse Context Container -->
                <div id="repulse-context-container"></div>
                
                <div class="caption-text" id="caption-text">
                    The rhythm of African storytelling isn't just in the wordsit's in the spaces between them. The moments of silence, the glances, the pauses that speak volumes. That's where the real magic happens.
                </div>
            </div>
            
            <!-- NEW: Updated Action Bar for BANTU CONNECT -->
            <div class="pulse-actions">
                <button class="action-button tap-btn" id="tapBtn">
                    <i class="far fa-hand-point-up tap-icon" aria-hidden="true"></i> Feel
                </button>
                <button class="action-button comment-btn" id="commentBtn">
                    <i class="fas fa-comment" aria-hidden="true"></i> <span id="comment-count">0</span>
                </button>
                <button class="action-button repulse-btn" id="repulseBtn">
                    <i class="fas fa-retweet" aria-hidden="true"></i> <span id="repulse-count">0</span>
                </button>
                <button class="action-button save-btn" id="saveBtn">
                    <i class="far fa-bookmark" aria-hidden="true"></i> Save
                </button>
            </div>
            
            <!-- NEW: Pulse Stats -->
            <div class="pulse-stats" id="pulse-stats">
                <!-- Stats will be populated here -->
            </div>
        </div>
        
        <!-- Comments Section Container -->
        <div class="comments-section-container">
            <!-- Comments Section -->
            <div class="comments-section">
                <div class="comments-header">
                    <h3 class="comments-title">Conversation</h3>
                    <p class="comments-subtitle">Thoughts on this Pulse?</p>
                </div>
                
                <!-- NEW: Comment Composer with Mention Support -->
                <div class="comment-composer">
                    <div class="composer-avatar" id="composer-avatar">
                        <img id="composer-avatar-img">
                        <span>AB</span>
                    </div>
                    <div class="composer-input-container">
                        <textarea 
                            class="composer-input" 
                            id="commentInput" 
                            placeholder="Add your voice Use @ to mention people"
                            maxlength="500"
                            rows="2"
                        ></textarea>
                        <!-- NEW: Mention counter -->
                        <div id="commentMentionCounter" class="mention-counter">0/10 mentions</div>
                        <!-- NEW: Autocomplete dropdown -->
                        <div id="commentMentionAutocomplete" class="mention-autocomplete"></div>
                    </div>
                    <button class="post-comment-btn" id="postCommentBtn" disabled>Post</button>
                </div>
                
                <!-- Comments Thread -->
                <div class="comments-thread" id="commentsThread">
                    <!-- Comments will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-item" onclick="window.location.href='pulse-feed.html'">
            <i class="fas fa-home nav-icon"></i>
            <span>Home</span>
        </button>
        <button class="nav-item" onclick="window.location.href='search.html'">
            <i class="fas fa-search nav-icon"></i>
            <span>Search</span>
        </button>
        <button class="nav-item" onclick="window.location.href='saved.html'">
            <i class="fas fa-bookmark nav-icon"></i>
            <span>Saved</span>
        </button>
        <button class="nav-item" onclick="window.location.href='profile.html'">
            <i class="fas fa-user nav-icon"></i>
            <span>Profile</span>
        </button>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Share Modal -->
    <div id="shareModal" class="modal-overlay">
        <div class="share-modal">
            <div class="modal-header">
                <h3 class="modal-title">Share Pulse</h3>
                <button class="close-modal" id="closeShareModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="share-options">
                    <div class="share-option" id="copyLinkOption">
                        <div class="share-icon">
                            <i class="fas fa-link"></i>
                        </div>
                        <div class="share-text">
                            Copy link
                            <div class="share-description">Share via any platform</div>
                        </div>
                    </div>
                    
                    <div class="share-option" id="shareWhatsApp">
                        <div class="share-icon" style="background: linear-gradient(135deg, #25D366, #128C7E);">
                            <i class="fab fa-whatsapp"></i>
                        </div>
                        <div class="share-text">
                            Share on WhatsApp
                            <div class="share-description">Send to contacts or groups</div>
                        </div>
                    </div>
                    
                    <div class="share-option" id="shareTwitter">
                        <div class="share-icon" style="background: linear-gradient(135deg, #1DA1F2, #0d8bd9);">
                            <i class="fab fa-twitter"></i>
                        </div>
                        <div class="share-text">
                            Share on X
                            <div class="share-description">Post to your followers</div>
                        </div>
                    </div>
                    
                    <div class="share-option" id="shareInstagram">
                        <div class="share-icon" style="background: linear-gradient(135deg, #E1306C, #C13584);">
                            <i class="fab fa-instagram"></i>
                        </div>
                        <div class="share-text">
                            Share on Instagram
                            <div class="share-description">Add to your story or post</div>
                        </div>
                    </div>
                    
                    <div class="share-option" id="shareInternal">
                        <div class="share-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="share-text">
                            Share inside Bantu
                            <div class="share-description">Send to Connectors</div>
                        </div>
                    </div>
                    
                    <div class="share-option" id="addToSeries" style="display: none;">
                        <div class="share-icon">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <div class="share-text">
                            Add to Series
                            <div class="share-description">Include in an existing series</div>
                        </div>
                    </div>
                </div>
                
                <div class="copy-link-section">
                    <div class="copy-link-label">Direct link to this Pulse</div>
                    <div class="link-container">
                        <input type="text" class="link-input" id="shareLink" readonly value="https://bantuconnect.pulse/id/12345">
                        <button class="copy-link-btn" id="copyLinkBtn">Copy</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Comment Modal -->
    <div id="editCommentModal" class="modal-overlay">
        <div class="share-modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Edit Comment</h3>
                <button class="close-modal" id="closeEditCommentModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <textarea 
                    class="composer-input" 
                    id="editCommentInput" 
                    placeholder="Edit your comment..."
                    maxlength="500"
                    rows="4"
                ></textarea>
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-cancel" id="cancelEditComment">Cancel</button>
                    <button class="modal-btn modal-btn-post" id="saveEditComment">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Continue Series Modal -->
    <div id="continueSeriesModal" class="modal-overlay" style="display: none;">
        <div class="share-modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Continue Series</h3>
                <button class="close-modal" id="closeContinueSeriesModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <p>You're continuing the series "<span id="currentSeriesTitle">Untitled Series</span>"</p>
                    <p>Next part: <strong>Part <span id="nextSeriesPart">2</span></strong></p>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-cancel" id="cancelContinueSeries">Cancel</button>
                    <button class="modal-btn modal-btn-post" id="confirmContinueSeries">Continue Series</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Create New Series Modal -->
    <div id="createSeriesModal" class="modal-overlay" style="display: none;">
        <div class="share-modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Create New Series</h3>
                <button class="close-modal" id="closeCreateSeriesModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <label for="seriesTitle" style="display: block; margin-bottom: 8px; color: var(--soft-white);">Series Title</label>
                    <input type="text" id="seriesTitle" class="composer-input" placeholder="Enter series title" style="width: 100%;">
                    
                    <label for="seriesDescription" style="display: block; margin-bottom: 8px; margin-top: 16px; color: var(--soft-white);">Description (Optional)</label>
                    <textarea id="seriesDescription" class="composer-input" placeholder="Describe your series" rows="3" style="width: 100%;"></textarea>
                    
                    <label for="totalParts" style="display: block; margin-bottom: 8px; margin-top: 16px; color: var(--soft-white);">Total Planned Parts (Max: 50)</label>
                    <input type="number" id="totalParts" class="composer-input" placeholder="10" min="2" max="50" value="10" style="width: 100%;">
                </div>
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-cancel" id="cancelCreateSeries">Cancel</button>
                    <button class="modal-btn modal-btn-post" id="confirmCreateSeries">Create Series</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Re-Pulse Modal Template -->
    <div id="repulseModalTemplate" style="display: none;">
        <div class="modal-overlay">
            <div class="repulse-modal">
                <div class="repulse-modal-header">
                    <h3 class="repulse-modal-title">Re-Pulse</h3>
                    <button class="repulse-modal-close" id="closeRepulseModal" aria-label="Close modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div style="position: relative;">
                    <textarea 
                        class="repulse-context-input" 
                        id="repulseContext" 
                        placeholder="Add your thoughts (optional, max 140 chars). Use @ to mention people"
                        maxlength="140"
                        aria-label="Re-pulse context"
                    ></textarea>
                    <div id="repulseMentionCounter" class="mention-counter">0/10 mentions</div>
                    <div id="repulseMentionAutocomplete" class="mention-autocomplete"></div>
                </div>
                <div class="repulse-modal-actions">
                    <button class="modal-repulse-btn soft" id="softRepulse">
                        Re-Pulse
                    </button>
                    <button class="modal-repulse-btn" id="contextualRepulse">
                        Re-Pulse with Context
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase client
        const SUPABASE_URL = 'https://ydnxqnbjoshvxteevemc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkbnhxbmJqb3Nodnh0ZWV2ZW1jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MzI0OTMsImV4cCI6MjA3MzIwODQ5M30.NlaCCnLPSz1mM7AFeSlfZQ78kYEKUMh_Fi-7P_ccs_U';

        // Global variables
        let supabaseClient = null;
        let currentUserId = null;
        let currentSession = null;
        let pulseId = null;
        let currentPulse = null;
        let pulseCreator = null;
        let videoElement = null;
        let isPlaying = false;
        let isMuted = false;
        let volume = 1;
        let editingCommentId = null;
        let editingReplyId = null;
        let isProcessingLike = {};
        
        // NEW: Variables for new features
        let mentionAutocompleteActive = false;
        let mentionSuggestions = [];
        let currentMentionStart = -1;
        let currentMentionQuery = '';
        let mentionAbortController = null;
        let mentionDebounceTimeout = null;
        let tapTimers = new Map();
        let longPressThreshold = 500;
        let currentReactionMenuPulseId = null;
        let currentRepulseModal = null;
        let userConnections = new Set();

        async function initialize() {
            console.log('Starting Pulse Detail initialization...');
            
            try {
                // Create Supabase client
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    auth: {
                        autoRefreshToken: true,
                        persistSession: true,
                        detectSessionInUrl: false
                    },
                    global: {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY
                        }
                    }
                });
                
                // Check session
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                
                if (sessionError) {
                    console.error('Session error:', sessionError);
                    throw sessionError;
                }
                
                if (!session) {
                    window.location.href = 'login.html';
                    return;
                }
                
                console.log('User authenticated:', session.user.email);
                currentUserId = session.user.id;
                currentSession = session;
                
                // Set user initials
                const user = session.user;
                const initials = getUserInitials(user);
                document.getElementById('avatar-initials').textContent = initials;
                const composerAvatar = document.getElementById('composer-avatar');
                composerAvatar.querySelector('span').textContent = initials;
                
                // Get user profile with avatar
                try {
                    const { data: profile, error: profileError } = await supabaseClient
                        .from('user_profiles')
                        .select('avatar_url, full_name, username')
                        .eq('id', user.id)
                        .single();
                    
                    if (!profileError && profile?.avatar_url) {
                        const avatarImg = document.getElementById('user-avatar-img');
                        avatarImg.src = profile.avatar_url;
                        avatarImg.style.display = 'block';
                        avatarImg.alt = profile.full_name || profile.username || 'User';
                        document.getElementById('avatar-initials').style.display = 'none';
                        
                        const composerImg = document.getElementById('composer-avatar-img');
                        composerImg.src = profile.avatar_url;
                        composerImg.style.display = 'block';
                        composerImg.alt = profile.full_name || profile.username || 'User';
                        composerAvatar.querySelector('span').style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error loading user profile:', error);
                }
                
                // Get pulse ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                pulseId = urlParams.get('id');
                
                if (!pulseId) {
                    showToast('No pulse ID specified', 'error');
                    setTimeout(() => {
                        window.location.href = 'pulse-feed.html';
                    }, 2000);
                    return;
                }
                
                // NEW: Check for unread notifications
                await checkUnreadNotifications();
                
                // NEW: Subscribe to real-time notifications
                subscribeToNotifications();
                
                // NEW: Fetch user connections
                await fetchUserConnections();
                
                // Load pulse data
                await loadPulse();
                
                // Hide loading, show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
                // Initialize event listeners
                initializeEventListeners();
                
                // Load comments
                loadComments();
                
                // NEW: Setup mention autocomplete for comment input
                const commentInput = document.getElementById('commentInput');
                setupMentionAutocomplete(commentInput, 'commentMentionAutocomplete', 'commentMentionCounter');
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading-text').textContent = 'Error loading pulse. Please refresh.';
                
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('content').style.display = 'block';
                    initializeEventListeners();
                }, 2000);
            }
        }
        
        function getUserInitials(user) {
            if (!user) return 'U';
            const email = user.email || '';
            const name = user.user_metadata?.full_name || email.split('@')[0] || 'U';
            return name.substring(0, 2).toUpperCase();
        }
        
        // NEW: Check for unread notifications
        async function checkUnreadNotifications() {
            try {
                const { count, error: countError } = await supabaseClient
                    .from('pulse_notifications')
                    .select('*', { count: 'exact', head: true })
                    .eq('target_user_id', currentUserId)
                    .eq('is_read', false);
                
                if (countError) {
                    console.log('Using fallback for notifications');
                    updateNotificationIndicator(false);
                    return;
                }
                
                const hasUnread = count > 0;
                updateNotificationIndicator(hasUnread);
                
            } catch (error) {
                console.error('Error checking unread notifications:', error);
                updateNotificationIndicator(false);
            }
        }
        
        // NEW: Update notification indicator
        function updateNotificationIndicator(hasUnread) {
            const notificationBtn = document.getElementById('notificationBtn');
            if (notificationBtn) {
                if (hasUnread) {
                    notificationBtn.classList.add('has-unread');
                } else {
                    notificationBtn.classList.remove('has-unread');
                }
            }
        }
        
        // NEW: Subscribe to real-time notifications
        function subscribeToNotifications() {
            if (!supabaseClient || !currentUserId) return;
            
            try {
                const notificationsSubscription = supabaseClient
                    .channel('pulse-detail-notifications')
                    .on(
                        'postgres_changes',
                        {
                            event: 'INSERT',
                            schema: 'public',
                            table: 'pulse_notifications',
                            filter: `target_user_id=eq.${currentUserId}`
                        },
                        (payload) => {
                            console.log('New notification:', payload);
                            updateNotificationIndicator(true);
                            showToast('New notification!', 'success');
                        }
                    )
                    .on(
                        'postgres_changes',
                        {
                            event: 'UPDATE',
                            schema: 'public',
                            table: 'pulse_notifications',
                            filter: `target_user_id=eq.${currentUserId}`
                        },
                        (payload) => {
                            if (payload.new.is_read === true && payload.old.is_read === false) {
                                checkUnreadNotifications();
                            }
                        }
                    )
                    .subscribe((status) => {
                        console.log('Notification subscription:', status);
                    });
                    
            } catch (error) {
                console.error('Error setting up notification subscription:', error);
            }
        }
        
        // NEW: Create notification function
        async function createNotification(type, actorId, targetUserId, pulseId, commentId, message) {
            try {
                const notificationData = {
                    type: type,
                    actor_id: actorId,
                    target_user_id: targetUserId,
                    pulse_id: pulseId,
                    message: message,
                    is_read: false,
                    created_at: new Date().toISOString()
                };
                
                // Only add comment_id if it's provided
                if (commentId) {
                    notificationData.comment_id = commentId;
                }
                
                const { error } = await supabaseClient
                    .from('pulse_notifications')
                    .insert(notificationData);
                
                if (error) {
                    console.error('Error creating notification:', error);
                    // If there's a foreign key error, try without comment_id
                    if (error.code === '23503' && commentId) {
                        delete notificationData.comment_id;
                        const { error: retryError } = await supabaseClient
                            .from('pulse_notifications')
                            .insert(notificationData);
                        
                        if (retryError) {
                            throw retryError;
                        }
                    } else {
                        throw error;
                    }
                }
                
                await checkUnreadNotifications();
                
            } catch (error) {
                console.error('Error creating notification:', error);
            }
        }
        
        // NEW: Fetch user connections
        async function fetchUserConnections() {
            try {
                const { data: connections, error } = await supabaseClient
                    .from('connectors')
                    .select('connected_id')
                    .eq('connector_id', currentUserId);
                
                if (error) {
                    console.error('Error fetching connections:', error);
                    return;
                }
                
                userConnections = new Set();
                if (connections) {
                    connections.forEach(connection => {
                        userConnections.add(connection.connected_id);
                    });
                }
                
            } catch (error) {
                console.error('Error loading user connections:', error);
            }
        }
        
        async function loadPulse() {
            try {
                console.log('Loading pulse:', pulseId);
                
                // Fetch pulse data with series information
                const { data: pulse, error } = await supabaseClient
                    .from('pulses')
                    .select(`
                        *,
                        pulse_series (
                            id,
                            title,
                            total_parts,
                            created_by
                        )
                    `)
                    .eq('id', pulseId)
                    .single();
                
                if (error) {
                    console.error('Error fetching pulse:', error);
                    throw error;
                }
                
                currentPulse = pulse;
                
                // Get user info
                try {
                    const { data: creatorData } = await supabaseClient
                        .from('user_profiles')
                        .select('*')
                        .eq('id', pulse.user_id)
                        .single();
                    
                    pulseCreator = creatorData || {
                        full_name: 'Unknown User',
                        username: 'unknown',
                        avatar_url: null,
                        role: 'user',
                        email: 'unknown@example.com',
                        id: pulse.user_id
                    };
                } catch (creatorError) {
                    console.error('Error fetching creator:', creatorError);
                    pulseCreator = {
                        full_name: 'User',
                        username: 'user',
                        avatar_url: null,
                        role: 'user',
                        email: 'unknown@example.com',
                        id: pulse.user_id
                    };
                }
                
                // Update UI
                document.getElementById('creator-name').textContent = pulseCreator.full_name || 'User';
                document.getElementById('creator-handle').innerHTML = `@${pulseCreator.username || 'user'}  <span id="pulse-time">${getTimeAgo(new Date(currentPulse.created_at))}</span>`;
                
                const creatorInitials = getInitials(pulseCreator.full_name || pulseCreator.email || 'User');
                document.getElementById('creator-initials').textContent = creatorInitials;
                
                // Set creator avatar
                const creatorAvatarImg = document.getElementById('creator-avatar-img');
                const creatorInitialsElement = document.getElementById('creator-initials');
                
                if (pulseCreator.avatar_url) {
                    creatorAvatarImg.src = pulseCreator.avatar_url;
                    creatorAvatarImg.style.display = 'block';
                    creatorAvatarImg.alt = pulseCreator.full_name || pulseCreator.username || 'Creator';
                    creatorInitialsElement.style.display = 'none';
                } else {
                    creatorAvatarImg.style.display = 'none';
                    creatorInitialsElement.style.display = 'flex';
                }
                
                // NEW: Set connect button state
                const connectBtn = document.getElementById('connectBtn');
                if (connectBtn) {
                    connectBtn.setAttribute('data-creator-id', pulseCreator.id);
                    if (userConnections.has(pulseCreator.id)) {
                        connectBtn.classList.add('connected');
                        connectBtn.innerHTML = '<i class="fas fa-user-check" aria-hidden="true"></i>';
                    }
                }
                
                // Show series label if part of a series
                if (currentPulse.series_id && currentPulse.series_order) {
                    document.getElementById('seriesLabel').style.display = 'inline-block';
                    document.getElementById('series-part').textContent = currentPulse.series_order;
                    
                    try {
                        const { data: series } = await supabaseClient
                            .from('pulse_series')
                            .select('total_parts')
                            .eq('id', currentPulse.series_id)
                            .single();
                        
                        if (series?.total_parts) {
                            document.getElementById('series-total').textContent = series.total_parts;
                        } else {
                            document.getElementById('series-total').textContent = '?';
                        }
                    } catch (error) {
                        console.log('Could not fetch series details');
                        document.getElementById('series-total').textContent = '?';
                    }
                }
                
                // NEW: Parse mentions in caption
                if (currentPulse.caption) {
                    const parsedCaption = parseMentions(currentPulse.caption);
                    document.getElementById('caption-text').innerHTML = parsedCaption.text;
                } else {
                    document.getElementById('caption-text').textContent = '';
                }
                
                // NEW: Load re-pulse contexts
                const repulseContextHTML = await loadRepulseContexts(pulseId);
                if (repulseContextHTML) {
                    document.getElementById('repulse-context-container').innerHTML = repulseContextHTML;
                }
                
                // NEW: Update initial counts
                await updatePulseStats(pulseId);
                
                // Load media
                const mediaContainer = document.querySelector('.media-container');
                const mediaContent = document.getElementById('media-content');
                mediaContent.innerHTML = '';
                
                if (currentPulse.media_url && currentPulse.media_url.trim() !== '') {
                    mediaContainer.classList.add('has-media');
                    
                    if (currentPulse.media_type === 'video') {
                        videoElement = document.createElement('video');
                        videoElement.src = currentPulse.media_url;
                        videoElement.className = 'pulse-media';
                        videoElement.muted = false;
                        videoElement.playsInline = true;
                        videoElement.preload = 'auto';
                        videoElement.autoplay = true;
                        
                        videoElement.addEventListener('loadedmetadata', function() {
                            updateVideoTime();
                            document.getElementById('volumeSliderFilled').style.width = (volume * 100) + '%';
                        });
                        
                        videoElement.addEventListener('timeupdate', updateVideoTime);
                        videoElement.addEventListener('play', () => {
                            isPlaying = true;
                            document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-pause"></i>';
                        });
                        videoElement.addEventListener('pause', () => {
                            isPlaying = false;
                            document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-play"></i>';
                        });
                        videoElement.addEventListener('ended', () => {
                            isPlaying = false;
                            document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-play"></i>';
                        });
                        
                        mediaContent.appendChild(videoElement);
                        
                        const playPromise = videoElement.play();
                        if (playPromise !== undefined) {
                            playPromise.catch(e => {
                                console.log('Autoplay prevented, waiting for user interaction');
                            });
                        }
                    } else {
                        const img = document.createElement('img');
                        img.src = currentPulse.media_url;
                        img.className = 'pulse-media';
                        img.alt = 'Pulse image';
                        mediaContent.appendChild(img);
                        document.querySelector('.video-controls-overlay').style.display = 'none';
                    }
                } else {
                    mediaContainer.classList.remove('has-media');
                }
                
                // UPDATED: Show edit/delete buttons if user owns the pulse
                // Also show continue series button if user is creator
                if (currentPulse.user_id === currentUserId) {
                    document.getElementById('deletePulseBtn').style.display = 'flex';
                    document.getElementById('editPulseBtn').style.display = 'flex';
                    document.getElementById('addToSeries').style.display = 'flex';
                    
                    // Show continue series button if user is creator
                    document.getElementById('continueSeriesBtn').style.display = 'flex';
                }
                
                // NEW: Check if user has tapped, re-pulsed, or saved this pulse
                await checkTapStatus();
                await checkRePulseStatus();
                await checkSaveStatus();
                
            } catch (error) {
                console.error('Error loading pulse:', error);
                showToast('Failed to load pulse', 'error');
            }
        }
        
        function updateVideoTime() {
            if (!videoElement) return;
            
            const current = videoElement.currentTime;
            const duration = videoElement.duration;
            
            const progressPercent = (current / duration) * 100;
            document.getElementById('videoProgressFilled').style.width = progressPercent + '%';
            
            const currentFormatted = formatTime(current);
            const durationFormatted = formatTime(duration);
            document.getElementById('currentTime').textContent = `${currentFormatted} / ${durationFormatted}`;
        }
        
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function getInitials(name) {
            if (!name) return 'U';
            return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        }
        
        function getTimeAgo(date) {
            if (!date || isNaN(new Date(date).getTime())) {
                return 'just now';
            }
            
            const now = new Date();
            const then = new Date(date);
            const seconds = Math.floor((now - then) / 1000);
            
            if (seconds < 30) return 'just now';
            if (seconds < 60) return seconds + ' seconds ago';
            
            const minutes = Math.floor(seconds / 60);
            if (minutes < 2) return 'a minute ago';
            if (minutes < 60) return minutes + ' minutes ago';
            
            const hours = Math.floor(minutes / 60);
            if (hours < 2) return 'an hour ago';
            if (hours < 24) return hours + ' hours ago';
            
            const days = Math.floor(hours / 24);
            if (days < 2) return 'yesterday';
            if (days < 30) return days + ' days ago';
            
            const months = Math.floor(days / 30);
            if (months < 2) return 'a month ago';
            if (months < 12) return months + ' months ago';
            
            const years = Math.floor(months / 12);
            if (years < 2) return 'a year ago';
            return years + ' years ago';
        }
        
        // FIXED: Check tap status - fixed column name
        async function checkTapStatus() {
            try {
                const { data, error } = await supabaseClient
                    .from('pulse_taps')
                    .select('id')
                    .eq('pulse_id', pulseId)
                    .eq('user_id', currentUserId)
                    .maybeSingle();
                
                const isTapped = !!data;
                updateTapUI(pulseId, isTapped);
                
            } catch (error) {
                console.error('Error checking tap status:', error);
            }
        }
        
        // NEW: Check re-pulse status
        async function checkRePulseStatus() {
            try {
                const { data, error } = await supabaseClient
                    .from('pulse_repulses')
                    .select('id')
                    .eq('pulse_id', pulseId)
                    .eq('user_id', currentUserId)
                    .maybeSingle();
                
                const isRepulsed = !!data;
                updateRePulseUI(pulseId, isRepulsed);
                
            } catch (error) {
                console.error('Error checking re-pulse status:', error);
            }
        }
        
        // FIXED: Check save status - fixed column name
        async function checkSaveStatus() {
            try {
                const { data, error } = await supabaseClient
                    .from('saved_pulses')
                    .select('id')
                    .eq('pulse_id', pulseId)
                    .eq('user_id', currentUserId)
                    .maybeSingle();
                
                const isSaved = !!data;
                updateSaveUI(pulseId, isSaved);
                
            } catch (error) {
                console.error('Error checking save status:', error);
            }
        }
        
        // NEW: Update tap UI
        function updateTapUI(pulseId, isTapped) {
            const tapBtn = document.getElementById('tapBtn');
            
            if (tapBtn) {
                if (isTapped) {
                    tapBtn.classList.add('tapped');
                    tapBtn.innerHTML = '<i class="fas fa-hand-point-up tap-icon" aria-hidden="true"></i> Felt';
                } else {
                    tapBtn.classList.remove('tapped');
                    tapBtn.innerHTML = '<i class="far fa-hand-point-up tap-icon" aria-hidden="true"></i> Feel';
                }
            }
        }
        
        // NEW: Update re-pulse UI
        function updateRePulseUI(pulseId, isRepulsed) {
            const repulseBtn = document.getElementById('repulseBtn');
            
            if (repulseBtn) {
                if (isRepulsed) {
                    repulseBtn.classList.add('repulsed');
                    repulseBtn.innerHTML = '<i class="fas fa-retweet" aria-hidden="true"></i> Re-Pulsed';
                } else {
                    repulseBtn.classList.remove('repulsed');
                    repulseBtn.innerHTML = '<i class="fas fa-retweet" aria-hidden="true"></i> Re-Pulse';
                }
            }
        }
        
        // NEW: Update save UI
        function updateSaveUI(pulseId, isSaved) {
            const saveBtn = document.getElementById('saveBtn');
            const savePulseBtn = document.getElementById('savePulseBtn');
            
            if (saveBtn) {
                if (isSaved) {
                    saveBtn.classList.add('saved');
                    saveBtn.innerHTML = '<i class="fas fa-bookmark" aria-hidden="true"></i> Saved';
                } else {
                    saveBtn.classList.remove('saved');
                    saveBtn.innerHTML = '<i class="far fa-bookmark" aria-hidden="true"></i> Save';
                }
            }
            
            if (savePulseBtn) {
                if (isSaved) {
                    savePulseBtn.innerHTML = '<i class="fas fa-bookmark"></i> Unsave Pulse';
                } else {
                    savePulseBtn.innerHTML = '<i class="far fa-bookmark"></i> Save Pulse';
                }
            }
        }
        
        // FIXED: Handle Tap - fixed column name from created_at to tapped_at
        async function handleTap(pulseId, e) {
            if (e) e.stopPropagation();
            
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    showToast('Please login to tap pulses', 'error');
                    return;
                }
                
                // Check if already tapped
                const { data: existingTap } = await supabaseClient
                    .from('pulse_taps')
                    .select('id')
                    .eq('pulse_id', pulseId)
                    .eq('user_id', session.user.id)
                    .maybeSingle();
                
                let isTapped;
                
                if (existingTap) {
                    // Untap
                    const { error } = await supabaseClient
                        .from('pulse_taps')
                        .delete()
                        .eq('id', existingTap.id);
                    
                    if (error) throw error;
                    
                    isTapped = false;
                    showToast('Tap removed', 'success');
                } else {
                    // Tap - FIXED: Use tapped_at instead of created_at
                    const { error } = await supabaseClient
                        .from('pulse_taps')
                        .insert({
                            pulse_id: pulseId,
                            user_id: session.user.id,
                            tapped_at: new Date().toISOString() // FIXED
                        });
                    
                    if (error) throw error;
                    
                    isTapped = true;
                    showToast('Pulse tapped!', 'success');
                    
                    // Create notification for pulse creator
                    if (pulseCreator && pulseCreator.id !== session.user.id) {
                        const actorName = session.user.email.split('@')[0];
                        await createNotification(
                            'tap',
                            session.user.id,
                            pulseCreator.id,
                            pulseId,
                            null,
                            `${actorName} felt your pulse`
                        );
                    }
                }
                
                // Update UI immediately
                updateTapUI(pulseId, isTapped);
                
                // Update pulse stats
                await updatePulseStats(pulseId);
                
            } catch (error) {
                console.error('Tap error:', error);
                showToast('Failed to tap pulse', 'error');
            }
        }
        
        // NEW: Setup tap button event handlers with long press for reactions
        function setupTapButtonEvents(tapBtn, pulseId) {
            let tapTimer;
            let isLongPress = false;
            let touchStartTime;
            
            const startTimer = (e) => {
                isLongPress = false;
                touchStartTime = Date.now();
                tapTimer = setTimeout(() => {
                    isLongPress = true;
                    showReactionMenu(pulseId, e);
                }, 500);
            };
            
            const clearTapTimer = () => {
                clearTimeout(tapTimer);
            };
            
            const handleTapEnd = (e) => {
                clearTapTimer();
                const touchDuration = Date.now() - touchStartTime;
                
                if (!isLongPress && touchDuration < 500) {
                    handleTap(pulseId, e);
                }
            };
            
            // Touch events for mobile
            tapBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startTimer(e);
            }, { passive: false });
            
            tapBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                handleTapEnd(e);
            });
            
            tapBtn.addEventListener('touchmove', clearTapTimer);
            tapBtn.addEventListener('touchcancel', clearTapTimer);
            
            // Mouse events for desktop
            tapBtn.addEventListener('mousedown', (e) => {
                startTimer(e);
            });
            
            tapBtn.addEventListener('mouseup', (e) => {
                handleTapEnd(e);
            });
            
            tapBtn.addEventListener('mouseleave', clearTapTimer);
            
            // Context menu prevention
            tapBtn.addEventListener('contextmenu', (e) => {
                e.preventDefault();
            });
        }
        
        // NEW: Show Reaction Menu (for long press)
        function showReactionMenu(pulseId, event) {
            closeReactionMenu();
            
            const pulseContainer = document.querySelector('.pulse-post-container');
            if (!pulseContainer) return;
            
            const reactionMenu = document.createElement('div');
            reactionMenu.className = 'reaction-menu';
            reactionMenu.id = `reaction-menu-${pulseId}`;
            
            reactionMenu.innerHTML = `
                <button class="reaction-option awe" data-reaction-type="awe" data-pulse-id="${pulseId}" aria-label="React with Awe">
                    <i class="fas fa-bolt reaction-icon" aria-hidden="true"></i>
                    <span>Awe</span>
                </button>
                <button class="reaction-option banger" data-reaction-type="banger" data-pulse-id="${pulseId}" aria-label="React with Banger">
                    <i class="fas fa-fire reaction-icon" aria-hidden="true"></i>
                    <span>Banger</span>
                </button>
            `;
            
            pulseContainer.appendChild(reactionMenu);
            reactionMenu.classList.add('active');
            
            const tapBtn = pulseContainer.querySelector('.tap-btn');
            if (tapBtn && event) {
                const rect = tapBtn.getBoundingClientRect();
                reactionMenu.style.position = 'absolute';
                reactionMenu.style.left = '50%';
                reactionMenu.style.bottom = `${rect.height + 10}px`;
            }
            
            currentReactionMenuPulseId = pulseId;
            
            reactionMenu.querySelectorAll('.reaction-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    const reactionType = e.currentTarget.dataset.reactionType;
                    handleReaction(pulseId, reactionType, e);
                });
            });
            
            setTimeout(() => {
                document.addEventListener('click', closeReactionMenuOnClickOutside);
            }, 10);
        }
        
        // NEW: Close Reaction Menu
        function closeReactionMenu() {
            if (currentReactionMenuPulseId) {
                const menu = document.querySelector(`#reaction-menu-${currentReactionMenuPulseId}`);
                if (menu) {
                    menu.remove();
                }
                currentReactionMenuPulseId = null;
            }
            document.removeEventListener('click', closeReactionMenuOnClickOutside);
        }
        
        function closeReactionMenuOnClickOutside(e) {
            const menu = document.querySelector(`#reaction-menu-${currentReactionMenuPulseId}`);
            if (menu && !menu.contains(e.target)) {
                closeReactionMenu();
            }
        }
        
        // NEW: Handle Reaction (Awe or Banger)
        async function handleReaction(pulseId, reactionType, e) {
            if (e) e.stopPropagation();
            
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    showToast('Please login to react to pulses', 'error');
                    return;
                }
                
                // Check if already has this reaction
                const { data: existingReaction } = await supabaseClient
                    .from('pulse_reactions')
                    .select('id, reaction_type')
                    .eq('pulse_id', pulseId)
                    .eq('user_id', session.user.id)
                    .eq('reaction_type', reactionType)
                    .maybeSingle();
                
                const reactionBtn = e.currentTarget;
                reactionBtn.classList.add('active');
                
                if (existingReaction) {
                    // Remove reaction
                    const { error } = await supabaseClient
                        .from('pulse_reactions')
                        .delete()
                        .eq('id', existingReaction.id);
                    
                    if (error) throw error;
                    
                    setTimeout(() => {
                        reactionBtn.classList.remove('active');
                    }, 600);
                } else {
                    // Add reaction
                    const { error } = await supabaseClient
                        .from('pulse_reactions')
                        .insert({
                            pulse_id: pulseId,
                            user_id: session.user.id,
                            reaction_type: reactionType,
                            created_at: new Date().toISOString()
                        });
                    
                    if (error) throw error;
                    
                    // Create notification for pulse creator
                    if (pulseCreator && pulseCreator.id !== session.user.id) {
                        const actorName = session.user.email.split('@')[0];
                        let message = '';
                        
                        if (reactionType === 'awe') {
                            message = `${actorName} is in awe of your pulse.`;
                        } else if (reactionType === 'banger') {
                            message = `${actorName} considers your pulse a banger.`;
                        }
                        
                        await createNotification(
                            'reaction',
                            session.user.id,
                            pulseCreator.id,
                            pulseId,
                            null,
                            message
                        );
                    }
                    
                    setTimeout(() => {
                        reactionBtn.classList.remove('active');
                    }, 600);
                }
                
                closeReactionMenu();
                
            } catch (error) {
                console.error('Reaction error:', error);
            }
        }
        
        // NEW: Show Re-Pulse Modal
        function showRePulseModal(pulseId, event) {
            if (currentRepulseModal) {
                currentRepulseModal.remove();
            }
            
            const repulseModal = document.createElement('div');
            repulseModal.className = 'modal-overlay';
            repulseModal.style.display = 'flex';
            
            repulseModal.innerHTML = `
                <div class="repulse-modal">
                    <div class="repulse-modal-header">
                        <h3 class="repulse-modal-title">Re-Pulse</h3>
                        <button class="repulse-modal-close" id="closeRepulseModal" aria-label="Close modal">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div style="position: relative;">
                        <textarea 
                            class="repulse-context-input" 
                            id="repulseContext" 
                            placeholder="Add your thoughts (optional, max 140 chars). Use @ to mention people"
                            maxlength="140"
                            aria-label="Re-pulse context"
                        ></textarea>
                        <div id="repulseMentionCounter" class="mention-counter">0/10 mentions</div>
                        <div id="repulseMentionAutocomplete" class="mention-autocomplete"></div>
                    </div>
                    <div class="repulse-modal-actions">
                        <button class="modal-repulse-btn soft" id="softRepulse" data-pulse-id="${pulseId}">
                            Re-Pulse
                        </button>
                        <button class="modal-repulse-btn" id="contextualRepulse" data-pulse-id="${pulseId}">
                            Re-Pulse with Context
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(repulseModal);
            currentRepulseModal = repulseModal;
            
            const repulseContextTextarea = repulseModal.querySelector('#repulseContext');
            setupMentionAutocomplete(repulseContextTextarea, 'repulseMentionAutocomplete', 'repulseMentionCounter');
            
            const closeBtn = repulseModal.querySelector('#closeRepulseModal');
            closeBtn.addEventListener('click', () => {
                repulseModal.remove();
                currentRepulseModal = null;
            });
            
            repulseModal.addEventListener('click', (e) => {
                if (e.target === repulseModal) {
                    repulseModal.remove();
                    currentRepulseModal = null;
                }
            });
            
            const softRepulseBtn = repulseModal.querySelector('#softRepulse');
            const contextualRepulseBtn = repulseModal.querySelector('#contextualRepulse');
            
            softRepulseBtn.addEventListener('click', (e) => {
                handleRePulse(pulseId, null, e);
            });
            
            contextualRepulseBtn.addEventListener('click', (e) => {
                const context = repulseModal.querySelector('#repulseContext').value.trim();
                handleRePulse(pulseId, context, e);
            });
        }
        
        // NEW: Handle Re-Pulse
        async function handleRePulse(pulseId, context = null, e) {
            if (e) e.stopPropagation();
            
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    showToast('Please login to re-pulse', 'error');
                    return;
                }
                
                // Check if the pulse belongs to the current user
                if (currentPulse.user_id === session.user.id) {
                    showToast('Not allowed to re-pulse your own pulses', 'error');
                    return;
                }
                
                // Check if already re-pulsed
                const { data: existingRePulse } = await supabaseClient
                    .from('pulse_repulses')
                    .select('id')
                    .eq('pulse_id', pulseId)
                    .eq('user_id', session.user.id)
                    .maybeSingle();
                
                let isRepulsed;
                
                if (existingRePulse) {
                    // Remove re-pulse
                    const { error } = await supabaseClient
                        .from('pulse_repulses')
                        .delete()
                        .eq('id', existingRePulse.id);
                    
                    if (error) throw error;
                    
                    isRepulsed = false;
                    showToast('Re-pulse removed', 'success');
                } else {
                    // Check mention count
                    const mentionCount = countMentions(context || '');
                    if (mentionCount > 10) {
                        showToast('Cannot mention more than 10 users in a re-pulse', 'error');
                        return;
                    }
                    
                    // Add re-pulse
                    const { error } = await supabaseClient
                        .from('pulse_repulses')
                        .insert({
                            pulse_id: pulseId,
                            user_id: session.user.id,
                            context: context,
                            created_at: new Date().toISOString()
                        });
                    
                    if (error) throw error;
                    
                    isRepulsed = true;
                    
                    // Create notification for pulse creator
                    if (pulseCreator && pulseCreator.id !== session.user.id) {
                        const actorName = session.user.email.split('@')[0];
                        let message = `${actorName} re-pulsed your pulse`;
                        
                        if (context) {
                            message += ' with added context.';
                        } else {
                            message += '.';
                        }
                        
                        await createNotification(
                            'repulse',
                            session.user.id,
                            pulseCreator.id,
                            pulseId,
                            null,
                            message
                        );
                    }
                    
                    // Create notifications for mentioned users
                    if (context) {
                        const mentions = parseMentions(context).mentions;
                        for (const username of mentions) {
                            try {
                                const { data: mentionedUser } = await supabaseClient
                                    .from('user_profiles')
                                    .select('id')
                                    .eq('username', username)
                                    .single();
                                
                                if (mentionedUser && mentionedUser.id !== session.user.id && mentionedUser.id !== pulseCreator.id) {
                                    await createNotification(
                                        'mention',
                                        session.user.id,
                                        mentionedUser.id,
                                        pulseId,
                                        null,
                                        `${session.user.email.split('@')[0]} mentioned you in a re-pulse`
                                    );
                                }
                            } catch (err) {
                                console.error('Error creating mention notification:', err);
                            }
                        }
                    }
                    
                    showToast(context ? 'Re-pulsed with context!' : 'Re-pulsed!', 'success');
                }
                
                // Update UI immediately
                updateRePulseUI(pulseId, isRepulsed);
                
                // Close re-pulse modal if open
                if (currentRepulseModal) {
                    currentRepulseModal.remove();
                    currentRepulseModal = null;
                }
                
                // Update pulse stats
                await updatePulseStats(pulseId);
                
            } catch (error) {
                console.error('Re-pulse error:', error);
                showToast('Failed to re-pulse', 'error');
            }
        }
        
        // FIXED: Handle Save - fixed column name from created_at to saved_at
        async function handleSave(pulseId, e) {
            if (e) e.stopPropagation();
            
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    showToast('Please login to save pulses', 'error');
                    return;
                }
                
                // Check if already saved
                const { data: existingSave } = await supabaseClient
                    .from('saved_pulses')
                    .select('id')
                    .eq('pulse_id', pulseId)
                    .eq('user_id', session.user.id)
                    .maybeSingle();
                
                let isSaved;
                
                if (existingSave) {
                    // Remove save
                    const { error } = await supabaseClient
                        .from('saved_pulses')
                        .delete()
                        .eq('id', existingSave.id);
                    
                    if (error) throw error;
                    
                    isSaved = false;
                    showToast('Removed from saved', 'success');
                } else {
                    // Add save - FIXED: Use saved_at instead of created_at
                    const { error } = await supabaseClient
                        .from('saved_pulses')
                        .insert({
                            pulse_id: pulseId,
                            user_id: session.user.id,
                            saved_at: new Date().toISOString() // FIXED
                        });
                    
                    if (error) throw error;
                    
                    isSaved = true;
                    showToast('Pulse saved!', 'success');
                }
                
                // Update UI immediately
                updateSaveUI(pulseId, isSaved);
                
            } catch (error) {
                console.error('Save error:', error);
                showToast('Failed to save pulse', 'error');
            }
        }
        
        // NEW: Handle Connect
        async function handleConnect(pulseCreatorId, connectBtn) {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    showToast('Please login to connect with creators', 'error');
                    return;
                }
                
                if (pulseCreatorId === session.user.id) {
                    showToast('You cannot connect with yourself', 'error');
                    return;
                }
                
                const isConnected = userConnections.has(pulseCreatorId);
                
                connectBtn.classList.add('connecting');
                connectBtn.disabled = true;
                
                if (isConnected) {
                    const { error } = await supabaseClient
                        .from('connectors')
                        .delete()
                        .eq('connector_id', session.user.id)
                        .eq('connected_id', pulseCreatorId);
                    
                    if (error) throw error;
                    
                    userConnections.delete(pulseCreatorId);
                    
                    setTimeout(() => {
                        connectBtn.classList.remove('connected');
                        connectBtn.classList.remove('connecting');
                        connectBtn.innerHTML = '<i class="fas fa-user-plus" aria-hidden="true"></i>';
                        connectBtn.disabled = false;
                    }, 600);
                    
                    showToast('Disconnected from creator', 'success');
                } else {
                    const { error } = await supabaseClient
                        .from('connectors')
                        .insert({
                            connector_id: session.user.id,
                            connected_id: pulseCreatorId,
                            connection_type: 'creator',
                            created_at: new Date().toISOString()
                        });
                    
                    if (error) {
                        if (error.code === '23505') {
                            userConnections.add(pulseCreatorId);
                        } else {
                            throw error;
                        }
                    } else {
                        userConnections.add(pulseCreatorId);
                    }
                    
                    setTimeout(() => {
                        connectBtn.classList.add('connected');
                        connectBtn.classList.remove('connecting');
                        connectBtn.innerHTML = '<i class="fas fa-user-check" aria-hidden="true"></i>';
                        connectBtn.disabled = false;
                    }, 600);
                    
                    // Create notification for the connected user
                    await createNotification(
                        'connect',
                        session.user.id,
                        pulseCreatorId,
                        pulseId,
                        null,
                        `${session.user.email.split('@')[0]} has connected with you`
                    );
                    
                    showToast('Connected with creator!', 'success');
                }
                
            } catch (error) {
                console.error('Error handling connection:', error);
                connectBtn.classList.remove('connecting');
                connectBtn.disabled = false;
                showToast('Failed to update connection', 'error');
            }
        }
        
        // NEW: Parse mentions in text with clickable links
        function parseMentions(text) {
            if (!text) return { text: '', mentions: [] };
            
            const mentionRegex = /@(\w+)/g;
            const mentions = [];
            let parsedText = text;
            
            let match;
            while ((match = mentionRegex.exec(text)) !== null) {
                mentions.push(match[1]);
            }
            
            parsedText = parsedText.replace(/@(\w+)/g, '<span class="mention" data-username="$1" onclick="navigateToProfile(\'$1\')">@$1</span>');
            
            return { text: parsedText, mentions };
        }
        
        // NEW: Navigate to profile when mention is clicked
        function navigateToProfile(username) {
            event.stopPropagation();
            window.location.href = `profile.html?username=${username}`;
        }
        
        // NEW: Count mentions in text
        function countMentions(text) {
            if (!text) return 0;
            const mentionRegex = /@(\w+)/g;
            const matches = text.match(mentionRegex);
            return matches ? matches.length : 0;
        }
        
        // NEW: Update mention counter
        function updateMentionCounter(textarea, counterId) {
            const count = countMentions(textarea.value);
            const counter = document.getElementById(counterId);
            if (counter) {
                counter.textContent = `${count}/10 mentions`;
                if (count >= 10) {
                    counter.classList.add('error');
                    counter.classList.remove('warning');
                } else if (count >= 8) {
                    counter.classList.add('warning');
                    counter.classList.remove('error');
                } else {
                    counter.classList.remove('warning', 'error');
                }
            }
            return count;
        }
        
        // NEW: Fetch user suggestions for mentions
        async function fetchMentionSuggestions(query) {
            if (!query || query.length < 1) return [];
            
            try {
                if (mentionAbortController) {
                    mentionAbortController.abort();
                }
                
                mentionAbortController = new AbortController();
                
                const { data: users, error } = await supabaseClient
                    .from('user_profiles')
                    .select('id, username, full_name, avatar_url')
                    .ilike('username', `%${query}%`)
                    .limit(10);
                
                if (error) throw error;
                
                return users || [];
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Error fetching mention suggestions:', error);
                }
                return [];
            }
        }
        
        // NEW: Show mention autocomplete
        function showMentionAutocomplete(textarea, containerId, cursorPosition, query) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (mentionDebounceTimeout) {
                clearTimeout(mentionDebounceTimeout);
            }
            
            mentionDebounceTimeout = setTimeout(async () => {
                const suggestions = await fetchMentionSuggestions(query);
                mentionSuggestions = suggestions;
                
                if (suggestions.length === 0) {
                    container.innerHTML = '';
                    container.style.display = 'none';
                    mentionAutocompleteActive = false;
                    return;
                }
                
                container.innerHTML = suggestions.map((user, index) => `
                    <div class="mention-suggestion ${index === 0 ? 'selected' : ''}" 
                         data-username="${user.username}"
                         data-user-id="${user.id}"
                         onclick="insertMention('${textarea.id}', '${containerId}', '${user.username}')">
                        <div class="mention-suggestion-avatar" style="${user.avatar_url ? `background-image: url('${user.avatar_url}'); background-size: cover;` : ''}">
                            ${user.avatar_url ? '' : (user.full_name || user.username).substring(0, 2).toUpperCase()}
                        </div>
                        <div>
                            <div class="mention-suggestion-username">@${user.username}</div>
                            <div class="mention-suggestion-name">${user.full_name || ''}</div>
                        </div>
                    </div>
                `).join('');
                
                const textareaRect = textarea.getBoundingClientRect();
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                container.style.position = 'fixed';
                container.style.top = `${textareaRect.bottom + scrollTop}px`;
                container.style.left = `${textareaRect.left}px`;
                container.style.width = `${textareaRect.width}px`;
                container.style.display = 'block';
                container.style.zIndex = '2000';
                
                mentionAutocompleteActive = true;
                
                container.dataset.textareaId = textarea.id;
                container.dataset.containerId = containerId;
            }, 300);
        }
        
        // NEW: Hide mention autocomplete
        function hideMentionAutocomplete(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                container.style.display = 'none';
                mentionAutocompleteActive = false;
                mentionSuggestions = [];
            }
        }
        
        // NEW: Insert mention into textarea
        function insertMention(textareaId, containerId, username) {
            const textarea = document.getElementById(textareaId);
            if (!textarea) return;
            
            const value = textarea.value;
            const before = value.substring(0, currentMentionStart);
            const after = value.substring(currentMentionStart + currentMentionQuery.length + 1);
            
            textarea.value = before + '@' + username + ' ' + after;
            textarea.focus();
            
            const newCursorPos = before.length + username.length + 2;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            
            updateMentionCounter(textarea, textareaId === 'commentInput' ? 'commentMentionCounter' : 'repulseMentionCounter');
            
            hideMentionAutocomplete(containerId);
            
            textarea.dispatchEvent(new Event('input'));
        }
        
        // NEW: Setup mention autocomplete for a textarea
        function setupMentionAutocomplete(textarea, autocompleteId, counterId) {
            if (!textarea) return;
            
            textarea.addEventListener('input', function(e) {
                updateMentionCounter(this, counterId);
                
                const cursorPos = this.selectionStart;
                const textBeforeCursor = this.value.substring(0, cursorPos);
                const lastAtIndex = textBeforeCursor.lastIndexOf('@');
                
                if (lastAtIndex >= 0 && 
                    (lastAtIndex === 0 || textBeforeCursor[lastAtIndex - 1] === ' ' || 
                     textBeforeCursor[lastAtIndex - 1] === '\n' || textBeforeCursor[lastAtIndex - 1] === '\t')) {
                    
                    const query = textBeforeCursor.substring(lastAtIndex + 1);
                    const lastSpace = query.lastIndexOf(' ');
                    
                    if (lastSpace === -1) {
                        currentMentionStart = lastAtIndex;
                        currentMentionQuery = query;
                        showMentionAutocomplete(this, autocompleteId, cursorPos, query);
                        return;
                    }
                }
                
                hideMentionAutocomplete(autocompleteId);
            });
            
            textarea.addEventListener('keydown', function(e) {
                const autocomplete = document.getElementById(autocompleteId);
                if (!autocomplete || autocomplete.style.display === 'none') return;
                
                const selected = autocomplete.querySelector('.mention-suggestion.selected');
                if (!selected) return;
                
                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        const next = selected.nextElementSibling;
                        if (next && next.classList.contains('mention-suggestion')) {
                            selected.classList.remove('selected');
                            next.classList.add('selected');
                            next.scrollIntoView({ block: 'nearest' });
                        }
                        break;
                        
                    case 'ArrowUp':
                        e.preventDefault();
                        const prev = selected.previousElementSibling;
                        if (prev && prev.classList.contains('mention-suggestion')) {
                            selected.classList.remove('selected');
                            prev.classList.add('selected');
                            prev.scrollIntoView({ block: 'nearest' });
                        }
                        break;
                        
                    case 'Enter':
                        e.preventDefault();
                        const username = selected.dataset.username;
                        insertMention(this.id, autocompleteId, username);
                        break;
                        
                    case 'Escape':
                        e.preventDefault();
                        hideMentionAutocomplete(autocompleteId);
                        break;
                }
            });
            
            document.addEventListener('click', function(e) {
                const autocomplete = document.getElementById(autocompleteId);
                if (autocomplete && !autocomplete.contains(e.target) && e.target !== textarea) {
                    hideMentionAutocomplete(autocompleteId);
                }
            });
        }
        
        // NEW: Toggle hidden re-pulses
        function toggleHiddenRepulses(pulseId) {
            const hiddenDiv = document.getElementById(`hidden-repulses-${pulseId}`);
            const button = document.querySelector(`button[data-pulse-id="${pulseId}"]`);
            
            if (!hiddenDiv || !button) return;
            
            if (hiddenDiv.classList.contains('expanded')) {
                hiddenDiv.classList.remove('expanded');
                const count = hiddenDiv.children.length;
                button.innerHTML = `<i class="fas fa-chevron-down"></i> Show ${count} more re-pulse${count !== 1 ? 's' : ''}`;
            } else {
                hiddenDiv.classList.add('expanded');
                button.innerHTML = `<i class="fas fa-chevron-up"></i> Hide re-pulses`;
            }
        }
        
        // NEW: Load re-pulse contexts
        async function loadRepulseContexts(pulseId) {
            try {
                const { data: repulses, error } = await supabaseClient
                    .from('pulse_repulses')
                    .select(`
                        context, 
                        created_at,
                        user_profiles!pulse_repulses_user_id_fkey (
                            username,
                            full_name,
                            avatar_url
                        )
                    `)
                    .eq('pulse_id', pulseId)
                    .order('created_at', { ascending: true });
                
                if (error || !repulses || repulses.length === 0) {
                    return '';
                }
                
                const hasContext = repulses.some(ctx => ctx.context);
                const hasMultiple = repulses.length > 2;
                
                let repulseContextHTML = '';
                
                if (hasContext) {
                    const contextualRepulses = repulses.filter(ctx => ctx.context);
                    const latestContextual = contextualRepulses[contextualRepulses.length - 1];
                    
                    if (latestContextual) {
                        const otherContextual = contextualRepulses.slice(0, -1);
                        const hasHiddenContextual = otherContextual.length > 0;
                        
                        repulseContextHTML = `
                            <div class="repulse-context">
                                <div class="repulse-context-user">@${latestContextual.user_profiles?.username || 'user'} re-pulsed with context:</div>
                                <div>${latestContextual.context}</div>
                                ${hasMultiple ? `
                                    <div class="repulse-hidden-contexts" id="hidden-repulses-${pulseId}">
                                        ${otherContextual.map(ctx => `
                                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(245, 158, 11, 0.2);">
                                                <div class="repulse-context-user">@${ctx.user_profiles?.username || 'user'} re-pulsed with context:</div>
                                                <div>${ctx.context}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <button class="repulse-expand-toggle" onclick="toggleHiddenRepulses('${pulseId}')" data-pulse-id="${pulseId}">
                                        <i class="fas fa-chevron-down"></i>
                                        Show ${otherContextual.length} more re-pulse${otherContextual.length !== 1 ? 's' : ''}
                                    </button>
                                ` : ''}
                            </div>
                        `;
                    }
                } else {
                    const latestRepulse = repulses[repulses.length - 1];
                    const otherRepulses = repulses.slice(0, -1);
                    const hasHiddenRepulses = otherRepulses.length > 0;
                    
                    repulseContextHTML = `
                        <div class="repulse-context">
                            <div class="repulse-context-user">@${latestRepulse.user_profiles?.username || 'user'} re-pulsed this pulse</div>
                            ${hasMultiple ? `
                                <div class="repulse-hidden-contexts" id="hidden-repulses-${pulseId}">
                                    ${otherRepulses.map(ctx => `
                                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(245, 158, 11, 0.2);">
                                            <div class="repulse-context-user">@${ctx.user_profiles?.username || 'user'} re-pulsed this pulse</div>
                                        </div>
                                    `).join('')}
                                </div>
                                <button class="repulse-expand-toggle" onclick="toggleHiddenRepulses('${pulseId}')" data-pulse-id="${pulseId}">
                                    <i class="fas fa-chevron-down"></i>
                                    Show ${otherRepulses.length} more re-pulse${otherRepulses.length !== 1 ? 's' : ''}
                                </button>
                            ` : ''}
                        </div>
                    `;
                }
                
                return repulseContextHTML;
                
            } catch (error) {
                console.error('Error loading re-pulse contexts:', error);
                return '';
            }
        }
        
        // NEW: Update pulse stats
        async function updatePulseStats(pulseId) {
            try {
                // Get taps count
                const { count: tapsCount } = await supabaseClient
                    .from('pulse_taps')
                    .select('*', { count: 'exact', head: true })
                    .eq('pulse_id', pulseId);
                
                // Get comments count
                const { count: commentsCount } = await supabaseClient
                    .from('pulse_comments')
                    .select('*', { count: 'exact', head: true })
                    .eq('pulse_id', pulseId)
                    .is('is_removed', false);
                
                // Get repulses count
                const { count: repulsesCount } = await supabaseClient
                    .from('pulse_repulses')
                    .select('*', { count: 'exact', head: true })
                    .eq('pulse_id', pulseId);
                
                // Update stats display
                const statsContainer = document.getElementById('pulse-stats');
                if (statsContainer) {
                    statsContainer.innerHTML = '';
                    
                    if (tapsCount > 0) {
                        const tapStat = document.createElement('span');
                        tapStat.className = 'stat-item';
                        tapStat.innerHTML = `<i class="fas fa-hand-point-up"></i> ${tapsCount} felt`;
                        statsContainer.appendChild(tapStat);
                    }
                    
                    if (commentsCount > 0) {
                        const commentStat = document.createElement('span');
                        commentStat.className = 'stat-item';
                        commentStat.innerHTML = `<i class="fas fa-comment"></i> ${commentsCount} comments`;
                        statsContainer.appendChild(commentStat);
                        document.getElementById('comment-count').textContent = commentsCount;
                    } else {
                        document.getElementById('comment-count').textContent = '0';
                    }
                    
                    if (repulsesCount > 0) {
                        const repulseStat = document.createElement('span');
                        repulseStat.className = 'stat-item';
                        repulseStat.innerHTML = `<i class="fas fa-retweet"></i> ${repulsesCount} re-pulses`;
                        statsContainer.appendChild(repulseStat);
                        document.getElementById('repulse-count').textContent = repulsesCount;
                    } else {
                        document.getElementById('repulse-count').textContent = '0';
                    }
                }
                
            } catch (error) {
                console.error('Error updating pulse stats:', error);
            }
        }
        
        // UPDATED: Load comments with comment likes
        async function loadComments() {
            try {
                console.log('Loading comments for pulse:', pulseId);
                
                // Fetch comments with user profiles
                const { data: comments, error } = await supabaseClient
                    .from('pulse_comments')
                    .select(`
                        *,
                        user_profiles!pulse_comments_user_id_fkey (
                            id,
                            username,
                            full_name,
                            avatar_url
                        )
                    `)
                    .eq('pulse_id', pulseId)
                    .eq('is_removed', false)
                    .order('created_at', { ascending: true });
                
                if (error) {
                    console.error('Error loading comments:', error);
                    // Fallback: try without the join
                    const { data: commentsData, error: simpleError } = await supabaseClient
                        .from('pulse_comments')
                        .select('*')
                        .eq('pulse_id', pulseId)
                        .eq('is_removed', false)
                        .order('created_at', { ascending: true });
                    
                    if (simpleError) throw simpleError;
                    
                    // Manually fetch user profiles
                    const commentsWithUsers = await Promise.all(commentsData.map(async (comment) => {
                        const { data: userProfile } = await supabaseClient
                            .from('user_profiles')
                            .select('id, username, full_name, avatar_url')
                            .eq('id', comment.user_id)
                            .single();
                        
                        return {
                            ...comment,
                            user_profiles: userProfile || { username: 'user', full_name: 'User' }
                        };
                    }));
                    
                    // Check which comments the current user has liked
                    const commentIds = commentsWithUsers.map(comment => comment.id);
                    const { data: userLikes } = await supabaseClient
                        .from('pulse_comments_likes')
                        .select('comment_id')
                        .eq('user_id', currentUserId)
                        .in('comment_id', commentIds);
                    
                    const likedCommentIds = new Set(userLikes?.map(like => like.comment_id) || []);
                    
                    commentsWithUsers.forEach(comment => {
                        comment.is_liked = likedCommentIds.has(comment.id);
                    });
                    
                    displayComments(commentsWithUsers);
                    return;
                }
                
                // Check which comments the current user has liked
                const commentIds = comments.map(comment => comment.id);
                const { data: userLikes } = await supabaseClient
                    .from('pulse_comments_likes')
                    .select('comment_id')
                    .eq('user_id', currentUserId)
                    .in('comment_id', commentIds);
                
                const likedCommentIds = new Set(userLikes?.map(like => like.comment_id) || []);
                
                comments.forEach(comment => {
                    comment.is_liked = likedCommentIds.has(comment.id);
                });
                
                displayComments(comments || []);
                
            } catch (error) {
                console.error('Error loading comments:', error);
                document.getElementById('commentsThread').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-comment-slash"></i>
                        </div>
                        <div class="empty-title">Failed to load comments</div>
                        <div class="empty-description">Please try again later.</div>
                    </div>
                `;
                showToast('Failed to load comments', 'error');
            }
        }
        
        function displayComments(comments) {
            const commentsThread = document.getElementById('commentsThread');
            
            if (!comments || comments.length === 0) {
                commentsThread.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="empty-title">No comments yet</div>
                        <div class="empty-description">Be the first to share your thoughts on this pulse.</div>
                    </div>
                `;
                return;
            }
            
            let commentsHTML = '';
            
            comments.forEach(comment => {
                const user = comment.user_profiles || {};
                const commentDate = new Date(comment.created_at);
                const timeAgo = getTimeAgo(commentDate);
                const parsedComment = parseMentions(comment.comment_text);
                
                commentsHTML += `
                    <div class="comment-item" id="comment-${comment.id}">
                        <div class="comment-header">
                            <div class="comment-avatar" onclick="viewUserProfile('${user.id}')">
                                ${user.avatar_url ? 
                                    `<img src="${user.avatar_url}" alt="${user.full_name || user.username}">` : 
                                    getInitials(user.full_name || user.username)
                                }
                            </div>
                            <div class="comment-meta">
                                <div class="comment-name" onclick="viewUserProfile('${user.id}')">${user.full_name || 'User'}</div>
                                <div class="comment-handle">@${user.username || 'user'}  <span class="comment-time">${timeAgo}</span></div>
                            </div>
                            ${comment.user_id === currentUserId ? `
                                <div class="comment-options">
                                    <button class="comment-options-btn" onclick="toggleCommentOptions('${comment.id}')">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>
                                    <div class="comment-options-menu" id="comment-options-${comment.id}">
                                        <button class="comment-option-item" onclick="editComment('${comment.id}')">
                                            <i class="fas fa-edit"></i>
                                            Edit
                                        </button>
                                        <button class="comment-option-item delete" onclick="deleteComment('${comment.id}')">
                                            <i class="fas fa-trash"></i>
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="comment-text">${parsedComment.text}</div>
                        <div class="comment-actions">
                            <button class="comment-action ${comment.is_liked ? 'liked' : ''}" 
                                    onclick="likeComment('${comment.id}', ${comment.likes_count || 0})"
                                    id="like-comment-${comment.id}">
                                <i class="fas fa-heart"></i>
                                <span id="comment-likes-${comment.id}">${comment.likes_count || 0}</span>
                            </button>
                            <button class="comment-action" onclick="showReplyComposer('${comment.id}')">
                                <i class="fas fa-reply"></i>
                                Reply
                            </button>
                        </div>
                        <div class="reply-composer" id="reply-composer-${comment.id}">
                            <textarea class="reply-input" id="reply-input-${comment.id}" placeholder="Write a reply..." rows="1"></textarea>
                            <button class="post-reply-btn" onclick="postReply('${comment.id}')">Reply</button>
                        </div>
                    </div>
                `;
            });
            
            commentsThread.innerHTML = commentsHTML;
        }
        
        // UPDATED: Enhanced comment posting with mentions
        async function postCommentWithMentions() {
            const commentInput = document.getElementById('commentInput');
            const commentText = commentInput.value.trim();
            
            if (!commentText) {
                showToast('Please enter a comment', 'error');
                return;
            }
            
            try {
                // Check mention count
                const mentionCount = countMentions(commentText);
                if (mentionCount > 10) {
                    showToast('Cannot mention more than 10 users in a comment', 'error');
                    return;
                }
                
                // Insert comment
                const { data: newComment, error } = await supabaseClient
                    .from('pulse_comments')
                    .insert({
                        pulse_id: pulseId,
                        user_id: currentUserId,
                        comment_text: commentText,
                        likes_count: 0,
                        created_at: new Date().toISOString()
                    })
                    .select()
                    .single();
                
                if (error) {
                    console.error('Error posting comment:', error);
                    throw error;
                }
                
                // Clear input
                commentInput.value = '';
                document.getElementById('postCommentBtn').disabled = true;
                updateMentionCounter(commentInput, 'commentMentionCounter');
                
                // Create notification for pulse creator
                if (pulseCreator && pulseCreator.id !== currentUserId) {
                    await createNotification(
                        'comment',
                        currentUserId,
                        pulseCreator.id,
                        pulseId,
                        newComment.id,
                        `${currentSession.user.email.split('@')[0]} commented on your pulse`
                    );
                }
                
                // Create notifications for mentioned users
                const mentions = parseMentions(commentText).mentions;
                for (const username of mentions) {
                    try {
                        const { data: mentionedUser } = await supabaseClient
                            .from('user_profiles')
                            .select('id')
                            .eq('username', username)
                            .single();
                        
                        if (mentionedUser && mentionedUser.id !== currentUserId && mentionedUser.id !== pulseCreator.id) {
                            await createNotification(
                                'mention',
                                currentUserId,
                                mentionedUser.id,
                                pulseId,
                                newComment.id,
                                `${currentSession.user.email.split('@')[0]} mentioned you in a comment`
                            );
                        }
                    } catch (err) {
                        console.error('Error creating mention notification:', err);
                    }
                }
                
                // Update comment count
                await updateCommentCount();
                
                // Reload comments
                loadComments();
                
                showToast('Comment posted!', 'success');
                
            } catch (error) {
                console.error('Error posting comment:', error);
                showToast('Failed to post comment', 'error');
            }
        }
        
        // UPDATED: Update comment count
        async function updateCommentCount() {
            try {
                const { count, error } = await supabaseClient
                    .from('pulse_comments')
                    .select('*', { count: 'exact', head: true })
                    .eq('pulse_id', pulseId)
                    .is('is_removed', false);
                
                if (!error && count !== null) {
                    document.getElementById('comment-count').textContent = count;
                    
                    // Update pulse comment count
                    await supabaseClient
                        .from('pulses')
                        .update({ comments_count: count })
                        .eq('id', pulseId);
                }
            } catch (error) {
                console.error('Error updating comment count:', error);
            }
        }
        
        // FIXED: Like Comment - Updated to use pulse_comments_likes table
        async function likeComment(commentId, currentLikes) {
            if (isProcessingLike[commentId]) return;
            isProcessingLike[commentId] = true;
            
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    showToast('Please login to like comments', 'error');
                    return;
                }
                
                // Check if already liked using pulse_comments_likes table
                const { data: existingLike } = await supabaseClient
                    .from('pulse_comments_likes')
                    .select('id')
                    .eq('comment_id', commentId)
                    .eq('user_id', session.user.id)
                    .maybeSingle();
                
                const likeBtn = document.getElementById(`like-comment-${commentId}`);
                const likesSpan = document.getElementById(`comment-likes-${commentId}`);
                
                if (existingLike) {
                    // Unlike
                    const { error } = await supabaseClient
                        .from('pulse_comments_likes')
                        .delete()
                        .eq('id', existingLike.id);
                    
                    if (error) throw error;
                    
                    likeBtn.classList.remove('liked');
                    likesSpan.textContent = currentLikes - 1;
                    showToast('Comment unliked', 'success');
                } else {
                    // Like
                    const { error } = await supabaseClient
                        .from('pulse_comments_likes')
                        .insert({
                            comment_id: commentId,
                            user_id: session.user.id,
                            created_at: new Date().toISOString()
                        });
                    
                    if (error) throw error;
                    
                    likeBtn.classList.add('liked');
                    likesSpan.textContent = currentLikes + 1;
                    showToast('Comment liked!', 'success');
                    
                    // Get comment to notify owner
                    const { data: comment } = await supabaseClient
                        .from('pulse_comments')
                        .select('user_id')
                        .eq('id', commentId)
                        .single();
                    
                    if (comment && comment.user_id !== session.user.id) {
                        await createNotification(
                            'like',
                            session.user.id,
                            comment.user_id,
                            pulseId,
                            commentId,
                            `${session.user.email.split('@')[0]} liked your comment`
                        );
                    }
                }
                
            } catch (error) {
                console.error('Error liking comment:', error);
                showToast('Failed to like comment', 'error');
            } finally {
                isProcessingLike[commentId] = false;
            }
        }
        
        function toggleCommentOptions(commentId) {
            const menu = document.getElementById(`comment-options-${commentId}`);
            const allMenus = document.querySelectorAll('.comment-options-menu');
            
            allMenus.forEach(m => {
                if (m.id !== `comment-options-${commentId}`) {
                    m.classList.remove('active');
                }
            });
            
            menu.classList.toggle('active');
        }
        
        function editComment(commentId) {
            const commentElement = document.getElementById(`comment-${commentId}`);
            const commentText = commentElement.querySelector('.comment-text').textContent;
            
            editingCommentId = commentId;
            document.getElementById('editCommentInput').value = commentText;
            document.getElementById('editCommentModal').style.display = 'flex';
            
            // Close all comment option menus
            document.querySelectorAll('.comment-options-menu').forEach(menu => {
                menu.classList.remove('active');
            });
        }
        
        async function saveEditedComment() {
            if (!editingCommentId) return;
            
            const editedText = document.getElementById('editCommentInput').value.trim();
            
            if (!editedText) {
                showToast('Comment cannot be empty', 'error');
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('pulse_comments')
                    .update({
                        comment_text: editedText,
                        is_edited: true,
                        edited_at: new Date().toISOString()
                    })
                    .eq('id', editingCommentId);
                
                if (error) throw error;
                
                showToast('Comment updated', 'success');
                closeEditCommentModalFunc();
                loadComments();
                
            } catch (error) {
                console.error('Error updating comment:', error);
                showToast('Failed to update comment', 'error');
            }
        }
        
        async function deleteComment(commentId) {
            if (!confirm('Are you sure you want to delete this comment? This action cannot be undone.')) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('pulse_comments')
                    .update({
                        is_removed: true,
                        removed_reason: 'user_deleted'
                    })
                    .eq('id', commentId);
                
                if (error) throw error;
                
                showToast('Comment deleted', 'success');
                loadComments();
                updateCommentCount();
                
            } catch (error) {
                console.error('Error deleting comment:', error);
                showToast('Failed to delete comment', 'error');
            }
        }
        
        function showReplyComposer(commentId) {
            const replyComposer = document.getElementById(`reply-composer-${commentId}`);
            const allComposers = document.querySelectorAll('.reply-composer');
            
            allComposers.forEach(composer => {
                if (composer.id !== `reply-composer-${commentId}`) {
                    composer.classList.remove('active');
                }
            });
            
            replyComposer.classList.toggle('active');
            
            if (replyComposer.classList.contains('active')) {
                const replyInput = document.getElementById(`reply-input-${commentId}`);
                replyInput.focus();
            }
        }
        
        async function postReply(commentId) {
            const replyInput = document.getElementById(`reply-input-${commentId}`);
            const replyText = replyInput.value.trim();
            
            if (!replyText) {
                showToast('Please enter a reply', 'error');
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('pulse_comments')
                    .insert({
                        pulse_id: pulseId,
                        user_id: currentUserId,
                        comment_text: replyText,
                        parent_comment_id: commentId,
                        likes_count: 0,
                        created_at: new Date().toISOString()
                    });
                
                if (error) throw error;
                
                replyInput.value = '';
                showReplyComposer(commentId);
                showToast('Reply posted', 'success');
                loadComments();
                updateCommentCount();
                
            } catch (error) {
                console.error('Error posting reply:', error);
                showToast('Failed to post reply', 'error');
            }
        }
        
        // NEW: Continue Series Functionality
        async function continueSeries() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    showToast('Please login to continue series', 'error');
                    return;
                }
                
                // Check if user is the creator
                if (currentPulse.user_id !== currentUserId) {
                    showToast('Only the creator can continue a series', 'error');
                    return;
                }
                
                // Close the more menu
                document.getElementById('moreMenu').classList.remove('active');
                
                // If pulse is already part of a series, continue it
                if (currentPulse.series_id) {
                    // Get series details
                    const { data: series } = await supabaseClient
                        .from('pulse_series')
                        .select('*')
                        .eq('id', currentPulse.series_id)
                        .single();
                    
                    if (!series) {
                        showToast('Series not found', 'error');
                        return;
                    }
                    
                    // Check if series has reached max parts
                    if (series.total_parts && currentPulse.series_order >= series.total_parts) {
                        showToast('Series has reached maximum number of parts', 'error');
                        return;
                    }
                    
                    // Show confirmation modal
                    document.getElementById('currentSeriesTitle').textContent = series.title || 'Untitled Series';
                    document.getElementById('nextSeriesPart').textContent = (currentPulse.series_order || 1) + 1;
                    document.getElementById('continueSeriesModal').style.display = 'flex';
                    
                } else {
                    // Pulse is not part of a series, create a new series
                    document.getElementById('createSeriesModal').style.display = 'flex';
                }
                
            } catch (error) {
                console.error('Error continuing series:', error);
                showToast('Failed to continue series', 'error');
            }
        }
        
        // NEW: Handle confirm continue series
        async function confirmContinueSeries() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) return;
                
                // Get series details
                const { data: series } = await supabaseClient
                    .from('pulse_series')
                    .select('*')
                    .eq('id', currentPulse.series_id)
                    .single();
                
                if (!series) {
                    showToast('Series not found', 'error');
                    return;
                }
                
                // Update series total parts if needed
                const nextPart = (currentPulse.series_order || 1) + 1;
                if (series.total_parts && nextPart > series.total_parts) {
                    await supabaseClient
                        .from('pulse_series')
                        .update({ total_parts: nextPart })
                        .eq('id', series.id);
                }
                
                // Redirect to create pulse page with series info
                window.location.href = `create-pulse.html?series_id=${series.id}&part=${nextPart}&continue=true`;
                
            } catch (error) {
                console.error('Error confirming continue series:', error);
                showToast('Failed to continue series', 'error');
            }
        }
        
        // NEW: Handle create new series
        async function confirmCreateSeries() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) return;
                
                const seriesTitle = document.getElementById('seriesTitle').value.trim();
                const seriesDescription = document.getElementById('seriesDescription').value.trim();
                const totalParts = parseInt(document.getElementById('totalParts').value) || 10;
                
                if (!seriesTitle) {
                    showToast('Please enter a series title', 'error');
                    return;
                }
                
                if (totalParts < 2 || totalParts > 50) {
                    showToast('Total parts must be between 2 and 50', 'error');
                    return;
                }
                
                // Create new series
                const { data: newSeries, error } = await supabaseClient
                    .from('pulse_series')
                    .insert({
                        title: seriesTitle,
                        description: seriesDescription,
                        total_parts: totalParts,
                        created_by: currentUserId,
                        created_at: new Date().toISOString()
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Update current pulse to be part of this series (part 1)
                await supabaseClient
                    .from('pulses')
                    .update({
                        series_id: newSeries.id,
                        series_order: 1
                    })
                    .eq('id', pulseId);
                
                // Redirect to create pulse page for part 2
                window.location.href = `create-pulse.html?series_id=${newSeries.id}&part=2&continue=true`;
                
            } catch (error) {
                console.error('Error creating series:', error);
                showToast('Failed to create series', 'error');
            }
        }
        
        // UPDATED: Initialize event listeners with new features
        function initializeEventListeners() {
            // More options menu
            const moreBtn = document.getElementById('moreBtn');
            const moreMenu = document.getElementById('moreMenu');
            
            moreBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                moreMenu.classList.toggle('active');
            });
            
            document.addEventListener('click', (e) => {
                if (!moreBtn.contains(e.target) && !moreMenu.contains(e.target)) {
                    moreMenu.classList.remove('active');
                }
            });
            
            // Video controls
            const playPauseBtn = document.getElementById('playPauseBtn');
            const muteBtn = document.getElementById('muteBtn');
            const videoProgress = document.getElementById('videoProgress');
            const volumeSlider = document.getElementById('volumeSlider');
            
            if (playPauseBtn) {
                playPauseBtn.addEventListener('click', () => {
                    if (videoElement) {
                        if (isPlaying) {
                            videoElement.pause();
                        } else {
                            videoElement.play();
                        }
                    }
                });
            }
            
            if (muteBtn) {
                muteBtn.addEventListener('click', () => {
                    if (videoElement) {
                        videoElement.muted = !videoElement.muted;
                        isMuted = videoElement.muted;
                        muteBtn.innerHTML = isMuted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
                    }
                });
            }
            
            if (videoProgress && videoElement) {
                videoProgress.addEventListener('click', (e) => {
                    const rect = videoProgress.getBoundingClientRect();
                    const pos = (e.clientX - rect.left) / rect.width;
                    videoElement.currentTime = pos * videoElement.duration;
                });
            }
            
            if (volumeSlider && videoElement) {
                volumeSlider.addEventListener('click', (e) => {
                    const rect = volumeSlider.getBoundingClientRect();
                    const pos = (e.clientX - rect.left) / rect.width;
                    volume = Math.max(0, Math.min(1, pos));
                    videoElement.volume = volume;
                    document.getElementById('volumeSliderFilled').style.width = (volume * 100) + '%';
                });
            }
            
            // Media click to play/pause
            const mediaContainer = document.querySelector('.media-container');
            if (mediaContainer && videoElement) {
                mediaContainer.addEventListener('click', (e) => {
                    if (e.target === mediaContainer || e.target.classList.contains('video-controls-overlay')) {
                        if (isPlaying) {
                            videoElement.pause();
                        } else {
                            videoElement.play();
                        }
                    }
                });
            }
            
            // NEW: Tap button with long press
            const tapBtn = document.getElementById('tapBtn');
            if (tapBtn) {
                setupTapButtonEvents(tapBtn, pulseId);
            }
            
            // NEW: Comment button (scroll to comment input)
            const commentBtn = document.getElementById('commentBtn');
            commentBtn.addEventListener('click', () => {
                document.getElementById('commentInput').focus();
            });
            
            // NEW: Re-pulse button
            const repulseBtn = document.getElementById('repulseBtn');
            if (repulseBtn) {
                repulseBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showRePulseModal(pulseId, e);
                });
            }
            
            // FIXED: Save button
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleSave(pulseId, e);
                });
            }
            
            // NEW: Connect button
            const connectBtn = document.getElementById('connectBtn');
            if (connectBtn) {
                connectBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const creatorId = connectBtn.getAttribute('data-creator-id');
                    handleConnect(creatorId, connectBtn);
                });
            }
            
            // Save pulse button in menu
            const savePulseBtn = document.getElementById('savePulseBtn');
            savePulseBtn.addEventListener('click', () => {
                handleSave(pulseId, null);
                moreMenu.classList.remove('active');
            });
            
            // UPDATED: Continue series button
            const continueSeriesBtn = document.getElementById('continueSeriesBtn');
            if (continueSeriesBtn) {
                continueSeriesBtn.addEventListener('click', continueSeries);
            }
            
            // UPDATED: Edit pulse button
            const editPulseBtn = document.getElementById('editPulseBtn');
            if (editPulseBtn) {
                editPulseBtn.addEventListener('click', () => {
                    moreMenu.classList.remove('active');
                    window.location.href = `edit-pulse.html?id=${pulseId}`;
                });
            }
            
            // Report pulse button
            const reportPulseBtn = document.getElementById('reportPulseBtn');
            reportPulseBtn.addEventListener('click', handleReport);
            
            // Mute creator button
            const muteCreatorBtn = document.getElementById('muteCreatorBtn');
            muteCreatorBtn.addEventListener('click', handleMuteCreator);
            
            // Delete pulse button
            const deletePulseBtn = document.getElementById('deletePulseBtn');
            if (deletePulseBtn) {
                deletePulseBtn.addEventListener('click', handleDelete);
            }
            
            // Comment input
            const commentInput = document.getElementById('commentInput');
            const postCommentBtn = document.getElementById('postCommentBtn');
            
            commentInput.addEventListener('input', () => {
                const hasText = commentInput.value.trim().length > 0;
                postCommentBtn.disabled = !hasText;
                updateMentionCounter(commentInput, 'commentMentionCounter');
            });
            
            commentInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!postCommentBtn.disabled) {
                        postCommentWithMentions();
                    }
                }
            });
            
            // Post comment button
            postCommentBtn.addEventListener('click', postCommentWithMentions);
            
            // Share modal (existing)
            const closeShareModal = document.getElementById('closeShareModal');
            closeShareModal.addEventListener('click', closeShareModalFunc);
            
            document.getElementById('copyLinkOption').addEventListener('click', copyLink);
            document.getElementById('shareWhatsApp').addEventListener('click', shareToWhatsApp);
            document.getElementById('shareTwitter').addEventListener('click', shareToTwitter);
            document.getElementById('shareInstagram').addEventListener('click', shareToInstagram);
            document.getElementById('shareInternal').addEventListener('click', shareInternal);
            document.getElementById('addToSeries').addEventListener('click', addToSeries);
            
            document.getElementById('copyLinkBtn').addEventListener('click', copyLink);
            
            const shareModal = document.getElementById('shareModal');
            shareModal.addEventListener('click', (e) => {
                if (e.target === shareModal) {
                    closeShareModalFunc();
                }
            });
            
            // Edit comment modal
            const closeEditCommentModal = document.getElementById('closeEditCommentModal');
            const cancelEditComment = document.getElementById('cancelEditComment');
            const saveEditComment = document.getElementById('saveEditComment');
            
            closeEditCommentModal.addEventListener('click', closeEditCommentModalFunc);
            cancelEditComment.addEventListener('click', closeEditCommentModalFunc);
            saveEditComment.addEventListener('click', saveEditedComment);
            
            const editCommentModal = document.getElementById('editCommentModal');
            editCommentModal.addEventListener('click', (e) => {
                if (e.target === editCommentModal) {
                    closeEditCommentModalFunc();
                }
            });
            
            // NEW: Continue Series Modal
            const closeContinueSeriesModal = document.getElementById('closeContinueSeriesModal');
            const cancelContinueSeries = document.getElementById('cancelContinueSeries');
            const confirmContinueSeriesBtn = document.getElementById('confirmContinueSeries');
            
            closeContinueSeriesModal.addEventListener('click', () => {
                document.getElementById('continueSeriesModal').style.display = 'none';
            });
            
            cancelContinueSeries.addEventListener('click', () => {
                document.getElementById('continueSeriesModal').style.display = 'none';
            });
            
            confirmContinueSeriesBtn.addEventListener('click', confirmContinueSeries);
            
            const continueSeriesModal = document.getElementById('continueSeriesModal');
            continueSeriesModal.addEventListener('click', (e) => {
                if (e.target === continueSeriesModal) {
                    continueSeriesModal.style.display = 'none';
                }
            });
            
            // NEW: Create Series Modal
            const closeCreateSeriesModal = document.getElementById('closeCreateSeriesModal');
            const cancelCreateSeries = document.getElementById('cancelCreateSeries');
            const confirmCreateSeriesBtn = document.getElementById('confirmCreateSeries');
            
            closeCreateSeriesModal.addEventListener('click', () => {
                document.getElementById('createSeriesModal').style.display = 'none';
            });
            
            cancelCreateSeries.addEventListener('click', () => {
                document.getElementById('createSeriesModal').style.display = 'none';
            });
            
            confirmCreateSeriesBtn.addEventListener('click', confirmCreateSeries);
            
            const createSeriesModal = document.getElementById('createSeriesModal');
            createSeriesModal.addEventListener('click', (e) => {
                if (e.target === createSeriesModal) {
                    createSeriesModal.style.display = 'none';
                }
            });
            
            // Listen for auth changes
            supabaseClient.auth.onAuthStateChange((event, session) => {
                console.log(' Auth state changed:', event);
                
                if (event === 'SIGNED_OUT') {
                    window.location.href = 'login.html';
                }
            });
        }
        
        // Existing helper functions
        function handleReport() {
            showToast('Report submitted. Our team will review this pulse.', 'success');
            document.getElementById('moreMenu').classList.remove('active');
        }
        
        async function handleMuteCreator() {
            if (!pulseCreator) return;
            
            try {
                const mutedCreators = JSON.parse(localStorage.getItem('muted_creators') || '[]');
                if (!mutedCreators.includes(pulseCreator.id)) {
                    mutedCreators.push(pulseCreator.id);
                    localStorage.setItem('muted_creators', JSON.stringify(mutedCreators));
                }
                
                showToast(`You won't see pulses from @${pulseCreator.username} anymore`, 'success');
                document.getElementById('moreMenu').classList.remove('active');
                
            } catch (error) {
                console.error('Error muting creator:', error);
                showToast('Failed to mute creator', 'error');
            }
        }
        
        async function handleDelete() {
            if (!confirm('Are you sure you want to PERMANENTLY delete this pulse? This action cannot be undone.')) {
                return;
            }
            
            try {
                console.log('Attempting to delete pulse:', pulseId, 'User:', currentUserId);
                
                const { error } = await supabaseClient
                    .from('pulses')
                    .delete()
                    .eq('id', pulseId);
                
                if (error) {
                    console.error('Direct delete failed:', error);
                    
                    const { error: updateError } = await supabaseClient
                        .from('pulses')
                        .update({ 
                            deleted_at: new Date().toISOString(),
                            caption: '[Deleted]',
                            media_url: null,
                            media_type: null
                        })
                        .eq('id', pulseId);
                    
                    if (updateError) {
                        console.error('Mark as deleted also failed:', updateError);
                        throw updateError;
                    } else {
                        showToast('Pulse marked as deleted', 'success');
                    }
                } else {
                    showToast('Pulse deleted permanently', 'success');
                }
                
                setTimeout(() => {
                    window.location.href = 'pulse-feed.html';
                }, 1500);
                
            } catch (error) {
                console.error('Error deleting pulse:', error);
                
                if (error.message && error.message.includes('policy')) {
                    showToast('Permission denied. Check RLS policies for DELETE on pulses table.', 'error');
                } else {
                    showToast('Failed to delete pulse: ' + error.message, 'error');
                }
            }
        }
        
        function closeShareModalFunc() {
            document.getElementById('shareModal').style.display = 'none';
        }
        
        function copyLink() {
            const shareLink = document.getElementById('shareLink');
            shareLink.select();
            document.execCommand('copy');
            
            showToast('Pulse link copied', 'success');
            closeShareModalFunc();
        }
        
        function shareToWhatsApp() {
            const text = `Check out this pulse on Bantu Connect Pulse!`;
            const url = `${window.location.origin}/pulse-content-detail.html?id=${pulseId}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`, '_blank');
            closeShareModalFunc();
        }
        
        function shareToTwitter() {
            const text = `Check out this pulse on Bantu Connect Pulse!`;
            const url = `${window.location.origin}/pulse-content-detail.html?id=${pulseId}`;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
            closeShareModalFunc();
        }
        
        function shareToInstagram() {
            showToast('Share to Instagram coming soon!', 'success');
            closeShareModalFunc();
        }
        
        async function shareInternal() {
            try {
                const { error } = await supabaseClient
                    .from('pulse_shares')
                    .insert({
                        pulse_id: pulseId,
                        user_id: currentUserId,
                        share_type: 'internal',
                        share_platform: 'internal',
                        created_at: new Date().toISOString()
                    });
                
                if (error) throw error;
                
                showToast('Pulse shared internally!', 'success');
                closeShareModalFunc();
                
            } catch (error) {
                console.error('Error sharing internally:', error);
                showToast('Failed to share pulse', 'error');
            }
        }
        
        function addToSeries() {
            showToast('Add to Series feature coming soon!', 'success');
            closeShareModalFunc();
        }
        
        function viewCreatorProfile() {
            if (pulseCreator) {
                window.location.href = `profile.html?user_id=${pulseCreator.id}`;
            }
        }
        
        function viewUserProfile(userId) {
            window.location.href = `profile.html?user_id=${userId}`;
        }
        
        function showToast(message, type = 'error') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            const container = document.getElementById('toast-container');
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        function closeEditCommentModalFunc() {
            document.getElementById('editCommentModal').style.display = 'none';
            editingCommentId = null;
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initialize, 100);
        });
    </script>
</body>
</html>
