<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#0F172A">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Bantu Shorts - Bantu Stream Connect</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Swiper for Shorts Carousel -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  
  <style>
    /* ============================================
       DESIGN SYSTEM - Matches Creator Dashboard
       ============================================ */
    :root {
      --deep-black: #0A0E12;
      --deep-navy: #0F172A;
      --soft-white: #F8FAFC;
      --slate-grey: #94A3B8;
      --bantu-blue: #1D4ED8;
      --warm-gold: #F59E0B;
      --error-color: #EF4444;
      --success-color: #10B981;
      --card-bg: rgba(15, 23, 42, 0.95);
      --card-border: rgba(148, 163, 184, 0.2);
      --hover-overlay: rgba(255, 255, 255, 0.05);
      --active-overlay: rgba(245, 158, 11, 0.1);
      --glass-bg: rgba(15, 23, 42, 0.95);
      --glass-border: rgba(148, 163, 184, 0.15);
      
      /* Shorts-specific - MOBILE OPTIMIZED */
      --shorts-player-height: 100vh;
      --shorts-controls-height: 3rem;
      --shorts-action-btn-size: 2.5rem;
      --shorts-creator-avatar-size: 2.25rem;
      --shorts-caption-max-height: 6rem;
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
      --safe-area-top: env(safe-area-inset-top, 0px);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html {
      font-size: 16px;
      height: 100%;
      overflow: hidden;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: var(--deep-black);
      color: var(--soft-white);
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      user-select: none;
      position: fixed;
    }
    
    /* Loading Screen */
    .shorts-loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--deep-black);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      transition: opacity 0.3s ease;
      padding: 20px;
    }
    
    .shorts-loading.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .shorts-loading .spinner {
      width: 3.5rem;
      height: 3.5rem;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top-color: var(--warm-gold);
      border-right-color: var(--bantu-blue);
      animation: spin 1s linear infinite;
      margin-bottom: 1.5rem;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-progress {
      width: 200px;
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      margin: 1rem 0;
      overflow: hidden;
    }
    
    .loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--bantu-blue), var(--warm-gold));
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 2px;
    }
    
    .fallback-message {
      text-align: center;
      max-width: 90%;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fallback-message h3 {
      color: var(--soft-white);
      margin-bottom: 10px;
      font-size: 1.25rem;
    }
    
    .fallback-message p {
      color: var(--slate-grey);
      margin-bottom: 20px;
      font-size: 0.9375rem;
    }
    
    .fallback-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .fallback-btn {
      background: var(--warm-gold);
      color: var(--deep-black);
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9375rem;
      min-width: 120px;
      transition: all 0.3s ease;
    }
    
    .fallback-btn.secondary {
      background: rgba(255,255,255,0.1);
      color: var(--soft-white);
      border: 1px solid var(--card-border);
    }
    
    .fallback-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(245,158,11,0.3);
    }
    
    .fallback-tip {
      color: var(--slate-grey);
      font-size: 0.75rem;
      margin-top: 20px;
      padding: 10px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
    }
    
    /* ============================================
       HEADER
       ============================================ */
    .header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(10, 14, 18, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 12px 20px;
      padding-top: max(12px, var(--safe-area-top));
      z-index: 100;
      border-bottom: 1px solid var(--card-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 64px;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      text-decoration: none;
    }
    
    .logo-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 32px rgba(29, 78, 216, 0.3);
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .logo-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .logo-text {
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
      font-size: 1.125rem;
      background: linear-gradient(to right, var(--soft-white), var(--bantu-blue));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: 0.5px;
    }
    
    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .icon-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: var(--soft-white);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      font-size: 1.25rem;
    }
    
    .icon-btn:active {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(0.95);
    }
    
    .notification-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      background: var(--error-color);
      color: white;
      font-size: 0.6875rem;
      font-weight: bold;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--deep-black);
    }
    
    .profile-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
      border: 2px solid rgba(255, 255, 255, 0.2);
      cursor: pointer;
      overflow: hidden;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 1rem;
    }
    
    .profile-btn:active {
      transform: scale(0.95);
    }
    
    .profile-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .profile-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
      color: white;
      font-size: 1rem;
    }
    
    /* ============================================
       SEARCH MODAL
       ============================================ */
    .search-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      z-index: 1500;
      display: none;
      flex-direction: column;
      overflow: hidden;
      padding-top: env(safe-area-inset-top, 0px);
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }
    
    .search-modal.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    
    .search-modal-header {
      padding: 1rem;
      display: flex;
      gap: 1rem;
      align-items: center;
      border-bottom: 1px solid var(--card-border);
    }
    
    .search-input-container {
      flex: 1;
      position: relative;
    }
    
    .search-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--slate-grey);
      font-size: 1rem;
    }
    
    .search-input {
      width: 100%;
      height: 3rem;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--card-border);
      border-radius: 2rem;
      padding: 0 1rem 0 3rem;
      color: var(--soft-white);
      font-size: 1rem;
      outline: none;
      font-family: 'Inter', sans-serif;
    }
    
    .search-input:focus {
      border-color: var(--warm-gold);
      background: rgba(255, 255, 255, 0.15);
    }
    
    .close-search-btn {
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--card-border);
      color: var(--soft-white);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }
    
    .close-search-btn:active {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .search-filters {
      padding: 1rem;
      display: flex;
      gap: 1rem;
      border-bottom: 1px solid var(--card-border);
    }
    
    .filter-group {
      flex: 1;
    }
    
    .filter-label {
      display: block;
      font-size: 0.75rem;
      color: var(--slate-grey);
      margin-bottom: 0.375rem;
    }
    
    .filter-select {
      width: 100%;
      height: 2.5rem;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--card-border);
      border-radius: 0.5rem;
      padding: 0 0.75rem;
      color: var(--soft-white);
      font-size: 0.875rem;
      outline: none;
      cursor: pointer;
    }
    
    .filter-select option {
      background: var(--deep-navy);
      color: var(--soft-white);
    }
    
    .search-results {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      -webkit-overflow-scrolling: touch;
    }
    
    .search-results-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }
    
    .content-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 0.75rem;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s ease;
      border: 1px solid var(--card-border);
    }
    
    .content-card:active {
      transform: scale(0.98);
    }
    
    .card-thumbnail {
      aspect-ratio: 9/16;
      width: 100%;
      background: var(--deep-navy);
    }
    
    .card-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .card-content {
      padding: 0.5rem;
    }
    
    .card-title {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--soft-white);
      margin-bottom: 0.25rem;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    
    .related-meta {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.6875rem;
      color: var(--slate-grey);
    }
    
    .no-results {
      grid-column: span 2;
      text-align: center;
      padding: 3rem 1rem;
      color: var(--slate-grey);
      font-size: 0.9375rem;
    }
    
    /* ============================================
       NOTIFICATIONS PANEL
       ============================================ */
    .notifications-panel {
      position: fixed;
      top: 0;
      right: -100%;
      width: 100%;
      max-width: 400px;
      height: 100%;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      z-index: 1500;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
      border-left: 1px solid var(--glass-border);
      box-shadow: -5px 0 30px rgba(0, 0, 0, 0.5);
    }
    
    .notifications-panel.active {
      right: 0;
    }
    
    .notifications-header {
      padding: 1.25rem;
      border-bottom: 1px solid var(--card-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: max(1.25rem, env(safe-area-inset-top));
    }
    
    .notifications-header h2 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--soft-white);
    }
    
    .notifications-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 0;
      -webkit-overflow-scrolling: touch;
    }
    
    .notification-item {
      display: flex;
      gap: 1rem;
      padding: 1rem 1.25rem;
      cursor: pointer;
      transition: background 0.2s ease;
      position: relative;
    }
    
    .notification-item.unread {
      background: rgba(29, 78, 216, 0.1);
    }
    
    .notification-item:active {
      background: var(--hover-overlay);
    }
    
    .notification-item.read {
      opacity: 0.7;
    }
    
    .notification-icon {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--warm-gold);
      font-size: 1.125rem;
      flex-shrink: 0;
    }
    
    .notification-content {
      flex: 1;
      min-width: 0;
    }
    
    .notification-content h4 {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--soft-white);
      margin-bottom: 0.25rem;
    }
    
    .notification-content p {
      font-size: 0.8125rem;
      color: var(--slate-grey);
      margin-bottom: 0.375rem;
      line-height: 1.4;
    }
    
    .notification-time {
      font-size: 0.6875rem;
      color: var(--slate-grey);
    }
    
    .notification-dot {
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 50%;
      background: var(--bantu-blue);
      position: absolute;
      right: 1.25rem;
      top: 1.5rem;
    }
    
    .empty-notifications {
      text-align: center;
      padding: 3rem 1.5rem;
      color: var(--slate-grey);
    }
    
    .empty-notifications i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    .empty-notifications p {
      font-size: 0.9375rem;
    }
    
    .notifications-footer {
      padding: 1rem 1.25rem;
      border-top: 1px solid var(--card-border);
      padding-bottom: max(1rem, env(safe-area-inset-bottom));
    }
    
    .text-btn {
      background: none;
      border: none;
      color: var(--warm-gold);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      padding: 0.5rem;
      width: 100%;
      text-align: center;
    }
    
    .text-btn:active {
      opacity: 0.7;
    }
    
    /* ============================================
       SHORTS PLAYER CONTAINER
       ============================================ */
    .shorts-player-container {
      position: relative;
      width: 100%;
      height: 100vh;
      height: -webkit-fill-available;
      background: var(--deep-black);
      overflow: hidden;
      padding-top: 64px;
      padding-bottom: 0;
    }
    
    .shorts-swiper {
      width: 100%;
      height: 100%;
    }
    
    .shorts-swiper .swiper-slide {
      display: flex;
      justify-content: center;
      align-items: center;
      background: var(--deep-navy);
      position: relative;
      overflow: hidden;
    }
    
    .short-video-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .short-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      background: var(--deep-black);
    }
    
    .video-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 50%;
      background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
      pointer-events: none;
      z-index: 5;
    }
    
    /* ============================================
       SHORTS ACTIONS (Right Side) - MOBILE OPTIMIZED
       ============================================ */
    .shorts-actions {
      position: absolute;
      right: 0.5rem;
      bottom: 5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      z-index: 20;
    }
    
    .action-btn {
      width: var(--shorts-action-btn-size);
      height: var(--shorts-action-btn-size);
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: var(--soft-white);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 1.25rem;
      position: relative;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .action-btn:active {
      transform: scale(0.9);
      background: rgba(255, 255, 255, 0.2);
    }
    
    .action-btn.liked {
      color: var(--error-color);
      background: rgba(239, 68, 68, 0.3);
      border-color: var(--error-color);
    }
    
    .action-btn.saved {
      color: var(--warm-gold);
      background: rgba(245, 158, 11, 0.3);
      border-color: var(--warm-gold);
    }
    
    .action-count {
      position: absolute;
      bottom: -1.25rem;
      font-size: 0.6875rem;
      color: var(--soft-white);
      font-weight: 500;
      white-space: nowrap;
      text-shadow: 0 2px 4px rgba(0,0,0,0.8);
      background: rgba(0, 0, 0, 0.5);
      padding: 0.125rem 0.375rem;
      border-radius: 0.75rem;
      min-width: 2rem;
      text-align: center;
    }
    
    @keyframes likePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.3); }
    }
    
    .action-btn.liked .fa-heart {
      animation: likePulse 0.3s ease;
    }
    
    .double-tap-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      font-size: 5rem;
      color: var(--error-color);
      opacity: 0;
      pointer-events: none;
      z-index: 30;
      text-shadow: 0 0 30px rgba(239, 68, 68, 0.8);
    }
    
    .double-tap-indicator.active {
      animation: doubleTap 0.5s ease forwards;
    }
    
    @keyframes doubleTap {
      0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 0;
      }
      20% {
        transform: translate(-50%, -50%) scale(1.2);
        opacity: 1;
      }
      80% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 0;
      }
    }
    
    /* ============================================
       CREATOR INFO & CAPTION (Bottom Left) - MOBILE OPTIMIZED
       ============================================ */
    .shorts-info {
      position: absolute;
      left: 0.75rem;
      bottom: 5rem;
      right: 4rem;
      z-index: 20;
    }
    
    .creator-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
      background: rgba(0,0,0,0.3);
      padding: 0.375rem 0.5rem 0.375rem 0.375rem;
      border-radius: 2.5rem;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
      max-width: fit-content;
    }
    
    .creator-avatar {
      width: var(--shorts-creator-avatar-size);
      height: var(--shorts-creator-avatar-size);
      border-radius: 50%;
      background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.9375rem;
      overflow: hidden;
      flex-shrink: 0;
      border: 2px solid rgba(255,255,255,0.2);
    }
    
    .creator-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .creator-details {
      flex: 1;
      min-width: 0;
    }
    
    .creator-name {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--soft-white);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    
    .creator-username {
      font-size: 0.75rem;
      color: var(--slate-grey);
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    
    .connect-btn {
      background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
      color: white;
      border: none;
      padding: 0.375rem 0.75rem;
      border-radius: 2rem;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      border: 1px solid rgba(255,255,255,0.2);
      min-width: 70px;
    }
    
    .connect-btn:active {
      transform: scale(0.95);
    }
    
    .connect-btn.connected {
      background: rgba(255,255,255,0.2);
      color: var(--soft-white);
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .shorts-caption {
      font-size: 0.875rem;
      line-height: 1.4;
      color: var(--soft-white);
      margin-bottom: 0.375rem;
      max-height: var(--shorts-caption-max-height);
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      text-overflow: ellipsis;
      text-shadow: 0 1px 3px rgba(0,0,0,0.5);
      background: rgba(0,0,0,0.3);
      padding: 0.375rem 0.5rem;
      border-radius: 0.5rem;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .shorts-caption.expanded {
      -webkit-line-clamp: unset;
      max-height: none;
    }
    
    .caption-toggle {
      background: none;
      border: none;
      color: var(--warm-gold);
      font-size: 0.6875rem;
      cursor: pointer;
      padding: 0.125rem 0.25rem;
      margin-top: 0.125rem;
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    
    .shorts-meta {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.6875rem;
      color: var(--soft-white);
      margin-top: 0.375rem;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    
    .shorts-meta span {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    /* ============================================
       VIDEO CONTROLS (Bottom) - MOBILE OPTIMIZED
       ============================================ */
    .video-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--shorts-controls-height);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0 0.75rem;
      padding-bottom: max(0.5rem, var(--safe-area-bottom));
      z-index: 20;
      background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
    }
    
    .progress-container {
      flex: 1;
      height: 4px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 0.25rem;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: var(--warm-gold);
      width: 0%;
      transition: width 0.1s linear;
      z-index: 2;
    }
    
    .progress-buffer {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: rgba(255, 255, 255, 0.3);
      width: 0%;
      z-index: 1;
    }
    
    .control-btn {
      background: none;
      border: none;
      color: var(--soft-white);
      font-size: 1rem;
      cursor: pointer;
      padding: 0.4rem;
      border-radius: 50%;
      transition: all 0.2s ease;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .control-btn:active {
      background: rgba(255,255,255,0.2);
      transform: scale(0.9);
    }
    
    .play-pause-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      width: 4rem;
      height: 4rem;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 2rem;
      opacity: 0;
      pointer-events: none;
      z-index: 25;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 2px solid rgba(255,255,255,0.2);
    }
    
    .play-pause-overlay.active {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }
    
    /* ============================================
       MORE MENU - FIXED CLICKABLE
       ============================================ */
    .more-menu {
      position: fixed;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 1rem;
      width: 220px;
      padding: 0.5rem 0;
      z-index: 1000;
      display: none;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }
    
    .more-menu.active {
      display: block;
      animation: menuFadeIn 0.2s ease;
    }
    
    @keyframes menuFadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .more-menu-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.875rem 1.25rem;
      color: var(--soft-white);
      font-size: 0.9375rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }
    
    .more-menu-item:hover {
      background: var(--hover-overlay);
    }
    
    .more-menu-item:active {
      background: rgba(255,255,255,0.1);
    }
    
    .more-menu-item.danger {
      color: var(--error-color);
    }
    
    .more-menu-item.danger:hover {
      background: rgba(239, 68, 68, 0.15);
    }
    
    .more-menu-item i {
      width: 1.25rem;
      font-size: 1rem;
    }
    
    /* ============================================
       MODALS & DRAWERS
       ============================================ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 1500;
      display: none;
      align-items: flex-end;
      justify-content: center;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .comments-drawer {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 1.5rem 1.5rem 0 0;
      width: 100%;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: slideUp 0.3s ease;
      border-top: 1px solid var(--glass-border);
    }
    
    .share-modal {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 1.5rem 1.5rem 0 0;
      width: 100%;
      padding: 1.5rem;
      animation: slideUp 0.3s ease;
      border-top: 1px solid var(--glass-border);
    }
    
    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
    
    .drawer-header {
      padding: 1.25rem;
      border-bottom: 1px solid var(--card-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .drawer-header h3 {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--soft-white);
    }
    
    .drawer-close {
      background: none;
      border: none;
      color: var(--slate-grey);
      font-size: 1.25rem;
      cursor: pointer;
      padding: 0.5rem;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    
    .drawer-close:active {
      background: rgba(255,255,255,0.1);
    }
    
    .comments-list {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      -webkit-overflow-scrolling: touch;
    }
    
    .comment-item {
      display: flex;
      gap: 0.75rem;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--card-border);
    }
    
    .comment-avatar {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.875rem;
      font-weight: 600;
      flex-shrink: 0;
    }
    
    .comment-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .comment-content {
      flex: 1;
      min-width: 0;
    }
    
    .comment-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
      flex-wrap: wrap;
    }
    
    .comment-username {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--soft-white);
    }
    
    .comment-time {
      font-size: 0.6875rem;
      color: var(--slate-grey);
    }
    
    .comment-text {
      font-size: 0.875rem;
      color: var(--soft-white);
      line-height: 1.4;
      word-break: break-word;
    }
    
    .comment-actions {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    
    .comment-action {
      background: none;
      border: none;
      color: var(--slate-grey);
      font-size: 0.75rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      border-radius: 1rem;
    }
    
    .comment-action:active {
      background: rgba(255,255,255,0.1);
    }
    
    .comment-action.liked {
      color: var(--error-color);
    }
    
    .comment-composer {
      padding: 1rem;
      border-top: 1px solid var(--card-border);
      display: flex;
      gap: 0.75rem;
      align-items: flex-end;
      background: rgba(0,0,0,0.3);
    }
    
    .composer-avatar {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.875rem;
      font-weight: 600;
      flex-shrink: 0;
    }
    
    .composer-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--card-border);
      border-radius: 1.5rem;
      padding: 0.75rem 1rem;
      color: var(--soft-white);
      font-size: 0.9375rem;
      resize: none;
      min-height: 2.5rem;
      max-height: 6rem;
      outline: none;
      font-family: 'Inter', sans-serif;
    }
    
    .composer-input:focus {
      border-color: var(--warm-gold);
      background: rgba(255,255,255,0.15);
    }
    
    .post-comment-btn {
      background: var(--warm-gold);
      color: var(--deep-black);
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 1.5rem;
      font-size: 0.9375rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 80px;
    }
    
    .post-comment-btn:active:not(:disabled) {
      transform: scale(0.95);
    }
    
    .post-comment-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Share Options */
    .share-options {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin: 1.5rem 0;
    }
    
    .share-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      background: rgba(255, 255, 255, 0.05);
      padding: 1rem;
      border-radius: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid var(--card-border);
    }
    
    .share-option:active {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(0.95);
    }
    
    .share-icon {
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: white;
    }
    
    .share-icon.whatsapp { background: #25D366; }
    .share-icon.twitter { background: #1DA1F2; }
    .share-icon.instagram { background: linear-gradient(135deg, #E1306C, #C13584); }
    .share-icon.copy { background: var(--bantu-blue); }
    
    .share-label {
      font-size: 0.6875rem;
      color: var(--soft-white);
      text-align: center;
    }
    
    .share-link {
      display: flex;
      gap: 0.75rem;
      background: rgba(255, 255, 255, 0.05);
      padding: 0.75rem;
      border-radius: 0.75rem;
      margin-top: 0.5rem;
    }
    
    .share-link input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--slate-grey);
      font-size: 0.8125rem;
      outline: none;
      padding: 0.25rem;
    }
    
    .copy-link-btn {
      background: var(--warm-gold);
      color: var(--deep-black);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
    }
    
    .copy-link-btn:active {
      transform: scale(0.95);
    }
    
    /* Toast Notifications */
    .toast-container {
      position: fixed;
      bottom: 6rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      pointer-events: none;
      width: 100%;
      max-width: 300px;
    }
    
    .toast {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 2rem;
      padding: 0.75rem 1.25rem;
      color: var(--soft-white);
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      animation: toastIn 0.3s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      pointer-events: none;
    }
    
    .toast.success { 
      border-color: var(--success-color);
      background: rgba(16, 185, 129, 0.2);
    }
    .toast.error { 
      border-color: var(--error-color);
      background: rgba(239, 68, 68, 0.2);
    }
    .toast.info { 
      border-color: var(--bantu-blue);
      background: rgba(29, 78, 216, 0.2);
    }
    
    @keyframes toastIn {
      from {
        transform: translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    /* ============================================
       BOTTOM NAVIGATION - REMOVED PERMANENTLY
       ============================================ */
    /* Global nav has been removed */
    
    /* ============================================
       RESPONSIVE - MOBILE OPTIMIZATION
       ============================================ */
    @media (max-width: 768px) {
      .logo-text {
        font-size: 1rem;
      }
      
      .logo-icon {
        width: 36px;
        height: 36px;
      }
      
      .shorts-actions {
        right: 0.5rem;
        bottom: 5rem;
        gap: 1rem;
      }
      
      .action-btn {
        width: 2.5rem;
        height: 2.5rem;
        font-size: 1.25rem;
      }
      
      .shorts-info {
        left: 0.75rem;
        bottom: 5rem;
        right: 4rem;
      }
      
      .creator-avatar {
        width: 2.25rem;
        height: 2.25rem;
      }
      
      .creator-name {
        font-size: 0.9375rem;
      }
      
      .connect-btn {
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
        min-width: 70px;
      }
      
      .video-controls {
        height: 3rem;
        padding: 0 0.75rem;
        padding-bottom: max(0.5rem, var(--safe-area-bottom));
      }
      
      .control-btn {
        width: 36px;
        height: 36px;
        font-size: 1rem;
      }
    }
    
    @media (max-width: 480px) {
      .header {
        padding: 0.5rem 0.75rem;
        min-height: 56px;
      }
      
      .logo-text {
        font-size: 0.875rem;
      }
      
      .icon-btn, .profile-btn {
        width: 40px;
        height: 40px;
      }
      
      .shorts-actions {
        right: 0.375rem;
        bottom: 4.5rem;
        gap: 0.875rem;
      }
      
      .action-btn {
        width: 2.25rem;
        height: 2.25rem;
        font-size: 1.125rem;
      }
      
      .action-count {
        font-size: 0.625rem;
        bottom: -1.125rem;
        padding: 0.1rem 0.3rem;
        min-width: 1.75rem;
      }
      
      .shorts-info {
        left: 0.5rem;
        right: 3.5rem;
        bottom: 4.5rem;
      }
      
      .shorts-caption {
        font-size: 0.8125rem;
        max-height: 5rem;
        -webkit-line-clamp: 2;
      }
      
      .creator-avatar {
        width: 2rem;
        height: 2rem;
      }
      
      .connect-btn {
        min-width: 65px;
        font-size: 0.7rem;
      }
      
      .video-controls {
        height: 3rem;
      }
      
      .control-btn {
        width: 36px;
        height: 36px;
        font-size: 1rem;
      }
      
      .progress-container {
        height: 3px;
      }
    }
    
    @media (max-width: 360px) {
      .shorts-actions {
        right: 0.25rem;
        bottom: 4rem;
        gap: 0.75rem;
      }
      
      .action-btn {
        width: 2rem;
        height: 2rem;
        font-size: 1rem;
      }
      
      .action-count {
        font-size: 0.5625rem;
        bottom: -1rem;
        padding: 0.08rem 0.25rem;
        min-width: 1.5rem;
      }
      
      .header {
        min-height: 52px;
      }
      
      .logo-icon {
        width: 32px;
        height: 32px;
      }
      
      .logo-text {
        font-size: 0.8125rem;
      }
      
      .icon-btn, .profile-btn {
        width: 38px;
        height: 38px;
      }
    }
    
    /* Touch target optimization */
    @media (hover: none) and (pointer: coarse) {
      .action-btn, .control-btn, .connect-btn, .icon-btn, .profile-btn {
        min-width: 44px;
        min-height: 44px;
      }
      
      .action-count {
        pointer-events: none;
      }
    }
    
    /* Prevent pull-to-refresh */
    body {
      overscroll-behavior-y: contain;
    }
    
    /* Safe area handling */
    @supports (padding: max(0px)) {
      .header {
        padding-top: max(12px, env(safe-area-inset-top));
      }
      
      .shorts-player-container {
        padding-top: max(64px, calc(env(safe-area-inset-top) + 44px));
      }
      
      .video-controls {
        padding-bottom: max(0.5rem, env(safe-area-inset-bottom));
      }
      
      .search-modal-header {
        padding-top: max(1rem, env(safe-area-inset-top));
      }
      
      .notifications-header {
        padding-top: max(1.25rem, env(safe-area-inset-top));
      }
      
      .notifications-footer {
        padding-bottom: max(1rem, env(safe-area-inset-bottom));
      }
    }
    
    /* Accessibility */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 4px;
    }
    ::-webkit-scrollbar-track {
      background: var(--deep-navy);
    }
    ::-webkit-scrollbar-thumb {
      background: var(--bantu-blue);
      border-radius: 2px;
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="shorts-loading" class="shorts-loading">
    <div class="spinner"></div>
    <div id="loading-text">Loading Shorts...</div>
    <div class="loading-progress">
      <div class="loading-progress-bar" id="loading-progress-bar" style="width: 0%"></div>
    </div>
  </div>
  
  <!-- Header -->
  <header class="header">
    <div class="logo" onclick="window.location.href='index.html'">
      <div class="logo-icon">
        <img src="https://ydnxqnbjoshvxteevemc.supabase.co/storage/v1/object/public/assets/bantu-icon.png" alt="Bantu Stream Connect" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\' viewBox=\'0 0 40 40\'%3E%3Crect width=\'40\' height=\'40\' fill=\'%231D4ED8\'/%3E%3Ctext x=\'8\' y=\'28\' fill=\'%23F59E0B\' font-size=\'24\' font-weight=\'bold\'%3EB%3C/text%3E%3C/svg%3E'">
      </div>
      <div class="logo-text">BANTU SHORTS</div>
    </div>
    <div class="header-actions">
      <button id="search-btn" class="icon-btn" title="Search">
        <i class="fas fa-search"></i>
      </button>
      <button id="notifications-btn" class="icon-btn" title="Notifications">
        <i class="fas fa-bell"></i>
        <span class="notification-badge" id="notification-count" style="display: none;">0</span>
      </button>
      <button id="profile-btn" class="profile-btn" title="Profile">
        <div class="profile-placeholder" id="userProfilePlaceholder">
          <i class="fas fa-user"></i>
        </div>
      </button>
    </div>
  </header>
  
  <!-- Main Shorts Player -->
  <div class="shorts-player-container" id="shorts-player">
    <div class="swiper shorts-swiper" id="shorts-swiper">
      <div class="swiper-wrapper" id="shorts-wrapper">
        <!-- Shorts loaded dynamically -->
      </div>
    </div>
    
    <div class="double-tap-indicator" id="double-tap-indicator">
      <i class="fas fa-heart"></i>
    </div>
    
    <div class="play-pause-overlay" id="play-pause-overlay">
      <i class="fas fa-play" id="play-pause-icon"></i>
    </div>
    
    <!-- More Menu (Three Dots) -->
    <div class="more-menu" id="more-menu">
      <button class="more-menu-item" id="more-report">
        <i class="fas fa-flag"></i>
        <span>Report</span>
      </button>
      <button class="more-menu-item" id="more-mute">
        <i class="fas fa-volume-mute"></i>
        <span>Mute Creator</span>
      </button>
      <button class="more-menu-item" id="more-not-interested">
        <i class="fas fa-thumbs-down"></i>
        <span>Not Interested</span>
      </button>
      <button class="more-menu-item danger" id="more-block">
        <i class="fas fa-ban"></i>
        <span>Block Creator</span>
      </button>
    </div>
  </div>
  
  <!-- SEARCH MODAL -->
  <div id="search-modal" class="search-modal">
    <div class="search-modal-header">
      <div class="search-input-container">
        <i class="search-icon fas fa-search"></i>
        <input type="text" id="search-input" class="search-input" 
               placeholder="Search shorts, creators, or categories..." autocomplete="off">
      </div>
      <button id="close-search-btn" class="close-search-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="search-filters">
      <div class="filter-group">
        <label class="filter-label">Category</label>
        <select id="category-filter" class="filter-select">
          <option value="">All Categories</option>
          <option value="Music">Music</option>
          <option value="STEM">STEM</option>
          <option value="Culture">Culture</option>
          <option value="News">News</option>
          <option value="Sports">Sports</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">Sort By</label>
        <select id="sort-filter" class="filter-select">
          <option value="newest">Newest First</option>
          <option value="popular">Most Popular</option>
          <option value="trending">Trending</option>
        </select>
      </div>
    </div>
    <div id="search-results" class="search-results">
      <div id="search-results-grid" class="search-results-grid">
        <!-- Results loaded here -->
      </div>
    </div>
  </div>
  
  <!-- NOTIFICATIONS PANEL -->
  <div id="notifications-panel" class="notifications-panel">
    <div class="notifications-header">
      <h2>Notifications</h2>
      <button id="close-notifications" class="icon-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="notifications-list" id="notifications-list">
      <div class="empty-notifications">
        <i class="fas fa-bell-slash"></i>
        <p>Loading notifications...</p>
      </div>
    </div>
    <div class="notifications-footer">
      <button id="mark-all-read" class="text-btn">Mark all as read</button>
    </div>
  </div>
  
  <!-- Comments Drawer Modal -->
  <div class="modal-overlay" id="comments-modal">
    <div class="comments-drawer">
      <div class="drawer-header">
        <h3>Comments</h3>
        <button class="drawer-close" id="close-comments">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="comments-list" id="comments-list">
        <!-- Comments loaded here -->
      </div>
      <div class="comment-composer">
        <div class="composer-avatar" id="composer-avatar">
          <span id="composer-initials">U</span>
        </div>
        <textarea 
          class="composer-input" 
          id="comment-input" 
          placeholder="Add a comment..."
          maxlength="500"
          rows="1"
        ></textarea>
        <button class="post-comment-btn" id="post-comment-btn" disabled>Post</button>
      </div>
    </div>
  </div>
  
  <!-- Share Modal -->
  <div class="modal-overlay" id="share-modal">
    <div class="share-modal">
      <div class="drawer-header">
        <h3>Share Short</h3>
        <button class="drawer-close" id="close-share">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="share-options">
        <div class="share-option" id="share-whatsapp">
          <div class="share-icon whatsapp">
            <i class="fab fa-whatsapp"></i>
          </div>
          <span class="share-label">WhatsApp</span>
        </div>
        <div class="share-option" id="share-twitter">
          <div class="share-icon twitter">
            <i class="fab fa-twitter"></i>
          </div>
          <span class="share-label">X</span>
        </div>
        <div class="share-option" id="share-instagram">
          <div class="share-icon instagram">
            <i class="fab fa-instagram"></i>
          </div>
          <span class="share-label">Instagram</span>
        </div>
        <div class="share-option" id="share-copy">
          <div class="share-icon copy">
            <i class="fas fa-link"></i>
          </div>
          <span class="share-label">Copy Link</span>
        </div>
      </div>
      <div class="share-link">
        <input type="text" id="share-link-input" readonly value="">
        <button class="copy-link-btn" id="copy-link-btn">Copy</button>
      </div>
    </div>
  </div>
  
  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>
  
  <!-- Bottom Navigation - REMOVED PERMANENTLY -->
  
  <script>
    // ============================================
    // SUPABASE CONFIGURATION - FIXED & ROBUST
    // ============================================
    const SUPABASE_URL = 'https://ydnxqnbjoshvxteevemc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkbnhxbmJqb3Nodnh0ZWV2ZW1jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MzI0OTMsImV4cCI6MjA3MzIwODQ5M30.NlaCCnLPSz1mM7AFeSlfZQ78kYEKUMh_Fi-7P_ccs_U';
    
    // Global state
    let supabaseClient = null;
    let currentUser = null;
    let shortsData = [];
    let currentShort = null;
    let currentVideo = null;
    let isMuted = false;
    let isPlaying = true;
    let userConnections = new Set();
    let moreMenuOpen = false;
    let lastTapTime = 0;
    let connectionFailed = false;
    let swiperInstance = null;
    let initTimeout = null;
    let authCheckComplete = false;
    let hasRecordedView = false; // Track if view has been recorded for current video
    
    // Loading progress tracking
    let loadingProgress = 0;
    const loadingSteps = [
      { name: 'Initializing...', progress: 10 },
      { name: 'Checking connection...', progress: 25 },
      { name: 'Loading shorts...', progress: 50 },
      { name: 'Almost ready...', progress: 75 },
      { name: 'Starting player...', progress: 90 }
    ];
    
    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      console.log(' DOMContentLoaded - Starting initialization');
      updateLoadingProgress('Initializing...', 10);
      
      // Set timeout for initialization
      initTimeout = setTimeout(() => {
        if (!authCheckComplete) {
          console.warn(' Initialization timeout - showing fallback');
          connectionFailed = true;
          hideLoadingScreen(true, 'Connection timeout. Showing offline content.');
        }
      }, 8000);
      
      initSupabase();
    });
    
    // Update loading progress
    function updateLoadingProgress(text, progress) {
      const loadingText = document.getElementById('loading-text');
      const progressBar = document.getElementById('loading-progress-bar');
      
      if (loadingText) loadingText.textContent = text;
      if (progressBar) progressBar.style.width = progress + '%';
      loadingProgress = progress;
    }
    
    // Initialize Supabase
    function initSupabase() {
      try {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: {
            autoRefreshToken: true,
            persistSession: true,
            detectSessionInUrl: false,
            storage: localStorage
          },
          global: {
            headers: { 'apikey': SUPABASE_ANON_KEY }
          }
        });
        console.log(' Supabase client initialized');
        
        updateLoadingProgress('Checking connection...', 25);
        
        // Test connection with timeout
        testConnection();
        
      } catch (error) {
        console.error(' Failed to initialize Supabase:', error);
        connectionFailed = true;
        useFallbackData();
      }
    }
    
    // Test Supabase connection
    async function testConnection() {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const { error } = await supabaseClient
          .from('Content')
          .select('id')
          .limit(1)
          .abortSignal(controller.signal);
        
        clearTimeout(timeoutId);
        
        if (error) {
          console.error(' Connection test failed:', error);
          connectionFailed = true;
          useFallbackData();
        } else {
          console.log(' Connection test passed');
          connectionFailed = false;
          checkAuth();
        }
      } catch (error) {
        console.error(' Connection test error:', error);
        connectionFailed = true;
        useFallbackData();
      }
    }
    
    // Check authentication
    async function checkAuth() {
      updateLoadingProgress('Checking authentication...', 35);
      
      try {
        const authPromise = supabaseClient.auth.getSession();
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Auth timeout')), 3000)
        );
        
        const result = await Promise.race([authPromise, timeoutPromise]);
        const session = result?.data?.session;
        
        currentUser = session?.user || null;
        console.log(' Auth state:', currentUser ? 'signed in' : 'guest');
        
        authCheckComplete = true;
        clearTimeout(initTimeout);
        
        if (currentUser) {
          updateLoadingProgress('Loading profile...', 45);
          await loadUserProfilePicture(currentUser);
          await loadUserNotifications(); // Load notifications for logged-in user
          await fetchUserConnections();
        }
        
        // Load shorts
        loadShorts();
        
      } catch (error) {
        console.warn(' Auth check failed, continuing as guest:', error);
        currentUser = null;
        authCheckComplete = true;
        clearTimeout(initTimeout);
        loadShorts();
      }
    }
    
    // Load shorts from Supabase
    async function loadShorts() {
      updateLoadingProgress('Loading shorts...', 50);
      
      try {
        const { data, error } = await supabaseClient
          .from('Content')
          .select(`
            *,
            user_profiles!user_id (
              id,
              username,
              full_name,
              avatar_url
            )
          `)
          .eq('status', 'published')
          .or('media_type.eq.short,duration.lte.60')
          .order('created_at', { ascending: false })
          .limit(20);
        
        if (error) throw error;
        
        if (data && data.length > 0) {
          shortsData = data;
          console.log(` Loaded ${shortsData.length} shorts`);
          
          // Cache the data
          try {
            localStorage.setItem('shorts_cache', JSON.stringify({
              data: shortsData,
              timestamp: Date.now()
            }));
          } catch (e) {}
          
          updateLoadingProgress('Loading interactions...', 75);
          await loadLikeCounts();
          
          updateLoadingProgress('Rendering...', 90);
          renderShorts();
          
          setTimeout(() => {
            initSwiper();
            hideLoadingScreen();
          }, 500);
          
        } else {
          console.log('No shorts found, using fallback');
          useFallbackData();
        }
        
      } catch (error) {
        console.error(' Error loading shorts:', error);
        useFallbackData();
      }
    }
    
    // Load like counts
    async function loadLikeCounts() {
      if (!shortsData.length) return;
      
      const contentIds = shortsData.map(s => s.id);
      
      const likeCounts = await Promise.all(
        contentIds.map(async (id) => {
          try {
            const { count } = await supabaseClient
              .from('content_likes')
              .select('*', { count: 'exact', head: true })
              .eq('content_id', id);
            return { id, count: count || 0 };
          } catch (e) {
            return { id, count: 0 };
          }
        })
      );
      
      likeCounts.forEach(({ id, count }) => {
        const short = shortsData.find(s => s.id === id);
        if (short) short.real_likes_count = count;
      });
    }
    
    // Use fallback/cached data
    function useFallbackData() {
      console.log(' Using fallback data');
      
      // Try cache first
      try {
        const cached = localStorage.getItem('shorts_cache');
        if (cached) {
          const { data, timestamp } = JSON.parse(cached);
          if (Date.now() - timestamp < 24 * 60 * 60 * 1000) { // 24 hours
            shortsData = data;
            console.log(' Using cached shorts');
            renderShorts();
            setTimeout(() => {
              initSwiper();
              hideLoadingScreen();
              showToast('Showing cached content', 'info');
            }, 500);
            return;
          }
        }
      } catch (e) {}
      
      // Use test data
      shortsData = [
        {
          id: 'test-1',
          title: 'Welcome to Bantu Shorts',
          description: 'Discover amazing short-form content from creators across Africa. Swipe up to see more!',
          file_url: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
          thumbnail_url: 'https://images.unsplash.com/photo-1511379938547-c1f69419868d?w=400&h=700&fit=crop',
          duration: 596,
          views_count: 1250,
          likes_count: 89,
          comments_count: 12,
          real_likes_count: 89,
          created_at: new Date().toISOString(),
          genre: 'Original Audio',
          user_profiles: {
            id: 'test-creator',
            username: 'bantuteam',
            full_name: 'Bantu Team',
            avatar_url: null
          }
        },
        {
          id: 'test-2',
          title: 'Creator Tips',
          description: 'Learn how to grow your audience on Bantu Stream Connect with these pro tips! ',
          file_url: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4',
          thumbnail_url: 'https://images.unsplash.com/photo-1523800503107-5bc3ba2a6f81?w=400&h=700&fit=crop',
          duration: 653,
          views_count: 3420,
          likes_count: 234,
          comments_count: 45,
          real_likes_count: 234,
          created_at: new Date().toISOString(),
          genre: 'Education',
          user_profiles: {
            id: 'test-creator2',
            username: 'creatorschool',
            full_name: 'Creator School',
            avatar_url: null
          }
        }
      ];
      
      renderShorts();
      setTimeout(() => {
        initSwiper();
        hideLoadingScreen();
        showToast('Showing demo content', 'info');
      }, 500);
    }
    
    // Render shorts to DOM
    function renderShorts() {
      const wrapper = document.getElementById('shorts-wrapper');
      if (!wrapper) return;
      
      wrapper.innerHTML = shortsData.map((short, index) => {
        const creator = short.user_profiles || {};
        const videoUrl = fixMediaUrl(short.file_url);
        const thumbnailUrl = short.thumbnail_url ? fixMediaUrl(short.thumbnail_url) : '';
        const creatorName = creator.full_name || creator.username || 'Creator';
        const initials = getInitials(creatorName);
        const isConnected = currentUser && userConnections.has(creator.id);
        
        return `
          <div class="swiper-slide" data-short-id="${short.id}" data-index="${index}">
            <div class="short-video-wrapper">
              <video 
                class="short-video" 
                src="${videoUrl}" 
                poster="${thumbnailUrl}"
                loop 
                playsinline 
                preload="metadata"
                data-short-id="${short.id}"
              ></video>
              <div class="video-overlay"></div>
              
              <!-- Actions (Right Side) -->
              <div class="shorts-actions">
                <button class="action-btn like-btn" data-action="like" data-short-id="${short.id}" title="Like">
                  <i class="far fa-heart"></i>
                  <span class="action-count">${formatNumber(short.real_likes_count || short.likes_count || 0)}</span>
                </button>
                
                <button class="action-btn comment-btn" data-action="comment" data-short-id="${short.id}" title="Comments">
                  <i class="far fa-comment"></i>
                  <span class="action-count">${formatNumber(short.comments_count || 0)}</span>
                </button>
                
                <button class="action-btn share-btn" data-action="share" data-short-id="${short.id}" title="Share">
                  <i class="fas fa-share"></i>
                </button>
                
                <button class="action-btn save-btn" data-action="save" data-short-id="${short.id}" title="Save">
                  <i class="far fa-bookmark"></i>
                </button>
              </div>
              
              <!-- Creator Info & Caption -->
              <div class="shorts-info">
                <div class="creator-info" data-creator-id="${creator.id}" data-creator-name="${creatorName}">
                  <div class="creator-avatar">
                    ${creator.avatar_url 
                      ? `<img src="${fixMediaUrl(creator.avatar_url)}" alt="${creatorName}" loading="lazy">` 
                      : `<span>${initials}</span>`
                    }
                  </div>
                  <div class="creator-details">
                    <div class="creator-name">${escapeHtml(creatorName)}</div>
                    <div class="creator-username">@${escapeHtml(creator.username || 'creator')}</div>
                  </div>
                  <button class="connect-btn ${isConnected ? 'connected' : ''}" data-creator-id="${creator.id}">
                    ${isConnected ? 'Connected' : 'Connect'}
                  </button>
                </div>
                
                <div class="shorts-caption" id="caption-${short.id}">
                  ${escapeHtml(short.description || short.title || 'No description')}
                </div>
                ${(short.description?.length > 100 || short.title?.length > 100) ? `
                  <button class="caption-toggle" data-caption-id="caption-${short.id}">
                    more
                  </button>
                ` : ''}
                
                <div class="shorts-meta">
                  <span><i class="fas fa-music"></i> ${escapeHtml(short.genre || 'Original Audio')}</span>
                  <span><i class="fas fa-clock"></i> ${formatTime(short.duration || 0)}</span>
                  <span><i class="fas fa-eye"></i> ${formatNumber(short.views_count || 0)}</span>
                </div>
              </div>
              
              <!-- Video Controls -->
              <div class="video-controls">
                <button class="control-btn mute-btn" title="Mute">
                  <i class="fas fa-volume-up"></i>
                </button>
                
                <div class="progress-container">
                  <div class="progress-buffer"></div>
                  <div class="progress-bar"></div>
                </div>
                
                <button class="control-btn more-btn" data-short-id="${short.id}" title="More options">
                  <i class="fas fa-ellipsis-h"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Initialize Swiper
    function initSwiper() {
      if (typeof Swiper === 'undefined') {
        console.error('Swiper not loaded');
        setTimeout(initSwiper, 100);
        return;
      }
      
      swiperInstance = new Swiper('.shorts-swiper', {
        direction: 'vertical',
        loop: false,
        speed: 300,
        mousewheel: true,
        keyboard: {
          enabled: true,
          onlyInViewport: false
        },
        on: {
          init: function() {
            console.log(' Swiper initialized');
            setTimeout(() => playCurrentShort(), 300);
          },
          slideChange: function() {
            pauseAllVideos();
            hasRecordedView = false; // Reset view tracking for new video
            setTimeout(() => playCurrentShort(), 100);
            updateActiveShort();
            closeMoreMenu();
          },
          reachEnd: function() {
            loadMoreShorts();
          }
        }
      });
      
      setupEventListeners();
      
      // Initialize search and notifications after swiper is ready
      initSearchModal();
      initNotificationsPanel();
    }
    
    // ============================================
    // SEARCH FUNCTIONS
    // ============================================
    function initSearchModal() {
      const searchBtn = document.getElementById('search-btn');
      const searchModal = document.getElementById('search-modal');
      const closeSearchBtn = document.getElementById('close-search-btn');
      const searchInput = document.getElementById('search-input');
      const categoryFilter = document.getElementById('category-filter');
      const sortFilter = document.getElementById('sort-filter');
      
      if (!searchBtn || !searchModal) return;
      
      searchBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        searchModal.classList.add('active');
        setTimeout(() => searchInput?.focus(), 300);
      });
      
      closeSearchBtn?.addEventListener('click', () => {
        searchModal.classList.remove('active');
        if (searchInput) searchInput.value = '';
        document.getElementById('search-results-grid').innerHTML = '';
      });
      
      searchModal.addEventListener('click', (e) => {
        if (e.target === searchModal) {
          searchModal.classList.remove('active');
          if (searchInput) searchInput.value = '';
          document.getElementById('search-results-grid').innerHTML = '';
        }
      });
      
      // Search with debounce
      if (searchInput) {
        searchInput.addEventListener('input', debounce(async (e) => {
          const query = e.target.value.trim();
          const category = categoryFilter?.value || '';
          const sortBy = sortFilter?.value || 'newest';
          
          if (query.length < 2) {
            document.getElementById('search-results-grid').innerHTML = 
              '<div class="no-results">Start typing to search...</div>';
            return;
          }
          
          document.getElementById('search-results-grid').innerHTML = 
            '<div class="infinite-scroll-loading"><div class="infinite-scroll-spinner"></div>Searching...</div>';
          
          try {
            const results = await searchShorts(query, category, sortBy);
            renderSearchResults(results);
          } catch (error) {
            console.error('Search error:', error);
            document.getElementById('search-results-grid').innerHTML = 
              '<div class="no-results">Error searching. Please try again.</div>';
          }
        }, 300));
      }
      
      // Filter change events
      if (categoryFilter) {
        categoryFilter.addEventListener('change', () => {
          if (searchInput?.value.trim().length >= 2) {
            searchInput.dispatchEvent(new Event('input'));
          }
        });
      }
      
      if (sortFilter) {
        sortFilter.addEventListener('change', () => {
          if (searchInput?.value.trim().length >= 2) {
            searchInput.dispatchEvent(new Event('input'));
          }
        });
      }
    }
    
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    async function searchShorts(query, category = '', sortBy = 'newest') {
      try {
        let orderBy = 'created_at';
        let order = 'desc';
        if (sortBy === 'popular') orderBy = 'views_count';
        else if (sortBy === 'trending') orderBy = 'likes_count';
        
        let queryBuilder = supabaseClient
          .from('Content')
          .select('*, user_profiles!user_id(*)')
          .ilike('title', `%${query}%`)
          .eq('status', 'published')
          .or('media_type.eq.short,duration.lte.60')
          .order(orderBy, { ascending: order === 'asc' })
          .limit(20);
        
        if (category) queryBuilder = queryBuilder.eq('genre', category);
        
        const { data, error } = await queryBuilder;
        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('Search error:', error);
        return [];
      }
    }
    
    function renderSearchResults(results) {
      const grid = document.getElementById('search-results-grid');
      if (!grid) return;
      
      if (!results || results.length === 0) {
        grid.innerHTML = '<div class="no-results">No results found. Try different keywords.</div>';
        return;
      }
      
      grid.innerHTML = results.map(item => {
        const creator = item.user_profiles?.full_name || item.user_profiles?.username || 'Creator';
        const viewsCount = item.views_count || 0;
        return `
          <div class="content-card" data-content-id="${item.id}">
            <div class="card-thumbnail">
              <img src="${fixMediaUrl(item.thumbnail_url) || 'https://via.placeholder.com/400x700'}" 
                   alt="${escapeHtml(item.title)}"
                   onerror="this.src='https://via.placeholder.com/400x700'">
            </div>
            <div class="card-content">
              <h3 class="card-title">${truncateText(item.title, 45)}</h3>
              <div class="related-meta">
                <i class="fas fa-eye"></i>
                <span>${formatNumber(viewsCount)} views</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // Add click handlers
      grid.querySelectorAll('.content-card').forEach(card => {
        card.addEventListener('click', () => {
          const id = card.dataset.contentId;
          if (id) {
            // Close search modal
            document.getElementById('search-modal')?.classList.remove('active');
            // Navigate to the content
            window.location.href = `shorts-detail.html?id=${id}`;
          }
        });
      });
    }
    
    function truncateText(text, maxLength) {
      if (!text) return '';
      if (text.length <= maxLength) return text;
      return text.substring(0, maxLength) + '...';
    }
    
    // ============================================
    // NOTIFICATIONS FUNCTIONS
    // ============================================
    function initNotificationsPanel() {
      const notificationsBtn = document.getElementById('notifications-btn');
      const notificationsPanel = document.getElementById('notifications-panel');
      const closeNotifications = document.getElementById('close-notifications');
      const markAllReadBtn = document.getElementById('mark-all-read');
      
      if (!notificationsBtn || !notificationsPanel) return;
      
      notificationsBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        notificationsPanel.classList.add('active');
        if (currentUser) {
          await loadUserNotifications();
          // Auto-mark as read when opened
          setTimeout(() => markAllNotificationsAsRead(), 1000);
        } else {
          document.getElementById('notifications-list').innerHTML = `
            <div class="empty-notifications">
              <i class="fas fa-bell-slash"></i>
              <p>Sign in to see notifications</p>
            </div>`;
          updateNotificationBadge(0);
        }
      });
      
      closeNotifications?.addEventListener('click', () => {
        notificationsPanel.classList.remove('active');
      });
      
      markAllReadBtn?.addEventListener('click', () => {
        if (currentUser) {
          markAllNotificationsAsRead();
        }
      });
      
      document.addEventListener('click', (e) => {
        if (notificationsPanel.classList.contains('active') &&
            !notificationsPanel.contains(e.target) &&
            !notificationsBtn.contains(e.target)) {
          notificationsPanel.classList.remove('active');
        }
      });
    }
    
    async function loadUserNotifications() {
      const notificationsList = document.getElementById('notifications-list');
      if (!notificationsList) return;
      
      if (!currentUser) {
        notificationsList.innerHTML = `
          <div class="empty-notifications">
            <i class="fas fa-bell-slash"></i>
            <p>Sign in to see notifications</p>
          </div>`;
        updateNotificationBadge(0);
        return;
      }
      
      try {
        const { data, error } = await supabaseClient
          .from('notifications')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false })
          .limit(20);
        
        if (error) throw error;
        
        if (!data || data.length === 0) {
          notificationsList.innerHTML = `
            <div class="empty-notifications">
              <i class="fas fa-bell-slash"></i>
              <p>No notifications yet</p>
            </div>`;
          updateNotificationBadge(0);
          return;
        }
        
        notificationsList.innerHTML = data.map(notification => `
          <div class="notification-item ${notification.is_read ? 'read' : 'unread'}" data-id="${notification.id}">
            <div class="notification-icon">
              <i class="${getNotificationIcon(notification.type)}"></i>
            </div>
            <div class="notification-content">
              <h4>${escapeHtml(notification.title)}</h4>
              <p>${escapeHtml(notification.message)}</p>
              <span class="notification-time">${formatNotificationTime(notification.created_at)}</span>
            </div>
            ${!notification.is_read ? '<div class="notification-dot"></div>' : ''}
          </div>
        `).join('');
        
        // Add click handlers
        notificationsList.querySelectorAll('.notification-item').forEach(item => {
          item.addEventListener('click', async () => {
            const id = item.dataset.id;
            await markNotificationAsRead(id);
            const notification = data.find(n => n.id === id);
            if (notification?.content_id) {
              // Close panel and navigate
              notificationsPanel.classList.remove('active');
              window.location.href = `shorts-detail.html?id=${notification.content_id}`;
            }
          });
        });
        
        const unreadCount = data.filter(n => !n.is_read).length;
        updateNotificationBadge(unreadCount);
        
      } catch (error) {
        console.error('Error loading notifications:', error);
        notificationsList.innerHTML = `
          <div class="empty-notifications">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Error loading notifications</p>
          </div>`;
      }
    }
    
    function getNotificationIcon(type) {
      switch(type) {
        case 'like': return 'fas fa-heart';
        case 'comment': return 'fas fa-comment';
        case 'follow': return 'fas fa-user-plus';
        case 'view_milestone': return 'fas fa-trophy';
        case 'system': return 'fas fa-bell';
        default: return 'fas fa-bell';
      }
    }
    
    async function markNotificationAsRead(notificationId) {
      if (!currentUser) return;
      
      try {
        const { error } = await supabaseClient
          .from('notifications')
          .update({ is_read: true })
          .eq('id', notificationId);
        if (error) throw error;
        
        const item = document.querySelector(`.notification-item[data-id="${notificationId}"]`);
        if (item) {
          item.classList.remove('unread');
          item.classList.add('read');
          const dot = item.querySelector('.notification-dot');
          if (dot) dot.remove();
        }
        
        // Update badge
        const unreadCount = document.querySelectorAll('.notification-item.unread').length;
        updateNotificationBadge(unreadCount);
        
      } catch (error) {
        console.error('Error marking notification as read:', error);
      }
    }
    
    async function markAllNotificationsAsRead() {
      if (!currentUser) return;
      
      try {
        const { error } = await supabaseClient
          .from('notifications')
          .update({ is_read: true })
          .eq('user_id', currentUser.id)
          .eq('is_read', false);
        
        if (error) throw error;
        
        document.querySelectorAll('.notification-item.unread').forEach(item => {
          item.classList.remove('unread');
          item.classList.add('read');
          const dot = item.querySelector('.notification-dot');
          if (dot) dot.remove();
        });
        
        updateNotificationBadge(0);
        showToast('All notifications marked as read', 'success');
        
      } catch (error) {
        console.error('Error marking all notifications as read:', error);
      }
    }
    
    function updateNotificationBadge(count = null) {
      if (count === null) {
        count = document.querySelectorAll('.notification-item.unread').length;
      }
      const badge = document.getElementById('notification-count');
      if (badge) {
        badge.textContent = count > 99 ? '99+' : count;
        badge.style.display = count > 0 ? 'flex' : 'none';
      }
    }
    
    function formatNotificationTime(timestamp) {
      const now = new Date();
      const diffMs = now - new Date(timestamp);
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return new Date(timestamp).toLocaleDateString();
    }
    
    // ============================================
    // VIDEO CONTROL FUNCTIONS
    // ============================================
    function pauseAllVideos() {
      document.querySelectorAll('.short-video').forEach(video => {
        video.pause();
      });
    }
    
    function playCurrentShort() {
      const activeSlide = document.querySelector('.swiper-slide-active');
      if (!activeSlide) return;
      
      const video = activeSlide.querySelector('.short-video');
      if (!video) return;
      
      currentVideo = video;
      const shortId = activeSlide.dataset.shortId;
      currentShort = shortsData.find(s => s.id == shortId) || null;
      
      if (currentShort) {
        updateShareLink();
        
        if (document.getElementById('comments-modal').classList.contains('active')) {
          loadComments(currentShort.id);
        }
      }
      
      video.currentTime = 0;
      hasRecordedView = false; // Reset view tracking
      
      // Try to play with user interaction fallback
      const playPromise = video.play();
      if (playPromise !== undefined) {
        playPromise.catch(error => {
          console.log('Autoplay prevented:', error);
          showPlayPauseOverlay('play');
        });
      }
      
      setupVideoListeners(video);
      updateMuteButton();
    }
    
    function setupVideoListeners(video) {
      // Remove existing listeners to avoid duplicates
      video.removeEventListener('timeupdate', handleTimeUpdate);
      video.removeEventListener('progress', handleProgress);
      video.removeEventListener('ended', handleEnded);
      video.removeEventListener('error', handleVideoError);
      
      // Add fresh listeners
      video.addEventListener('timeupdate', handleTimeUpdate);
      video.addEventListener('progress', handleProgress);
      video.addEventListener('ended', handleEnded);
      video.addEventListener('error', handleVideoError);
    }
    
    function handleTimeUpdate(e) {
      const video = e.target;
      const shortId = video.dataset.shortId;
      const progressBar = document.querySelector(`.swiper-slide-active .progress-bar`);
      if (progressBar && video.duration) {
        const progress = (video.currentTime / video.duration) * 100;
        progressBar.style.width = `${progress}%`;
      }
      
      // Record view after 3 seconds
      if (!hasRecordedView && video.currentTime >= 3) {
        hasRecordedView = true;
        recordView(shortId, Math.floor(video.currentTime));
      }
    }
    
    function handleProgress(e) {
      const video = e.target;
      if (video.buffered.length > 0) {
        const bufferBar = document.querySelector(`.swiper-slide-active .progress-buffer`);
        if (bufferBar && video.duration) {
          const buffered = (video.buffered.end(0) / video.duration) * 100;
          bufferBar.style.width = `${buffered}%`;
        }
      }
    }
    
    function handleEnded(e) {
      if (swiperInstance) {
        swiperInstance.slideNext();
      } else {
        e.target.currentTime = 0;
        e.target.play().catch(() => {});
      }
    }
    
    function handleVideoError(e) {
      console.error('Video error:', e);
      showToast('Failed to load video', 'error');
    }
    
    function updateActiveShort() {
      const activeSlide = document.querySelector('.swiper-slide-active');
      if (!activeSlide) return;
      
      const shortId = activeSlide.dataset.shortId;
      updateLikeButton(shortId);
      updateSaveButton(shortId);
    }
    
    function updateMuteButton() {
      const muteBtn = document.querySelector('.swiper-slide-active .mute-btn');
      if (muteBtn) {
        muteBtn.innerHTML = isMuted 
          ? '<i class="fas fa-volume-mute"></i>' 
          : '<i class="fas fa-volume-up"></i>';
      }
    }
    
    function toggleMute() {
      if (!currentVideo) return;
      
      isMuted = !isMuted;
      currentVideo.muted = isMuted;
      updateMuteButton();
      showToast(isMuted ? 'Muted' : 'Unmuted', 'info');
    }
    
    function togglePlayPause() {
      if (!currentVideo) return;
      
      if (currentVideo.paused) {
        currentVideo.play().catch(() => {});
        isPlaying = true;
        showPlayPauseOverlay('play');
      } else {
        currentVideo.pause();
        isPlaying = false;
        showPlayPauseOverlay('pause');
      }
    }
    
    function showPlayPauseOverlay(action) {
      const overlay = document.getElementById('play-pause-overlay');
      const icon = document.getElementById('play-pause-icon');
      
      icon.className = action === 'play' ? 'fas fa-play' : 'fas fa-pause';
      overlay.classList.add('active');
      
      setTimeout(() => {
        overlay.classList.remove('active');
      }, 300);
    }
    
    function seekVideo(container, event) {
      if (!currentVideo || !currentVideo.duration) return;
      
      const rect = container.getBoundingClientRect();
      const percent = (event.clientX - rect.left) / rect.width;
      const time = percent * currentVideo.duration;
      
      currentVideo.currentTime = Math.max(0, Math.min(time, currentVideo.duration));
    }
    
    // ============================================
    // UPDATED SUPABASE FUNCTIONS - MATCHING YOUR SCHEMA
    // ============================================
    
    //  1 RECORD VIEW (Short Watch)
    async function recordView(contentId, watchDuration = 3) {
      if (!currentUser) return; // Only record views for logged-in users
      
      try {
        await supabaseClient
          .from('content_views')
          .insert({
            content_id: contentId,
            viewer_id: currentUser.id, // Note: viewer_id, not user_id
            view_duration: watchDuration,
            device_type: 'web'
          });
        console.log(' View recorded for content:', contentId);
      } catch (error) {
        console.error('Error recording view:', error);
      }
    }
    
    //  2 LOAD COMMENTS
    async function loadComments(contentId) {
      const list = document.getElementById('comments-list');
      list.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--slate-grey)"><i class="fas fa-spinner fa-spin"></i> Loading comments...</div>';
      
      try {
        const { data: comments, error } = await supabaseClient
          .from('comments')
          .select(`
            id,
            comment_text,
            created_at,
            author_name,
            author_avatar,
            user_id,
            comment_likes(count)
          `)
          .eq('content_id', contentId)
          .order('created_at', { ascending: false })
          .limit(50);
        
        if (error) throw error;
        
        if (!comments || comments.length === 0) {
          list.innerHTML = `
            <div style="text-align:center;padding:2rem;color:var(--slate-grey)">
              <i class="far fa-comment-dots" style="font-size:2rem;margin-bottom:1rem;opacity:0.5"></i>
              <p>No comments yet</p>
              <p style="font-size:0.875rem">Be the first to comment!</p>
            </div>
          `;
          return;
        }
        
        list.innerHTML = comments.map(comment => {
          const likeCount = comment.comment_likes?.[0]?.count || 0;
          
          return `
            <div class="comment-item" data-comment-id="${comment.id}">
              <div class="comment-avatar">
                ${comment.author_avatar 
                  ? `<img src="${fixMediaUrl(comment.author_avatar)}" alt="${escapeHtml(comment.author_name)}" loading="lazy">` 
                  : `<span>${getInitials(comment.author_name || 'User')}</span>`
                }
              </div>
              <div class="comment-content">
                <div class="comment-header">
                  <span class="comment-username">${escapeHtml(comment.author_name || 'User')}</span>
                  <span class="comment-time">${getTimeAgo(comment.created_at)}</span>
                </div>
                <div class="comment-text">${escapeHtml(comment.comment_text)}</div>
                <div class="comment-actions">
                  <button class="comment-action like-comment-btn" data-comment-id="${comment.id}">
                    <i class="far fa-heart"></i> ${formatNumber(likeCount)}
                  </button>
                  <button class="comment-action report-comment-btn" data-comment-id="${comment.id}">
                    <i class="fas fa-flag"></i> Report
                  </button>
                  ${currentUser && comment.user_id === currentUser.id ? `
                    <button class="comment-action delete-comment-btn" data-comment-id="${comment.id}">
                      <i class="fas fa-trash"></i> Delete
                    </button>
                  ` : ''}
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        // Attach comment action listeners
        attachCommentActionListeners();
        
      } catch (error) {
        console.error('Error loading comments:', error);
        list.innerHTML = `
          <div style="text-align:center;padding:2rem;color:var(--error-color)">
            <i class="fas fa-exclamation-circle" style="font-size:2rem;margin-bottom:1rem"></i>
            <p>Failed to load comments</p>
            <button onclick="loadComments('${contentId}')" style="background:var(--warm-gold);color:var(--deep-black);border:none;padding:0.5rem 1rem;border-radius:0.5rem;margin-top:1rem;cursor:pointer">
              Retry
            </button>
          </div>
        `;
      }
    }
    
    //  3 POST COMMENT
    async function postComment() {
      const input = document.getElementById('comment-input');
      const text = input.value.trim();
      
      if (!text || !currentShort || !currentUser) {
        showToast('Please sign in to comment', 'info');
        return;
      }
      
      // Get user profile for author info
      try {
        const { data: profile, error: profileError } = await supabaseClient
          .from('user_profiles')
          .select('full_name, avatar_url')
          .eq('id', currentUser.id)
          .single();
        
        if (profileError) throw profileError;
        
        const { error } = await supabaseClient
          .from('comments')
          .insert({
            content_id: currentShort.id,
            user_id: currentUser.id,
            author_name: profile?.full_name || currentUser.email?.split('@')[0] || 'User',
            author_avatar: profile?.avatar_url || null,
            comment_text: text
          });
        
        if (error) throw error;
        
        input.value = '';
        document.getElementById('post-comment-btn').disabled = true;
        
        // Update comment count in UI
        const commentBtn = document.querySelector(`.swiper-slide-active .comment-btn .action-count`);
        if (commentBtn) {
          const currentCount = parseInt(commentBtn.textContent) || 0;
          commentBtn.textContent = formatNumber(currentCount + 1);
        }
        
        await loadComments(currentShort.id);
        showToast('Comment posted!', 'success');
        
      } catch (error) {
        console.error('Error posting comment:', error);
        showToast('Failed to post comment', 'error');
      }
    }
    
    //  4 LIKE COMMENT
    async function likeComment(commentId, btn) {
      if (!currentUser) {
        showToast('Sign in to like comments', 'info');
        return;
      }
      
      const liked = btn.classList.contains('liked');
      const countSpan = btn.querySelector('span') || btn;
      const currentCount = parseInt(countSpan.textContent.replace(/[^0-9]/g, '')) || 0;
      
      // Optimistic update
      if (liked) {
        btn.classList.remove('liked');
        btn.querySelector('i').className = 'far fa-heart';
        countSpan.textContent = formatNumber(currentCount - 1);
      } else {
        btn.classList.add('liked');
        btn.querySelector('i').className = 'fas fa-heart';
        countSpan.textContent = formatNumber(currentCount + 1);
      }
      
      try {
        if (liked) {
          await supabaseClient
            .from('comment_likes')
            .delete()
            .eq('comment_id', commentId)
            .eq('user_id', currentUser.id);
        } else {
          await supabaseClient
            .from('comment_likes')
            .insert({
              comment_id: commentId,
              user_id: currentUser.id
            });
        }
      } catch (error) {
        // Revert on error
        if (liked) {
          btn.classList.add('liked');
          btn.querySelector('i').className = 'fas fa-heart';
          countSpan.textContent = formatNumber(currentCount);
        } else {
          btn.classList.remove('liked');
          btn.querySelector('i').className = 'far fa-heart';
          countSpan.textContent = formatNumber(currentCount);
        }
        console.error('Comment like error:', error);
        showToast('Failed to update like', 'error');
      }
    }
    
    //  5 REPORT COMMENT
    async function reportComment(commentId) {
      if (!currentUser) {
        showToast('Sign in to report comments', 'info');
        return;
      }
      
      const reason = prompt('Please provide a reason for reporting this comment:');
      if (!reason) return;
      
      try {
        const { error } = await supabaseClient
          .from('comment_reports')
          .insert({
            comment_id: commentId,
            user_id: currentUser.id,
            reason: reason
          });
        
        if (error) throw error;
        
        showToast('Report submitted. Thank you for helping keep our community safe!', 'success');
      } catch (error) {
        console.error('Error reporting comment:', error);
        showToast('Failed to submit report', 'error');
      }
    }
    
    //  6 DELETE COMMENT
    async function deleteComment(commentId) {
      if (!currentUser) return;
      
      if (!confirm('Delete this comment?')) return;
      
      try {
        const { error } = await supabaseClient
          .from('comments')
          .delete()
          .eq('id', commentId)
          .eq('user_id', currentUser.id);
        
        if (error) throw error;
        
        // Remove comment from UI
        const commentEl = document.querySelector(`.comment-item[data-comment-id="${commentId}"]`);
        if (commentEl) commentEl.remove();
        
        // Update comment count in UI
        const commentBtn = document.querySelector(`.swiper-slide-active .comment-btn .action-count`);
        if (commentBtn) {
          const currentCount = parseInt(commentBtn.textContent) || 0;
          commentBtn.textContent = formatNumber(Math.max(0, currentCount - 1));
        }
        
        showToast('Comment deleted', 'info');
      } catch (error) {
        console.error('Error deleting comment:', error);
        showToast('Failed to delete comment', 'error');
      }
    }
    
    function attachCommentActionListeners() {
      // Like comment buttons
      document.querySelectorAll('.like-comment-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const commentId = btn.dataset.commentId;
          likeComment(commentId, btn);
        });
      });
      
      // Report comment buttons
      document.querySelectorAll('.report-comment-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const commentId = btn.dataset.commentId;
          reportComment(commentId);
        });
      });
      
      // Delete comment buttons
      document.querySelectorAll('.delete-comment-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const commentId = btn.dataset.commentId;
          deleteComment(commentId);
        });
      });
    }
    
    // ============================================
    // ACTION HANDLERS
    // ============================================
    async function handleLike(shortId, btn) {
      if (!currentUser) {
        showToast('Sign in to like shorts', 'info');
        return;
      }
      
      const liked = btn.classList.contains('liked');
      const countEl = btn.querySelector('.action-count');
      let currentCount = parseInt(countEl.textContent.replace(/[^0-9]/g, '')) || 0;
      
      // Optimistic update
      if (liked) {
        btn.classList.remove('liked');
        btn.querySelector('i').className = 'far fa-heart';
        countEl.textContent = formatNumber(currentCount - 1);
      } else {
        btn.classList.add('liked');
        btn.querySelector('i').className = 'fas fa-heart';
        countEl.textContent = formatNumber(currentCount + 1);
      }
      
      try {
        if (liked) {
          await supabaseClient
            .from('content_likes')
            .delete()
            .eq('content_id', shortId)
            .eq('user_id', currentUser.id);
        } else {
          await supabaseClient
            .from('content_likes')
            .insert({
              content_id: shortId,
              user_id: currentUser.id,
              created_at: new Date().toISOString()
            });
          showDoubleTapIndicator();
        }
      } catch (error) {
        // Revert on error
        if (liked) {
          btn.classList.add('liked');
          btn.querySelector('i').className = 'fas fa-heart';
          countEl.textContent = formatNumber(currentCount);
        } else {
          btn.classList.remove('liked');
          btn.querySelector('i').className = 'far fa-heart';
          countEl.textContent = formatNumber(currentCount);
        }
        console.error('Like error:', error);
        showToast('Failed to update like', 'error');
      }
    }
    
    async function handleSave(shortId, btn) {
      if (!currentUser) {
        showToast('Sign in to save shorts', 'info');
        return;
      }
      
      const saved = btn.classList.contains('saved');
      
      if (saved) {
        btn.classList.remove('saved');
        btn.querySelector('i').className = 'far fa-bookmark';
      } else {
        btn.classList.add('saved');
        btn.querySelector('i').className = 'fas fa-bookmark';
      }
      
      try {
        if (saved) {
          await supabaseClient
            .from('saved_shorts')
            .delete()
            .eq('content_id', shortId)
            .eq('user_id', currentUser.id);
          showToast('Removed from saved', 'info');
        } else {
          await supabaseClient
            .from('saved_shorts')
            .insert({
              content_id: shortId,
              user_id: currentUser.id,
              saved_at: new Date().toISOString()
            });
          showToast('Saved!', 'success');
        }
      } catch (error) {
        // Revert
        if (saved) {
          btn.classList.add('saved');
          btn.querySelector('i').className = 'fas fa-bookmark';
        } else {
          btn.classList.remove('saved');
          btn.querySelector('i').className = 'far fa-bookmark';
        }
        console.error('Save error:', error);
        showToast('Failed to save', 'error');
      }
    }
    
    async function handleConnect(creatorId, btn) {
      if (!currentUser) {
        showToast('Sign in to connect', 'info');
        return;
      }
      
      const connected = btn.classList.contains('connected');
      
      if (connected) {
        btn.textContent = 'Connect';
        btn.classList.remove('connected');
      } else {
        btn.textContent = 'Connected';
        btn.classList.add('connected');
      }
      
      try {
        if (connected) {
          await supabaseClient
            .from('connectors')
            .delete()
            .eq('connector_id', currentUser.id)
            .eq('connected_id', creatorId);
          userConnections.delete(creatorId);
          showToast('Disconnected', 'info');
        } else {
          await supabaseClient
            .from('connectors')
            .insert({
              connector_id: currentUser.id,
              connected_id: creatorId,
              connection_type: 'creator',
              created_at: new Date().toISOString()
            });
          userConnections.add(creatorId);
          showToast('Connected!', 'success');
        }
      } catch (error) {
        // Revert
        if (connected) {
          btn.textContent = 'Connected';
          btn.classList.add('connected');
        } else {
          btn.textContent = 'Connect';
          btn.classList.remove('connected');
        }
        console.error('Connection error:', error);
        showToast('Failed to update connection', 'error');
      }
    }
    
    // ============================================
    // MORE MENU FUNCTIONS
    // ============================================
    function toggleMoreMenu(shortId, button) {
      const menu = document.getElementById('more-menu');
      if (!menu) return;
      
      if (moreMenuOpen) {
        closeMoreMenu();
        return;
      }
      
      // Position menu relative to button
      const rect = button.getBoundingClientRect();
      menu.style.bottom = `${window.innerHeight - rect.top + 10}px`;
      menu.style.right = `${window.innerWidth - rect.right + 10}px`;
      
      menu.dataset.shortId = shortId;
      menu.classList.add('active');
      moreMenuOpen = true;
    }
    
    function closeMoreMenu() {
      const menu = document.getElementById('more-menu');
      if (menu) menu.classList.remove('active');
      moreMenuOpen = false;
    }
    
    function handleReport() {
      const shortId = document.getElementById('more-menu').dataset.shortId;
      showToast('Report submitted', 'success');
      closeMoreMenu();
    }
    
    function handleMuteCreator() {
      showToast('Creator muted', 'info');
      closeMoreMenu();
    }
    
    function handleNotInterested() {
      showToast('Thanks for feedback', 'info');
      closeMoreMenu();
    }
    
    function handleBlockCreator() {
      if (confirm('Block this creator? You won\'t see their content.')) {
        showToast('Creator blocked', 'info');
        closeMoreMenu();
      }
    }
    
    // ============================================
    // COMMENT FUNCTIONS
    // ============================================
    function openComments(shortId) {
      const modal = document.getElementById('comments-modal');
      modal.classList.add('active');
      loadComments(shortId);
      setTimeout(() => {
        document.getElementById('comment-input')?.focus();
      }, 300);
    }
    
    function closeComments() {
      document.getElementById('comments-modal').classList.remove('active');
    }
    
    // ============================================
    // SHARE FUNCTIONS
    // ============================================
    function openShare(shortId) {
      document.getElementById('share-modal').classList.add('active');
      updateShareLink();
    }
    
    function closeShare() {
      document.getElementById('share-modal').classList.remove('active');
    }
    
    function updateShareLink() {
      if (!currentShort) return;
      const shareUrl = `${window.location.origin}${window.location.pathname}?id=${currentShort.id}`;
      document.getElementById('share-link-input').value = shareUrl;
    }
    
    async function copyShareLink() {
      const input = document.getElementById('share-link-input');
      try {
        await navigator.clipboard.writeText(input.value);
        showToast('Link copied!', 'success');
      } catch {
        input.select();
        document.execCommand('copy');
        showToast('Link copied!', 'success');
      }
      closeShare();
    }
    
    function shareToWhatsApp() {
      const text = `Check out this short on Bantu Stream Connect!`;
      const url = document.getElementById('share-link-input').value;
      window.open(`https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`, '_blank');
      closeShare();
    }
    
    function shareToTwitter() {
      const text = `Check out this short on Bantu Stream Connect!`;
      const url = document.getElementById('share-link-input').value;
      window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
      closeShare();
    }
    
    function shareToInstagram() {
      showToast('Share to Instagram coming soon!', 'info');
      closeShare();
    }
    
    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function hideLoadingScreen(showFallback = false, message = '') {
      const loadingScreen = document.getElementById('shorts-loading');
      if (!loadingScreen) return;
      
      if (showFallback) {
        loadingScreen.innerHTML = `
          <div class="fallback-message">
            <i class="fas fa-exclamation-circle" style="font-size:3rem;color:var(--warm-gold);margin-bottom:1rem"></i>
            <h3>Connection Issue</h3>
            <p>${escapeHtml(message || 'Unable to connect. Showing offline content.')}</p>
            <div class="fallback-actions">
              <button class="fallback-btn" onclick="location.reload()">
                <i class="fas fa-redo"></i> Retry
              </button>
              <button class="fallback-btn secondary" onclick="window.location.href='index.html'">
                <i class="fas fa-home"></i> Home
              </button>
            </div>
            <div class="fallback-tip">
              <i class="fas fa-lightbulb"></i> Tip: Check your internet connection
            </div>
          </div>
        `;
        loadingScreen.classList.remove('hidden');
      } else {
        loadingScreen.classList.add('hidden');
        setTimeout(() => {
          loadingScreen.style.display = 'none';
        }, 300);
      }
    }
    
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      if (!container) return;
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        info: 'fa-info-circle'
      };
      
      toast.innerHTML = `
        <i class="fas ${icons[type]}"></i>
        <span>${escapeHtml(message)}</span>
      `;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(100%)';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function formatNumber(num) {
      if (!num && num !== 0) return '0';
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toString();
    }
    
    function formatTime(seconds) {
      if (!seconds) return '0:00';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    function getTimeAgo(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      const now = new Date();
      const seconds = Math.floor((now - date) / 1000);
      
      if (seconds < 60) return 'just now';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      if (days < 7) return `${days}d ago`;
      return date.toLocaleDateString();
    }
    
    function getInitials(name) {
      if (!name) return 'U';
      return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
    }
    
    function fixMediaUrl(url) {
      if (!url) return '';
      if (url.startsWith('http')) return url;
      if (url.includes('supabase.co')) return url;
      return `${SUPABASE_URL}/storage/v1/object/public/${url.replace(/^\/+/, '')}`;
    }
    
    function updateLikeButton(shortId) {
      if (!currentUser) return;
      const btn = document.querySelector(`.swiper-slide-active .like-btn[data-short-id="${shortId}"]`);
      if (!btn) return;
      
      // Check if user has liked this content
      supabaseClient
        .from('content_likes')
        .select('id')
        .eq('content_id', shortId)
        .eq('user_id', currentUser.id)
        .maybeSingle()
        .then(({ data }) => {
          if (data) {
            btn.classList.add('liked');
            btn.querySelector('i').className = 'fas fa-heart';
          }
        })
        .catch(() => {});
    }
    
    function updateSaveButton(shortId) {
      if (!currentUser) return;
      const btn = document.querySelector(`.swiper-slide-active .save-btn[data-short-id="${shortId}"]`);
      if (!btn) return;
      
      // Check if user has saved this content
      supabaseClient
        .from('saved_shorts')
        .select('id')
        .eq('content_id', shortId)
        .eq('user_id', currentUser.id)
        .maybeSingle()
        .then(({ data }) => {
          if (data) {
            btn.classList.add('saved');
            btn.querySelector('i').className = 'fas fa-bookmark';
          }
        })
        .catch(() => {});
    }
    
    function showDoubleTapIndicator() {
      const indicator = document.getElementById('double-tap-indicator');
      indicator.classList.add('active');
      setTimeout(() => indicator.classList.remove('active'), 500);
    }
    
    function handleDoubleTap(e) {
      const now = Date.now();
      if (now - lastTapTime < 300) {
        const likeBtn = document.querySelector('.swiper-slide-active .like-btn');
        if (likeBtn && !likeBtn.classList.contains('liked')) {
          likeBtn.click();
        }
        lastTapTime = 0;
      } else {
        lastTapTime = now;
      }
    }
    
    // ============================================
    // USER PROFILE FUNCTIONS
    // ============================================
    async function loadUserProfilePicture(user) {
      if (!user) return;
      
      try {
        const { data: profile, error } = await supabaseClient
          .from('user_profiles')
          .select('avatar_url, full_name, username')
          .eq('id', user.id)
          .maybeSingle();
        
        const placeholder = document.getElementById('userProfilePlaceholder');
        if (!placeholder) return;
        
        placeholder.innerHTML = '';
        
        if (profile?.avatar_url) {
          const img = document.createElement('img');
          img.className = 'profile-img';
          img.src = fixMediaUrl(profile.avatar_url);
          img.alt = profile.full_name || 'User';
          img.onerror = () => {
            placeholder.innerHTML = '<div class="profile-placeholder"><i class="fas fa-user"></i></div>';
          };
          placeholder.appendChild(img);
        } else {
          const initials = profile?.full_name ? getInitials(profile.full_name) : getInitials(user.email);
          const div = document.createElement('div');
          div.className = 'profile-placeholder';
          div.textContent = initials;
          placeholder.appendChild(div);
        }
      } catch (error) {
        console.error('Error loading profile picture:', error);
      }
    }
    
    async function fetchUserConnections() {
      if (!currentUser) return;
      
      try {
        const { data, error } = await supabaseClient
          .from('connectors')
          .select('connected_id')
          .eq('connector_id', currentUser.id);
        
        if (error) throw error;
        
        userConnections.clear();
        if (data) data.forEach(c => userConnections.add(c.connected_id));
        
      } catch (error) {
        console.error('Error fetching connections:', error);
      }
    }
    
    // ============================================
    // LOAD MORE SHORTS
    // ============================================
    async function loadMoreShorts() {
      if (shortsData.length >= 50 || connectionFailed) return;
      
      try {
        const lastShort = shortsData[shortsData.length - 1];
        
        const { data, error } = await supabaseClient
          .from('Content')
          .select(`
            *,
            user_profiles!user_id (
              id,
              username,
              full_name,
              avatar_url
            )
          `)
          .eq('status', 'published')
          .or('media_type.eq.short,duration.lte.60')
          .lt('created_at', lastShort.created_at)
          .order('created_at', { ascending: false })
          .limit(10);
        
        if (error) throw error;
        
        if (data && data.length > 0) {
          shortsData = [...shortsData, ...data];
          
          data.forEach(short => {
            const slide = createShortSlide(short);
            document.getElementById('shorts-wrapper').appendChild(slide);
          });
          
          if (swiperInstance) swiperInstance.update();
        }
        
      } catch (error) {
        console.error('Error loading more shorts:', error);
      }
    }
    
    function createShortSlide(short) {
      const creator = short.user_profiles || {};
      const videoUrl = fixMediaUrl(short.file_url);
      const thumbnailUrl = short.thumbnail_url ? fixMediaUrl(short.thumbnail_url) : '';
      const creatorName = creator.full_name || creator.username || 'Creator';
      const initials = getInitials(creatorName);
      const isConnected = currentUser && userConnections.has(creator.id);
      
      const slide = document.createElement('div');
      slide.className = 'swiper-slide';
      slide.dataset.shortId = short.id;
      slide.innerHTML = `
        <div class="short-video-wrapper">
          <video class="short-video" src="${videoUrl}" poster="${thumbnailUrl}" loop playsinline preload="metadata" data-short-id="${short.id}"></video>
          <div class="video-overlay"></div>
          <div class="shorts-actions">
            <button class="action-btn like-btn" data-action="like" data-short-id="${short.id}">
              <i class="far fa-heart"></i>
              <span class="action-count">${formatNumber(short.real_likes_count || short.likes_count || 0)}</span>
            </button>
            <button class="action-btn comment-btn" data-action="comment" data-short-id="${short.id}">
              <i class="far fa-comment"></i>
              <span class="action-count">${formatNumber(short.comments_count || 0)}</span>
            </button>
            <button class="action-btn share-btn" data-action="share" data-short-id="${short.id}">
              <i class="fas fa-share"></i>
            </button>
            <button class="action-btn save-btn" data-action="save" data-short-id="${short.id}">
              <i class="far fa-bookmark"></i>
            </button>
          </div>
          <div class="shorts-info">
            <div class="creator-info" data-creator-id="${creator.id}" data-creator-name="${creatorName}">
              <div class="creator-avatar">
                ${creator.avatar_url ? `<img src="${fixMediaUrl(creator.avatar_url)}" alt="${escapeHtml(creatorName)}">` : `<span>${initials}</span>`}
              </div>
              <div class="creator-details">
                <div class="creator-name">${escapeHtml(creatorName)}</div>
                <div class="creator-username">@${escapeHtml(creator.username || 'creator')}</div>
              </div>
              <button class="connect-btn ${isConnected ? 'connected' : ''}" data-creator-id="${creator.id}">
                ${isConnected ? 'Connected' : 'Connect'}
              </button>
            </div>
            <div class="shorts-caption" id="caption-${short.id}">${escapeHtml(short.description || short.title || '')}</div>
            <div class="shorts-meta">
              <span><i class="fas fa-music"></i> ${escapeHtml(short.genre || 'Original Audio')}</span>
              <span><i class="fas fa-clock"></i> ${formatTime(short.duration || 0)}</span>
            </div>
          </div>
          <div class="video-controls">
            <button class="control-btn mute-btn"><i class="fas fa-volume-up"></i></button>
            <div class="progress-container">
              <div class="progress-buffer"></div>
              <div class="progress-bar"></div>
            </div>
            <button class="control-btn more-btn" data-short-id="${short.id}"><i class="fas fa-ellipsis-h"></i></button>
          </div>
        </div>
      `;
      
      return slide;
    }
    
    // ============================================
    // EVENT LISTENERS
    // ============================================
    function setupEventListeners() {
      // Header buttons
      document.getElementById('search-btn')?.addEventListener('click', () => {
        // Already handled in initSearchModal
      });
      
      document.getElementById('notifications-btn')?.addEventListener('click', () => {
        // Already handled in initNotificationsPanel
      });
      
      document.getElementById('profile-btn')?.addEventListener('click', () => {
        if (currentUser) {
          window.location.href = 'profile.html';
        } else {
          window.location.href = `login.html?redirect=${encodeURIComponent(window.location.pathname)}`;
        }
      });
      
      // Action buttons
      document.getElementById('shorts-player')?.addEventListener('click', (e) => {
        const btn = e.target.closest('.action-btn');
        if (!btn) return;
        
        e.stopPropagation();
        const action = btn.dataset.action;
        const shortId = btn.dataset.shortId;
        
        if (action === 'like') handleLike(shortId, btn);
        else if (action === 'comment') openComments(shortId);
        else if (action === 'share') openShare(shortId);
        else if (action === 'save') handleSave(shortId, btn);
      });
      
      // Connect button
      document.getElementById('shorts-player')?.addEventListener('click', (e) => {
        const btn = e.target.closest('.connect-btn');
        if (btn) {
          e.stopPropagation();
          handleConnect(btn.dataset.creatorId, btn);
        }
      });
      
      // More button
      document.getElementById('shorts-player')?.addEventListener('click', (e) => {
        const btn = e.target.closest('.more-btn');
        if (btn) {
          e.stopPropagation();
          toggleMoreMenu(btn.dataset.shortId, btn);
        }
      });
      
      // Caption toggle
      document.getElementById('shorts-player')?.addEventListener('click', (e) => {
        const toggle = e.target.closest('.caption-toggle');
        if (toggle) {
          e.stopPropagation();
          const captionId = toggle.dataset.captionId;
          const caption = document.getElementById(captionId);
          if (caption) {
            caption.classList.toggle('expanded');
            toggle.textContent = caption.classList.contains('expanded') ? 'less' : 'more';
          }
        }
      });
      
      // Creator info click
      document.getElementById('shorts-player')?.addEventListener('click', (e) => {
        const creatorInfo = e.target.closest('.creator-info');
        if (creatorInfo && !e.target.closest('.connect-btn')) {
          const creatorId = creatorInfo.dataset.creatorId;
          if (creatorId) {
            window.location.href = `creator-channel.html?id=${creatorId}`;
          }
        }
      });
      
      // Video controls
      document.getElementById('shorts-player')?.addEventListener('click', (e) => {
        const muteBtn = e.target.closest('.mute-btn');
        if (muteBtn) {
          e.stopPropagation();
          toggleMute();
          return;
        }
        
        const progressContainer = e.target.closest('.progress-container');
        if (progressContainer) {
          e.stopPropagation();
          seekVideo(progressContainer, e);
          return;
        }
        
        const videoWrapper = e.target.closest('.short-video-wrapper');
        if (videoWrapper && 
            !e.target.closest('.shorts-actions') && 
            !e.target.closest('.shorts-info') &&
            !e.target.closest('.video-controls')) {
          togglePlayPause();
        }
      });
      
      // More menu actions
      document.getElementById('more-report')?.addEventListener('click', handleReport);
      document.getElementById('more-mute')?.addEventListener('click', handleMuteCreator);
      document.getElementById('more-not-interested')?.addEventListener('click', handleNotInterested);
      document.getElementById('more-block')?.addEventListener('click', handleBlockCreator);
      
      // Close more menu when clicking outside
      document.addEventListener('click', (e) => {
        if (moreMenuOpen && !e.target.closest('.more-menu') && !e.target.closest('.more-btn')) {
          closeMoreMenu();
        }
      });
      
      // Double-tap
      document.getElementById('shorts-player')?.addEventListener('touchend', handleDoubleTap);
      
      // Modal close buttons
      document.getElementById('close-comments')?.addEventListener('click', closeComments);
      document.getElementById('close-share')?.addEventListener('click', closeShare);
      
      // Modal backdrop click
      document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.classList.remove('active');
        });
      });
      
      // Comment composer
      const commentInput = document.getElementById('comment-input');
      const postCommentBtn = document.getElementById('post-comment-btn');
      
      commentInput?.addEventListener('input', () => {
        postCommentBtn.disabled = commentInput.value.trim().length === 0;
      });
      
      commentInput?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if (!postCommentBtn.disabled) postComment();
        }
      });
      
      postCommentBtn?.addEventListener('click', postComment);
      
      // Share options
      document.getElementById('share-whatsapp')?.addEventListener('click', shareToWhatsApp);
      document.getElementById('share-twitter')?.addEventListener('click', shareToTwitter);
      document.getElementById('share-instagram')?.addEventListener('click', shareToInstagram);
      document.getElementById('share-copy')?.addEventListener('click', copyShareLink);
      document.getElementById('copy-link-btn')?.addEventListener('click', copyShareLink);
      
      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.target.matches('input, textarea')) return;
        
        switch(e.key) {
          case ' ':
          case 'k':
            e.preventDefault();
            togglePlayPause();
            break;
          case 'm':
            e.preventDefault();
            toggleMute();
            break;
          case 'ArrowUp':
            e.preventDefault();
            if (swiperInstance) swiperInstance.slidePrev();
            break;
          case 'ArrowDown':
            e.preventDefault();
            if (swiperInstance) swiperInstance.slideNext();
            break;
          case 'Escape':
            e.preventDefault();
            closeMoreMenu();
            closeComments();
            closeShare();
            document.getElementById('search-modal')?.classList.remove('active');
            document.getElementById('notifications-panel')?.classList.remove('active');
            break;
        }
      });
    }
    
    // ============================================
    // VISIBILITY CHANGE HANDLER
    // ============================================
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        pauseAllVideos();
      } else {
        playCurrentShort();
      }
    });
    
    // Orientation change
    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        if (swiperInstance) swiperInstance.update();
      }, 300);
    });
    
    // Auth state listener
    if (supabaseClient) {
      supabaseClient.auth.onAuthStateChange((event, session) => {
        console.log('Auth state changed:', event);
        
        if (event === 'SIGNED_IN' && session?.user) {
          currentUser = session.user;
          loadUserProfilePicture(session.user);
          loadUserNotifications();
          fetchUserConnections();
          showToast('Welcome back!', 'success');
        } else if (event === 'SIGNED_OUT') {
          currentUser = null;
          document.getElementById('userProfilePlaceholder').innerHTML = '<i class="fas fa-user"></i>';
          document.getElementById('notification-count').style.display = 'none';
          showToast('Signed out', 'info');
        }
      });
    }
  </script>
</body>
</html>
