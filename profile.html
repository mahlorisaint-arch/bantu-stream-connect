<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Bantu Connect Pulse</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- External CSS for better performance -->
    <link rel="stylesheet" href="css/profile-styles.css">
    
    <!-- Critical CSS for initial render -->
    <style>
        /* Critical: Loading and initial skeleton */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0A0E12;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: #1D4ED8;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Skeleton loading for better perceived performance */
        .skeleton {
            background: linear-gradient(90deg, #0F172A 25%, #1E293B 50%, #0F172A 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 8px;
        }
        
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Mobile safe areas */
        @supports (padding: max(0px)) {
            .bottom-nav {
                padding-bottom: max(12px, env(safe-area-inset-bottom));
            }
        }
        
        /* Prevent zoom on inputs for iOS */
        input, textarea {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg" aria-hidden="true">
        <div class="glow-cycle glow-1"></div>
        <div class="glow-cycle glow-2"></div>
        <div class="glow-cycle glow-3"></div>
        <div class="glow-cycle glow-4"></div>
    </div>

    <!-- Loading Screen -->
    <div id="loading" class="loading-screen">
        <div class="spinner"></div>
        <div id="loading-text" aria-live="polite">Loading Profile...</div>
    </div>

    <!-- Main Container -->
    <div class="container" id="content" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="logo-container" onclick="window.location.href='pulse-feed.html'" role="button" tabindex="0" aria-label="Go to home">
                <div class="logo-icon">
                    <svg width="32" height="32" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <rect width="40" height="40" rx="8" fill="#0F172A"/>
                        <path d="M8 20 L12 16 L16 22 L20 18 L24 24 L28 20 L32 26" stroke="url(#pulse-gradient)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="32" cy="26" r="3" fill="#F59E0B"/>
                        <defs>
                            <linearGradient id="pulse-gradient" x1="8" y1="20" x2="32" y2="26" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#1D4ED8"/>
                                <stop offset="1" stop-color="#F59E0B"/>
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <div class="logo-text">PULSE</div>
            </div>
            
            <div class="user-section">
                <!-- Notification button with real-time indicator -->
                <button class="notification-btn" id="notificationBtn" onclick="window.location.href='notifications.html'" aria-label="Notifications">
                    <i class="far fa-bell" aria-hidden="true"></i>
                    <span class="sr-only">Notifications</span>
                </button>
                <div class="user-avatar" id="user-avatar" onclick="window.location.href='profile.html'" role="button" tabindex="0" aria-label="Your profile">
                    <img id="user-avatar-img" alt="Your profile picture">
                    <span id="avatar-initials" class="sr-only">User initials</span>
                </div>
            </div>
        </header>
        
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="profile-top">
                <!-- Pulse Identity Ring Container -->
                <div class="profile-avatar-container">
                    <div class="profile-avatar-ring" id="profile-avatar-ring" aria-hidden="true"></div>
                    <div class="profile-avatar" id="profile-avatar">
                        <img id="profile-avatar-img" alt="Profile picture">
                        <span id="profile-avatar-initials" class="sr-only">Profile initials</span>
                    </div>
                </div>
                
                <div class="profile-info">
                    <h1 class="profile-name" id="profile-name">
                        <span class="skeleton" style="width: 120px; height: 24px; display: inline-block;"></span>
                        <span class="creator-badge" id="creator-badge" style="display: none;">CREATOR</span>
                    </h1>
                    <div class="profile-username" id="profile-username" aria-label="Username">
                        <span class="skeleton" style="width: 80px; height: 16px; display: inline-block;"></span>
                    </div>
                    <div class="profile-bio" id="profile-bio" aria-label="Bio">
                        <span class="skeleton" style="width: 100%; height: 40px; display: block;"></span>
                    </div>
                </div>
            </div>
            
            <!-- Log Out Button (Owner Only) -->
            <button class="logout-btn" id="logoutBtn" style="display: none;" aria-label="Log out">
                <i class="fas fa-sign-out-alt" aria-hidden="true"></i> Log Out
            </button>
            
            <!-- Action Row -->
            <div class="action-row" id="actionRow">
                <button class="action-btn primary" id="connectBtn" aria-label="Connect with user">
                    <i class="fas fa-plus" aria-hidden="true"></i> Connect
                </button>
                <button class="action-btn" id="messageBtn" style="display: none;" aria-label="Send message">
                    <i class="far fa-envelope" aria-hidden="true"></i> Message
                </button>
                <button class="action-btn" id="shareBtn" aria-label="Share profile">
                    <i class="fas fa-share" aria-hidden="true"></i> Share
                </button>
            </div>
            
            <!-- Stats Row -->
            <div class="stats-row">
                <button class="stat-item" onclick="viewPulses()" aria-label="View pulses, count: loading">
                    <div class="stat-value" id="statPulses">0</div>
                    <div class="stat-label">Pulses</div>
                </button>
                <button class="stat-item" onclick="viewSeriesTab()" aria-label="View series, count: loading">
                    <div class="stat-value" id="statSeries">0</div>
                    <div class="stat-label">Series</div>
                </button>
                <button class="stat-item" onclick="viewConnectors()" aria-label="View connectors, count: loading">
                    <div class="stat-value" id="statConnectors">0</div>
                    <div class="stat-label">Connectors</div>
                </button>
            </div>
        </div>
        
        <!-- Content Tabs -->
        <div class="tabs-container" role="tablist" aria-label="Profile content sections">
            <button class="tab active" data-tab="pulse" role="tab" aria-selected="true" aria-controls="pulse-tab">
                <div class="pulse-tab-icon" aria-hidden="true">
                    <svg width="20" height="20" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="40" height="40" rx="8" fill="#0F172A"/>
                        <path d="M8 20 L12 16 L16 22 L20 18 L24 24 L28 20 L32 26" stroke="url(#pulse-tab-gradient)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="32" cy="26" r="3" fill="#F59E0B"/>
                        <defs>
                            <linearGradient id="pulse-tab-gradient" x1="8" y1="20" x2="32" y2="26" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#1D4ED8"/>
                                <stop offset="1" stop-color="#F59E0B"/>
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <span>Pulses</span>
            </button>
            
            <button class="tab" data-tab="series" role="tab" aria-selected="false" aria-controls="series-tab">
                <div class="tab-icon" aria-hidden="true">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="15" width="18" height="6" rx="2" fill="#FFD700" filter="url(#gold-glow)"/>
                        <rect x="4" y="10" width="16" height="6" rx="2" fill="url(#layer-gradient)"/>
                        <rect x="5" y="5" width="14" height="6" rx="2" fill="#00E0FF" filter="url(#blue-glow)"/>
                        <defs>
                            <filter id="gold-glow" x="-20%" y="-20%" width="140%" height="140%">
                                <feGaussianBlur stdDeviation="2" result="blur"/>
                                <feFlood flood-color="#FFD700" flood-opacity="0.5"/>
                                <feComposite in2="blur" operator="in"/>
                                <feMerge>
                                    <feMergeNode/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                            <filter id="blue-glow" x="-20%" y="-20%" width="140%" height="140%">
                                <feGaussianBlur stdDeviation="2" result="blur"/>
                                <feFlood flood-color="#00E0FF" flood-opacity="0.5"/>
                                <feComposite in2="blur" operator="in"/>
                                <feMerge>
                                    <feMergeNode/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                            <linearGradient id="layer-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#FFB300"/>
                                <stop offset="100%" stop-color="#0095FF"/>
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <span>Series</span>
            </button>
            
            <button class="tab" data-tab="links" role="tab" aria-selected="false" aria-controls="links-tab">
                <div class="tab-icon" aria-hidden="true">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 13C10.4295 13.5741 10.9774 14.0491 11.6066 14.3929C12.2357 14.7367 12.9315 14.9411 13.6467 14.9923C14.3618 15.0435 15.0796 14.9403 15.7513 14.6897C16.4231 14.4392 17.0331 14.047 17.54 13.54L20.54 10.54C21.4508 9.59699 21.9548 8.33397 21.9434 7.02299C21.932 5.71201 21.4061 4.45794 20.4791 3.5309C19.5521 2.60386 18.298 2.07802 16.987 2.06663C15.676 2.05524 14.413 2.55921 13.47 3.47L11.75 5.18" stroke="url(#links-gradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M14 11C13.5705 10.4259 13.0226 9.95085 12.3934 9.60707C11.7642 9.26329 11.0685 9.05889 10.3533 9.00768C9.63815 8.95647 8.92037 9.05971 8.24861 9.31026C7.57685 9.5608 6.96688 9.953 6.46 10.46L3.46 13.46C2.54921 14.403 2.04524 15.666 2.05663 16.977C2.06802 18.288 2.59386 19.5421 3.5209 20.4691C4.44794 21.3961 5.70201 21.922 7.01299 21.9334C8.32397 21.9448 9.58699 21.4408 10.53 20.53L12.24 18.82" stroke="url(#links-gradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <defs>
                            <linearGradient id="links-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#0095FF"/>
                                <stop offset="100%" stop-color="#FFB300"/>
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <span>Links</span>
            </button>
            
            <!-- Journey Tab (Only visible for own profile) -->
            <button class="tab" data-tab="timecapsule" id="timecapsuleTab" style="display: none;" role="tab" aria-selected="false" aria-controls="timecapsule-tab">
                <div class="tab-icon journey-icon" aria-hidden="true">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="url(#journey-gradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 6V12L16 14" stroke="url(#journey-gradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <defs>
                            <linearGradient id="journey-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#00E0FF"/>
                                <stop offset="100%" stop-color="#FFD700"/>
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <span>Journey</span>
            </button>
        </div>
        
        <!-- Content Area -->
        <div class="content-area">
            <!-- Pulse Tab -->
            <div class="tab-content active" id="pulse-tab" role="tabpanel" aria-labelledby="pulse-tab">
                <div class="pulse-grid" id="pulseGrid">
                    <!-- Pulses will be loaded here -->
                </div>
            </div>
            
            <!-- Series Tab -->
            <div class="tab-content" id="series-tab" role="tabpanel" aria-labelledby="series-tab" hidden>
                <div class="series-grid" id="seriesGrid">
                    <!-- Series will be loaded here -->
                </div>
            </div>
            
            <!-- Links Tab -->
            <div class="tab-content" id="links-tab" role="tabpanel" aria-labelledby="links-tab" hidden>
                <div class="links-grid" id="linksGrid">
                    <!-- Links will be loaded here -->
                </div>
            </div>
            
            <!-- Journey Tab -->
            <div class="tab-content" id="timecapsule-tab" role="tabpanel" aria-labelledby="timecapsule-tab" hidden>
                <div class="timecapsule-container">
                    <div class="timecapsule-header">
                        <h2 class="timecapsule-title">Your Pulse Journey</h2>
                        <p class="timecapsule-subtitle">A personal archive of your cultural moments and milestones</p>
                    </div>
                    <div class="memory-cards-container" id="memoryCardsContainer">
                        <!-- Memory cards will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav" aria-label="Main navigation">
        <button class="nav-item" onclick="window.location.href='pulse-feed.html'" aria-label="Home">
            <i class="fas fa-home nav-icon" aria-hidden="true"></i>
            <span>Home</span>
        </button>
        <button class="nav-item" onclick="window.location.href='search.html'" aria-label="Search">
            <i class="fas fa-search nav-icon" aria-hidden="true"></i>
            <span>Search</span>
        </button>
        <button class="nav-item active" aria-label="Profile (current page)" aria-current="page">
            <i class="fas fa-user nav-icon" aria-hidden="true"></i>
            <span>Profile</span>
        </button>
        <button class="nav-item" onclick="window.location.href='saved.html'" aria-label="Saved items">
            <i class="fas fa-bookmark nav-icon" aria-hidden="true"></i>
            <span>Saved</span>
        </button>
    </nav>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container" role="status" aria-live="polite"></div>

    <!-- Edit Profile Modal -->
    <div id="editModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="editModalTitle" hidden>
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="editModalTitle">Edit Profile</h3>
                <button class="close-modal" id="closeEditModal" aria-label="Close modal">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="avatar-upload-container">
                    <div class="avatar-preview-container">
                        <div class="avatar-preview" id="avatarPreview" onclick="triggerAvatarUpload()" role="button" tabindex="0" aria-label="Change profile picture">
                            <img id="avatarPreviewImg" alt="Profile preview">
                            <span id="avatarPreviewInitials" class="sr-only">Preview initials</span>
                        </div>
                        <button class="avatar-upload-btn" onclick="triggerAvatarUpload()" aria-label="Upload new picture">
                            <i class="fas fa-camera" aria-hidden="true"></i>
                        </button>
                    </div>
                    <div class="avatar-upload-options">
                        <button class="avatar-upload-option" onclick="triggerAvatarUpload()" aria-label="Upload picture">
                            <i class="fas fa-upload" aria-hidden="true"></i> Upload
                        </button>
                        <button class="avatar-upload-option" onclick="removeProfilePicture()" aria-label="Remove picture">
                            <i class="fas fa-trash" aria-hidden="true"></i> Remove
                        </button>
                    </div>
                </div>
                
                <form id="editForm">
                    <div class="form-group">
                        <label class="form-label" for="editName">Display Name</label>
                        <input type="text" class="form-input" id="editName" placeholder="Your name" aria-required="true">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="editUsername">Username</label>
                        <input type="text" class="form-input" id="editUsername" placeholder="@username" aria-required="true">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="editBio">Bio</label>
                        <textarea class="form-textarea" id="editBio" placeholder="Tell your story... (max 120 characters)" maxlength="120" aria-describedby="bio-char-count"></textarea>
                        <div id="bio-char-count" class="char-count" aria-live="polite">0/120</div>
                    </div>
                    
                    <input type="hidden" id="editAvatar" value="">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEdit" aria-label="Cancel changes">Cancel</button>
                <button class="btn btn-primary" id="saveEdit" aria-label="Save changes">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Hidden input for Supabase config (in real app, these should come from server-side) -->
    <input type="hidden" id="supabase-config" 
           data-url="YOUR_SUPABASE_URL_HERE" 
           data-key="YOUR_SUPABASE_ANON_KEY_HERE">
           <!-- IMPORTANT: Replace with actual values from server-side or environment -->

    <script>
        // ============================================
        // PROFILE MODULE - Optimized and Secured
        // ============================================

        (function() {
            'use strict';

            // ============================================
            // DOM ELEMENT CACHE
            // ============================================
            const DOM = {
                // Core elements
                loading: null,
                content: null,
                loadingText: null,
                
                // Header elements
                notificationBtn: null,
                userAvatarImg: null,
                avatarInitials: null,
                
                // Profile elements
                profileAvatarRing: null,
                profileAvatarImg: null,
                profileAvatarInitials: null,
                profileName: null,
                profileUsername: null,
                profileBio: null,
                creatorBadge: null,
                
                // Action elements
                logoutBtn: null,
                connectBtn: null,
                messageBtn: null,
                shareBtn: null,
                
                // Stats elements
                statPulses: null,
                statSeries: null,
                statConnectors: null,
                
                // Content containers
                pulseGrid: null,
                seriesGrid: null,
                linksGrid: null,
                memoryCardsContainer: null,
                
                // Modal elements
                editModal: null,
                closeEditModal: null,
                cancelEdit: null,
                saveEdit: null,
                editForm: null,
                editName: null,
                editUsername: null,
                editBio: null,
                editAvatar: null,
                avatarPreviewImg: null,
                avatarPreviewInitials: null,
                bioCharCount: null,
                
                // Toast container
                toastContainer: null,
                
                // Tab elements
                tabs: [],
                tabContents: {}
            };

            // ============================================
            // STATE MANAGEMENT
            // ============================================
            const State = {
                supabaseClient: null,
                currentUserId: null,
                currentUserProfile: null,
                isViewingOwnProfile: true,
                profileUserId: null,
                currentViewProfile: null,
                isConnected: false,
                profileAvatarFile: null,
                notificationsSubscription: null,
                isInitialized: false,
                activeTab: 'pulse',
                cachedData: {
                    pulses: null,
                    series: null,
                    links: null,
                    journey: null
                },
                debounceTimers: {},
                observer: null
            };

            // ============================================
            // CONFIGURATION
            // ============================================
            const Config = {
                // IMPORTANT: These values should come from server-side or build process
                SUPABASE_URL: '',
                SUPABASE_ANON_KEY: '',
                
                // App configuration
                PAGINATION_LIMIT: 9,
                DEBOUNCE_DELAY: 300,
                CACHE_TTL: 5 * 60 * 1000, // 5 minutes
                
                // Feature flags
                FEATURES: {
                    PULSE_RING: true,
                    JOURNEY_TAB: true,
                    NOTIFICATIONS: true,
                    LAZY_LOADING: true
                }
            };

            // ============================================
            // INITIALIZATION
            // ============================================
            async function initialize() {
                console.log('ðŸš€ Initializing Profile Module...');
                
                try {
                    // 1. Cache DOM elements
                    cacheDOMElements();
                    
                    // 2. Load configuration from server (in real app)
                    await loadConfiguration();
                    
                    // 3. Initialize Supabase client
                    await initializeSupabase();
                    
                    // 4. Check authentication
                    await checkAuthentication();
                    
                    // 5. Initialize Intersection Observer for lazy loading
                    if (Config.FEATURES.LAZY_LOADING) {
                        initializeIntersectionObserver();
                    }
                    
                    // 6. Set up event listeners
                    initializeEventListeners();
                    
                    // 7. Load initial data
                    await loadInitialData();
                    
                    // 8. Show content
                    showContent();
                    
                    // 9. Initialize real-time features
                    if (Config.FEATURES.NOTIFICATIONS) {
                        initializeRealTimeFeatures();
                    }
                    
                    State.isInitialized = true;
                    console.log('âœ… Profile Module initialized successfully');
                    
                } catch (error) {
                    console.error('âŒ Initialization failed:', error);
                    handleInitializationError(error);
                }
            }

            function cacheDOMElements() {
                console.log('ðŸ” Caching DOM elements...');
                
                // Core elements
                DOM.loading = document.getElementById('loading');
                DOM.content = document.getElementById('content');
                DOM.loadingText = document.getElementById('loading-text');
                
                // Header elements
                DOM.notificationBtn = document.getElementById('notificationBtn');
                DOM.userAvatarImg = document.getElementById('user-avatar-img');
                DOM.avatarInitials = document.getElementById('avatar-initials');
                
                // Profile elements
                DOM.profileAvatarRing = document.getElementById('profile-avatar-ring');
                DOM.profileAvatarImg = document.getElementById('profile-avatar-img');
                DOM.profileAvatarInitials = document.getElementById('profile-avatar-initials');
                DOM.profileName = document.getElementById('profile-name');
                DOM.profileUsername = document.getElementById('profile-username');
                DOM.profileBio = document.getElementById('profile-bio');
                DOM.creatorBadge = document.getElementById('creator-badge');
                
                // Action elements
                DOM.logoutBtn = document.getElementById('logoutBtn');
                DOM.connectBtn = document.getElementById('connectBtn');
                DOM.messageBtn = document.getElementById('messageBtn');
                DOM.shareBtn = document.getElementById('shareBtn');
                
                // Stats elements
                DOM.statPulses = document.getElementById('statPulses');
                DOM.statSeries = document.getElementById('statSeries');
                DOM.statConnectors = document.getElementById('statConnectors');
                
                // Content containers
                DOM.pulseGrid = document.getElementById('pulseGrid');
                DOM.seriesGrid = document.getElementById('seriesGrid');
                DOM.linksGrid = document.getElementById('linksGrid');
                DOM.memoryCardsContainer = document.getElementById('memoryCardsContainer');
                
                // Modal elements
                DOM.editModal = document.getElementById('editModal');
                DOM.closeEditModal = document.getElementById('closeEditModal');
                DOM.cancelEdit = document.getElementById('cancelEdit');
                DOM.saveEdit = document.getElementById('saveEdit');
                DOM.editForm = document.getElementById('editForm');
                DOM.editName = document.getElementById('editName');
                DOM.editUsername = document.getElementById('editUsername');
                DOM.editBio = document.getElementById('editBio');
                DOM.editAvatar = document.getElementById('editAvatar');
                DOM.avatarPreviewImg = document.getElementById('avatarPreviewImg');
                DOM.avatarPreviewInitials = document.getElementById('avatarPreviewInitials');
                DOM.bioCharCount = document.getElementById('bio-char-count');
                
                // Toast container
                DOM.toastContainer = document.getElementById('toast-container');
                
                // Cache all tabs and tab contents
                DOM.tabs = Array.from(document.querySelectorAll('.tab'));
                DOM.tabContents = {
                    'pulse': document.getElementById('pulse-tab'),
                    'series': document.getElementById('series-tab'),
                    'links': document.getElementById('links-tab'),
                    'timecapsule': document.getElementById('timecapsule-tab')
                };
                
                console.log(`âœ… Cached ${Object.keys(DOM).length} DOM elements`);
            }

            async function loadConfiguration() {
                // In a real app, this would fetch from your server
                // For now, we'll use the hidden input or environment
                const configElement = document.getElementById('supabase-config');
                
                if (configElement && configElement.dataset.url && configElement.dataset.key) {
                    Config.SUPABASE_URL = configElement.dataset.url;
                    Config.SUPABASE_ANON_KEY = configElement.dataset.key;
                } else {
                    // Fallback for development - SET THESE IN YOUR ENVIRONMENT
                    Config.SUPABASE_URL = window.ENV?.SUPABASE_URL || '';
                    Config.SUPABASE_ANON_KEY = window.ENV?.SUPABASE_ANON_KEY || '';
                    
                    if (!Config.SUPABASE_URL || !Config.SUPABASE_ANON_KEY) {
                        throw new Error('Supabase configuration missing. Please set SUPABASE_URL and SUPABASE_ANON_KEY.');
                    }
                }
                
                console.log('âœ… Configuration loaded');
            }

            async function initializeSupabase() {
                if (!Config.SUPABASE_URL || !Config.SUPABASE_ANON_KEY) {
                    throw new Error('Supabase credentials not configured');
                }
                
                State.supabaseClient = window.supabase.createClient(
                    Config.SUPABASE_URL,
                    Config.SUPABASE_ANON_KEY,
                    {
                        auth: {
                            persistSession: true,
                            autoRefreshToken: true
                        }
                    }
                );
                
                console.log('âœ… Supabase client initialized');
            }

            async function checkAuthentication() {
                const { data: { session }, error } = await State.supabaseClient.auth.getSession();
                
                if (error) {
                    throw new Error(`Authentication error: ${error.message}`);
                }
                
                if (!session) {
                    window.location.href = 'login.html';
                    return;
                }
                
                State.currentUserId = session.user.id;
                console.log(`âœ… Authenticated as: ${session.user.email}`);
            }

            // ============================================
            // DATA LOADING
            // ============================================
            async function loadInitialData() {
                console.log('ðŸ“Š Loading initial data...');
                
                // 1. Load current user profile for header
                await loadCurrentUserProfile();
                
                // 2. Determine which profile to view
                await determineProfileView();
                
                // 3. Load viewed profile data
                await loadViewProfile();
                
                // 4. Load initial tab content
                await loadActiveTabContent();
                
                console.log('âœ… Initial data loaded');
            }

            async function loadCurrentUserProfile() {
                try {
                    const { data: profile, error } = await State.supabaseClient
                        .from('user_profiles')
                        .select('*')
                        .eq('id', State.currentUserId)
                        .single();
                    
                    if (error) {
                        console.warn('Could not load user profile, using auth data:', error);
                        State.currentUserProfile = {
                            id: State.currentUserId,
                            full_name: 'User',
                            username: 'user',
                            avatar_url: null,
                            email: ''
                        };
                    } else {
                        State.currentUserProfile = profile;
                    }
                    
                    // Update header with current user
                    updateHeaderAvatar(State.currentUserProfile);
                    
                } catch (error) {
                    console.error('Error loading current user profile:', error);
                    throw error;
                }
            }

            async function determineProfileView() {
                const urlParams = new URLSearchParams(window.location.search);
                State.profileUserId = urlParams.get('user_id') || State.currentUserId;
                State.isViewingOwnProfile = State.profileUserId === State.currentUserId;
                
                console.log(`ðŸ‘ï¸ Viewing ${State.isViewingOwnProfile ? 'own' : 'other'} profile`);
            }

            async function loadViewProfile() {
                try {
                    // Check cache first
                    const cacheKey = `profile_${State.profileUserId}`;
                    const cached = getFromCache(cacheKey);
                    
                    if (cached && !isCacheExpired(cached.timestamp)) {
                        State.currentViewProfile = cached.data;
                        console.log('ðŸ“¦ Using cached profile data');
                    } else {
                        const { data: profile, error } = await State.supabaseClient
                            .from('user_profiles')
                            .select('*')
                            .eq('id', State.profileUserId)
                            .single();
                        
                        if (error) throw error;
                        
                        State.currentViewProfile = profile;
                        saveToCache(cacheKey, profile);
                    }
                    
                    // Update UI
                    updateProfileUI(State.currentViewProfile);
                    
                    // Update action buttons based on ownership
                    updateActionButtons();
                    
                    // Load stats
                    await loadProfileStats();
                    
                } catch (error) {
                    console.error('Error loading view profile:', error);
                    showToast('Failed to load profile data', 'error');
                }
            }

            // ============================================
            // UI UPDATES
            // ============================================
            function updateHeaderAvatar(profile) {
                if (!profile || !DOM.userAvatarImg || !DOM.avatarInitials) return;
                
                const initials = getInitials(profile.full_name || profile.email || 'User');
                
                if (profile.avatar_url) {
                    DOM.userAvatarImg.src = profile.avatar_url;
                    DOM.userAvatarImg.alt = `${profile.full_name || profile.username}'s profile picture`;
                    DOM.userAvatarImg.style.display = 'block';
                    DOM.avatarInitials.style.display = 'none';
                } else {
                    DOM.userAvatarImg.style.display = 'none';
                    DOM.avatarInitials.style.display = 'flex';
                    DOM.avatarInitials.textContent = initials;
                }
            }

            function updateProfileUI(profile) {
                if (!profile) return;
                
                // Update name
                if (DOM.profileName) {
                    DOM.profileName.innerHTML = '';
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = profile.full_name || 'User';
                    DOM.profileName.appendChild(nameSpan);
                    
                    // Add creator badge if applicable
                    if (profile.role === 'creator' && DOM.creatorBadge) {
                        DOM.creatorBadge.style.display = 'inline-block';
                        DOM.profileName.appendChild(DOM.creatorBadge);
                    }
                }
                
                // Update username
                if (DOM.profileUsername) {
                    DOM.profileUsername.textContent = profile.username ? `@${profile.username}` : '@user';
                    DOM.profileUsername.setAttribute('aria-label', `Username: ${profile.username}`);
                }
                
                // Update bio with character limit
                if (DOM.profileBio) {
                    const bio = profile.bio || '';
                    const truncatedBio = bio.length > 120 ? bio.substring(0, 117) + '...' : bio;
                    DOM.profileBio.textContent = truncatedBio;
                }
                
                // Update profile avatar
                updateProfileAvatar(profile);
            }

            function updateProfileAvatar(profile) {
                if (!DOM.profileAvatarImg || !DOM.profileAvatarInitials) return;
                
                const initials = getInitials(profile.full_name || profile.email || 'User');
                
                if (profile.avatar_url) {
                    DOM.profileAvatarImg.src = profile.avatar_url;
                    DOM.profileAvatarImg.alt = `${profile.full_name || profile.username}'s profile picture`;
                    DOM.profileAvatarImg.style.display = 'block';
                    DOM.profileAvatarInitials.style.display = 'none';
                } else {
                    DOM.profileAvatarImg.style.display = 'none';
                    DOM.profileAvatarInitials.style.display = 'flex';
                    DOM.profileAvatarInitials.textContent = initials;
                }
                
                // Initialize pulse identity ring for own profile
                if (State.isViewingOwnProfile && Config.FEATURES.PULSE_RING) {
                    initializePulseIdentityRing();
                }
            }

            function updateActionButtons() {
                if (!DOM.connectBtn) return;
                
                if (State.isViewingOwnProfile) {
                    // Owner sees manage button
                    DOM.connectBtn.innerHTML = '<i class="fas fa-cog"></i> Manage';
                    DOM.connectBtn.onclick = openEditModal;
                    
                    // Show logout button
                    if (DOM.logoutBtn) {
                        DOM.logoutBtn.style.display = 'flex';
                    }
                    
                    // Show journey tab if feature enabled
                    const journeyTab = document.getElementById('timecapsuleTab');
                    if (journeyTab && Config.FEATURES.JOURNEY_TAB) {
                        journeyTab.style.display = 'flex';
                    }
                } else {
                    // Other users see connect/disconnect button
                    updateConnectionButton();
                }
            }

            // ============================================
            // TAB MANAGEMENT
            // ============================================
            async function loadActiveTabContent() {
                // Debounce tab switching
                debounce(`tab_${State.activeTab}`, async () => {
                    switch (State.activeTab) {
                        case 'pulse':
                            await loadPulses();
                            break;
                        case 'series':
                            await loadSeries();
                            break;
                        case 'links':
                            await loadLinks();
                            break;
                        case 'timecapsule':
                            if (State.isViewingOwnProfile) {
                                await loadJourney();
                            }
                            break;
                    }
                }, Config.DEBOUNCE_DELAY);
            }

            async function loadPulses() {
                try {
                    // Show skeleton loading
                    showSkeletonGrid(DOM.pulseGrid, 9);
                    
                    const { data: pulses, error } = await State.supabaseClient
                        .from('pulses')
                        .select('*')
                        .eq('user_id', State.profileUserId)
                        .is('deleted_at', null)
                        .order('created_at', { ascending: false })
                        .limit(Config.PAGINATION_LIMIT);
                    
                    if (error) throw error;
                    
                    renderPulses(pulses || []);
                    
                    // Cache for quick switching
                    State.cachedData.pulses = {
                        data: pulses,
                        timestamp: Date.now()
                    };
                    
                } catch (error) {
                    console.error('Error loading pulses:', error);
                    showEmptyState(DOM.pulseGrid, 'pulse', 'Failed to load pulses');
                }
            }

            function renderPulses(pulses) {
                if (!DOM.pulseGrid) return;
                
                if (!pulses || pulses.length === 0) {
                    showEmptyState(DOM.pulseGrid, 'pulse', 
                        State.isViewingOwnProfile ? 
                        'Share your first cultural moment!' : 
                        'No pulses to show yet.'
                    );
                    return;
                }
                
                DOM.pulseGrid.innerHTML = '';
                
                pulses.forEach(pulse => {
                    const pulseItem = createPulseElement(pulse);
                    DOM.pulseGrid.appendChild(pulseItem);
                });
                
                // Initialize lazy loading for images
                if (Config.FEATURES.LAZY_LOADING && State.observer) {
                    document.querySelectorAll('.pulse-item img').forEach(img => {
                        State.observer.observe(img);
                    });
                }
            }

            function createPulseElement(pulse) {
                const pulseItem = document.createElement('div');
                pulseItem.className = 'pulse-item';
                pulseItem.setAttribute('data-pulse-id', pulse.id);
                pulseItem.setAttribute('role', 'button');
                pulseItem.setAttribute('tabindex', '0');
                pulseItem.setAttribute('aria-label', `View pulse: ${pulse.caption?.substring(0, 50) || 'Cultural moment'}`);
                
                let seriesBadge = '';
                if (pulse.series_id) {
                    seriesBadge = `<div class="series-badge">Series Â· Part ${pulse.series_order || 1}</div>`;
                }
                
                pulseItem.innerHTML = `
                    ${seriesBadge}
                    <div class="pulse-overlay">
                        <div class="pulse-stats">
                            <span class="pulse-icon"><i class="fas fa-heart"></i></span>
                            <span class="pulse-icon"><i class="fas fa-comment"></i></span>
                        </div>
                    </div>
                `;
                
                // Add media with lazy loading
                if (pulse.media_url) {
                    if (pulse.media_type === 'video') {
                        const video = document.createElement('video');
                        video.src = pulse.media_url;
                        video.muted = true;
                        video.playsInline = true;
                        video.loading = 'lazy';
                        video.style.cssText = 'width:100%;height:100%;object-fit:cover;';
                        pulseItem.prepend(video);
                    } else {
                        const img = document.createElement('img');
                        img.src = pulse.media_url;
                        img.alt = pulse.caption || 'Cultural moment';
                        img.loading = 'lazy';
                        img.style.cssText = 'width:100%;height:100%;object-fit:cover;';
                        pulseItem.prepend(img);
                    }
                } else {
                    const captionPreview = document.createElement('div');
                    captionPreview.className = 'pulse-content-preview';
                    const captionText = pulse.caption ? 
                        (pulse.caption.length > 100 ? pulse.caption.substring(0, 97) + '...' : pulse.caption) :
                        'No media';
                    captionPreview.textContent = captionText;
                    pulseItem.prepend(captionPreview);
                }
                
                pulseItem.addEventListener('click', () => {
                    window.location.href = `pulse-content-detail.html?id=${pulse.id}`;
                });
                
                // Keyboard accessibility
                pulseItem.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        window.location.href = `pulse-content-detail.html?id=${pulse.id}`;
                    }
                });
                
                return pulseItem;
            }

            // ============================================
            // FEATURE: PULSE IDENTITY RING
            // ============================================
            async function initializePulseIdentityRing() {
                if (!Config.FEATURES.PULSE_RING || !DOM.profileAvatarRing) return;
                
                try {
                    const twelveHoursAgo = new Date();
                    twelveHoursAgo.setHours(twelveHoursAgo.getHours() - 12);
                    
                    // Check recent activity
                    const { data: recentPulses } = await State.supabaseClient
                        .from('pulses')
                        .select('id')
                        .eq('user_id', State.currentUserId)
                        .gte('created_at', twelveHoursAgo.toISOString())
                        .limit(1);
                    
                    const { data: recentComments } = await State.supabaseClient
                        .from('pulse_comments')
                        .select('id')
                        .in('pulse_id', 
                            State.supabaseClient
                                .from('pulses')
                                .select('id')
                                .eq('user_id', State.currentUserId)
                        )
                        .gte('created_at', twelveHoursAgo.toISOString())
                        .limit(1);
                    
                    const isActiveToday = recentPulses && recentPulses.length > 0;
                    const isReceivingAttention = recentComments && recentComments.length > 0;
                    
                    // Update ring state
                    DOM.profileAvatarRing.className = 'profile-avatar-ring ' + (
                        isActiveToday && isReceivingAttention ? 'receiving-attention' :
                        isActiveToday ? 'active-today' : 'inactive'
                    );
                    
                } catch (error) {
                    console.error('Error initializing pulse ring:', error);
                    DOM.profileAvatarRing.className = 'profile-avatar-ring inactive';
                }
            }

            // ============================================
            // FEATURE: JOURNEY TAB
            // ============================================
            async function loadJourney() {
                if (!State.isViewingOwnProfile) return;
                
                try {
                    showSkeletonCards(DOM.memoryCardsContainer, 4);
                    
                    const memories = await fetchJourneyMemories();
                    renderJourneyMemories(memories);
                    
                    State.cachedData.journey = {
                        data: memories,
                        timestamp: Date.now()
                    };
                    
                } catch (error) {
                    console.error('Error loading journey:', error);
                    showEmptyState(DOM.memoryCardsContainer, 'journey', 
                        'Start creating pulses to build your personal archive!'
                    );
                }
            }

            // ============================================
            // REAL-TIME FEATURES
            // ============================================
            function initializeRealTimeFeatures() {
                if (!Config.FEATURES.NOTIFICATIONS) return;
                
                // Check for unread notifications
                checkUnreadNotifications();
                
                // Subscribe to notifications
                subscribeToNotifications();
                
                // Set up visibility change handler
                document.addEventListener('visibilitychange', handleVisibilityChange);
            }

            async function checkUnreadNotifications() {
                try {
                    const { count, error } = await State.supabaseClient
                        .from('pulse_notifications')
                        .select('*', { count: 'exact', head: true })
                        .eq('target_user_id', State.currentUserId)
                        .eq('is_read', false);
                    
                    if (!error && count > 0) {
                        updateNotificationIndicator(true);
                    }
                } catch (error) {
                    console.log('Notifications table might not exist');
                }
            }

            function updateNotificationIndicator(hasUnread) {
                if (DOM.notificationBtn) {
                    DOM.notificationBtn.classList.toggle('has-unread', hasUnread);
                }
            }

            // ============================================
            // PERFORMANCE OPTIMIZATIONS
            // ============================================
            function initializeIntersectionObserver() {
                State.observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.src = img.dataset.src;
                            img.classList.remove('lazy');
                            State.observer.unobserve(img);
                        }
                    });
                }, {
                    rootMargin: '50px',
                    threshold: 0.1
                });
            }

            function debounce(id, func, delay) {
                clearTimeout(State.debounceTimers[id]);
                State.debounceTimers[id] = setTimeout(func, delay);
            }

            // ============================================
            // CACHE MANAGEMENT
            // ============================================
            function saveToCache(key, data) {
                try {
                    const cacheItem = {
                        data: data,
                        timestamp: Date.now()
                    };
                    sessionStorage.setItem(`pulse_${key}`, JSON.stringify(cacheItem));
                } catch (error) {
                    console.warn('Cache save failed:', error);
                }
            }

            function getFromCache(key) {
                try {
                    const cached = sessionStorage.getItem(`pulse_${key}`);
                    return cached ? JSON.parse(cached) : null;
                } catch (error) {
                    console.warn('Cache read failed:', error);
                    return null;
                }
            }

            function isCacheExpired(timestamp) {
                return Date.now() - timestamp > Config.CACHE_TTL;
            }

            // ============================================
            // UI UTILITIES
            // ============================================
            function showContent() {
                if (DOM.loading) DOM.loading.style.display = 'none';
                if (DOM.content) DOM.content.style.display = 'block';
            }

            function showSkeletonGrid(container, count) {
                if (!container) return;
                
                container.innerHTML = '';
                for (let i = 0; i < count; i++) {
                    const skeleton = document.createElement('div');
                    skeleton.className = 'pulse-item skeleton';
                    container.appendChild(skeleton);
                }
            }

            function showSkeletonCards(container, count) {
                if (!container) return;
                
                container.innerHTML = '';
                for (let i = 0; i < count; i++) {
                    const skeleton = document.createElement('div');
                    skeleton.className = 'memory-card skeleton';
                    skeleton.style.height = '120px';
                    container.appendChild(skeleton);
                }
            }

            function showEmptyState(container, type, message) {
                if (!container) return;
                
                const icons = {
                    pulse: 'fas fa-pulse',
                    series: 'fas fa-layer-group',
                    links: 'fas fa-link',
                    journey: 'fas fa-history'
                };
                
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1; padding: 60px 20px;">
                        <div class="empty-icon">
                            <i class="${icons[type] || 'fas fa-inbox'}"></i>
                        </div>
                        <div class="empty-title">No ${type === 'pulse' ? 'Pulses' : type === 'journey' ? 'Journey Data' : type} Yet</div>
                        <div class="empty-description">
                            ${message}
                        </div>
                    </div>
                `;
            }

            function showToast(message, type = 'error') {
                if (!DOM.toastContainer) return;
                
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.setAttribute('role', 'alert');
                toast.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    <span>${message}</span>
                `;
                
                DOM.toastContainer.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => {
                        if (toast.parentNode === DOM.toastContainer) {
                            DOM.toastContainer.removeChild(toast);
                        }
                    }, 300);
                }, 4000);
            }

            // ============================================
            // EVENT HANDLERS
            // ============================================
            function initializeEventListeners() {
                // Tab switching
                DOM.tabs.forEach(tab => {
                    tab.addEventListener('click', handleTabSwitch);
                });
                
                // Logout
                if (DOM.logoutBtn) {
                    DOM.logoutBtn.addEventListener('click', handleLogout);
                }
                
                // Share button
                if (DOM.shareBtn) {
                    DOM.shareBtn.addEventListener('click', shareProfile);
                }
                
                // Modal controls
                if (DOM.closeEditModal) {
                    DOM.closeEditModal.addEventListener('click', () => toggleModal(false));
                }
                
                if (DOM.cancelEdit) {
                    DOM.cancelEdit.addEventListener('click', () => toggleModal(false));
                }
                
                if (DOM.saveEdit) {
                    DOM.saveEdit.addEventListener('click', saveProfile);
                }
                
                // Bio character counter
                if (DOM.editBio) {
                    DOM.editBio.addEventListener('input', updateBioCharCount);
                }
                
                // Window events
                window.addEventListener('pagehide', cleanup);
                window.addEventListener('beforeunload', cleanup);
                
                console.log('âœ… Event listeners initialized');
            }

            function handleTabSwitch(event) {
                const tab = event.currentTarget;
                const tabId = tab.dataset.tab;
                
                // Update UI
                DOM.tabs.forEach(t => {
                    t.classList.remove('active');
                    t.setAttribute('aria-selected', 'false');
                });
                
                Object.values(DOM.tabContents).forEach(content => {
                    if (content) {
                        content.classList.remove('active');
                        content.hidden = true;
                    }
                });
                
                tab.classList.add('active');
                tab.setAttribute('aria-selected', 'true');
                
                const content = DOM.tabContents[tabId];
                if (content) {
                    content.classList.add('active');
                    content.hidden = false;
                }
                
                // Update state and load content
                State.activeTab = tabId;
                loadActiveTabContent();
            }

            // ============================================
            // HELPER FUNCTIONS
            // ============================================
            function getInitials(name) {
                if (!name) return 'U';
                return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            }

            function handleInitializationError(error) {
                if (DOM.loadingText) {
                    DOM.loadingText.textContent = 'Error loading profile. Please refresh.';
                }
                
                // Fallback after delay
                setTimeout(() => {
                    showContent();
                    initializeEventListeners();
                    loadSampleData();
                }, 2000);
            }

            // ============================================
            // CLEANUP
            // ============================================
            function cleanup() {
                // Cleanup subscriptions
                if (State.notificationsSubscription && State.supabaseClient) {
                    State.supabaseClient.removeChannel(State.notificationsSubscription);
                }
                
                // Cleanup observer
                if (State.observer) {
                    State.observer.disconnect();
                }
                
                // Clear debounce timers
                Object.keys(State.debounceTimers).forEach(key => {
                    clearTimeout(State.debounceTimers[key]);
                });
                
                console.log('ðŸ§¹ Cleanup completed');
            }

            // ============================================
            // PUBLIC API (for inline onclick handlers)
            // ============================================
            window.viewPulses = function() {
                const pulseTab = document.querySelector('.tab[data-tab="pulse"]');
                if (pulseTab) pulseTab.click();
            };
            
            window.viewSeriesTab = function() {
                const seriesTab = document.querySelector('.tab[data-tab="series"]');
                if (seriesTab) seriesTab.click();
            };
            
            window.viewConnectors = function() {
                showToast('Connectors list feature coming soon!', 'success');
            };
            
            window.triggerAvatarUpload = function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = handleAvatarUpload;
                input.click();
            };

            // ============================================
            // STARTUP
            // ============================================
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initialize);
            } else {
                initialize();
            }

        })();
    </script>
</body>
</html>
