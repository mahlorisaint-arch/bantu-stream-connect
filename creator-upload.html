<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
<title>Upload Content - Bantu Stream Connect</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {--deep-black:#0A0E12;--deep-navy:#0F172A;--soft-white:#F8FAFC;--slate-grey:#94A3B8;--bantu-blue:#1D4ED8;--warm-gold:#F59E0B;--error-color:#EF4444;--success-color:#10B981;--card-bg:rgba(15,23,42,.6);--card-border:rgba(148,163,184,.2)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:var(--deep-black);color:var(--soft-white);min-height:100vh;overflow-x:hidden}
.loading-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--deep-black);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000}
.spinner{width:50px;height:50px;border:3px solid rgba(255,255,255,.1);border-radius:50%;border-top-color:var(--bantu-blue);animation:spin 1s linear infinite;margin-bottom:20px}
@keyframes spin{to{transform:rotate(360deg)}}
.header{background:rgba(10,14,18,.9);backdrop-filter:blur(20px);padding:12px 24px;position:sticky;top:0;z-index:100;border-bottom:1px solid var(--card-border);display:flex;justify-content:space-between;align-items:center;min-height:60px}
.logo{display:flex;align-items:center;gap:12px;cursor:pointer;text-decoration:none}
.logo-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;box-shadow:0 0 32px rgba(29,78,216,.3);background:transparent;border:1px solid rgba(255,255,255,.1)}
.logo-text{font-family:'Orbitron',sans-serif;font-weight:700;font-size:17px;background:linear-gradient(to right,var(--soft-white),var(--bantu-blue));-webkit-background-clip:text;background-clip:text;color:transparent;letter-spacing:.5px}
.upload-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:24px;padding:40px;margin:24px auto;max-width:800px;backdrop-filter:blur(10px);box-shadow:0 20px 40px rgba(0,0,0,.2);position:relative;overflow:hidden}
.upload-card h1{font-family:'Orbitron',sans-serif;font-size:32px;font-weight:700;background:linear-gradient(135deg,var(--soft-white),var(--warm-gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:30px;text-align:center}
.form-group{margin-bottom:25px}
.form-label{display:block;margin-bottom:10px;font-weight:600;color:var(--soft-white);font-size:16px}
.form-label span{color:var(--error-color);margin-left:4px}
.form-input{width:100%;padding:15px;background:rgba(255,255,255,.05);border:1px solid var(--card-border);border-radius:12px;color:var(--soft-white);font-size:16px;transition:all .3s ease}
.form-input:focus{outline:none;border-color:var(--warm-gold);box-shadow:0 0 0 2px rgba(245,158,11,.2)}
textarea.form-input{min-height:120px;resize:vertical}
.upload-zone{border:2px dashed rgba(255,255,255,.3);border-radius:16px;padding:40px 20px;text-align:center;cursor:pointer;transition:all .3s ease;margin-bottom:20px;background:rgba(255,255,255,.05)}
.upload-zone:hover{border-color:var(--warm-gold);background:rgba(245,158,11,.05)}
.upload-zone-icon{font-size:48px;color:var(--warm-gold);margin-bottom:15px}
.upload-zone-text{font-size:16px;color:var(--slate-grey);margin-bottom:10px}
.upload-zone-hint{font-size:14px;color:rgba(255,255,255,.5)}
.file-info{display:flex;align-items:center;gap:15px;padding:15px;background:rgba(255,255,255,.05);border-radius:12px;margin-top:10px;border:1px solid var(--card-border);display:none}
.file-icon{font-size:24px;color:var(--warm-gold)}
.file-name{font-weight:600;margin-bottom:5px;color:var(--soft-white)}
.file-size{font-size:14px;color:var(--slate-grey)}
.file-remove{color:var(--error-color);cursor:pointer;font-size:20px}
.action-buttons{display:flex;gap:20px;margin-top:40px}
.action-btn{flex:1;padding:18px;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:all .3s ease;border:none}
.action-btn.publish{background:linear-gradient(135deg,var(--bantu-blue),var(--warm-gold));color:var(--soft-white)}
.action-btn.publish:disabled{opacity:.5;cursor:not-allowed}
.action-btn.draft{background:rgba(255,255,255,.05);border:1px solid var(--card-border);color:var(--soft-white)}
#toast-container{position:fixed;bottom:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:10px}
.toast{padding:15px 25px;border-radius:12px;color:var(--soft-white);font-weight:500;max-width:300px;border:1px solid var(--card-border);display:flex;align-items:center;gap:10px}
.toast.error{background:rgba(239,68,68,.9)}
.toast.success{background:rgba(16,185,129,.9)}
.auth-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:2000}
.auth-modal.active{display:flex}
.auth-content{background:var(--card-bg);border-radius:20px;padding:40px;max-width:400px;width:90%;text-align:center;border:1px solid var(--card-border)}
.profile-btn{width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,var(--bantu-blue),var(--warm-gold));border:2px solid rgba(255,255,255,.2);cursor:pointer;display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:14px}
#app{display:none}
</style>
</head>
<body>
<div id="loading" class="loading-screen">
  <div class="spinner"></div>
  <div id="loading-text">Loading Creator Upload...</div>
</div>

<div id="auth-modal" class="auth-modal">
  <div class="auth-content">
    <div style="font-size:64px;color:var(--warm-gold);margin-bottom:20px"><i class="fas fa-lock"></i></div>
    <h2 style="font-family:'Orbitron',sans-serif;font-size:24px;margin-bottom:15px;color:var(--soft-white)">Authentication Required</h2>
    <p style="color:var(--slate-grey);margin-bottom:30px;line-height:1.6">You need to be logged in to upload content. Please sign in to share your content with the community.</p>
    <div style="display:flex;gap:15px">
      <button id="auth-login-btn" style="flex:1;padding:15px;border-radius:12px;font-size:16px;font-weight:600;background:linear-gradient(135deg,var(--bantu-blue),var(--warm-gold));color:var(--soft-white);border:none">Log In</button>
      <button id="auth-cancel-btn" style="flex:1;padding:15px;border-radius:12px;font-size:16px;font-weight:600;background:rgba(255,255,255,.05);border:1px solid var(--card-border);color:var(--soft-white)">Cancel</button>
    </div>
  </div>
</div>

<div id="app">
  <header class="header">
    <div class="logo" onclick="window.location.href='index.html'">
      <div class="logo-icon"><i class="fas fa-film" style="color:var(--warm-gold);font-size:20px"></i></div>
      <div class="logo-text">BANTU STREAM CONNECT</div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <button id="back-btn" class="profile-btn" style="width:38px;height:38px;background:rgba(255,255,255,.1)"><i class="fas fa-arrow-left" style="color:var(--soft-white)"></i></button>
      <button id="profile-btn" class="profile-btn"><i class="fas fa-user"></i></button>
    </div>
  </header>

  <main>
    <div class="upload-card">
      <h1>UPLOAD YOUR CONTENT</h1>
      <form id="upload-form">
        <div class="form-group">
          <label class="form-label">Title <span>*</span></label>
          <input type="text" id="content-title" class="form-input" placeholder="Enter content title (max 100 characters)" maxlength="100" required>
        </div>
        <div class="form-group">
          <label class="form-label">Description <span>*</span></label>
          <textarea id="content-description" class="form-input" placeholder="Describe your content (max 500 characters)" maxlength="500" rows="4" required></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Genre/Category <span>(Optional)</span></label>
          <select id="content-genre" class="form-input" style="cursor:pointer">
            <option value="">Select a genre (optional)</option>
            <option value="Music">Music</option>
            <option value="STEM">STEM</option>
            <option value="Culture">Culture</option>
            <option value="News">News</option>
            <option value="Sports">Sports</option>
            <option value="Movies">Movies</option>
            <option value="Documentaries">Documentaries</option>
            <option value="Podcasts">Podcasts</option>
            <option value="Skits">Skits</option>
            <option value="Videos">Videos</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Media File (Video/Audio) <span>*</span></label>
          <div id="media-upload-zone" class="upload-zone">
            <div class="upload-zone-icon"><i class="fas fa-video"></i></div>
            <div class="upload-zone-text" id="media-zone-text">Click or drag video/audio files here</div>
            <div class="upload-zone-hint">Supports MP4, MOV, AVI, MKV, WEBM, MP3, AAC, WAV (Max 800MB)</div>
          </div>
          <div id="media-file-info" class="file-info">
            <div class="file-icon"><i class="fas fa-video"></i></div>
            <div style="flex:1">
              <div class="file-name" id="media-file-name"></div>
              <div class="file-size" id="media-file-size"></div>
            </div>
            <div class="file-remove" onclick="removeMediaFile()"><i class="fas fa-times"></i></div>
          </div>
          <input type="file" id="media-file-input" accept="video/*,audio/*" style="display:none">
        </div>
        <div class="action-buttons">
          <button type="button" id="save-draft-btn" class="action-btn draft" disabled>
            <i class="fas fa-save"></i> Save Draft
          </button>
          <button type="submit" id="publish-btn" class="action-btn publish" disabled>
            <i class="fas fa-cloud-upload-alt"></i> Publish Content
          </button>
        </div>
      </form>
    </div>
  </main>
</div>

<div id="toast-container"></div>

<!-- CRITICAL FIX #1: Initialize Supabase client BEFORE DOMContentLoaded -->
<script>
// Initialize shared Supabase client globally (MUST be before DOMContentLoaded)
if (!window.supabaseClient) {
  window.supabaseClient = supabase.createClient(
    'https://ydnxqnbjoshvxteevemc.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkbnhxbmJqb3Nodnh0ZWV2ZW1jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MzI0OTMsImV4cCI6MjA3MzIwODQ5M30.NlaCCnLPSz1mM7AFeSlfZQ78kYEKUMh_Fi-7P_ccs_U'
  );
  console.log('✅ Global Supabase client initialized');
}
</script>

<script>
// CRITICAL FIX #2: Minimal initialization without helper dependencies
document.addEventListener('DOMContentLoaded', async () => {
  const loadingScreen = document.getElementById('loading');
  const app = document.getElementById('app');
  const authModal = document.getElementById('auth-modal');
  const publishBtn = document.getElementById('publish-btn');
  const saveDraftBtn = document.getElementById('save-draft-btn');
  const profileBtn = document.getElementById('profile-btn');
  const backBtn = document.getElementById('back-btn');
  
  let selectedMediaFile = null;
  let currentUserId = null;
  let isUploading = false;

  // Simple loading toggle
  function setLoading(loading) {
    loadingScreen.style.display = loading ? 'flex' : 'none';
    app.style.display = loading ? 'none' : 'block';
  }

  // Simple toast
  function showToast(message, type = 'error') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i> ${message}`;
    document.getElementById('toast-container').appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  // Format file size
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // CRITICAL FIX #3: CORRECT SYNTAX (single braces)
  async function checkAuthentication() {
    try {
      // ✅ FIXED SYNTAX: Single braces around session
      const {  { session }, error } = await window.supabaseClient.auth.getSession();
      
      if (error) {
        console.error('Session error:', error);
        return false;
      }
      
      if (!session?.user) {
        console.log('⚠️ User not authenticated');
        return false;
      }
      
      currentUserId = session.user.id;
      console.log('✅ Authenticated user:', session.user.email);
      
      // Simple profile UI update
      profileBtn.innerHTML = session.user.email.charAt(0).toUpperCase();
      
      return true;
    } catch (error) {
      console.error('Auth check failed:', error);
      return false;
    }
  }

  // Setup media upload
  function setupMediaUpload() {
    const zone = document.getElementById('media-upload-zone');
    const input = document.getElementById('media-file-input');
    
    zone.addEventListener('click', () => input.click());
    input.addEventListener('change', (e) => {
      if (e.target.files.length > 0) handleMediaFile(e.target.files[0]);
    });
  }

  function handleMediaFile(file) {
    // ✅ MOBILE APP PATTERN: 800MB limit
    const maxSize = 800 * 1024 * 1024;
    if (file.size > maxSize) {
      showToast('File size must be less than 800MB');
      return;
    }
    
    const videoTypes = ['video/mp4', 'video/mov', 'video/avi', 'video/mkv', 'video/webm'];
    const audioTypes = ['audio/mpeg', 'audio/mp3', 'audio/aac', 'audio/wav'];
    if (!videoTypes.includes(file.type) && !audioTypes.includes(file.type)) {
      showToast('Please select a valid video or audio file');
      return;
    }
    
    selectedMediaFile = file;
    document.getElementById('media-file-name').textContent = file.name;
    document.getElementById('media-file-size').textContent = formatFileSize(file.size);
    document.getElementById('media-file-info').style.display = 'flex';
    document.getElementById('media-zone-text').textContent = 'Click to change file';
    updateButtonsState();
  }

  function removeMediaFile() {
    selectedMediaFile = null;
    document.getElementById('media-file-info').style.display = 'none';
    document.getElementById('media-zone-text').textContent = 'Click or drag video/audio files here';
    updateButtonsState();
  }

  function updateButtonsState() {
    const title = document.getElementById('content-title').value.trim();
    const desc = document.getElementById('content-description').value.trim();
    
    saveDraftBtn.disabled = !title || isUploading || !currentUserId;
    publishBtn.disabled = !title || !desc || !selectedMediaFile || isUploading || !currentUserId;
  }

  // ✅ MOBILE APP PATTERN: Upload to 'content-media' bucket
  async function uploadFileToStorage(file, path) {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(7);
    const fileName = `${timestamp}_${random}_${file.name}`;
    const filePath = `${path}/${fileName}`;
    
    try {
      // ✅ CORRECT BUCKET NAME (matches mobile app)
      const { data, error } = await window.supabaseClient.storage
        .from('content-media')
        .upload(filePath, file, { contentType: file.type });
      
      if (error) throw error;
      
      // ✅ CORRECT PUBLIC URL FORMAT
      return `https://ydnxqnbjoshvxteevemc.supabase.co/storage/v1/object/public/content-media/${filePath}`;
    } catch (error) {
      console.error('Upload failed:', error);
      throw error;
    }
  }

  // ✅ MOBILE APP PATTERN: Insert into 'Content' table with user_id
  async function createContentRecord(data) {
    try {
      const { error } = await window.supabaseClient
        .from('Content') // ✅ Capital C to match schema
        .insert([{
          title: data.title,
          description: data.description,
          file_url: data.media_url,
          thumbnail_url: data.thumbnail_url || '',
          media_type: data.media_type,
          genre: data.genre || null,
          status: data.status,
          user_id: currentUserId, // ✅ CRITICAL FOR RLS
          created_at: new Date().toISOString()
        }]);
      
      if (error) throw error;
      return true;
    } catch (error) {
      console.error('DB insert failed:', error);
      throw error;
    }
  }

  async function uploadContent(isDraft = false) {
    if (!currentUserId) {
      showToast('Please sign in to upload content');
      authModal.classList.add('active');
      return;
    }
    
    const title = document.getElementById('content-title').value.trim();
    const desc = document.getElementById('content-description').value.trim();
    const genre = document.getElementById('content-genre').value;
    
    if (!title || !desc || !selectedMediaFile) {
      showToast('Please fill all required fields');
      return;
    }
    
    isUploading = true;
    updateButtonsState();
    
    try {
      // Step 1: Upload media
      const mediaType = selectedMediaFile.type.includes('video') ? 'video' : 'audio';
      const mediaUrl = await uploadFileToStorage(selectedMediaFile, 'videos');
      
      // Step 2: Create content record
      await createContentRecord({
        title,
        description: desc,
        media_url: mediaUrl,
        thumbnail_url: '',
        media_type: mediaType,
        genre,
        status: isDraft ? 'draft' : 'published'
      });
      
      showToast(`Content ${isDraft ? 'saved as draft' : 'published'} successfully!`, 'success');
      
      // Reset form
      setTimeout(() => {
        document.getElementById('content-title').value = '';
        document.getElementById('content-description').value = '';
        document.getElementById('content-genre').value = '';
        removeMediaFile();
        if (!isDraft) window.location.href = 'content-library.html';
      }, 1500);
      
    } catch (error) {
      showToast(`Upload failed: ${error.message || 'Unknown error'}`);
    } finally {
      isUploading = false;
      updateButtonsState();
    }
  }

  // Event listeners
  function setupListeners() {
    document.getElementById('upload-form').addEventListener('submit', (e) => {
      e.preventDefault();
      uploadContent(false);
    });
    
    document.getElementById('save-draft-btn').addEventListener('click', () => {
      uploadContent(true);
    });
    
    ['content-title', 'content-description'].forEach(id => {
      document.getElementById(id).addEventListener('input', updateButtonsState);
    });
    
    document.getElementById('content-genre').addEventListener('change', updateButtonsState);
    
    document.getElementById('auth-login-btn').addEventListener('click', () => {
      window.location.href = `login.html?redirect=${encodeURIComponent('creator-upload.html')}`;
    });
    
    document.getElementById('auth-cancel-btn').addEventListener('click', () => {
      authModal.classList.remove('active');
      window.history.back();
    });
    
    backBtn.addEventListener('click', () => window.history.back());
    
    profileBtn.addEventListener('click', () => {
      if (currentUserId) {
        window.location.href = 'profile.html';
      } else {
        window.location.href = `login.html?redirect=${encodeURIComponent('creator-upload.html')}`;
      }
    });
  }

  // ✅ CRITICAL FIX #4: Initialize WITHOUT waiting for helpers (prevents freeze)
  async function initialize() {
    setLoading(true);
    
    // Check auth FIRST (doesn't depend on helpers)
    const isAuthenticated = await checkAuthentication();
    
    if (!isAuthenticated) {
      authModal.classList.add('active');
    }
    
    // Setup UI regardless of auth state (prevents infinite loading)
    setupMediaUpload();
    setupListeners();
    updateButtonsState();
    
    setLoading(false);
    console.log('✅ Creator Upload initialized successfully');
  }
  
  initialize();
});

// Global functions
window.removeMediaFile = function() {
  document.getElementById('media-file-input').value = '';
  document.getElementById('media-file-info').style.display = 'none';
  document.getElementById('media-zone-text').textContent = 'Click or drag video/audio files here';
  selectedMediaFile = null;
  updateButtonsState();
};
</script>
</body>
</html>
