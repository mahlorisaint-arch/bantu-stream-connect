<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
<title>Upload Content - Bantu Stream Connect</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
--deep-black: #0A0E12;
--deep-navy: #0F172A;
--soft-white: #F8FAFC;
--slate-grey: #94A3B8;
--bantu-blue: #1D4ED8;
--warm-gold: #F59E0B;
--error-color: #EF4444;
--success-color: #10B981;
--card-bg: rgba(15, 23, 42, 0.6);
--card-border: rgba(148, 163, 184, 0.2);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Inter', sans-serif; background: var(--deep-black); color: var(--soft-white); min-height: 100vh; overflow-x: hidden; }
.loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--deep-black); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
.spinner { width: 50px; height: 50px; border: 3px solid rgba(255,255,255,.1); border-radius: 50%; border-top-color: var(--bantu-blue); animation: spin 1s linear infinite; margin-bottom: 20px; }
@keyframes spin { to { transform: rotate(360deg); } }
.header { background: rgba(10,14,18,.9); backdrop-filter: blur(20px); padding: 12px 24px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--card-border); display: flex; justify-content: space-between; align-items: center; min-height: 60px; }
.logo { display: flex; align-items: center; gap: 12px; cursor: pointer; text-decoration: none; }
.logo-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 32px rgba(29,78,216,.3); background: transparent; border: 1px solid rgba(255,255,255,.1); overflow: hidden; }
.logo-icon img { width: 100%; height: 100%; object-fit: contain; }
.logo-text { font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 17px; background: linear-gradient(to right,var(--soft-white),var(--bantu-blue)); -webkit-background-clip: text; background-clip: text; color: transparent; letter-spacing: .5px; }
.upload-card { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 24px; padding: 40px; margin: 24px auto; max-width: 800px; backdrop-filter: blur(10px); box-shadow: 0 20px 40px rgba(0,0,0,.2); position: relative; overflow: hidden; }
.upload-card h1 { font-family: 'Orbitron', sans-serif; font-size: 32px; font-weight: 700; background: linear-gradient(135deg,var(--soft-white),var(--warm-gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 30px; text-align: center; }
.form-group { margin-bottom: 25px; }
.form-label { display: block; margin-bottom: 10px; font-weight: 600; color: var(--soft-white); font-size: 16px; }
.form-label span { color: var(--error-color); margin-left: 4px; }
.form-input { width: 100%; padding: 15px; background: rgba(255,255,255,.05); border: 1px solid var(--card-border); border-radius: 12px; color: var(--soft-white); font-size: 16px; transition: all .3s ease; }
.form-input:focus { outline: none; border-color: var(--warm-gold); box-shadow: 0 0 0 2px rgba(245,158,11,.2); }
textarea.form-input { min-height: 120px; resize: vertical; }
.upload-zone { border: 2px dashed rgba(255,255,255,.3); border-radius: 16px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all .3s ease; margin-bottom: 20px; background: rgba(255,255,255,.05); }
.upload-zone:hover { border-color: var(--warm-gold); background: rgba(245,158,11,.05); }
.upload-zone-icon { font-size: 48px; color: var(--warm-gold); margin-bottom: 15px; }
.upload-zone-text { font-size: 16px; color: var(--slate-grey); margin-bottom: 10px; }
.upload-zone-hint { font-size: 14px; color: rgba(255,255,255,.5); }
.file-info { display: flex; align-items: center; gap: 15px; padding: 15px; background: rgba(255,255,255,.05); border-radius: 12px; margin-top: 10px; border: 1px solid var(--card-border); display: none; }
.file-icon { font-size: 24px; color: var(--warm-gold); }
.file-name { font-weight: 600; margin-bottom: 5px; color: var(--soft-white); }
.file-size { font-size: 14px; color: var(--slate-grey); }
.file-remove { color: var(--error-color); cursor: pointer; font-size: 20px; }
.thumbnail-section { margin: 30px 0; }
.thumbnail-preview { width: 100%; height: 200px; border-radius: 12px; overflow: hidden; margin-top: 15px; background: rgba(0,0,0,.3); border: 1px solid var(--card-border); display: none; }
.thumbnail-preview img { width: 100%; height: 100%; object-fit: cover; }
.thumbnail-actions { display: flex; gap: 15px; margin-top: 15px; }
.thumbnail-btn { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid var(--card-border); background: rgba(255,255,255,.05); color: var(--soft-white); font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all .3s ease; }
.thumbnail-btn:hover { background: rgba(255,255,255,.1); border-color: var(--warm-gold); }
.thumbnail-btn.primary { background: linear-gradient(135deg,var(--warm-gold),#f97316); color: var(--deep-black); border: none; font-weight: 600; }
.genre-select { width: 100%; padding: 15px; background: rgba(255,255,255,.05); border: 1px solid var(--card-border); border-radius: 12px; color: var(--soft-white); font-size: 16px; cursor: pointer; }
.upload-progress { margin: 30px 0; padding: 20px; background: rgba(255,255,255,.05); border-radius: 12px; display: none; border: 1px solid var(--card-border); }
.upload-progress.active { display: block; }
.progress-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
.progress-bar { height: 8px; background: rgba(255,255,255,.1); border-radius: 4px; overflow: hidden; margin-bottom: 10px; }
.progress-fill { height: 100%; background: linear-gradient(90deg,var(--warm-gold),#f97316); border-radius: 4px; width: 0%; transition: width .3s ease; }
.progress-text { font-size: 14px; color: var(--slate-grey); text-align: center; }
.action-buttons { display: flex; gap: 20px; margin-top: 40px; }
.action-btn { flex: 1; padding: 18px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all .3s ease; border: none; }
.action-btn.publish { background: linear-gradient(135deg,var(--bantu-blue),var(--warm-gold)); color: var(--soft-white); }
.action-btn.publish:disabled { opacity: .5; cursor: not-allowed; }
.action-btn.draft { background: rgba(255,255,255,.05); border: 1px solid var(--card-border); color: var(--soft-white); }
.action-btn.draft:disabled { opacity: .5; cursor: not-allowed; }
.helper-text { margin-top: 30px; padding: 20px; background: rgba(255,255,255,.05); border-radius: 12px; font-size: 14px; color: var(--slate-grey); text-align: center; line-height: 1.6; border: 1px solid var(--card-border); }
#toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
.toast { padding: 15px 25px; border-radius: 12px; color: var(--soft-white); font-weight: 500; max-width: 300px; border: 1px solid var(--card-border); display: flex; align-items: center; gap: 10px; }
.toast.error { background: rgba(239,68,68,.9); }
.toast.success { background: rgba(16,185,129,.9); }
.auth-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.8); display: none; align-items: center; justify-content: center; z-index: 2000; }
.auth-modal.active { display: flex; }
.auth-content { background: var(--card-bg); border-radius: 20px; padding: 40px; max-width: 400px; width: 90%; text-align: center; border: 1px solid var(--card-border); }
.profile-btn { width: 38px; height: 38px; border-radius: 50%; background: linear-gradient(135deg,var(--bantu-blue),var(--warm-gold)); border: 2px solid rgba(255,255,255,.2); cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; overflow: hidden; }
.profile-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
.profile-placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg,var(--bantu-blue),var(--warm-gold)); color: white; font-weight: bold; font-size: 14px; border-radius: 50%; }
#app { display: none; }
.icon-btn { width: 38px; height: 38px; border-radius: 50%; background: rgba(255,255,255,.1); border: 1px solid rgba(255,255,255,.2); color: var(--soft-white); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all .3s ease; position: relative; }
.icon-btn:hover { background: rgba(255,255,255,.2); transform: translateY(-2px); }
.notification-badge { position: absolute; top: -5px; right: -5px; background: var(--error-color); color: white; font-size: 10px; font-weight: bold; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid var(--deep-black); }

/* ðŸ”‘ CRITICAL FIX: Notifications Panel Styles (EXACT from explore-screen.html) */
.notifications-panel {
position: fixed;
top: 0;
right: -100%;
width: 400px;
height: 100%;
background: var(--card-bg);
border-left: 1px solid var(--card-border);
box-shadow: -5px 0 25px rgba(0, 0, 0, 0.3);
z-index: 1000;
transition: right 0.3s ease;
backdrop-filter: blur(10px);
}
.notifications-panel.active {
right: 0;
}
.notifications-header {
padding: 20px;
border-bottom: 1px solid var(--card-border);
display: flex;
justify-content: space-between;
align-items: center;
width: 100%;
}
.notifications-list {
max-height: calc(100vh - 150px);
overflow-y: auto;
padding: 20px;
width: 100%;
}
.notification-item {
padding: 15px;
border-bottom: 1px solid var(--card-border);
display: flex;
gap: 12px;
width: 100%;
position: relative;
}
.notification-item.read {
opacity: 0.7;
}
.notification-icon {
width: 40px;
height: 40px;
border-radius: 50%;
background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
display: flex;
align-items: center;
justify-content: center;
flex-shrink: 0;
}
.notification-content h4 {
font-weight: 600;
margin-bottom: 5px;
color: var(--soft-white);
font-size: 16px;
}
.notification-content p {
font-size: 14px;
color: var(--slate-grey);
margin-bottom: 8px;
line-height: 1.4;
}
.notification-time {
font-size: 12px;
color: var(--warm-gold);
}
.notification-dot {
width: 10px;
height: 10px;
border-radius: 50%;
background: var(--warm-gold);
position: absolute;
top: 15px;
right: 15px;
}
.notifications-footer {
padding: 20px;
border-top: 1px solid var(--card-border);
display: flex;
gap: 15px;
width: 100%;
}
.text-btn {
flex: 1;
padding: 12px;
border-radius: 10px;
border: 1px solid var(--card-border);
background: rgba(255, 255, 255, 0.05);
color: var(--soft-white);
font-size: 16px;
font-weight: 600;
cursor: pointer;
transition: all 0.3s ease;
}
.text-btn:hover {
background: rgba(245, 158, 11, 0.1);
border-color: var(--warm-gold);
}
.empty-notifications {
text-align: center;
padding: 40px 20px;
color: var(--slate-grey);
}
.empty-notifications i {
font-size: 48px;
margin-bottom: 15px;
opacity: 0.5;
}

/* ðŸ”‘ CRITICAL FIX: Search Modal Styles (EXACT from explore-screen.html) */
.search-modal {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.9);
display: none;
align-items: center;
justify-content: center;
z-index: 2000;
backdrop-filter: blur(5px);
}
.search-modal.active {
display: flex;
}
.search-modal-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
padding-bottom: 15px;
border-bottom: 1px solid var(--card-border);
width: 100%;
}
.search-input-container {
position: relative;
width: 100%;
max-width: 600px;
}
.search-icon {
position: absolute;
left: 15px;
top: 50%;
transform: translateY(-50%);
color: var(--slate-grey);
font-size: 18px;
}
.search-input {
width: 100%;
padding: 15px 15px 15px 45px;
border-radius: 12px;
border: 1px solid var(--card-border);
background: var(--card-bg);
color: var(--soft-white);
font-size: 16px;
backdrop-filter: blur(10px);
}
.search-input::placeholder {
color: var(--slate-grey);
}
.search-input:focus {
outline: none;
border-color: var(--warm-gold);
box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
}
.close-search-btn {
background: none;
border: none;
color: var(--soft-white);
font-size: 24px;
cursor: pointer;
width: 40px;
height: 40px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
transition: all 0.3s ease;
}
.close-search-btn:hover {
background: rgba(255, 255, 255, 0.1);
transform: rotate(90deg);
}
.search-filters {
display: flex;
gap: 15px;
margin-bottom: 20px;
width: 100%;
max-width: 600px;
}
.filter-group {
flex: 1;
}
.filter-label {
display: block;
margin-bottom: 8px;
font-size: 14px;
color: var(--slate-grey);
}
.filter-select {
width: 100%;
padding: 12px;
border-radius: 10px;
border: 1px solid var(--card-border);
background: var(--card-bg);
color: var(--soft-white);
font-size: 14px;
backdrop-filter: blur(10px);
}
.search-results {
width: 100%;
max-width: 800px;
max-height: 70vh;
overflow-y: auto;
}
.search-results-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
gap: 15px;
}
.content-card {
background: var(--card-bg);
border: 1px solid var(--card-border);
border-radius: 20px;
overflow: hidden;
transition: all 0.3s ease;
cursor: pointer;
text-decoration: none;
color: inherit;
backdrop-filter: blur(10px);
position: relative;
}
.content-card:hover {
transform: translateY(-8px);
box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
border-color: rgba(245, 158, 11, 0.3);
}
.card-thumbnail {
position: relative;
height: 140px;
overflow: hidden;
}
.card-thumbnail img {
width: 100%;
height: 100%;
object-fit: cover;
transition: transform 0.3s ease;
}
.content-card:hover .card-thumbnail img {
transform: scale(1.05);
}
.thumbnail-overlay {
position: absolute;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: linear-gradient(to bottom, transparent 50%, rgba(0, 0, 0, 0.5) 100%);
}
.play-overlay {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.5);
display: flex;
align-items: center;
justify-content: center;
opacity: 0;
transition: opacity 0.3s ease;
}
.content-card:hover .play-overlay {
opacity: 1;
}
.play-icon {
width: 50px;
height: 50px;
background: rgba(245, 158, 11, 0.9);
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
color: var(--deep-black);
font-size: 1.5rem;
transform: scale(0.8);
transition: all 0.3s ease;
}
.content-card:hover .play-icon {
transform: scale(1);
}
.card-content {
padding: 15px;
}
.card-title {
font-size: 16px;
font-weight: 600;
margin-bottom: 10px;
display: -webkit-box;
-webkit-line-clamp: 2;
-webkit-box-orient: vertical;
overflow: hidden;
min-height: 40px;
color: var(--soft-white);
line-height: 1.4;
}
.creator-btn {
background: linear-gradient(135deg, var(--bantu-blue), var(--warm-gold));
color: var(--soft-white);
border: none;
padding: 8px 15px;
border-radius: 10px;
font-size: 12px;
font-weight: 500;
cursor: pointer;
display: inline-flex;
align-items: center;
gap: 5px;
transition: all 0.3s ease;
border: 1px solid rgba(255, 255, 255, 0.1);
margin-top: 8px;
}
.creator-btn:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(29, 78, 216, 0.4);
}
.card-stats {
display: flex;
gap: 15px;
margin-top: 8px;
font-size: 12px;
color: var(--slate-grey);
}
.card-stat {
display: flex;
align-items: center;
gap: 4px;
}
.card-stat i {
color: var(--bantu-blue);
font-size: 12px;
}
.no-results {
text-align: center;
padding: 40px;
color: var(--slate-grey);
font-size: 16px;
}
.infinite-scroll-loading {
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
padding: 40px;
color: var(--slate-grey);
}
.infinite-scroll-spinner {
width: 40px;
height: 40px;
border: 3px solid rgba(255, 255, 255, 0.1);
border-radius: 50%;
border-top-color: var(--warm-gold);
animation: spin 1s linear infinite;
margin-bottom: 15px;
}
.footer { background: var(--card-bg); border-top: 1px solid var(--card-border); padding: 30px 20px; margin-top: 50px; backdrop-filter: blur(10px); text-align: center; }
.footer-links { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-top: 15px; }
.footer-links a { color: var(--slate-grey); text-decoration: none; transition: color .3s ease; font-size: 14px; }
.footer-links a:hover { color: var(--warm-gold); }
@media (max-width: 768px) {
.upload-card { padding: 30px 20px; }
.action-buttons { flex-direction: column; }
.thumbnail-actions { flex-direction: column; }
}
</style>
</head>
<body>
<div id="loading" class="loading-screen">
  <div class="spinner"></div>
  <div id="loading-text">Loading Creator Upload...</div>
</div>

<div id="auth-modal" class="auth-modal">
  <div class="auth-content">
    <div style="font-size:64px;color:var(--warm-gold);margin-bottom:20px"><i class="fas fa-lock"></i></div>
    <h2 style="font-family:'Orbitron',sans-serif;font-size:24px;margin-bottom:15px;color:var(--soft-white)">Authentication Required</h2>
    <p style="color:var(--slate-grey);margin-bottom:30px;line-height:1.6">You need to be logged in to upload content. Please sign in to share your content with the community.</p>
    <div style="display:flex;gap:15px">
      <button id="auth-login-btn" style="flex:1;padding:15px;border-radius:12px;font-size:16px;font-weight:600;background:linear-gradient(135deg,var(--bantu-blue),var(--warm-gold));color:var(--soft-white);border:none">Log In</button>
      <button id="auth-cancel-btn" style="flex:1;padding:15px;border-radius:12px;font-size:16px;font-weight:600;background:rgba(255,255,255,.05);border:1px solid var(--card-border);color:var(--soft-white)">Cancel</button>
    </div>
  </div>
</div>

<!-- ðŸ”‘ CRITICAL FIX: Search Modal Structure (EXACT from explore-screen.html) -->
<div id="search-modal" class="search-modal">
  <div style="width:90%;max-width:800px;background:var(--card-bg);border-radius:20px;padding:30px;backdrop-filter:blur(10px);">
    <div class="search-modal-header">
      <div class="search-input-container">
        <i class="search-icon fas fa-search"></i>
        <input type="text" id="search-input" class="search-input" placeholder="Search content, creators, or categories..." autocomplete="off">
      </div>
      <button id="close-search-btn" class="close-search-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="search-filters">
      <div class="filter-group">
        <label class="filter-label">Category</label>
        <select id="category-filter" class="filter-select">
          <option value="">All Categories</option>
          <option value="Music">Music</option>
          <option value="STEM">STEM</option>
          <option value="Culture">Culture</option>
          <option value="News">News</option>
          <option value="Sports">Sports</option>
          <option value="Movies">Movies</option>
          <option value="Documentaries">Documentaries</option>
          <option value="Podcasts">Podcasts</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">Sort By</label>
        <select id="sort-filter" class="filter-select">
          <option value="newest">Newest First</option>
          <option value="popular">Most Popular</option>
          <option value="trending">Trending</option>
        </select>
      </div>
    </div>
    <div class="search-results">
      <div id="search-results-grid" class="search-results-grid">
        <!-- Results loaded here -->
      </div>
    </div>
  </div>
</div>

<!-- ðŸ”‘ CRITICAL FIX: Notifications Panel Structure (EXACT from explore-screen.html) -->
<div id="notifications-panel" class="notifications-panel">
  <div class="notifications-header">
    <h2 style="font-family:'Orbitron',sans-serif;font-size:20px;margin:0;color:var(--soft-white)">Notifications</h2>
    <button id="close-notifications" class="close-search-btn">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="notifications-list" id="notifications-list">
    <!-- Notifications loaded here -->
  </div>
  <div class="notifications-footer">
    <button id="mark-all-read" class="text-btn">Mark all as read</button>
    <button id="notification-settings" class="text-btn">Settings</button>
  </div>
</div>

<div id="app">
  <header class="header">
    <div class="logo" onclick="window.location.href='index.html'">
      <div class="logo-icon">
        <img src="assets/icon/bantu_stream_connect_icon.png" alt="Bantu Stream Connect Logo">
      </div>
      <div class="logo-text">BANTU STREAM CONNECT</div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <button id="back-btn" class="icon-btn" title="Go Back">
        <i class="fas fa-arrow-left"></i>
      </button>
      <button id="search-btn" class="icon-btn" title="Search">
        <i class="fas fa-search"></i>
      </button>
      <button id="notifications-btn" class="icon-btn" title="Notifications">
        <i class="fas fa-bell"></i>
        <span class="notification-badge" id="notification-count" style="display:none">0</span>
      </button>
      <button id="profile-btn" class="profile-btn" title="Profile">
        <div class="profile-placeholder" id="userProfilePlaceholder">
          <i class="fas fa-user"></i>
        </div>
      </button>
    </div>
  </header>

  <main>
    <div class="upload-card">
      <h1>UPLOAD YOUR CONTENT</h1>
      <form id="upload-form">
        <div class="form-group">
          <label class="form-label">Title <span>*</span></label>
          <input type="text" id="content-title" class="form-input" placeholder="Enter content title (max 100 characters)" maxlength="100" required>
        </div>
        <div class="form-group">
          <label class="form-label">Description <span>*</span></label>
          <textarea id="content-description" class="form-input" placeholder="Describe your content (max 500 characters)" maxlength="500" rows="4" required></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Genre/Category <span>(Optional)</span></label>
          <select id="content-genre" class="genre-select">
            <option value="">Select a genre (optional)</option>
            <option value="Music">Music</option>
            <option value="STEM">STEM</option>
            <option value="Culture">Culture</option>
            <option value="News">News</option>
            <option value="Sports">Sports</option>
            <option value="Movies">Movies</option>
            <option value="Documentaries">Documentaries</option>
            <option value="Podcasts">Podcasts</option>
            <option value="Skits">Skits</option>
            <option value="Videos">Videos</option>
          </select>
          <div style="color:var(--slate-grey);font-size:14px;margin-top:5px">Selecting a genre helps users discover your content in category feeds</div>
        </div>
        <div class="form-group">
          <label class="form-label">Media File (Video/Audio) <span>*</span></label>
          <div id="media-upload-zone" class="upload-zone">
            <div class="upload-zone-icon"><i class="fas fa-video"></i></div>
            <div class="upload-zone-text" id="media-zone-text">Click or drag video/audio files here</div>
            <div class="upload-zone-hint">Supports MP4, MOV, AVI, MKV, WEBM, MP3, AAC, WAV (Max 800MB)</div>
          </div>
          <div id="media-file-info" class="file-info">
            <div class="file-icon"><i class="fas fa-video"></i></div>
            <div style="flex:1">
              <div class="file-name" id="media-file-name"></div>
              <div class="file-size" id="media-file-size"></div>
            </div>
            <div class="file-remove" onclick="removeMediaFile()"><i class="fas fa-times"></i></div>
          </div>
          <input type="file" id="media-file-input" accept="video/*,audio/*" style="display:none">
        </div>
        <div class="form-group thumbnail-section">
          <label class="form-label">Thumbnail Image <span>(Optional)</span></label>
          <div id="thumbnail-upload-zone" class="upload-zone" style="padding:20px">
            <div class="upload-zone-icon"><i class="fas fa-image"></i></div>
            <div class="upload-zone-text">Click or drag thumbnail image here</div>
            <div class="upload-zone-hint">Supports JPG, PNG, GIF (Recommended: 1280x720)</div>
          </div>
          <div id="thumbnail-preview" class="thumbnail-preview">
            <img id="thumbnail-image" src="" alt="Thumbnail Preview">
          </div>
          <div class="thumbnail-actions">
            <button type="button" class="thumbnail-btn" onclick="openImagePicker()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <polyline points="21 15 16 10 5 21"/>
              </svg>
              Choose from Gallery
            </button>
            <button type="button" class="thumbnail-btn" onclick="captureCameraImage()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
                <circle cx="12" cy="13" r="4"/>
              </svg>
              Take Photo
            </button>
          </div>
          <input type="file" id="thumbnail-file-input" accept="image/*" style="display:none">
          <input type="file" id="camera-file-input" accept="image/*" capture="environment" style="display:none">
        </div>
        <div id="upload-progress" class="upload-progress">
          <div class="progress-header">
            <span>Uploading...</span>
            <span id="progress-percentage">0%</span>
          </div>
          <div class="progress-bar">
            <div id="progress-fill" class="progress-fill"></div>
          </div>
          <div id="progress-text" class="progress-text">Preparing upload...</div>
        </div>
        <div class="action-buttons">
          <button type="button" id="save-draft-btn" class="action-btn draft" disabled>
            <i class="fas fa-save"></i> Save Draft
          </button>
          <button type="submit" id="publish-btn" class="action-btn publish" disabled>
            <i class="fas fa-cloud-upload-alt"></i> Publish Content
          </button>
        </div>
      </form>
      <div class="helper-text">
        Your content will be reviewed and published within 24 hours. Make sure to follow our community guidelines.<br>
        Please stay on this page until upload is complete.
      </div>
    </div>
  </main>

  <footer class="footer">
    <p>Bantu Stream Connect Â© 2025 â€¢ Built in South Africa â€¢ NO DNA, JUST RSA</p>
    <div class="footer-links">
      <a href="privacy-policy.html">Privacy Policy</a>
      <a href="terms-of-service.html">Terms of Service</a>
      <a href="support.html">Support</a>
    </div>
  </footer>
</div>

<div id="toast-container"></div>

<script>
// Initialize shared Supabase client BEFORE DOMContentLoaded
if (!window.supabaseClient) {
  window.supabaseClient = supabase.createClient(
    'https://ydnxqnbjoshvxteevemc.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkbnhxbmJqb3Nodnh0ZWV2ZW1jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MzI0OTMsImV4cCI6MjA3MzIwODQ5M30.NlaCCnLPSz1mM7AFeSlfZQ78kYEKUMh_Fi-7P_ccs_U'
  );
  console.log('âœ… Global Supabase client initialized');
}
</script>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  // DOM Elements
  const loadingScreen = document.getElementById('loading');
  const app = document.getElementById('app');
  const authModal = document.getElementById('auth-modal');
  const publishBtn = document.getElementById('publish-btn');
  const saveDraftBtn = document.getElementById('save-draft-btn');
  const profileBtn = document.getElementById('profile-btn');
  const backBtn = document.getElementById('back-btn');
  const notificationsBtn = document.getElementById('notifications-btn');
  const searchBtn = document.getElementById('search-btn');
  const progressSection = document.getElementById('upload-progress');
  const progressFill = document.getElementById('progress-fill');
  const progressPercentage = document.getElementById('progress-percentage');
  const progressText = document.getElementById('progress-text');
  
  let selectedMediaFile = null;
  let selectedThumbnailFile = null;
  let currentUserId = null;
  let isUploading = false;
  let currentUserEmail = null;

  // UI Helpers
  function setLoading(loading) {
    loadingScreen.style.display = loading ? 'flex' : 'none';
    app.style.display = loading ? 'none' : 'block';
  }

  function showToast(message, type = 'error') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i> ${message}`;
    document.getElementById('toast-container').appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  function updateProgress(percentage, text) {
    progressFill.style.width = `${percentage}%`;
    progressPercentage.textContent = `${Math.round(percentage)}%`;
    progressText.textContent = text;
    if (percentage > 0) progressSection.classList.add('active');
    else progressSection.classList.remove('active');
  }

  // Helper Functions for Profile Display
  function getInitials(email) {
    if (!email) return 'U';
    const parts = email.split('@')[0];
    return parts.substring(0, 2).toUpperCase();
  }

  function getInitialsFromName(fullName) {
    if (!fullName) return 'U';
    const names = fullName.split(' ');
    if (names.length >= 2) {
      return (names[0].charAt(0) + names[names.length - 1].charAt(0)).toUpperCase();
    }
    return fullName.charAt(0).toUpperCase();
  }

  // ðŸ”‘ CRITICAL FIX: Load profile picture with proper avatar handling (from explore-screen.html)
  async function loadUserProfilePicture(user) {
    try {
      if (!user || !profileBtn) return;
      
      const placeholder = document.getElementById('userProfilePlaceholder');
      const userInitials = getInitials(user.email);
      
      // Set initial placeholder with email initials
      placeholder.innerHTML = `<div class="profile-placeholder">${userInitials}</div>`;
      
      // Fetch user profile from database
      const {  profile, error: profileError } = await window.supabaseClient
        .from('user_profiles')
        .select('*')
        .eq('id', user.id)
        .maybeSingle();
      
      if (profileError) {
        console.log('Profile query error:', profileError);
        return;
      }
      
      if (profile) {
        // If avatar URL exists, display it
        if (profile.avatar_url) {
          let avatarUrl = profile.avatar_url;
          
          // Construct full URL if needed
          if (!avatarUrl.startsWith('http')) {
            if (avatarUrl.startsWith('avatars/')) {
              avatarUrl = `https://ydnxqnbjoshvxteevemc.supabase.co/storage/v1/object/public/${avatarUrl}`;
            } else {
              avatarUrl = `https://ydnxqnbjoshvxteevemc.supabase.co/storage/v1/object/public/avatars/${avatarUrl}`;
            }
          }
          
          // Create image element
          const img = document.createElement('img');
          img.src = avatarUrl;
          img.alt = 'Profile Picture';
          img.className = 'profile-img';
          img.onerror = () => {
            // Fallback to initials if image fails to load
            const fallbackInitials = profile.full_name ? getInitialsFromName(profile.full_name) : userInitials;
            placeholder.innerHTML = `<div class="profile-placeholder">${fallbackInitials}</div>`;
          };
          
          placeholder.innerHTML = '';
          placeholder.appendChild(img);
        } 
        // If no avatar but full name exists, use name initials
        else if (profile.full_name) {
          const nameInitials = getInitialsFromName(profile.full_name);
          placeholder.innerHTML = `<div class="profile-placeholder">${nameInitials}</div>`;
        }
      }
    } catch (error) {
      console.error('Error loading user profile picture:', error);
    }
  }

  // Authentication
  async function checkAuthentication() {
    try {
      const sessionResponse = await window.supabaseClient.auth.getSession();
      const session = sessionResponse.data.session;
      const error = sessionResponse.error;
      
      if (error || !session?.user) {
        console.log('âš ï¸ User not authenticated');
        return null;
      }
      
      currentUserId = session.user.id;
      currentUserEmail = session.user.email;
      console.log('âœ… Authenticated user ID:', currentUserId);
      
      // Load profile picture
      await loadUserProfilePicture(session.user);
      
      return session.user;
    } catch (error) {
      console.error('Auth check failed:', error);
      return null;
    }
  }

  // ðŸ”‘ CRITICAL FIX: Notifications functions (EXACT from explore-screen.html)
  async function loadNotifications() {
    try {
      if (!currentUserId) {
        updateNotificationBadge(0);
        return;
      }
      
      const { data, error } = await window.supabaseClient
        .from('notifications')
        .select('*')
        .eq('user_id', currentUserId)
        .order('created_at', { ascending: false })
        .limit(20);
      
      if (error) throw error;
      
      const unreadCount = (data || []).filter(n => !n.is_read).length;
      updateNotificationBadge(unreadCount);
      
      // Render notifications
      const notificationsList = document.getElementById('notifications-list');
      if (!notificationsList) return;
      
      if (!data || data.length === 0) {
        notificationsList.innerHTML = `
          <div class="empty-notifications">
            <i class="fas fa-bell-slash"></i>
            <p>No notifications yet</p>
          </div>
        `;
        return;
      }
      
      notificationsList.innerHTML = data.map(notification => `
        <div class="notification-item ${notification.is_read ? 'read' : 'unread'}" data-id="${notification.id}">
          <div class="notification-icon">
            <i class="${getNotificationIcon(notification.type)}"></i>
          </div>
          <div class="notification-content">
            <h4>${escapeHtml(notification.title)}</h4>
            <p>${escapeHtml(notification.message)}</p>
            <span class="notification-time">${formatNotificationTime(notification.created_at)}</span>
          </div>
          ${!notification.is_read ? '<div class="notification-dot"></div>' : ''}
        </div>
      `).join('');
      
      // Add click handlers
      notificationsList.querySelectorAll('.notification-item').forEach(item => {
        item.addEventListener('click', async () => {
          const id = item.dataset.id;
          await markNotificationAsRead(id);
          if (item.dataset.contentId) {
            window.location.href = `content-detail.html?id=${item.dataset.contentId}`;
          }
          document.getElementById('notifications-panel').classList.remove('active');
        });
      });
    } catch (error) {
      console.error('Error loading notifications:', error);
      updateNotificationBadge(0);
    }
  }
  
  function getNotificationIcon(type) {
    switch(type) {
      case 'like': return 'fas fa-heart';
      case 'comment': return 'fas fa-comment';
      case 'follow': return 'fas fa-user-plus';
      case 'view_milestone': return 'fas fa-trophy';
      case 'system': return 'fas fa-bell';
      default: return 'fas fa-bell';
    }
  }
  
  async function markNotificationAsRead(notificationId) {
    try {
      const { error } = await window.supabaseClient
        .from('notifications')
        .update({ is_read: true })
        .eq('id', notificationId);
      
      if (error) throw error;
      
      // Update UI
      const item = document.querySelector(`.notification-item[data-id="${notificationId}"]`);
      if (item) {
        item.classList.remove('unread');
        item.classList.add('read');
        const dot = item.querySelector('.notification-dot');
        if (dot) dot.remove();
      }
      
      await loadNotifications();
    } catch (error) {
      console.error('Error marking notification as read:', error);
    }
  }
  
  async function markAllNotificationsAsRead() {
    try {
      if (!currentUserId) return;
      
      const { error } = await window.supabaseClient
        .from('notifications')
        .update({ is_read: true })
        .eq('user_id', currentUserId)
        .eq('is_read', false);
      
      if (error) throw error;
      
      // Update UI
      document.querySelectorAll('.notification-item.unread').forEach(item => {
        item.classList.remove('unread');
        item.classList.add('read');
        const dot = item.querySelector('.notification-dot');
        if (dot) dot.remove();
      });
      
      updateNotificationBadge(0);
      showToast('All notifications marked as read', 'success');
    } catch (error) {
      console.error('Error marking all notifications as read:', error);
      showToast('Failed to mark notifications as read', 'error');
    }
  }
  
  function updateNotificationBadge(count = null) {
    if (count === null) {
      count = document.querySelectorAll('.notification-item.unread').length;
    }
    
    const badge = document.getElementById('notification-count');
    if (badge) {
      badge.textContent = count > 99 ? '99+' : count;
      badge.style.display = count > 0 ? 'flex' : 'none';
    }
  }
  
  function formatNotificationTime(timestamp) {
    if (!timestamp) return 'Just now';
    const diffMs = Date.now() - new Date(timestamp).getTime();
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return new Date(timestamp).toLocaleDateString();
  }

  // ðŸ”‘ CRITICAL FIX: Search functionality (EXACT from explore-screen.html)
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  async function searchContent(query, category = '', sortBy = 'newest') {
    try {
      let queryBuilder = window.supabaseClient
        .from('Content')
        .select('*, user_profiles!user_id(*)')
        .ilike('title', `%${query}%`)
        .eq('status', 'published');
      
      if (category) {
        queryBuilder = queryBuilder.eq('genre', category);
      }
      
      if (sortBy === 'newest') {
        queryBuilder = queryBuilder.order('created_at', { ascending: false });
      }
      
      const { data, error } = await queryBuilder.limit(50);
      
      if (error) throw error;
      
      // Enrich with real counts from source tables
      const enriched = await Promise.all(
        (data || []).map(async (item) => {
          const { count: viewsCount } = await window.supabaseClient
            .from('content_views')
            .select('*', { count: 'exact', head: true })
            .eq('content_id', item.id);
          
          const { count: likesCount } = await window.supabaseClient
            .from('content_likes')
            .select('*', { count: 'exact', head: true })
            .eq('content_id', item.id);
          
          return {
            ...item,
            real_views: viewsCount || 0,
            real_likes: likesCount || 0
          };
        })
      );
      
      // Additional sorting for popularity/trending
      if (sortBy === 'popular') {
        enriched.sort((a, b) => (b.real_views || 0) - (a.real_views || 0));
      } else if (sortBy === 'trending') {
        enriched.sort((a, b) => {
          const aScore = (a.real_views || 0) + ((a.real_likes || 0) * 2);
          const bScore = (b.real_views || 0) + ((b.real_likes || 0) * 2);
          return bScore - aScore;
        });
      }
      
      return enriched;
    } catch (error) {
      console.error('Search error:', error);
      return [];
    }
  }

  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function truncateText(text, maxLength) {
    if (!text) return '';
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
  }

  function formatNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num.toString();
  }

  // ðŸ”‘ CRITICAL FIX: Render search results with proper structure (from explore-screen.html)
  function renderSearchResults(results) {
    const grid = document.getElementById('search-results-grid');
    if (!grid) return;
    
    if (!results || results.length === 0) {
      grid.innerHTML = '<div class="no-results">No results found. Try different keywords.</div>';
      return;
    }
    
    grid.innerHTML = results.map(item => {
      const creator = item.user_profiles?.full_name || 
                      item.user_profiles?.username || 
                      item.creator || 
                      'Creator';
      const creatorId = item.user_profiles?.id || item.user_id;
      const thumbnailUrl = item.thumbnail_url 
        ? `https://ydnxqnbjoshvxteevemc.supabase.co/storage/v1/object/public/${item.thumbnail_url.replace(/^\/+/, '')}`
        : 'https://images.unsplash.com/photo-1511379938547-c1f69419868d?w=400&h=225&fit=crop';
      
      return `
        <div class="content-card" data-content-id="${item.id}">
          <div class="card-thumbnail">
            <img src="${thumbnailUrl}"
                 alt="${escapeHtml(item.title)}"
                 loading="lazy"
                 onerror="this.src='https://images.unsplash.com/photo-1511379938547-c1f69419868d?w=400&h=225&fit=crop'">
            <div class="thumbnail-overlay"></div>
            <div class="play-overlay">
              <div class="play-icon">
                <i class="fas fa-play"></i>
              </div>
            </div>
          </div>
          <div class="card-content">
            <h3 class="card-title">${truncateText(escapeHtml(item.title), 45)}</h3>
            <button class="creator-btn"
                    onclick="event.stopPropagation(); window.location.href='creator-channel.html?id=${creatorId}&name=${encodeURIComponent(creator)}'">
              <i class="fas fa-user"></i>
              ${truncateText(escapeHtml(creator), 15)}
            </button>
            <div class="card-stats">
              <div class="card-stat">
                <i class="fas fa-eye"></i>
                ${formatNumber(item.real_views || item.views_count || 0)}
              </div>
              <div class="card-stat">
                <i class="fas fa-heart"></i>
                ${formatNumber(item.real_likes || 0)}
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    // Add click handlers to cards
    grid.querySelectorAll('.content-card').forEach(card => {
      card.addEventListener('click', (e) => {
        if (e.target.closest('.creator-btn')) return;
        const id = card.dataset.contentId;
        if (id) window.location.href = `content-detail.html?id=${id}`;
      });
    });
  }

  // Media Upload Handlers (unchanged from working version)
  function setupMediaUpload() {
    const zone = document.getElementById('media-upload-zone');
    const input = document.getElementById('media-file-input');
    
    zone.addEventListener('click', () => input.click());
    input.addEventListener('change', (e) => {
      if (e.target.files.length > 0) handleMediaFile(e.target.files[0]);
    });
    
    // Drag and drop
    zone.addEventListener('dragover', (e) => {
      e.preventDefault();
      zone.style.borderColor = 'var(--warm-gold)';
      zone.style.background = 'rgba(245,158,11,.05)';
    });
    zone.addEventListener('dragleave', () => {
      zone.style.borderColor = 'rgba(255,255,255,.3)';
      zone.style.background = 'transparent';
    });
    zone.addEventListener('drop', (e) => {
      e.preventDefault();
      zone.style.borderColor = 'rgba(255,255,255,.3)';
      zone.style.background = 'transparent';
      if (e.dataTransfer.files.length > 0) handleMediaFile(e.dataTransfer.files[0]);
    });
  }

  function handleMediaFile(file) {
    const maxSize = 800 * 1024 * 1024;
    if (file.size > maxSize) {
      showToast('File size must be less than 800MB');
      return;
    }
    
    const videoTypes = ['video/mp4', 'video/mov', 'video/avi', 'video/mkv', 'video/webm'];
    const audioTypes = ['audio/mpeg', 'audio/mp3', 'audio/aac', 'audio/wav'];
    if (!videoTypes.includes(file.type) && !audioTypes.includes(file.type)) {
      showToast('Please select a valid video or audio file');
      return;
    }
    
    selectedMediaFile = file;
    document.getElementById('media-file-name').textContent = file.name;
    document.getElementById('media-file-size').textContent = formatFileSize(file.size);
    document.getElementById('media-file-info').style.display = 'flex';
    document.getElementById('media-zone-text').textContent = 'Click to change file';
    updateButtonsState();
  }

  function removeMediaFile() {
    selectedMediaFile = null;
    document.getElementById('media-file-info').style.display = 'none';
    document.getElementById('media-zone-text').textContent = 'Click or drag video/audio files here';
    updateButtonsState();
  }

  // Thumbnail Upload Handlers (unchanged)
  function setupThumbnailUpload() {
    const zone = document.getElementById('thumbnail-upload-zone');
    const input = document.getElementById('thumbnail-file-input');
    const preview = document.getElementById('thumbnail-preview');
    
    zone.addEventListener('click', () => openImagePicker());
    input.addEventListener('change', (e) => {
      if (e.target.files.length > 0) handleThumbnailFile(e.target.files[0]);
    });
    
    // Drag and drop
    zone.addEventListener('dragover', (e) => {
      e.preventDefault();
      zone.style.borderColor = 'var(--warm-gold)';
      zone.style.background = 'rgba(245,158,11,.05)';
    });
    zone.addEventListener('dragleave', () => {
      zone.style.borderColor = 'rgba(255,255,255,.3)';
      zone.style.background = 'transparent';
    });
    zone.addEventListener('drop', (e) => {
      e.preventDefault();
      zone.style.borderColor = 'rgba(255,255,255,.3)';
      zone.style.background = 'transparent';
      if (e.dataTransfer.files.length > 0) handleThumbnailFile(e.dataTransfer.files[0]);
    });
    
    // Camera input
    document.getElementById('camera-file-input').addEventListener('change', (e) => {
      if (e.target.files.length > 0) handleThumbnailFile(e.target.files[0]);
    });
  }

  function openImagePicker() {
    document.getElementById('thumbnail-file-input').click();
  }

  function captureCameraImage() {
    document.getElementById('camera-file-input').click();
  }

  function handleThumbnailFile(file) {
    const imageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
    if (!imageTypes.includes(file.type)) {
      showToast('Please select a valid image file (JPG, PNG, GIF)');
      return;
    }
    
    selectedThumbnailFile = file;
    
    // Create preview
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('thumbnail-image').src = e.target.result;
      document.getElementById('thumbnail-preview').style.display = 'block';
    };
    reader.readAsDataURL(file);
    
    showToast('Thumbnail image selected', 'success');
  }

  // Button State Management
  function updateButtonsState() {
    const title = document.getElementById('content-title').value.trim();
    const desc = document.getElementById('content-description').value.trim();
    
    saveDraftBtn.disabled = !title || isUploading || !currentUserId;
    publishBtn.disabled = !title || !desc || !selectedMediaFile || isUploading || !currentUserId;
    
    if (isUploading) {
      publishBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publishing...';
      saveDraftBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    } else {
      publishBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Publish Content';
      saveDraftBtn.innerHTML = '<i class="fas fa-save"></i> Save Draft';
    }
  }

  // Upload to Storage (unchanged from working version)
  async function uploadFileToStorage(file, bucket, basePath) {
    // Sanitize filename
    const cleanFileName = file.name
      .replace(/[^a-z0-9.]/gi, '_')
      .replace(/_{2,}/g, '_')
      .toLowerCase();
    
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(7);
    const fileName = `${timestamp}_${random}_${cleanFileName}`;
    
    // Path structure: {user_id}/{basePath}/{filename}
    const filePath = `${currentUserId}/${basePath}/${fileName}`;
    console.log(`ðŸ“¤ Uploading to ${bucket}: ${filePath}`);
    
    try {
      // Upload file
      const uploadResponse = await window.supabaseClient.storage
        .from(bucket)
        .upload(filePath, file, { contentType: file.type });
      
      if (uploadResponse.error) throw uploadResponse.error;
      
      // Get public URL
      const urlResponse = window.supabaseClient.storage
        .from(bucket)
        .getPublicUrl(filePath);
      
      console.log(`âœ… Upload successful. Public URL: ${urlResponse.data.publicUrl}`);
      return urlResponse.data.publicUrl;
    } catch (error) {
      console.error(`âŒ ${bucket} upload failed:`, error);
      throw error;
    }
  }

  // Create Content Record (unchanged)
  async function createContentRecord(data) {
    try {
      const insertResponse = await window.supabaseClient
        .from('Content')
        .insert([{
          title: data.title,
          description: data.description,
          file_url: data.media_url,
          thumbnail_url: data.thumbnail_url || '',
          media_type: data.media_type,
          genre: data.genre || null,
          status: data.status,
          user_id: currentUserId,
          created_at: new Date().toISOString()
        }]);
      
      if (insertResponse.error) throw insertResponse.error;
      return true;
    } catch (error) {
      console.error('DB insert failed:', error);
      throw error;
    }
  }

  // Main Upload Flow (unchanged)
  async function uploadContent(isDraft = false) {
    if (!currentUserId) {
      showToast('Please sign in to upload content');
      authModal.classList.add('active');
      return;
    }
    
    const title = document.getElementById('content-title').value.trim();
    const desc = document.getElementById('content-description').value.trim();
    const genre = document.getElementById('content-genre').value;
    
    if (!title || !desc || !selectedMediaFile) {
      showToast('Please fill all required fields');
      return;
    }
    
    isUploading = true;
    updateButtonsState();
    
    try {
      // STEP 1: Upload media file to content-media bucket
      updateProgress(20, 'Uploading media file...');
      const mediaType = selectedMediaFile.type.includes('video') ? 'video' : 'audio';
      const mediaUrl = await uploadFileToStorage(selectedMediaFile, 'content-media', 'media');
      
      // STEP 2: Upload thumbnail to content-thumbnails bucket
      let thumbnailUrl = null;
      if (selectedThumbnailFile) {
        updateProgress(60, 'Uploading thumbnail...');
        thumbnailUrl = await uploadFileToStorage(selectedThumbnailFile, 'content-thumbnails', 'thumbnails');
      } else {
        // Default thumbnails based on media type
        thumbnailUrl = mediaType === 'video'
          ? 'https://images.unsplash.com/photo-1574717024653-61fd2cf4d44d?w=800&q=80'
          : 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=800&q=80';
      }
      
      // STEP 3: Create content record
      updateProgress(85, 'Creating content record...');
      await createContentRecord({
        title,
        description: desc,
        media_url: mediaUrl,
        thumbnail_url: thumbnailUrl,
        media_type: mediaType,
        genre,
        status: isDraft ? 'draft' : 'published'
      });
      
      // Complete
      updateProgress(100, 'Upload complete!');
      showToast(`Content ${isDraft ? 'saved as draft' : 'published'} successfully!`, 'success');
      
      // Reset form after delay
      setTimeout(() => {
        document.getElementById('content-title').value = '';
        document.getElementById('content-description').value = '';
        document.getElementById('content-genre').value = '';
        removeMediaFile();
        selectedThumbnailFile = null;
        document.getElementById('thumbnail-preview').style.display = 'none';
        document.getElementById('thumbnail-file-input').value = '';
        document.getElementById('camera-file-input').value = '';
        
        if (!isDraft) window.location.href = 'content-library.html';
      }, 1500);
      
    } catch (error) {
      console.error('Upload failed:', error);
      showToast(`Upload failed: ${error.message || 'Unknown error'}`, 'error');
      updateProgress(0, '');
    } finally {
      isUploading = false;
      updateButtonsState();
    }
  }

  // ðŸ”‘ CRITICAL FIX: Setup Search Modal (EXACT from explore-screen.html)
  function setupSearchModal() {
    const searchModal = document.getElementById('search-modal');
    const searchInput = document.getElementById('search-input');
    const closeSearchBtn = document.getElementById('close-search-btn');
    
    if (!searchModal || !searchInput || !closeSearchBtn) return;
    
    // Open search modal
    searchBtn.addEventListener('click', () => {
      searchModal.classList.add('active');
      setTimeout(() => searchInput.focus(), 300);
    });
    
    // Close search modal
    closeSearchBtn.addEventListener('click', () => {
      searchModal.classList.remove('active');
      searchInput.value = '';
      document.getElementById('search-results-grid').innerHTML = '';
    });
    
    // Close when clicking outside modal content
    searchModal.addEventListener('click', (e) => {
      if (e.target === searchModal) {
        searchModal.classList.remove('active');
        searchInput.value = '';
        document.getElementById('search-results-grid').innerHTML = '';
      }
    });
    
    // Live search with debounce
    searchInput.addEventListener('input', debounce(async (e) => {
      const query = e.target.value.trim();
      const category = document.getElementById('category-filter')?.value;
      const sortBy = document.getElementById('sort-filter')?.value;
      const resultsGrid = document.getElementById('search-results-grid');
      
      if (!resultsGrid) return;
      
      if (query.length < 2) {
        resultsGrid.innerHTML = '<div class="no-results">Start typing to search...</div>';
        return;
      }
      
      resultsGrid.innerHTML = `
        <div class="infinite-scroll-loading">
          <div class="infinite-scroll-spinner"></div>
          <div>Searching...</div>
        </div>
      `;
      
      const results = await searchContent(query, category, sortBy);
      renderSearchResults(results);
    }, 300));
    
    // Filter change triggers search
    document.getElementById('category-filter')?.addEventListener('change', () => {
      if (searchInput.value.trim().length >= 2) {
        searchInput.dispatchEvent(new Event('input'));
      }
    });
    
    document.getElementById('sort-filter')?.addEventListener('change', () => {
      if (searchInput.value.trim().length >= 2) {
        searchInput.dispatchEvent(new Event('input'));
      }
    });
  }

  // ðŸ”‘ CRITICAL FIX: Setup Notifications Panel (EXACT from explore-screen.html)
  function setupNotificationsPanel() {
    const notificationsPanel = document.getElementById('notifications-panel');
    const closeNotifications = document.getElementById('close-notifications');
    const markAllReadBtn = document.getElementById('mark-all-read');
    
    if (!notificationsPanel || !closeNotifications || !markAllReadBtn) return;
    
    // Open notifications panel
    notificationsBtn.addEventListener('click', () => {
      notificationsPanel.classList.add('active');
      loadNotifications();
    });
    
    // Close notifications panel
    closeNotifications.addEventListener('click', () => {
      notificationsPanel.classList.remove('active');
    });
    
    // Close when clicking outside panel
    document.addEventListener('click', (e) => {
      if (notificationsPanel.classList.contains('active') &&
          !notificationsPanel.contains(e.target) &&
          !notificationsBtn.contains(e.target)) {
        notificationsPanel.classList.remove('active');
      }
    });
    
    // Mark all as read
    markAllReadBtn.addEventListener('click', markAllNotificationsAsRead);
  }

  // Event Listeners
  function setupListeners() {
    // Form submission
    document.getElementById('upload-form').addEventListener('submit', (e) => {
      e.preventDefault();
      if (!isUploading) uploadContent(false);
    });
    
    // Save draft
    document.getElementById('save-draft-btn').addEventListener('click', () => {
      if (!isUploading) uploadContent(true);
    });
    
    // Input listeners
    ['content-title', 'content-description'].forEach(id => {
      document.getElementById(id).addEventListener('input', updateButtonsState);
    });
    document.getElementById('content-genre').addEventListener('change', updateButtonsState);
    
    // Auth modal
    document.getElementById('auth-login-btn').addEventListener('click', () => {
      window.location.href = `login.html?redirect=${encodeURIComponent('creator-upload.html')}`;
    });
    document.getElementById('auth-cancel-btn').addEventListener('click', () => {
      authModal.classList.remove('active');
      window.history.back();
    });
    
    // Navigation
    backBtn.addEventListener('click', () => window.history.back());
    profileBtn.addEventListener('click', () => {
      if (currentUserId) window.location.href = 'profile.html';
      else window.location.href = `login.html?redirect=${encodeURIComponent('creator-upload.html')}`;
    });
    
    // Setup search and notifications
    setupSearchModal();
    setupNotificationsPanel();
  }

  // Initialize
  async function initialize() {
    setLoading(true);
    
    // Check auth
    const user = await checkAuthentication();
    if (!user) authModal.classList.add('active');
    
    // Setup UI
    setupMediaUpload();
    setupThumbnailUpload();
    setupListeners();
    updateButtonsState();
    
    // Load notifications if authenticated
    if (currentUserId) {
      loadNotifications();
    }
    
    setLoading(false);
    console.log('âœ… Creator Upload initialized with FIXED search and notifications');
  }
  
  initialize();
  
  // Auth state listener
  window.supabaseClient.auth.onAuthStateChange(async (event, session) => {
    console.log('Auth state changed:', event);
    
    if (event === 'SIGNED_IN' && session?.user) {
      currentUserId = session.user.id;
      currentUserEmail = session.user.email;
      await loadUserProfilePicture(session.user);
      await loadNotifications();
      authModal.classList.remove('active');
      showToast('Welcome back!', 'success');
    } else if (event === 'SIGNED_OUT') {
      currentUserId = null;
      currentUserEmail = null;
      document.getElementById('userProfilePlaceholder').innerHTML = `
        <div class="profile-placeholder">
          <i class="fas fa-user"></i>
        </div>
      `;
      updateNotificationBadge(0);
      showToast('Signed out successfully', 'info');
    }
  });
});

// Global functions for onclick handlers
window.removeMediaFile = function() {
  document.getElementById('media-file-input').value = '';
  document.getElementById('media-file-info').style.display = 'none';
  document.getElementById('media-zone-text').textContent = 'Click or drag video/audio files here';
  selectedMediaFile = null;
  updateButtonsState();
};

window.openImagePicker = function() {
  document.getElementById('thumbnail-file-input').click();
};

window.captureCameraImage = function() {
  document.getElementById('camera-file-input').click();
};
</script>
</body>
</html>
