<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
<title>Upload Content - Bantu Stream Connect</title>
<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Supabase JS SDK - MUST LOAD BEFORE ANY SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* [ALL EXISTING CSS REMAINS EXACTLY THE SAME - NO CHANGES NEEDED] */
/* Base styles merged from explore-screen and content-library */
:root {
--deep-black: #0A0E12;
--deep-navy: #0F172A;
--soft-white: #F8FAFC;
--slate-grey: #94A3B8;
--bantu-blue: #1D4ED8;
--warm-gold: #F59E0B;
--error-color: #EF4444;
--success-color: #10B981;
--glow-cycle-1: #00A3FF;
--glow-cycle-2: #0066FF;
--glow-cycle-3: #8B5CF6;
--glow-cycle-4: #EC4899;
--card-bg: rgba(15, 23, 42, 0.6);
--card-border: rgba(148, 163, 184, 0.2);
--hover-overlay: rgba(255, 255, 255, 0.05);
--active-overlay: rgba(245, 158, 11, 0.1);
--indigo: #4F46E5;
--gold-glow: rgba(245, 158, 11, 0.3);
--blue-glow: rgba(29, 78, 216, 0.3);
}
/* [ALL REMAINING CSS STYLES - IDENTICAL TO ORIGINAL] */
* { margin: 0; padding: 0; box-sizing: border-box; }
/* ... rest of CSS remains unchanged ... */
</style>
</head>
<body>
<!-- Loading Screen -->
<div id="loading" class="loading-screen">
<div class="spinner"></div>
<div id="loading-text">Loading Creator Upload...</div>
</div>
<!-- Animated Background -->
<div class="animated-bg">
<div class="glow-cycle glow-1"></div>
<div class="glow-cycle glow-2"></div>
<div class="glow-cycle glow-3"></div>
<div class="glow-cycle glow-4"></div>
</div>
<!-- Auth Modal (shown when user is not logged in) -->
<div id="auth-modal" class="auth-modal">
<div class="auth-content">
<div class="auth-icon">
<i class="fas fa-lock"></i>
</div>
<h2 class="auth-title">Authentication Required</h2>
<p class="auth-message">You need to be logged in to upload content. Please sign in or create an account to share your content with the community.</p>
<div class="auth-buttons">
<button id="auth-login-btn" class="auth-btn login">Log In</button>
<button id="auth-cancel-btn" class="auth-btn cancel">Cancel</button>
</div>
</div>
</div>
<!-- Search Modal -->
<div id="search-modal" class="search-modal">
<!-- [Search modal content identical to original] -->
</div>
<!-- Notifications Panel -->
<div id="notifications-panel" class="notifications-panel">
<!-- [Notifications panel content identical to original] -->
</div>
<!-- Main Content (hidden until loaded) -->
<div id="app" style="display: none;">
<!-- Header -->
<header class="header">
<div class="logo" onclick="window.location.href='index.html'">
<div class="logo-icon">
<i class="fas fa-film" style="color: var(--warm-gold); font-size: 20px;"></i>
</div>
<div class="logo-text">BANTU STREAM CONNECT</div>
</div>
<div class="header-actions">
<button id="search-btn" class="icon-btn search-btn" title="Search">
<i class="fas fa-search"></i>
</button>
<button id="notifications-btn" class="icon-btn" title="Notifications">
<i class="fas fa-bell"></i>
<span class="notification-badge" id="notification-count" style="display: none;">0</span>
</button>
<button id="profile-btn" class="profile-btn" title="Profile">
<div class="profile-placeholder" id="userProfilePlaceholder">
<i class="fas fa-user"></i>
</div>
</button>
</div>
</header>
<!-- Main Content -->
<main class="container">
<!-- Upload Card -->
<div class="upload-card">
<h1>UPLOAD YOUR CONTENT</h1>
<form id="upload-form">
<!-- [ALL FORM FIELDS IDENTICAL TO ORIGINAL] -->
</form>
<div class="helper-text">
Your content will be reviewed and published within 24 hours. Make sure to follow our community guidelines.
Please stay on this page until upload is complete.
</div>
</div>
</main>
<!-- Footer -->
<footer class="footer">
<p>Bantu Stream Connect Â© 2025 â€¢ Built in South Africa â€¢ NO DNA, JUST RSA</p>
<div class="footer-links">
<a href="privacy-policy.html">Privacy Policy</a>
<a href="terms-of-service.html">Terms of Service</a>
<a href="support.html">Support</a>
</div>
</footer>
</div>
<!-- Toast Container -->
<div id="toast-container"></div>

<!-- CRITICAL FIX: SINGLE SUPABASE CLIENT INITIALIZATION -->
<script>
// âœ… SINGLE GLOBAL SUPABASE CLIENT - INITIALIZED ONCE AT PAGE LOAD
const SUPABASE_CONFIG = {
  url: 'https://ydnxqnbjoshvxteevemc.supabase.co',
  anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkbnhxbmJqb3Nodnh0ZWV2ZW1jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MzI0OTMsImV4cCI6MjA3MzIwODQ5M30.NlaCCnLPSz1mM7AFeSlfZQ78kYEKUMh_Fi-7P_ccs_U'
};

// Initialize Supabase client ONCE at global scope (before DOMContentLoaded)
const supabaseClient = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
console.log('âœ… Global Supabase client initialized successfully');

// Expose to window for debugging if needed
window.supabaseClient = supabaseClient;
</script>

<!-- Creator Upload JavaScript - FIXED AUTHENTICATION FLOW -->
<script>
// Wait for DOM to be ready
document.addEventListener('DOMContentLoaded', async () => {
  console.log('ðŸ“¤ Creator Upload Initializing...');
  
  // DOM Elements
  const loadingScreen = document.getElementById('loading');
  const loadingText = document.getElementById('loading-text');
  const app = document.getElementById('app');
  const authModal = document.getElementById('auth-modal');
  const uploadForm = document.getElementById('upload-form');
  const publishBtn = document.getElementById('publish-btn');
  const saveDraftBtn = document.getElementById('save-draft-btn');
  const progressSection = document.getElementById('upload-progress');
  const progressFill = document.getElementById('progress-fill');
  const progressPercentage = document.getElementById('progress-percentage');
  const progressText = document.getElementById('progress-text');
  const profileBtn = document.getElementById('profile-btn');
  const notificationsBtn = document.getElementById('notifications-btn');
  const searchBtn = document.getElementById('search-btn');
  
  // State variables
  let selectedMediaFile = null;
  let selectedThumbnailFile = null;
  let isUploading = false;
  let currentUser = null;
  let notifications = [];
  
  // âœ… USE GLOBAL CLIENT - NO DUPLICATE DECLARATION
  const supabase = window.supabaseClient;
  
  // âœ… SHOW/HIDE LOADING
  function setLoading(loading, text = '') {
    if (text) loadingText.textContent = text;
    if (loading) {
      loadingScreen.style.display = 'flex';
      app.style.display = 'none';
    } else {
      setTimeout(() => {
        loadingScreen.style.display = 'none';
        app.style.display = 'block';
      }, 500);
    }
  }
  
  // âœ… SHOW TOAST MESSAGE
  function showToast(message, type = 'error') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    const icons = {
      error: 'fa-exclamation-triangle',
      success: 'fa-check-circle',
      warning: 'fa-exclamation-circle',
      info: 'fa-info-circle'
    };
    toast.innerHTML = `
      <i class="fas ${icons[type] || 'fa-info-circle'}"></i>
      <span>${escapeHtml(message)}</span>
    `;
    const container = document.getElementById('toast-container');
    if (!container) {
      const newContainer = document.createElement('div');
      newContainer.id = 'toast-container';
      document.body.appendChild(newContainer);
      newContainer.appendChild(toast);
    } else {
      container.appendChild(toast);
    }
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(100%)';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }
  
  // âœ… ESCAPE HTML
  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // âœ… FORMAT FILE SIZE
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }
  
  // âœ… GET INITIALS FROM EMAIL
  function getInitials(email) {
    if (!email) return 'U';
    const parts = email.split('@')[0];
    if (parts.length >= 2) {
      return parts.substring(0, 2).toUpperCase();
    }
    return email.charAt(0).toUpperCase();
  }
  
  // âœ… GET INITIALS FROM FULL NAME
  function getInitialsFromName(fullName) {
    if (!fullName) return 'U';
    const names = fullName.split(' ');
    if (names.length >= 2) {
      return (names[0].charAt(0) + names[names.length - 1].charAt(0)).toUpperCase();
    }
    return fullName.charAt(0).toUpperCase();
  }
  
  // âœ… LOAD USER PROFILE PICTURE - FIXED VERSION
  async function loadUserProfilePicture(user) {
    try {
      if (!user || !profileBtn) return;
      
      // First, update the profile button with email initials as fallback
      const userInitials = getInitials(user.email);
      const placeholder = document.getElementById('userProfilePlaceholder');
      placeholder.innerHTML = `<div class="profile-placeholder">${userInitials}</div>`;
      
      // Then try to get user profile from user_profiles table
      try {
        const { data: profile, error: profileError } = await supabase
          .from('user_profiles')
          .select('*')
          .eq('id', user.id)
          .maybeSingle();
          
        if (profileError) {
          console.log('Profile query error:', profileError);
          return; // Keep using initials
        }
        
        if (profile && profile.avatar_url) {
          // Fix avatar URL
          let avatarUrl = profile.avatar_url;
          if (!avatarUrl.startsWith('http')) {
            if (avatarUrl.startsWith('avatars/')) {
              avatarUrl = `https://ydnxqnbjoshvxteevemc.supabase.co/storage/v1/object/public/${avatarUrl}`;
            } else {
              avatarUrl = `https://ydnxqnbjoshvxteevemc.supabase.co/storage/v1/object/public/avatars/${avatarUrl}`;
            }
          }
          
          // Create img element for profile picture
          const profileImg = document.createElement('img');
          profileImg.className = 'profile-img';
          profileImg.src = avatarUrl;
          profileImg.alt = 'Profile Picture';
          profileImg.onerror = function() {
            // If image fails to load, keep using initials
            placeholder.innerHTML = `<div class="profile-placeholder">${userInitials}</div>`;
          };
          
          // Clear placeholder and add image
          placeholder.innerHTML = '';
          placeholder.appendChild(profileImg);
        } else {
          // Profile exists but no avatar_url, check full_name for better initials
          if (profile && profile.full_name) {
            const nameInitials = getInitialsFromName(profile.full_name);
            placeholder.innerHTML = `<div class="profile-placeholder">${nameInitials}</div>`;
          }
        }
      } catch (error) {
        console.log('No user profile found or error fetching profile:', error);
        // Keep using initials if profile fetch fails
      }
    } catch (error) {
      console.error('Error loading user profile picture:', error);
    }
  }
  
  // âœ… CHECK AUTHENTICATION - FIXED TO USE GLOBAL CLIENT
  async function checkAuthentication() {
    try {
      // Critical fix: Use the global supabase client that's already initialized
      const { data: { session }, error } = await supabase.auth.getSession();
      
      if (error) {
        console.error('Auth session error:', error);
        return false;
      }
      
      const isAuthenticated = !!session;
      
      if (!isAuthenticated) {
        console.log('âš ï¸ User not authenticated');
        return false;
      }
      
      currentUser = session.user;
      console.log('âœ… User authenticated:', currentUser.email);
      
      // Load user profile picture
      await loadUserProfilePicture(currentUser);
      
      // Load notifications
      await loadNotifications();
      
      return true;
    } catch (error) {
      console.error('âŒ Authentication error:', error);
      return false;
    }
  }
  
  // âœ… LOAD NOTIFICATIONS
  async function loadNotifications() {
    try {
      if (!currentUser) {
        updateNotificationBadge(0);
        return;
      }
      
      const { data, error } = await supabase
        .from('notifications')
        .select('*')
        .eq('user_id', currentUser.id)
        .order('created_at', { ascending: false })
        .limit(20);
        
      if (error) throw error;
      
      notifications = data || [];
      const unreadCount = notifications.filter(n => !n.is_read).length;
      updateNotificationBadge(unreadCount);
    } catch (error) {
      console.error('Error loading notifications:', error);
      updateNotificationBadge(0);
    }
  }
  
  // âœ… UPDATE NOTIFICATION BADGE
  function updateNotificationBadge(count) {
    const mainBadge = document.getElementById('notification-count');
    if (mainBadge) {
      mainBadge.textContent = count > 99 ? '99+' : count;
      mainBadge.style.display = count > 0 ? 'flex' : 'none';
    }
  }
  
  // âœ… RENDER NOTIFICATIONS
  function renderNotifications() {
    const notificationsList = document.getElementById('notifications-list');
    if (!notificationsList) return;
    
    if (!currentUser) {
      notificationsList.innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--slate-grey);">
          <i class="fas fa-bell-slash" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
          <p>Sign in to see notifications</p>
        </div>
      `;
      return;
    }
    
    if (!notifications || notifications.length === 0) {
      notificationsList.innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--slate-grey);">
          <i class="fas fa-bell" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
          <p>No notifications yet</p>
        </div>
      `;
      return;
    }
    
    notificationsList.innerHTML = notifications.map(notification => `
      <div class="notification-item ${notification.is_read ? 'read' : 'unread'}" data-id="${notification.id}">
        <div class="notification-icon">
          <i class="${getNotificationIcon(notification.type)}"></i>
        </div>
        <div class="notification-content">
          <h4>${escapeHtml(notification.title)}</h4>
          <p>${escapeHtml(notification.message)}</p>
          <span class="notification-time">${formatNotificationTime(notification.created_at)}</span>
        </div>
        ${!notification.is_read ? '<div class="notification-dot"></div>' : ''}
      </div>
    `).join('');
  }
  
  // âœ… GET NOTIFICATION ICON
  function getNotificationIcon(type) {
    switch(type) {
      case 'like': return 'fas fa-heart';
      case 'comment': return 'fas fa-comment';
      case 'follow': return 'fas fa-user-plus';
      default: return 'fas fa-bell';
    }
  }
  
  // âœ… FORMAT NOTIFICATION TIME
  function formatNotificationTime(timestamp) {
    if (!timestamp) return 'Just now';
    const diffMs = Date.now() - new Date(timestamp).getTime();
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return new Date(timestamp).toLocaleDateString();
  }
  
  // âœ… SHOW/HIDE AUTH MODAL
  function showAuthModal(show) {
    if (show) {
      authModal.classList.add('active');
    } else {
      authModal.classList.remove('active');
    }
  }
  
  // âœ… UPDATE UPLOAD BUTTONS STATE
  function updateButtonsState() {
    const title = document.getElementById('content-title').value.trim();
    const description = document.getElementById('content-description').value.trim();
    
    // Enable save draft if there's a title
    saveDraftBtn.disabled = !title || isUploading;
    
    // Enable publish if all required fields are filled
    const canPublish = title && description && selectedMediaFile && !isUploading;
    publishBtn.disabled = !canPublish;
    
    // Update button text if uploading
    if (isUploading) {
      publishBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publishing...';
      publishBtn.disabled = true;
      saveDraftBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
      saveDraftBtn.disabled = true;
    } else {
      publishBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
        </svg>
        Publish Content
      `;
      saveDraftBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
          <polyline points="17 21 17 13 7 13 7 21"/>
          <polyline points="7 3 7 8 15 8"/>
        </svg>
        Save Draft
      `;
    }
  }
  
  // âœ… HANDLE MEDIA FILE SELECTION
  function setupMediaUpload() {
    const mediaZone = document.getElementById('media-upload-zone');
    const mediaInput = document.getElementById('media-file-input');
    const mediaFileInfo = document.getElementById('media-file-info');
    
    // Click on zone
    mediaZone.addEventListener('click', () => {
      mediaInput.click();
    });
    
    // Drag and drop
    mediaZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      mediaZone.style.borderColor = 'var(--warm-gold)';
      mediaZone.style.background = 'rgba(245, 158, 11, 0.05)';
    });
    
    mediaZone.addEventListener('dragleave', () => {
      mediaZone.style.borderColor = 'rgba(255, 255, 255, 0.3)';
      mediaZone.style.background = 'transparent';
    });
    
    mediaZone.addEventListener('drop', (e) => {
      e.preventDefault();
      mediaZone.style.borderColor = 'rgba(255, 255, 255, 0.3)';
      mediaZone.style.background = 'transparent';
      if (e.dataTransfer.files.length > 0) {
        handleMediaFile(e.dataTransfer.files[0]);
      }
    });
    
    // File input change
    mediaInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleMediaFile(e.target.files[0]);
      }
    });
  }
  
  // âœ… HANDLE MEDIA FILE
  function handleMediaFile(file) {
    // Check file size (800MB limit)
    const maxSize = 800 * 1024 * 1024;
    if (file.size > maxSize) {
      showToast('File size must be less than 800MB', 'error');
      return;
    }
    
    // Check file type
    const videoTypes = ['video/mp4', 'video/mov', 'video/avi', 'video/mkv', 'video/webm'];
    const audioTypes = ['audio/mpeg', 'audio/mp3', 'audio/aac', 'audio/wav', 'audio/m4a', 'audio/flac', 'audio/ogg'];
    if (!videoTypes.includes(file.type) && !audioTypes.includes(file.type)) {
      showToast('Please select a valid video or audio file', 'error');
      return;
    }
    
    selectedMediaFile = file;
    
    // Update UI
    document.getElementById('media-file-name').textContent = file.name;
    document.getElementById('media-file-size').textContent = formatFileSize(file.size);
    document.getElementById('media-file-info').style.display = 'flex';
    document.getElementById('media-zone-text').textContent = 'Click to change file';
    updateButtonsState();
    showToast(`Selected: ${file.name}`, 'success');
  }
  
  // âœ… REMOVE MEDIA FILE
  function removeMediaFile() {
    selectedMediaFile = null;
    document.getElementById('media-file-info').style.display = 'none';
    document.getElementById('media-zone-text').textContent = 'Click or drag video/audio files here';
    document.getElementById('media-file-input').value = '';
    updateButtonsState();
    showToast('Media file removed', 'info');
  }
  
  // âœ… SETUP THUMBNAIL UPLOAD
  function setupThumbnailUpload() {
    const thumbnailZone = document.getElementById('thumbnail-upload-zone');
    const thumbnailInput = document.getElementById('thumbnail-file-input');
    const thumbnailPreview = document.getElementById('thumbnail-preview');
    
    // Click on zone
    thumbnailZone.addEventListener('click', () => {
      openImagePicker();
    });
    
    // Drag and drop
    thumbnailZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      thumbnailZone.style.borderColor = 'var(--warm-gold)';
      thumbnailZone.style.background = 'rgba(245, 158, 11, 0.05)';
    });
    
    thumbnailZone.addEventListener('dragleave', () => {
      thumbnailZone.style.borderColor = 'rgba(255, 255, 255, 0.3)';
      thumbnailZone.style.background = 'transparent';
    });
    
    thumbnailZone.addEventListener('drop', (e) => {
      e.preventDefault();
      thumbnailZone.style.borderColor = 'rgba(255, 255, 255, 0.3)';
      thumbnailZone.style.background = 'transparent';
      if (e.dataTransfer.files.length > 0) {
        handleThumbnailFile(e.dataTransfer.files[0]);
      }
    });
    
    // File input change
    thumbnailInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleThumbnailFile(e.target.files[0]);
      }
    });
    
    // Camera input
    document.getElementById('camera-file-input').addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleThumbnailFile(e.target.files[0]);
      }
    });
  }
  
  // âœ… OPEN IMAGE PICKER
  function openImagePicker() {
    document.getElementById('thumbnail-file-input').click();
  }
  
  // âœ… CAPTURE CAMERA IMAGE
  function captureCameraImage() {
    document.getElementById('camera-file-input').click();
  }
  
  // âœ… HANDLE THUMBNAIL FILE
  function handleThumbnailFile(file) {
    // Check file type
    const imageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
    if (!imageTypes.includes(file.type)) {
      showToast('Please select a valid image file (JPG, PNG, GIF)', 'error');
      return;
    }
    
    selectedThumbnailFile = file;
    
    // Create preview
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('thumbnail-image').src = e.target.result;
      document.getElementById('thumbnail-preview').style.display = 'block';
    };
    reader.readAsDataURL(file);
    showToast('Thumbnail image selected', 'success');
  }
  
  // âœ… UPDATE UPLOAD PROGRESS
  function updateProgress(percentage, text) {
    progressFill.style.width = `${percentage}%`;
    progressPercentage.textContent = `${Math.round(percentage)}%`;
    progressText.textContent = text;
    if (percentage > 0) {
      progressSection.classList.add('active');
    }
  }
  
  // âœ… DETECT MEDIA TYPE
  function getMediaType(file) {
    const videoTypes = ['video/mp4', 'video/mov', 'video/avi', 'video/mkv', 'video/webm'];
    const audioTypes = ['audio/mpeg', 'audio/mp3', 'audio/aac', 'audio/wav', 'audio/m4a', 'audio/flac', 'audio/ogg'];
    if (videoTypes.includes(file.type)) return 'video';
    if (audioTypes.includes(file.type)) return 'audio';
    return 'video'; // Default
  }
  
  // âœ… UPLOAD FILE TO SUPABASE STORAGE
  async function uploadFileToStorage(file, bucket, path = '') {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(7);
    const fileName = `${timestamp}_${random}_${file.name}`;
    const filePath = path ? `${path}/${fileName}` : fileName;
    
    try {
      const { data, error } = await supabase.storage
        .from(bucket)
        .upload(filePath, file, {
          cacheControl: '3600',
          upsert: false
        });
        
      if (error) throw error;
      
      // Get public URL
      const { data: { publicUrl } } = supabase.storage
        .from(bucket)
        .getPublicUrl(filePath);
        
      return publicUrl;
    } catch (error) {
      console.error('Storage upload error:', error);
      throw new Error(`Failed to upload file: ${error.message}`);
    }
  }
  
  // âœ… CREATE CONTENT RECORD - FIXED WITH CORRECT TABLE NAME
  async function createContentRecord(contentData) {
    try {
      // Try 'Content' table first (capital C)
      try {
        const { data, error } = await supabase
          .from('Content')
          .insert([{
            title: contentData.title,
            description: contentData.description,
            file_url: contentData.media_url, // Using file_url to match schema
            creator: currentUser.email,
            user_id: currentUser.id,
            thumbnail_url: contentData.thumbnail_url,
            media_type: contentData.media_type,
            genre: contentData.genre || null,
            status: contentData.status,
            created_at: new Date().toISOString()
          }])
          .select();
          
        if (error) throw error;
        return data[0];
      } catch (error) {
        // Fallback to lowercase 'content' table
        console.warn('Capital C Content table failed, trying lowercase:', error.message);
        const { data, error: lowerError } = await supabase
          .from('content')
          .insert([{
            title: contentData.title,
            description: contentData.description,
            file_url: contentData.media_url,
            creator: currentUser.email,
            user_id: currentUser.id,
            thumbnail_url: contentData.thumbnail_url,
            media_type: contentData.media_type,
            genre: contentData.genre || null,
            status: contentData.status,
            created_at: new Date().toISOString()
          }])
          .select();
          
        if (lowerError) throw lowerError;
        return data[0];
      }
    } catch (error) {
      console.error('Create content error:', error);
      throw new Error(`Failed to create content: ${error.message}`);
    }
  }
  
  // âœ… UPLOAD CONTENT
  async function uploadContent(isDraft = false) {
    // Check authentication FIRST
    const isAuthenticated = await checkAuthentication();
    if (!isAuthenticated) {
      showAuthModal(true);
      return;
    }
    
    // Validate form
    const title = document.getElementById('content-title').value.trim();
    const description = document.getElementById('content-description').value.trim();
    const genre = document.getElementById('content-genre').value;
    
    if (!title || !description || !selectedMediaFile) {
      showToast('Please fill all required fields', 'error');
      return;
    }
    
    // Start upload
    isUploading = true;
    updateButtonsState();
    updateProgress(0, 'Preparing upload...');
    
    try {
      // Step 1: Upload media file
      updateProgress(20, 'Uploading media file...');
      const mediaType = getMediaType(selectedMediaFile);
      const mediaUrl = await uploadFileToStorage(selectedMediaFile, 'media', 'videos');
      
      // Step 2: Upload thumbnail (if provided)
      let thumbnailUrl = null;
      if (selectedThumbnailFile) {
        updateProgress(60, 'Uploading thumbnail...');
        thumbnailUrl = await uploadFileToStorage(selectedThumbnailFile, 'media', 'thumbnails');
      } else {
        // Use default thumbnail based on media type
        thumbnailUrl = mediaType === 'video'
          ? 'https://images.unsplash.com/photo-1574717024653-61fd2cf4d44d?w=800&q=80'
          : 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=800&q=80';
      }
      
      // Step 3: Create content record
      updateProgress(80, 'Creating content record...');
      const contentData = {
        title: title,
        description: description,
        media_url: mediaUrl,
        thumbnail_url: thumbnailUrl,
        media_type: mediaType,
        genre: genre || null,
        status: isDraft ? 'draft' : 'published'
      };
      
      await createContentRecord(contentData);
      
      // Step 4: Complete
      updateProgress(100, 'Upload complete!');
      showToast(isDraft ? 'Content saved as draft!' : 'Content published successfully!', 'success');
      
      // Reset form after delay
      setTimeout(() => {
        resetForm();
        if (!isDraft) {
          // Redirect to content library after successful upload
          window.location.href = 'https://bantustreamconnect.com/content-library';
        }
      }, 2000);
    } catch (error) {
      console.error('Upload error:', error);
      showToast(`Upload failed: ${error.message}`, 'error');
      updateProgress(0, 'Upload failed');
    } finally {
      isUploading = false;
      updateButtonsState();
    }
  }
  
  // âœ… SAVE DRAFT
  async function saveDraft() {
    await uploadContent(true);
  }
  
  // âœ… RESET FORM
  function resetForm() {
    // Clear form fields
    document.getElementById('content-title').value = '';
    document.getElementById('content-description').value = '';
    document.getElementById('content-genre').value = '';
    
    // Clear file selections
    selectedMediaFile = null;
    selectedThumbnailFile = null;
    
    // Reset UI
    document.getElementById('media-file-info').style.display = 'none';
    document.getElementById('media-zone-text').textContent = 'Click or drag video/audio files here';
    document.getElementById('thumbnail-preview').style.display = 'none';
    document.getElementById('media-file-input').value = '';
    document.getElementById('thumbnail-file-input').value = '';
    
    // Hide progress
    progressSection.classList.remove('active');
    updateProgress(0, '');
    updateButtonsState();
  }
  
  // âœ… SETUP EVENT LISTENERS
  function setupEventListeners() {
    // Form submission
    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      await uploadContent(false);
    });
    
    // Save draft button
    saveDraftBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      await saveDraft();
    });
    
    // Input listeners for button state
    document.getElementById('content-title').addEventListener('input', updateButtonsState);
    document.getElementById('content-description').addEventListener('input', updateButtonsState);
    
    // Auth modal buttons
    document.getElementById('auth-login-btn').addEventListener('click', () => {
      showAuthModal(false);
      localStorage.setItem('redirectAfterLogin', 'creator-upload.html');
      window.location.href = 'login.html?redirect=creator-upload.html';
    });
    
    document.getElementById('auth-cancel-btn').addEventListener('click', () => {
      showAuthModal(false);
      window.history.back();
    });
    
    // Profile button
    profileBtn.addEventListener('click', async () => {
      const isAuthenticated = await checkAuthentication();
      if (isAuthenticated) {
        window.location.href = 'profile.html';
      } else {
        localStorage.setItem('redirectAfterLogin', 'creator-upload.html');
        window.location.href = 'login.html?redirect=creator-upload.html';
      }
    });
    
    // Notifications button
    notificationsBtn.addEventListener('click', () => {
      document.getElementById('notifications-panel').classList.add('active');
      renderNotifications();
    });
    
    // Close notifications panel
    document.getElementById('close-notifications').addEventListener('click', () => {
      document.getElementById('notifications-panel').classList.remove('active');
    });
    
    // Close notifications panel on background click
    document.getElementById('notifications-panel').addEventListener('click', (e) => {
      if (e.target === document.getElementById('notifications-panel')) {
        document.getElementById('notifications-panel').classList.remove('active');
      }
    });
    
    // Mark all notifications as read
    document.getElementById('mark-all-read').addEventListener('click', async () => {
      if (!currentUser) return;
      try {
        const { error } = await supabase
          .from('notifications')
          .update({ is_read: true })
          .eq('user_id', currentUser.id)
          .eq('is_read', false);
          
        if (error) throw error;
        
        notifications = notifications.map(n => ({ ...n, is_read: true }));
        renderNotifications();
        updateNotificationBadge(0);
        showToast('All notifications marked as read', 'success');
      } catch (error) {
        console.error('Error marking all as read:', error);
        showToast('Failed to mark notifications as read', 'error');
      }
    });
    
    // Search button
    searchBtn.addEventListener('click', () => {
      document.getElementById('search-modal').classList.add('active');
      setTimeout(() => document.getElementById('search-input')?.focus(), 300);
    });
    
    // Close search modal
    document.getElementById('close-search-btn').addEventListener('click', () => {
      document.getElementById('search-modal').classList.remove('active');
      document.getElementById('search-input').value = '';
      document.getElementById('search-results-grid').innerHTML = '';
    });
    
    // Close search modal on background click
    document.getElementById('search-modal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('search-modal')) {
        document.getElementById('search-modal').classList.remove('active');
        document.getElementById('search-input').value = '';
        document.getElementById('search-results-grid').innerHTML = '';
      }
    });
    
    // Back button functionality
    const backBtn = document.createElement('button');
    backBtn.className = 'icon-btn';
    backBtn.innerHTML = '<i class="fas fa-arrow-left"></i>';
    backBtn.title = 'Go Back';
    backBtn.onclick = () => window.history.back();
    document.querySelector('.header-actions').prepend(backBtn);
  }
  
  // âœ… INITIALIZE CREATOR UPLOAD - FIXED AUTH CHECK
  async function initializeCreatorUpload() {
    try {
      setLoading(true, 'Loading Creator Upload...');
      
      // Critical fix: Check authentication BEFORE setting up UI
      const isAuthenticated = await checkAuthentication();
      
      if (!isAuthenticated) {
        console.log('âš ï¸ User not authenticated - showing auth modal');
        showAuthModal(true);
        setLoading(false);
        return;
      }
      
      console.log('âœ… User authenticated - proceeding with upload setup');
      
      // Setup UI elements
      setupMediaUpload();
      setupThumbnailUpload();
      
      // Setup event listeners
      setupEventListeners();
      
      // Initial button state
      updateButtonsState();
      
      // Hide loading
      setLoading(false);
      console.log('âœ… Creator Upload initialized successfully');
    } catch (error) {
      console.error('âŒ Error initializing creator upload:', error);
      showToast('Failed to initialize upload page. Please refresh.', 'error');
      setLoading(false);
    }
  }
  
  // Initialize the app
  await initializeCreatorUpload();
  
  // Listen for auth state changes - FIXED TO USE GLOBAL CLIENT
  supabase.auth.onAuthStateChange((event, session) => {
    console.log('Auth state changed:', event);
    if (event === 'SIGNED_IN') {
      console.log('User signed in');
      if (session?.user) {
        currentUser = session.user;
        loadUserProfilePicture(session.user);
        loadNotifications();
        // Close auth modal if open
        showAuthModal(false);
      }
    } else if (event === 'SIGNED_OUT') {
      console.log('User signed out');
      currentUser = null;
      notifications = [];
      updateNotificationBadge(0);
      
      // Reset profile button to placeholder
      if (profileBtn) {
        document.getElementById('userProfilePlaceholder').innerHTML = `
          <div class="profile-placeholder">
            <i class="fas fa-user"></i>
          </div>
        `;
      }
      
      // Show auth modal since user is now signed out
      showAuthModal(true);
    }
  });
});

// Global functions for onclick handlers
window.removeMediaFile = function() {
  if (typeof removeMediaFile === 'function') removeMediaFile();
};
window.openImagePicker = function() {
  if (typeof openImagePicker === 'function') openImagePicker();
};
window.captureCameraImage = function() {
  if (typeof captureCameraImage === 'function') captureCameraImage();
};
</script>
</body>
</html>
